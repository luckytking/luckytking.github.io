<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/categories\/k8s\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="k8s">
<meta name="twitter:title" content="k8s">
<meta property="og:url" content="https://luckytking.github.io/categories/k8s/">
<meta property="twitter:url" content="https://luckytking.github.io/categories/k8s/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>k8s</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/categories/k8s/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/categories/k8s/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/ingressannotations%E6%A8%A1%E5%BC%8F%E5%90%AF%E7%94%A8apisix%E7%9A%84cors/" aria-label="">
      
          IngressAnnotations模式启用Apisix的Cors
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-15T22:19:52&#43;08:00">
        
   15, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Apache APISIX 是 Apache 软件基金会下的云原生 API 网关，它兼具动态、实时、高性能等特点，提供了负载均衡、动态上游、灰度发布（金丝雀发布）、服务熔断、身份认证、可观测性等丰富的流量管理功能。很多场景下，我们可以选择在APISIX中使用CORS（跨源资源共享）来解决跨域问题。</p>
<p>APISIX提供了CRD和Annotations模式来启用CORS。本文主要介绍如何在APISIX Ingress Annotations模式下启用CORS。</p>
<p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
<tr>
<td>apisix</td>
<td>apache/apisix:3.4.0-debian</td>
</tr>
<tr>
<td>apisix-ingress-controller</td>
<td>apache/apisix-ingress-controller:1.6.0</td>
</tr>
</tbody>
</table>
<h3 id="ingressannotations模式">IngressAnnotations模式</h3>
<p>IngressAnnotations模式，可以通过在Ingress资源上添加注释来配置APISIX的行为。比如添加一个CORS注释来指示APISIX启用CORS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">annotations</span>
    <span style="color:#f92672">k8s.apisix.apache.org/enable-cors</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">apisix</span>
</code></pre></div><p>接着，我们以给一个Http服务my-service, 创建了一个Ingress资源的例子来演示, Ingress详细如下：</p>
<h4 id="创建ingress">创建Ingress</h4>
<p>创建my-service的ingress资源：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">match-ingress</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">k8s.apisix.apache.org/enable-cors</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">apisix</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-service</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8000</span>
        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/v2</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>在这个示例中，我们添加了【k8s.apisix.apache.org/enable-cors: &ldquo;true&rdquo;】的注释， 即启用cors功能，默认允许来自任何源的请求访问my-service的API。</p>
<h4 id="dashboard启用cors">Dashboard启用CORS</h4>
<p>打开APISIX Dashboard界面：在【插件】中查找“CORS” 。单击该插件，然后单击“启用”。</p>
<p>然后，可以在路由点击查看my-service的对应路由，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;uris&#34;</span>: [
    <span style="color:#e6db74">&#34;/v2/&#34;</span>,
    <span style="color:#e6db74">&#34;/v2/*&#34;</span>
  ],
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ing_my-service-ingress_cfc81dbe&#34;</span>,
  <span style="color:#f92672">&#34;desc&#34;</span>: <span style="color:#e6db74">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span>,
  <span style="color:#f92672">&#34;plugins&#34;</span>: {
    <span style="color:#f92672">&#34;cors&#34;</span>: {
      <span style="color:#f92672">&#34;allow_credential&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;allow_headers&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;allow_methods&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;allow_origins&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;expose_headers&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;max_age&#34;</span>: <span style="color:#ae81ff">5</span>
    }
  },
  <span style="color:#f92672">&#34;upstream_id&#34;</span>: <span style="color:#e6db74">&#34;7c630009&#34;</span>,
  <span style="color:#f92672">&#34;labels&#34;</span>: {
    <span style="color:#f92672">&#34;managed-by&#34;</span>: <span style="color:#e6db74">&#34;apisix-ingress-controller&#34;</span>
  },
  <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>plugins.cors为跨域的对应规则配置，说明插件启用成功。</p>
<h4 id="测试">测试</h4>
<p>然后我们向my-service的发起一个测试请求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">-i</span> <span style="color:#f92672">-k</span> <span style="color:#e6db74">&#39;http://[my-cluster-ip:nodeport]/v2/my-service/api/geeker&#39;</span>   <span style="color:#f92672">-X</span> <span style="color:#f92672">OPTIONS</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Allow-Origin: *&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Request-Method: POST&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Request-Headers: content-type&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Origin: http://localhost/&#34;</span> 
   
</code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Date: Sat, <span style="color:#ae81ff">15</span> Jul <span style="color:#ae81ff">2023</span> 13:53:57 GMT
Content-Type: text/plain; charset<span style="color:#f92672">=</span>utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/3.4.0
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: *
Access-Control-Max-Age: <span style="color:#ae81ff">5</span>
Access-Control-Expose-Headers: *
Access-Control-Allow-Headers: *
</code></pre></div><p>如果返回结果中出现 CORS 相关的 header（
ccess-Control-Allow-Origin: *
&lt; Access-Control-Allow-Methods: *
&lt; Access-Control-Allow-Headers: *
&lt; Access-Control-Expose-Headers: *
&lt; Access-Control-Max-Age: 5
），则代表插件生效、跨域成功。</p>
<h3 id="遇到的问题">遇到的问题</h3>
<p>在增加好ingress后测试API，发现没有CORS 相关的 header</p>
<p>，跨域失败</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Content-Length: <span style="color:#ae81ff">0</span>
Connection: keep-alive
Access-Control-Allow-Headers: Content-Type
Access-Control-Allow-Origin: *
Date: Sat, <span style="color:#ae81ff">15</span> Jul <span style="color:#ae81ff">2023</span> 13:46:16 GMT
Server: APISIX/3.4.0
</code></pre></div><p>经检查，是ApiSix的config配置有误，在配置的插件里，开启了其他插件，没有包括cors，导致插件不生效。去掉后，重启插件配置生效、跨域成功。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">plugins</span>:
  <span style="color:#75715e"># the plugins you enabled</span>
  - <span style="color:#ae81ff">log-rotate</span>
  - <span style="color:#ae81ff">proxy-rewrite</span>
</code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/plugins/cors/">apisix cors</a></li>
<li><a href="https://apisix.apache.org/zh/blog/2022/12/15/how-support-ingress-custom-plugins/">apisix Ingress 如何支持自定义插件</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/ingressannotations%E6%A8%A1%E5%BC%8F%E5%90%AF%E7%94%A8apisix%E7%9A%84cors/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/" aria-label="">
      
          Sealos V4.2.2删除再增加节点失败
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-02T14:47:46&#43;08:00">
        
   2, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>sealos安装的Kubernetes集群，删除后增加节点失败。</p>
</blockquote>
<pre tabindex="0"><code>Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
</code></pre><p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>Ubuntu</td>
</tr>
<tr>
<td>sealos</td>
<td>v4.2.2</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
</tbody>
</table>
<h3 id="问题1文件时md5校验失败">问题1：文件时md5校验失败</h3>
<p>操作步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">sealos</span> <span style="color:#f92672">delete</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span> 
<span style="color:#f92672">sealos</span> <span style="color:#f92672">add</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span> 
</code></pre></div><p>执行报错:</p>
<pre tabindex="0"><code>sha256 sum not match
</code></pre><p>Sealos 的 &ndash;debug 参数是一个全局参数，用于开启调试模式，以便在出现问题时能更详细地了解系统的运行情况。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">sealos</span> <span style="color:#f92672">add</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span>  <span style="color:#f92672">--debug</span>
</code></pre></div><p>Sealos传输文件时比较md5查看是否报错，issues给了一个解决办法：可以关闭校验。</p>
<pre tabindex="0"><code>#  export SEALOS_SCP_CHECKSUM=false
</code></pre><p>修改完，出现了另外一个问题：</p>
<h3 id="问题2sealctl-增加host失败">问题2：sealctl 增加host失败</h3>
<pre tabindex="0"><code>Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
</code></pre><p> debug模式查看详细</p>
<pre tabindex="0"><code>2023-06-28T09:56:43 debug show registry info, IP: 10.0.0.X:22, Domain: sealos.hub, Data: /var/lib/registry2023-06-28T09:56:43 debug start to exec /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:222023-06-28T09:56:44 error Applied to cluster error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:22, output: , error: Process exited with status 139 from signal SEGV,2023-06-28T09:56:44 debug save objects into local: /root/.sealos/default/Clusterfile, objects: [apiVersion: apps.sealos.io/v1beta1kind: Cluster
</code></pre><p>可见，是seactl执行&quot;sealctl hosts add &ndash;ip 10.0.0.X &ndash;domain sealos.hub&quot; 失败。此文件是从master拷贝过来的：</p>
<pre tabindex="0"><code>/var/lib/containers/storage/overlay/5dd64dde7bc046cfd7554458e2950c41c0d86536e4e96532cfa2ee60685404d4/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:40 debug remote copy files src /var/lib/containers/storage/overlay/44ce75c1b3e483c61ecfbc07a72f87da8627ce40d9df9451f2d04dfad8dffc65/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:42 debug remote copy files src
</code></pre><p>我们试着手动拷贝过去，执行是正常的。初步判断是传输的文件出错 ,issure沟通,建议试着“scp进程可能有问题，比较md5查看是否有问题。export SEALOS_SCP_CHECKSUM = true”，还是出现 &ldquo;sha256 sum not match&rdquo;。无效。</p>
<h3 id="解决">解决</h3>
<p>这个v4.2.2 的一个bug，希望下个版本能修复。最终一个临时处理办法：重置集群</p>
<pre tabindex="0"><code># sealos reset 
</code></pre><p>我尝试重置集群，再加入node是可行的。</p>
<h3 id="小结">小结</h3>
<p>本文主要记录排查、解决【sealos-v4.2.2删除节点后再增加节点失败】的过程，原因sealos的版本v4.2.2 问题，，其一，旧版本在拷贝seactl文件到node时会抛出失败：sha256比较文件时，经排查判断是传输过程文件出错了。其二,可以临时通过重置集群来恢复。  希望对你有所帮助。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://sealos.io/docs/lifecycle-management/reference/sealos/commands/#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4"> sealos env 命令 </a></li>
<li><a href="https://github.com/labring/sealos/issues/2605"> sha256 not match</a></li>
<li><a href="https://github.com/labring/sealos/issues/3413"> sealos delete &ndash;nodes XXX sealos add &ndash;nodes XXX failed </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/" aria-label="">
      
          K8s安装metrics Server
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-23T18:17:24&#43;08:00">
        
   23, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Metrics Server是一个可扩展的、高效的容器资源度量源，用于Kubernetes内置的自动伸缩管道。</p>
<p>kubectl top 可以查看node、pod 的实时资源使用情况：如CPU、内存。但需要预装 Metrics Server ，不然会出现如下错误提示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">kubectl</span> <span style="color:#f92672">top</span> <span style="color:#f92672">pods</span>
<span style="color:#f92672">error</span><span style="color:#f92672">:</span> <span style="color:#f92672">Metrics</span> <span style="color:#f92672">API</span> <span style="color:#f92672">not</span> <span style="color:#f92672">available</span>
</code></pre></div><p>Metrics Server 从 Kubelet 收集资源指标，并通过Metrics API在 Kubernetes apiserver 中公开， 以供Horizo​​ntal Pod Autoscaler和Vertical Pod Autoscaler使用。指标 API 也可以通过 访问kubectl top，从而更容易调试自动缩放管道。</p>
<p>今天主要介绍安装的过程，以及记录安装过程遇到一些问题。</p>
<h3 id="开始安装">开始安装</h3>
<p>这里我们采用官网给的清单 components.yaml安装最新的 Metrics Server 版本:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">kubectl</span> <span style="color:#f92672">apply</span> <span style="color:#f92672">-f</span> <span style="color:#f92672">https</span><span style="color:#f92672">://</span><span style="color:#f92672">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#f92672">kubernetes-sigs</span><span style="color:#f92672">/</span><span style="color:#f92672">metrics-server</span><span style="color:#f92672">/</span><span style="color:#f92672">releases</span><span style="color:#f92672">/</span><span style="color:#f92672">latest</span><span style="color:#f92672">/</span><span style="color:#f92672">download</span><span style="color:#f92672">/</span><span style="color:#f92672">components</span>.<span style="color:#a6e22e">yaml</span>
</code></pre></div><p>查看是否安装成功:</p>
<pre tabindex="0"><code># kubectl get deployment metrics-server -n kube-system
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
metrics-server   0/1     1            0           118s
</code></pre><p>发现安装失败。</p>
<h3 id="问题1镜像拉取失败">问题1：镜像拉取失败</h3>
<p>查看pod详细信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">get</span> <span style="color:#f92672">pod</span>  <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">NAME</span>                              <span style="color:#f92672">READY</span>   <span style="color:#f92672">STATUS</span>         <span style="color:#f92672">RESTARTS</span>      <span style="color:#f92672">AGE</span>
<span style="color:#f92672">metrics-server-55c774cdbb-jmfz8</span>   <span style="color:#f92672">0</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>     <span style="color:#f92672">ErrImagePull</span>   <span style="color:#f92672">0</span>             <span style="color:#f92672">2m34s</span>
</code></pre></div><p>查看pod日志:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">logs</span> <span style="color:#f92672">pods</span><span style="color:#f92672">/</span><span style="color:#f92672">metrics-server-55c774cdbb-jmfz8</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">Error</span> <span style="color:#f92672">from</span> <span style="color:#f92672">server</span> <span style="color:#f92672">(</span><span style="color:#f92672">BadRequest</span><span style="color:#f92672">):</span> <span style="color:#f92672">container</span> <span style="color:#e6db74">&#34;metrics-server&#34;</span> <span style="color:#f92672">in</span> <span style="color:#f92672">pod</span> <span style="color:#e6db74">&#34;metrics-server-55c774cdbb-jmfz8&#34;</span> <span style="color:#f92672">is</span> <span style="color:#f92672">waiting</span> <span style="color:#f92672">to</span> <span style="color:#f92672">start</span><span style="color:#f92672">:</span> <span style="color:#f92672">trying</span> <span style="color:#f92672">and</span> <span style="color:#f92672">failing</span> <span style="color:#f92672">to</span> <span style="color:#f92672">pull</span> <span style="color:#f92672">image</span>
</code></pre></div><p>从日志可知是镜像拉取不下来，我们可以修改镜像地址。可以从dockerhub，查找最新版本，如作者安装的版本是：metrics-server:v0.6.1。打开components.yaml , 修改Deployment，spec.containers.coimage 为搜索到的，如“registry.aliyuncs.com/google_containers/metrics-server:v0.6.1&quot;,修改完详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">args</span>:
        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
        - --<span style="color:#ae81ff">secure-port=4443</span>
        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
        - --<span style="color:#ae81ff">metric-resolution=15s</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.aliyuncs.com/google_containers/metrics-server:v0.6.1</span>
</code></pre></div><p>更新部署deployment：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">delete</span>  <span style="color:#f92672">deployment</span> <span style="color:#f92672">metrics-server</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">deployment</span>.<span style="color:#a6e22e">apps</span> <span style="color:#e6db74">&#34;metrics-server&#34;</span> <span style="color:#f92672">deleted</span>

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">apply</span> <span style="color:#f92672">-f</span> <span style="color:#f92672">components</span>.<span style="color:#a6e22e">yaml</span>
</code></pre></div><h3 id="问题2证书">问题2：证书</h3>
<p>更新后，发现另外一个问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">server</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">132</span><span style="color:#f92672">]</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fully</span> <span style="color:#f92672">scrape</span> <span style="color:#f92672">metrics</span><span style="color:#f92672">:</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fully</span> <span style="color:#f92672">scrape</span> <span style="color:#f92672">metrics</span> <span style="color:#f92672">from</span> <span style="color:#f92672">node</span> <span style="color:#f92672">docker-desktop</span><span style="color:#f92672">:</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fetch</span> <span style="color:#f92672">metrics</span> <span style="color:#f92672">from</span> <span style="color:#f92672">node</span> <span style="color:#f92672">docker-desktop</span><span style="color:#f92672">:</span> <span style="color:#f92672">Get</span> <span style="color:#e6db74">&#34;https://192.168.1.88:10250/stats/summary?only_cpu_and_memory=true&#34;</span><span style="color:#f92672">:</span> <span style="color:#f92672">x509</span><span style="color:#f92672">:</span> <span style="color:#f92672">cannot</span> <span style="color:#f92672">validate</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">for</span> <span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">88</span> <span style="color:#f92672">because</span> <span style="color:#f92672">it</span> <span style="color:#f92672">doesn</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">t</span> <span style="color:#f92672">contain</span> <span style="color:#f92672">any</span> <span style="color:#f92672">IP</span> <span style="color:#f92672">SANs</span>
</code></pre></div><p>从日志可知是权限验证（证书）出了问题，通过搜索github issues ，issue回复里提供了一个解决方法是在可以关闭证书验证，详细如下：</p>
<p>修改清单components.yam, 增加：</p>
<pre tabindex="0"><code>- --kubelet-insecure-tls
</code></pre><p>修改完 Deplyment详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">args</span>:
        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
        - --<span style="color:#ae81ff">secure-port=4443</span>
        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
        - --<span style="color:#ae81ff">kubelet-insecure-tls</span>
        - --<span style="color:#ae81ff">metric-resolution=15s</span>
</code></pre></div><p>其中：</p>
<blockquote>
<p>&ndash;kubelet-preferred-address-types：
优先使用 InternalIP 来访问 kubelet，这样可以避免节点名称没有 DNS 解析记录时，通过节点名称调用节点 kubelet API 失败的情况（未配置时默认的情况）；</p>
<p>&ndash;kubelet-insecure-tls：
kubelet 的 10250 端口使用的是 https 协议，连接需要验证 tls 证书。&ndash;kubelet-insecure-tls 不验证客户端证书。</p>
</blockquote>
<p>然后，检查是否启动成功：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">#kubectl <span style="color:#f92672">get</span> <span style="color:#f92672">deployment</span> <span style="color:#f92672">metrics-server</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">NAME</span>             <span style="color:#f92672">READY</span>   <span style="color:#f92672">UP-TO-DATE</span>   <span style="color:#f92672">AVAILABLE</span>   <span style="color:#f92672">AGE</span>
<span style="color:#f92672">metrics-server</span>   <span style="color:#f92672">1</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>     <span style="color:#f92672">1</span>            <span style="color:#f92672">1</span>           <span style="color:#f92672">14m</span>
</code></pre></div><p>success。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/kubernetes-sigs/metrics-server"> 官网 </a></li>
<li><a href="https://cloud.tencent.com/developer/article/1818865"> 容器 &amp; 服务：metrics-server 安装探索   </a></li>
<li><a href="https://github.com/kubernetes-sigs/metrics-server/issues/131"> github issues 关闭证书  </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/" aria-label="">
      
          导入k8s集群到rancher报错no Secret Assigned to Service Account Cattle System
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-18T15:30:58&#43;08:00">
        
   18, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>在导入外部集群到rancher时，cattle-cluster-agent报错</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">level</span><span style="color:#f92672">=</span><span style="color:#f92672">fatal</span> <span style="color:#f92672">msg</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;looking up cattle-system/cattle ca/token: no secret exists for service account cattle-system/cattle&#34;</span>
</code></pre></div><p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
<tr>
<td>Rancher</td>
<td>v2.6.6</td>
</tr>
</tbody>
</table>
<h3 id="解决">解决</h3>
<p>经查，K8s在版本v1.24启用新测试功能特性-LegacyServiceAccountTokenNoAutoGeneration，默认是开启的。</p>
<blockquote>
<p>服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的持有者令牌来验证请求。</p>
<p>服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。</p>
</blockquote>
<p>我们可以通过k8s 组件上指定的各种特性开关控制 -
【特性门控是描述 Kubernetes 特性的一组键值对。你可以在 Kubernetes 的各个组件中使用 &ndash;feature-gates 标志来启用或禁用这些特性。】
关闭该特性：</p>
<p>打开 /etc/kubernetes/manifest/kube-controller-manager.yml的
spec.container.command中增加</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">-</span> <span style="color:#f92672">--feature-gates</span><span style="color:#f92672">=</span><span style="color:#f92672">LegacyServiceAccountTokenNoAutoGeneration</span><span style="color:#f92672">=</span><span style="color:#f92672">false</span>
</code></pre></div><p>修改完，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">creationTimestamp</span>: <span style="color:#66d9ef">null</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">kube-controller-manager</span>
    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">control-plane</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-controller-manager</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">command</span>:
    - <span style="color:#ae81ff">kube-controller-manager</span>
    - --<span style="color:#ae81ff">allocate-node-cidrs=true</span>
    - --<span style="color:#ae81ff">authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">bind-address=0.0.0.0</span>
    - --<span style="color:#ae81ff">client-ca-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">cluster-cidr=1.2.0.0/10</span>
    - --<span style="color:#ae81ff">cluster-name=kubernetes</span>
    - --<span style="color:#ae81ff">cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span>
    - --<span style="color:#ae81ff">controllers=*,bootstrapsigner,tokencleaner</span>
    - --<span style="color:#ae81ff">feature-gates=EphemeralContainers=true</span>
    - --<span style="color:#ae81ff">kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">leader-elect=true</span>
    - --<span style="color:#ae81ff">requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span>
    - --<span style="color:#ae81ff">root-ca-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">service-account-private-key-file=/etc/kubernetes/pki/sa.key</span>
    - --<span style="color:#ae81ff">service-cluster-ip-range=10.88.0.0/22</span>
    - --<span style="color:#ae81ff">use-service-account-credentials=true</span>
    - --<span style="color:#ae81ff">feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false</span>
    <span style="color:#ae81ff">...</span>
</code></pre></div><p>重启 kube-controller-manager，ps：如果是多个master，需要每个都修改。</p>
<h3 id="小结">小结</h3>
<p>本文记录导入外部集群到rancher时，遇到的用户认证密钥不正确的问题。回顾k8s在1.23~1.25的更新日志，以及查阅issues，原因是1.24启用了新测试特性LegacyServiceAccountTokenNoAutoGeneration，该特性使用经过签名的持有者令牌来验证请求。可以通过k8s组件上指定的各种特性开关控制来关闭此特性来解决报错，最终正常导入到rancher。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/feature-gates/"> k8s-features </a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#service-account-tokens">service-account-tokens </a></li>
<li><a href="htps://github.com/rancher/rancher/issues/37027"> issues </a></li>
<li><a href="htps://blog.isweluiz.com.br/2022/09/kubenetes-v1244-rancher-agent-error-no.html"> blog 解决用户secret </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" aria-label="">
      
          Kubernetes集群image-cri-him大量端口占用
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-27T18:11:54&#43;08:00">
        
   27, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>sealos安装的Kubernetes集群，master节点出现大量端口占用。</p>
</blockquote>
<p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>Ubuntu</td>
</tr>
<tr>
<td>sealos</td>
<td>v4.1.7</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.23.9</td>
</tr>
</tbody>
</table>
<h3 id="排查问题">排查问题</h3>
<p>按照本地端口对输出进行排序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">netstat</span> <span style="color:#f92672">-anp</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">ESTABLISHED</span> <span style="color:#f92672">|</span> <span style="color:#f92672">awk</span> <span style="color:#e6db74">&#39;{print $4}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">|</span> <span style="color:#f92672">uniq</span> <span style="color:#f92672">-c</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">-n</span>
    <span style="color:#f92672">28</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">6443</span>
    <span style="color:#f92672">111</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">2379</span>
  <span style="color:#f92672">9009</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">5000</span>
</code></pre></div><p>查找本地端口对应的应用程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">  <span style="color:#f92672">lsof</span> <span style="color:#f92672">-i</span> :<span style="color:#a6e22e">5000</span>
  <span style="color:#f92672">image-cri</span> <span style="color:#f92672">2811249</span> <span style="color:#f92672">root</span> <span style="color:#f92672">4120u</span>  <span style="color:#f92672">IPv4</span> <span style="color:#f92672">291818320</span>      <span style="color:#f92672">0t0</span>  <span style="color:#f92672">TCP</span> <span style="color:#f92672">master1</span>:<span style="color:#a6e22e">41710-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">master1</span>:<span style="color:#a6e22e">5000</span> <span style="color:#f92672">(</span><span style="color:#f92672">ESTABLISHED</span><span style="color:#f92672">)</span>
</code></pre></div><p>可见，是image-cri-shim占用的端口数。</p>
<h3 id="image-cri-shim-工作原理">image-cri-shim 工作原理</h3>
<blockquote>
<p>image-cri-shim 是一个基于 CRI (Container Runtime Interface) 和 kubelet 的 gRPC (Google Remote Procedure Call) shim。CRI 是 Kubernetes 中用于与容器运行时进行交互的接口，而 kubelet 是负责维护容器运行状态和节点级别的资源管理的 Kubernetes 组件。</p>
</blockquote>
<p>常用操作:</p>
<ul>
<li>启动服务： systemctl start image-cri-shim</li>
<li>停止服务： systemctl stop image-cri-shim</li>
<li>重启服务： systemctl restart image-cri-shim</li>
<li>查看服务状态： systemctl status image-cri-shim</li>
<li></li>
<li>参考日志:  journalctl -u image-cri-shim -f</li>
</ul>
<h3 id="重现问题">重现问题</h3>
<ol>
<li>
<p>在测试环境安装相同版本的sealos版本4.1.7，这里就不赘述，可以参考(<a href="https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle">https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle</a>)</p>
</li>
<li>
<p>安装好之后，发现image-cri-shim的版本（4.1.3）不对，</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">--version</span>
<span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">3-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>更新image-cri-shim版本为4.1.7</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.1.7/sealos_4.1.7_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.1.7_linux_amd64.tar.gz.1 image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出类似以下内容，表示成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">102</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>启动后，观察日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="4">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">netstat -na | grep <span style="color:#ae81ff">5000</span> | wc -l
<span style="color:#ae81ff">96</span>
<span style="color:#ae81ff">116</span>
<span style="color:#ae81ff">120</span>
...
</code></pre></div><ol start="5">
<li>可见，每个5分钟，占用的端口数就增加20左右。问题复现了，接着我们来看看怎么处理。</li>
</ol>
<h3 id="更新版本为420">更新版本为4.2.0</h3>
<p>从sealos的github的issues有提供一个修复方案：升级image-cri-shim的版本为4.2.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.2.0/sealos_4.2.0_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.2.0_linux_amd64.tar.gz image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出如下，表示成功：</p>
<pre tabindex="0"><code>image-cri-shim version 4.2.0-f696a621
192.168.1.101:22: image-cri-shim version 4.2.0-f696a621
192.168.1.102:22: image-cri-shim version 4.2.0-f696a621
</code></pre><h3 id="观察是否已修复">观察是否已修复</h3>
<ol>
<li>观察inamge-cri-shim日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">Timeout</span><span style="color:#f92672">:</span> {<span style="color:#f92672">15m0s</span>}
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criRegistryAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criOfflineAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">:</span>{Username:admin Password<span style="color:#f92672">:</span>passw0rd Auth<span style="color:#f92672">:</span> Email<span style="color:#f92672">:</span> ServerAddress<span style="color:#f92672">:</span>http<span style="color:#f92672">://</span>sealos<span style="color:#f92672">.</span>hub<span style="color:#f92672">:</span><span style="color:#ae81ff">5000</span> IdentityToken<span style="color:#f92672">:</span> RegistryToken<span style="color:#f92672">:</span>}<span style="color:#f92672">]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">socket</span> <span style="color:#f92672">info</span> <span style="color:#f92672">shim</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">var</span><span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">image-cri-shim</span>.<span style="color:#a6e22e">sock</span> <span style="color:#f92672">,</span><span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span>.<span style="color:#a6e22e">sock</span><span style="color:#f92672">,</span> <span style="color:#f92672">registry</span><span style="color:#f92672">:</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">ownership</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">root</span><span style="color:#f92672">/</span><span style="color:#f92672">root</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">permissions</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">-rw-rw----</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="2">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">netstat</span> <span style="color:#f92672">-na</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">5000</span> <span style="color:#f92672">|</span> <span style="color:#f92672">wc</span> <span style="color:#f92672">-l</span>
<span style="color:#f92672">1</span> 
<span style="color:#f92672">6</span> 
<span style="color:#f92672">1</span>
</code></pre></div><ol start="3">
<li>可见，请求是还有，但并没有增加端口数，看来问题修复了。</li>
</ol>
<p>ps： 我们重现问题的Kubenetes版本是v1.23.9，在实际开发中发现其他版本的v1.25.7也会出现类似问题，验证此版本待后续更新。</p>
<h3 id="小结">小结</h3>
<p>本文主要记录排查、复现、处理【sealos安装的Kubenetes集群master节点大量占用端口】的过程，原因系image-cri-shim的版本问题，旧版本会频繁请求master，导致创建大量的连接，占用端口数。通过升级image-cri-shim版本可以解决该问题。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://sealos.io/zh-Hans/docs/design/image-cri-shim"> sealos Doc： image-cri-shim 介绍</a></li>
<li><a href="https://github.com/labring/sealos/issues/2965"> 为什么sealos4.2部分的群，注册表库连接数很高 </a></li>
<li><a href="https://github.com/labring/sealos/issues/3052"> BUG: image-cri-shim导致端口大量占用，耗尽服务器socket资源 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" aria-label="">
      
          Apisix基于SNI代理TCP、UDP
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-30T13:45:59&#43;08:00">
        
   30, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <blockquote>
<p>背景:
公司项目中，需要暴露对内网的Websocket服务。</p>
</blockquote>
<p>Websocket 它是一种基于 TCP 的一种独立实现，APISIX 可以对 TCP/UDP 协议进行代理并实现动态负载均衡， 在 nginx 世界，称 TCP/UDP 代理为 stream 代理，在 APISIX 这里我们也遵循了这个声明，下文统称Stream。</p>
<p>SNI（Server Name Indication）是用来改善 SSL 和 TLS 的一项特性，它允许客户端在服务器端向其发送证书之前向服务器端发送请求的域名，服务器端根据客户端请求的域名选择合适的 SSL 证书发送给客户端。</p>
<p>本文主要介绍ApiSix如何基于SNI代理TCP/UDP。</p>
<h3 id="启用stream-代理">启用Stream 代理</h3>
<p>在 conf/config.yaml 配置文件设置 stream_proxy 选项， 指定一组需要进行动态代理的 IP 地址。默认情况不开启 stream 代理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9101&#34;</span>
    <span style="color:#f92672">udp</span>: <span style="color:#75715e"># UDP proxy address list</span>
      - <span style="color:#ae81ff">9200</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9211&#34;</span>
</code></pre></div><p>如果 apisix.enable_admin 为 true，上面的配置会同时启用 HTTP 和 stream 代理。如果你设置 enable_admin 为 false，且需要同时启用 HTTP 和 stream 代理，设置 only 为 false：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">enable_admin</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
</code></pre></div><h3 id="启用-tls">启用 TLS：</h3>
<p>首先，我们需要给对应的 TCP 地址启用 TLS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#f92672">addr</span>: <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="配置路由">配置路由</h3>
<p>当连接为 TLS over TCP 时，我们可以通过 SNI 来匹配路由，比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">PUT</span> <span style="color:#f92672">-d</span> <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  {
</span><span style="color:#e6db74">      &#34;sni&#34;: &#34;mysite.com&#34;,
</span><span style="color:#e6db74">      &#34;server_port&#34;: 9333,
</span><span style="color:#e6db74">      &#34;upstream&#34;: {
</span><span style="color:#e6db74">          &#34;scheme&#34;: &#34;tls&#34;,
</span><span style="color:#e6db74">          &#34;nodes&#34;: {
</span><span style="color:#e6db74">              &#34;192.168.1.33:8080&#34;: 1
</span><span style="color:#e6db74">          },
</span><span style="color:#e6db74">          &#34;type&#34;: &#34;roundrobin&#34;
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">  }&#39;</span>
</code></pre></div><p>查看是否创建成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span>
</code></pre></div><p>如创建错误，可以删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">DELETE</span> 
</code></pre></div><p>查看更多stream路由：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">//</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> 
</code></pre></div><p>更多Api参考：
<a href="https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route">https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route</a></p>
<h3 id="上传sni证书">上传SNI证书</h3>
<p>上传站点(mysite.com)的证书到ApiSix</p>
<h3 id="测试">测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">-v</span> <span style="color:#f92672">https</span><span style="color:#f92672">://</span><span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span><span style="color:#f92672">/</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">Trying</span> <span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">...</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TCP_NODELAY</span> <span style="color:#f92672">set</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connected</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span> <span style="color:#f92672">(</span><span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">)</span> <span style="color:#f92672">port</span> <span style="color:#f92672">9333</span> <span style="color:#f92672">(</span>#0<span style="color:#f92672">)</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">h2</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">http</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">successfully</span> <span style="color:#f92672">set</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">locations</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">CAfile</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">etc</span><span style="color:#f92672">/</span><span style="color:#f92672">ssl</span><span style="color:#f92672">/</span><span style="color:#f92672">cert</span>.<span style="color:#a6e22e">pem</span>
  <span style="color:#f92672">CApath</span><span style="color:#f92672">:</span> <span style="color:#f92672">none</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">2</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Certificate</span> <span style="color:#f92672">(</span><span style="color:#f92672">11</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">12</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">14</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">16</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">SSL</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">using</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">/</span> <span style="color:#f92672">ECDHE-RSA-CHACHA20-POLY1305</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">server</span> <span style="color:#f92672">did</span> <span style="color:#f92672">not</span> <span style="color:#f92672">agree</span> <span style="color:#f92672">to</span> <span style="color:#f92672">a</span> <span style="color:#f92672">protocol</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">certificate</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subject</span><span style="color:#f92672">:</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=*</span>.<span style="color:#a6e22e">mysite</span>.<span style="color:#a6e22e">com</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">start</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Mar</span> <span style="color:#f92672">29</span> <span style="color:#f92672">00</span>:<span style="color:#a6e22e">00</span>:<span style="color:#a6e22e">00</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">expire</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Jun</span> <span style="color:#f92672">27</span> <span style="color:#f92672">23</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">59</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subjectAltName</span><span style="color:#f92672">:</span> <span style="color:#f92672">host</span> <span style="color:#e6db74">&#34;mysite.com&#34;</span> <span style="color:#f92672">matched</span> <span style="color:#f92672">cert</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">s</span> <span style="color:#e6db74">&#34;*.mysite.com&#34;</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">issuer</span><span style="color:#f92672">:</span> <span style="color:#f92672">C</span><span style="color:#f92672">=</span><span style="color:#f92672">AT</span><span style="color:#f92672">;</span> <span style="color:#f92672">O</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span><span style="color:#f92672">;</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span> <span style="color:#f92672">RSA</span> <span style="color:#f92672">Domain</span> <span style="color:#f92672">Secure</span> <span style="color:#f92672">Site</span> <span style="color:#f92672">CA</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">SSL</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">ok</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">GET</span> <span style="color:#f92672">/</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Host</span><span style="color:#f92672">:</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">User-Agent</span><span style="color:#f92672">:</span> <span style="color:#f92672">curl</span><span style="color:#f92672">/</span><span style="color:#f92672">7</span>.<span style="color:#a6e22e">64</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Accept</span><span style="color:#f92672">:</span> <span style="color:#f92672">*/*</span>
<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span> <span style="color:#f92672">400</span> <span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Type</span><span style="color:#f92672">:</span> <span style="color:#f92672">text</span><span style="color:#f92672">/</span><span style="color:#f92672">plain</span><span style="color:#f92672">;</span> <span style="color:#f92672">charset</span><span style="color:#f92672">=</span><span style="color:#f92672">utf-8</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Sec-Websocket-Version</span><span style="color:#f92672">:</span> <span style="color:#f92672">13</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">X-Content-Type-Options</span><span style="color:#f92672">:</span> <span style="color:#f92672">nosniff</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Sun</span><span style="color:#f92672">,</span> <span style="color:#f92672">23</span> <span style="color:#f92672">Apr</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">05</span>:<span style="color:#a6e22e">50</span>:<span style="color:#a6e22e">07</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Length</span><span style="color:#f92672">:</span> <span style="color:#f92672">12</span>
<span style="color:#f92672">&lt;</span>
<span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connection</span> #0 <span style="color:#f92672">to</span> <span style="color:#f92672">host</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span> <span style="color:#f92672">left</span> <span style="color:#f92672">intact</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
</code></pre></div><p>Success。</p>
<h3 id="过程中遇见的问题">过程中遇见的问题</h3>
<ol>
<li>连接不上</li>
</ol>
<pre tabindex="0"><code> curl -v http://mysite.com
*   Trying x.x.y.y...
* TCP_NODELAY set
* Connected to mysite.com (x.x.y.y.) port 19333
&gt; GET / HTTP/1.1
&gt; Host: mysite.com:19333
&gt; User-Agent: curl/7.64.1
&gt; Accept: */*
&gt;
* Recv failure: Connection reset by peer
* Closing connection 0
curl: (56) Recv failure: Connection reset by peer
</code></pre><p>需要排查路由器端口是否正常开放，ApiSix的端口是否正常，经排查原因是：配置路由时&quot;server_port&quot;缺失</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
      <span style="color:#f92672">&#34;sni&#34;</span>: <span style="color:#e6db74">&#34;mysite.com&#34;</span>,
      <span style="color:#f92672">&#34;upstream&#34;</span>: {
          <span style="color:#f92672">&#34;scheme&#34;</span>: <span style="color:#e6db74">&#34;tls&#34;</span>,
          <span style="color:#f92672">&#34;nodes&#34;</span>: {
              <span style="color:#f92672">&#34;192.168.1.33:8080&#34;</span>: <span style="color:#ae81ff">1</span>
          },
          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;roundrobin&#34;</span>
      }
  }
</code></pre></div><ol start="2">
<li>handshark失败，证书错误</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
<span style="color:#f92672">curl</span><span style="color:#f92672">:</span> <span style="color:#f92672">(</span><span style="color:#f92672">35</span><span style="color:#f92672">)</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
</code></pre></div><p>排位原因是：这里作者使用的ApiSix版本是2.12，缺失前缀 【addr】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.org/zh/docs</a></li>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.ogr/zh/streams</a></li>
<li><a href="https://www.fenghong.tech/blog/kubernetes/sni-apisix-tcp/">
Blog-基于sni使用apisix代理四层TCP/UDP</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" aria-label="">
      
          CRI与使用crictl调试k8s节点
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-12T17:24:41&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Kubernetes 中，Kubelet 是在每个节点上运行的重要组件之一，它负责管理容器的生命周期。而 CRI（Container Runtime Interface）则是 Kubelet 用于与容器运行时进行通信的接口（如下图）。</p>
<p>CRI 采用了 ProtoBuffer 和 gPRC，规定 kubelet 该如何调用容器运行时去管理容器和镜像，Kubernetes 通过CRI可支持多种类型的OCI容器运行时，例如 docker、contained、CRI-O、runC、fraki和Kata Containers 等）。</p>
<p>为了方便用户进行容器运行时的调试工作，社区提供了 crictl 工具，用于与 CRI 接口进行交互，本文简要介绍如何使用 crictl 对 Kubernetes节点进行调试 。</p>
<p>kubelet-layout：</p>
<!-- raw HTML omitted -->
<p><img src="https://luckytking.github.io/images/kubelet-layout.png" alt=""></p>
<h4 id="安装">安装</h4>
<blockquote>
<p>你可以从 cri-tools <a href="https://github.com/kubernetes-sigs/cri-tools/releases">发布页面</a> 下载一个压缩的 crictl 归档文件，用于几种不同的架构。 下载与你的 kubernetes 版本相对应的版本。 提取它并将其移动到系统路径上的某个位置，例如 /usr/local/bin/。</p>
</blockquote>
<ul>
<li>查看版本，验证安装</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl --version
</code></pre></div><p>输出例如如下，说明安装成功:</p>
<pre tabindex="0"><code>crictl version v1.23.0 
</code></pre><h4 id="查看或编辑配置">查看或编辑配置</h4>
<p>要查看或编辑当前配置，请查看或编辑 /etc/crictl.yaml 的内容。</p>
<pre tabindex="0"><code>cat /etc/crictl.yaml
image-endpoint: unix:///var/run/image-cri-shim.sock
runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><h4 id="调试节点">调试节点</h4>
<ul>
<li>列出运行中的容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl ps
</code></pre></div><p>例如我们列出k8s集群的所有容器，例如输出：</p>
<pre tabindex="0"><code>CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID
508e30da66ce7       7a71aca7b60fc       3 days ago          Running             calico-node               0                   e0ec650992997
9daa288a68426       f822f80398b9a       3 days ago          Running             calico-typha              0                   f5c4bd6471941
300d948e75019       f6bc1b780606f       3 days ago          Running             kube-controller-manager   1                   d5d681744a377
1cfdc1a6726ae       0198979b7707e       3 days ago          Running             kube-scheduler            1                   eb6ff07ees98c
3699c312c56f9       9e6a540eeeb62       3 days ago          Running             kube-proxy                0                   e8707140d12941
4159d7ec37b29       5bc0062e9555c       3 days ago          Running             kube-apiserver            0                   22d043569737f
8f56a047e8627      25f8c7f3da61c       3 days ago          Restart             etcd                      0                   458e540c798c8
</code></pre><p>本例中，etcd容器一直启动，可以使用以下命令获取容器的日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl logs container-id
</code></pre></div><p>如此，通过日志帮助定位问题。</p>
<h4 id="更多命令">更多命令</h4>
<ul>
<li>列出所有的pods</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl pods
</code></pre></div><ul>
<li>创建容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl run --runtime<span style="color:#f92672">=</span>remote <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  docker.io/library/nginx:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  nginx-container
</code></pre></div><p>ps:使用远程容器CRI来使用最新的 nginx 镜像启动nginx-container的容器。</p>
<ul>
<li>删除容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crictl rm nginx-container
</code></pre></div><ul>
<li>列出所有镜像：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl images
</code></pre></div><ul>
<li>帮助</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> crictl -h 
NAME:
   crictl - client <span style="color:#66d9ef">for</span> CRI

USAGE:
   crictl <span style="color:#f92672">[</span>global options<span style="color:#f92672">]</span> command <span style="color:#f92672">[</span>command options<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>arguments...<span style="color:#f92672">]</span>

VERSION:
   v1.23.0

COMMANDS:
   attach              Attach to a running container
   create              Create a new container
   exec                Run a command in a running container
   version             Display runtime version information
   images, image, img  List images
   inspect             Display the status of one or more containers
   inspecti            Return the status of one or more images
   imagefsinfo         Return image filesystem info
   inspectp            Display the status of one or more pods
   logs                Fetch the logs of a container
   port-forward        Forward local port to a pod
   ps                  List containers
   pull                Pull an image from a registry
   run                 Run a new container inside a sandbox
   runp                Run a new pod
   rm                  Remove one or more containers
   rmi                 Remove one or more images
   rmp                 Remove one or more pods
   pods                List pods
   start               Start one or more created containers
   info                Display information of the container runtime
   stop                Stop one or more running containers
   stopp               Stop one or more running pods
   update              Update one or more running containers
   config              Get and set crictl client configuration options
   stats               List container<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> resource usage statistics
   completion          Output shell completion code
   help, h             Shows a list of commands or help <span style="color:#66d9ef">for</span> one command

GLOBAL OPTIONS:
   --config value, -c value            Location of the client config file. If not specified and the default does not exist, the program<span style="color:#e6db74">&#39;s directory is searched as well (default: &#34;/etc/crictl.yaml&#34;) [$CRI_CONFIG_FILE]
</span><span style="color:#e6db74">   --debug, -D                         Enable debug mode (default: false)
</span><span style="color:#e6db74">   --image-endpoint value, -i value    Endpoint of CRI image manager service (default: uses &#39;</span>runtime-endpoint<span style="color:#960050;background-color:#1e0010">&#39;</span> setting<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>$IMAGE_SERVICE_ENDPOINT<span style="color:#f92672">]</span>
   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service <span style="color:#f92672">(</span>default: uses in order the first successful one of <span style="color:#f92672">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style="color:#f92672">])</span>. Default is now deprecated and the endpoint should be set instead. <span style="color:#f92672">[</span>$CONTAINER_RUNTIME_ENDPOINT<span style="color:#f92672">]</span>
   --timeout value, -t value           Timeout of connecting to the server in seconds <span style="color:#f92672">(</span>e.g. 2s, 20s.<span style="color:#f92672">)</span>. <span style="color:#ae81ff">0</span> or less is set to default <span style="color:#f92672">(</span>default: 2s<span style="color:#f92672">)</span>
   --help, -h                          show help <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
   --version, -v                       print the version <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
</code></pre></div><p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">kubernetes.io 使用 crictl 对 Kubernetes 节点进行调试</a></li>
<li><a href="%C2%A0https://item.jd.com/13140598.html">《Kubernetes进阶实战-第2版》CRI 与OCI </a>
 </li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" aria-label="">
      
          Ingress与IngressController
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-20T15:31:51&#43;08:00">
        
   20, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要学习记录Kubernetes集群暴露服务的方式: Ingress。</p>
<h3 id="简介">简介</h3>
<blockquote>
<p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p>IngressController  为了让 Ingress 资源工作，集群必须有一个正在运行的 Ingress 控制器。</p>
</blockquote>
<p><img src="https://luckytking.github.io/images/ingress_layout.png" alt=""></p>
<p>上图清晰标识出了Ingress的流量走向，其中：</p>
<ul>
<li>Ingress基于DNS名称（host）或URL路径把请求转发⾄指定的Service资源的规则。它仅是⼀组路由规则的集合。</li>
<li>Ingress控制器是真正实现“流量穿透”，可以由具有反向代理（HTTP/HTTPS）功能的服务程序实现 , 然后根据这些规则的匹配机制路由请求流量</li>
</ul>
<h3 id="ingress-资源声明">Ingress 资源声明</h3>
<p>Ingress是Kubernetes API的标准资源类型之⼀ ,一个最小Ingress例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minimal-ingress</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx-example</span>
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/testpath</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>其中:</p>
<ul>
<li>Ingress 需要指定 apiVersion、kind、 metadata和 spec 字段。</li>
<li>Ingress 对象的命名必须是合法的 DNS 子域名名称。</li>
<li>Ingress annotations 来配置一些选项,  ⽤于识别其所属的Ingress控制器的类别。</li>
<li>Ingress rules 提供了配置负载均衡器或者代理服务器所需的所有信息。 最重要的是，其中包含与所有传入请求匹配的规则列表。 Ingress 资源仅支持用于转发 HTTP(S) 流量的规则。</li>
</ul>
<p>更多参考： <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>Ingress控制器可以由任何具有反向代理（HTTP/HTTPS）功能的服务程序实现，目前支持和维护 AWS、 GCE 和 Nginx Ingress 控制器。</p>
<ul>
<li>Nginx Ingress 作为反向代理和负载均衡器。</li>
<li>Apache APISIX Ingress 控制器 是一个基于 Apache APISIX 网关 的 Ingress 控制器。</li>
</ul>
<p>更多参考：https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</p>
<h3 id="安装-ingress-nginx">安装 Ingress Nginx</h3>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/cloud/deploy.yaml  -O ingress-nginx-deploy.yaml

kubectl apply -f  ingress-nginx-deploy.yaml
</code></pre><p>观测是否成功：</p>
<pre tabindex="0"><code>kubectl get pods -n ingress-nginx --watch
</code></pre><p>如果成功的话，查看namespace下所有的资源信息</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get all -n ingress-nginx
NAME                                            READY   STATUS    RESTARTS   AGE
pod/ingress-nginx-controller-123456   1/1     Running   0          1h

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.104.182.98    192.168.1.100   80:31666/TCP,443:31888/TCP   1d
service/ingress-nginx-controller-admission   ClusterIP      10.111.228.99   &lt;none&gt;         443/TCP                      1d

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           1d

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-123456   1         1         1      1d

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           1s         1d
job.batch/ingress-nginx-admission-patch    1/1           2s         1d
</code></pre><h3 id="使用ingress-发布-tomcat">使用Ingress 发布 Tomcat</h3>
<p>部署Tomcat Service</p>
<ol>
<li>
<p>创建deployment</p>
<pre tabindex="0"><code>    kubectl create deployment web --image=tomcat:8.0.50-jre8-alpine
</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>kubectl expose deployment web --type=NodePort --port=8080

</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get service web
    NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
    web    NodePort   10.100.183.22   &lt;none&gt;        8080:32562/TCP   30s
</code></pre></li>
<li>
<p>验证nodeport 是否正常访问 tomcat ，浏览器访问  http://matster_ip:32562
<img src="https://luckytking.github.io/images/ingress_tomcat.png" alt=""></p>
</li>
<li>
<p>创建 ingress</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingressfoo</span>
      <span style="color:#f92672">annotations</span>:
        <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">rules</span>:
      - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ingressfoo.io</span>
        <span style="color:#f92672">http</span>:
          <span style="color:#f92672">paths</span>:
          - <span style="color:#f92672">backend</span>:
              <span style="color:#f92672">service</span>:
                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
                <span style="color:#f92672">port</span>:
                  <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bar</span>
            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>查看ingress是否创建成功</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get ingress
NAME         CLASS    HOSTS                     ADDRESS        PORTS   AGE
ingressfoo   &lt;none&gt;   ingressfoo.io   192.168.1.100   80      1h
</code></pre><p>说明Ingress创建成功，修改hosts ：</p>
<blockquote>
<p>ingressfoo.io 192.168.1.100</p>
</blockquote>
<p>验证访问 ingressfoo.io/bar</p>
<p><img src="https://luckytking.github.io/images/ingress_tomcat2.png" alt=""></p>
<p>success</p>
<h3 id="参考">参考</h3>
<ul>
<li>Ingress  介绍 <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></li>
<li>IngressController 介绍  <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</a></li>
<li><a href="https://github.com/apache/apisix-ingress-controller">https://github.com/apache/apisix-ingress-controller</a></li>
<li>NGINX Ingress 控制器配置 Ingress <a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8</a></li>
<li>在K8S上的Web服务该怎么做域名解析 <a href="https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA">https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" aria-label="">
      
          Kubernetes集群资源监控一机制和资源指标
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-05T22:50:36&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        本文主要介绍Kubernetes集群资源监控机制和资源指标
前言 临近双11，对于码农，尤其是后端，尤其是某宝某东的后端，那是多么激动人心（心惊胆战）的一夜，为什么？怕宕机呀~。那么就让我们来构建护城河&ndash;监控与自动扩容，来抵挡千军万马&ndash;高并发场景。首先让我们学习一些基础：k8s集群资源监控机制和资源指标。
分析 从需求出发，我们自然需要收集一些数据(资源指标)，再根据指标做一系列的操作(control)，比如说预警警告、统计、自动扩容等。
首先，我们希望可以监控整个Kubernetes集群的健康状况，包括：
 整个集群的资源利⽤率 集群中的所有⼯作节点是否运⾏正常、系统资源容量⼤⼩ 每个⼯作节点上运⾏的容器化应⽤的数量  k8s资源控制 我们看看k8s如何资源控制
限制节点 以购物平台为例，微服务广受推崇，比如双11当天，用户进首页是流畅的，但是进活动主页就卡顿，到了零点时，加入购物车的按钮都转圈了。设想你的设计可能是三个微服务（主页服务 、双十一活动服务、订单服务），可想而知，活动服务是压力最大的，我们希望，就算宕机，不要影响其他的服务。所以可以把活动服务限制运行在某节点。
 创建一个会被调度到特定节点上的 Pod，你也可以通过设置 nodeName 将某个 Pod 调度到特定的节点
 nodeName: foo-node # 调度 Pod 到特定的节点 限制内存 还是上面的例子，我们把活动服务调度到了 foo-node。那么剩下的服务没有去限制，但想想订单服务的压力也不小，这里我们希望限制它的资源上限。
 要为容器指定内存请求，请在容器资源清单中包含 resources：requests 字段。 同理，要指定内存限制，请包含 resources：limits。
 resources: requests: memory: &#34;1000Gi&#34; limits: memory: &#34;1000Gi&#34; 限制CPU  要为容器指定 CPU 请求，请在容器资源清单中包含 resources: requests 字段。 要指定 CPU 限制，请包含 resources:limits
 resources: limits: cpu: &#34;100&#34; requests: cpu: &#34;100&#34; Example 环境准备:
 k8s集群（master * 1，node * 2 ) kubectl 命令行工具( 笔者使用rancher)   创建一个namespace（stress）。 增加一个deployment, 修改内存上限为10M 1.
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" aria-label="">
      
          利用k8s储存卷来部署redis之三StatefulSet
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-11T18:20:54&#43;08:00">
        
   11, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前两篇(1.<a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/">volume</a>2.<a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/">pv&amp;pvc</a>)通过部署redis学习实战了k8s的来Volume、PV和PVC。但是，应⽤程序存在“有状态”和“⽆状态”两种类别，显然redis属于读写磁盘需求的有状态应⽤程序，如⽀持事务功能的RDBMS存储系统，所以，本文学习实战k8s有状态应用的部署。</p>
<h3 id="stateful基础">Stateful基础</h3>
<p>StatefulSet是Pod资源控制器的⼀种实现，⽤于部署和扩展有状态应⽤的Pod资源，确保它们的运⾏顺序及每个Pod资源的唯⼀性。适用以下需求的应用：</p>
<ul>
<li>稳定且唯⼀的⽹络标识符。</li>
<li>稳定且持久的存储。</li>
<li>有序、优雅地部署和扩展。</li>
<li>有序、优雅地删除和终⽌。</li>
<li>有序⽽⾃动地滚动更新。</li>
</ul>
<h3 id="部署">部署</h3>
<p>接着，这里把之前的redis存储修改为stateful的方式，修改后的步骤：</p>
<ol>
<li>创建 ConfigMap （参考第一篇）</li>
<li>修改 Deployment 为StatefulSets</li>
</ol>
<h4 id="修改部署statefulsets">修改部署StatefulSets</h4>
<p>mkdir my-redis-statefulsets.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
          <span style="color:#f92672">emptyDir</span>: {}
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>
 
---
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30379</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis          </span>

</code></pre></div><p>其中：</p>
<ol>
<li>Headless Service：⽤于为Pod资源标识符⽣成可解析的DNS资源记录</li>
<li>StatefulSet ⽤于管控Pod资源</li>
<li>volumeClaimTemplate则基于静态或动态的PV供给⽅式为Pod资源提供
专有且固定的存储（这里我们直接使用了第二篇创建的pv）</li>
</ol>
<h3 id="测试">测试</h3>
<p>redis-client 连接 NodeId:NodePort</p>
<pre tabindex="0"><code># redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&gt; info
# Serverredis_version:7.0.4
</code></pre><p>连接成功!</p>
<h3 id="参考">参考</h3>
<ul>
<li>官方stateful介绍 <a href="https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage">https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/k8s/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/categories\/go\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="go">
<meta name="twitter:title" content="go">
<meta property="og:url" content="https://luckytking.github.io/categories/go/">
<meta property="twitter:url" content="https://luckytking.github.io/categories/go/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>go</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/categories/go/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/categories/go/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" aria-label="">
      
          浅谈kratos的表现层源码实现与解码器
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-02T17:25:55&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前后端数据常用传输格式有：json、xml 和 proto等，不管是mvc还是ddd，都会在表现层的对不同的格式进行转化下层依赖所需的类、Object、 aggregate等。</p>
<h2 id="kratos-表现层">Kratos 表现层</h2>
<p>在实际开发场景中，前后端传输采用json。 但kratos使用proto定义Api， 那么我们以一个Http请求为例，来看看kratos的表现层是如何处理的。</p>
<p>以下是一个Kratos-Example，由编写好的proto文件，proto-go 等自动生成表现层的代码。 大概步骤：</p>
<ol>
<li>编写proto，包括Service，Req，Reply</li>
<li>生成表现层代码</li>
<li>实现下层逻辑等</li>
</ol>
<p>Example完整代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>可以看到：</p>
<ol>
<li>这里对具体的格式无感，输入In还是输出Out都是一个proto生成的类。</li>
<li>具体的实现交给了ctx 上下文去实现
查看 ctx.Result的源码:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Result</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">code</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">enc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">v</span>)
}
</code></pre></div><p>这里的enc，没有特殊设置，使用默认的DefaultResponseEncoder，部分源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultResponseEncoder</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CodecForRequest</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;Accept&#34;</span>)
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ContentType</span>(<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Name</span>()))
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>通过codc接口隔离具体实现，调用接口的 codec.Marshal序列化。</p>
<h2 id="codec包">codec包</h2>
<p>Codec定义Transport用于编码和解码消息的接口。它的实现包括 json，xml，proto，yaml等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Codec</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Marshal returns the wire format of v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">// Unmarshal parses the wire format into v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">// Name returns the name of the Codec implementation. The returned string
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will be used as part of content type in transmission.  The result must be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// static; the result cannot change between calls.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>这里我们聚焦正在使用的Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">codec</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">codec</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshaler</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MarshalJSON</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	}
}
</code></pre></div><p>这里Marshal()使用第三方库“&ldquo;google.golang.org/protobuf/encoding/protojson&rdquo;</p>
<p>实现proto转json。</p>
<h2 id="protojson第三方包">protojson第三方包</h2>
<p>protojson是Google提供的proto和json的转化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">api_test</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;google.golang.org/protobuf/encoding/protojson&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;helloworld/api/helloworld/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestToJson</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">HelloReply</span>{
		<span style="color:#a6e22e">Message</span>: <span style="color:#e6db74">&#34;Jobs&#34;</span>,
	}
	<span style="color:#a6e22e">replyJson</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">ProtoReflect</span>().<span style="color:#a6e22e">Interface</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Marshal Error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;replyJson:  %v&#34;</span>, string(<span style="color:#a6e22e">replyJson</span>))
}
</code></pre></div><p>更多的接口请参考“https://google.golang.org/protobuf/encoding/protojson”</p>
<h2 id="小结">小结</h2>
<p>本文主要以kratos的表现层的组织方式，来介绍常用的框架表现层处理方式。
其中：</p>
<ul>
<li>kratos通过proto来生成表现层代码的类，包括http和grapc，内部对具体实现无感。</li>
<li>kratos通过解码器codec实现不同传输格式的解耦。</li>
<li>第三方包protojson实现proto和json转换。</li>
</ul>
<p>框架的主要功能之一就是标准化处理一下公共的问题场景,从源码中可以学习：通过接口隔离具体的实现，而使框架与具体实现解耦,且具备更好的拓展性。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://go-kratos.dev/docs/getting-started/usage">https://go-kratos.dev/docs/getting-started/usage</a></li>
<li><a href="https://google.golang.org/protobuf/encoding/protojson">https://google.golang.org/protobuf/encoding/protojson</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/08/go%E8%AF%BB%E5%86%99csv%E6%96%87%E4%BB%B6/" aria-label="">
      
          Go读写Csv文件
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-08-21T17:01:48&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍go如何读取和写入csv文件，以及使用第三方库gocsv转换为Struct。</p>
<h3 id="读取csv">读取csv</h3>
<p>go 标准库 &ldquo;encoding/csv&rdquo; 用于读写csv文件。</p>
<p>Reader从csv编码的文件中读取记录</p>
<ul>
<li>type Reader
<ul>
<li>func NewReader(r io.Reader) *Reader</li>
<li>func (r *Reader) Read() (record []string, err error) 。</li>
<li>func (r *Reader) ReadAll() (records [][]string, err error)</li>
</ul>
</li>
</ul>
<p>创建一个csv文件servers.csv,具体如下</p>
<pre tabindex="0"><code class="language-csv" data-lang="csv">world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><p>ReadAll从r中读取所有剩余的记录，每个记录都是字段的切片，成功的调用返回值err为nil而不是EOF。因为ReadAll方法定义为读取直到文件结尾，因此它不会将文件结尾视为应该报告的错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/csv&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">readeCsvAll</span>() 
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readerCsvReadAll</span>() {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;servers.csv&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">servers</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadAll</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;ReadAll:&#34;</span>, <span style="color:#a6e22e">servers</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>ReadAll:  [world-svc 1/1 Running 0 44m] [battle-svc 1/1 Running 0 7d]]
</code></pre><p>Read从r读取一条记录，返回值record是字符串的切片，每个字符串代表一个字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
<span style="color:#66d9ef">for</span> {
    <span style="color:#a6e22e">servers</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Read</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
        <span style="color:#66d9ef">break</span>
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error:&#34;</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">servers</span>)
}
</code></pre></div><p>输出和ReadAll是一样的。</p>
<p>csv读写逗号分隔值（csv）的文件，亦或可以定义数据的分隔符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Comma</span> = <span style="color:#e6db74">&#39;|&#39;</span> 
</code></pre></div><p>亦或可以定义忽略的的行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Comment</span> = <span style="color:#e6db74">&#39;#&#39;</span>
</code></pre></div><h3 id="写入csv">写入csv</h3>
<p>Writer类型的值将记录写入一个csv编码的文件</p>
<ul>
<li>type Writer
<ul>
<li>func NewWriter(w io.Writer) *Writer</li>
<li>func (w *Writer) Write(record []string) (err error)</li>
<li>func (w *Writer) WriteAll(records [][]string) (err error)</li>
<li>func (w *Writer) Flush()</li>
<li>func (w *Writer) Error() error</li>
</ul>
</li>
</ul>
<p>向w中写入一条记录，会自行添加必需的引号。记录是字符串切片，每个字符串代表一个字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writerOne</span>() {
	<span style="color:#a6e22e">servers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">Server</span>{
		{<span style="color:#e6db74">&#34;world-svc&#34;</span>, <span style="color:#e6db74">&#34;1/1&#34;</span>, <span style="color:#e6db74">&#34;Running&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;44m&#34;</span>},
		{<span style="color:#e6db74">&#34;battle-svc&#34;</span>, <span style="color:#e6db74">&#34;1/1&#34;</span>, <span style="color:#e6db74">&#34;Running&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;7d&#34;</span>},
	}
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;serversA.csv&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;failed to open file&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">file</span>)
   <span style="color:#75715e">//将缓存中的数据写入底层的io.Writer。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Flush</span>()
	<span style="color:#75715e">// 使用 Write
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Ready</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Restarts</span>), <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Age</span>}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">row</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;error writing server to file&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
	}

</code></pre></div><p>执行，在当前目录生成 serversA.csv,内容如下：</p>
<pre tabindex="0"><code>world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><p>WriteAll方法使用Write方法向w写入多条记录，并在最后调用Flush方法清空缓存</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">string</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Ready</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Restarts</span>), <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Age</span>}
		<span style="color:#a6e22e">data</span> = append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">row</span>)
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteAll</span>(<span style="color:#a6e22e">data</span>)

</code></pre></div><h3 id="to-struct">To Struct</h3>
<p>GoCSV包旨在提供 CSV 和 Go (golang) 值之间的快速和惯用的映射。
已有servers.csv 内容如下</p>
<pre tabindex="0"><code>Name,Ready,Status,Restart,Age
world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><blockquote>
<p>UnmarshalFile(in *os.File, out interface{}) error 
UnmarshalFile从接口中的文件解析CSV。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ToStruct</span>() {
	<span style="color:#a6e22e">clientsFile</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;servers.csv&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_RDWR</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ModePerm</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">clientsFile</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">servers</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>
    <span style="color:#75715e">//转换成 Server Object
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gocsv</span>.<span style="color:#a6e22e">UnmarshalFile</span>(<span style="color:#a6e22e">clientsFile</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">servers</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Server&#34;</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>)
	}
}
</code></pre></div><p>OuPut：</p>
<pre tabindex="0"><code>Server world-svc
Server battle-svc
</code></pre><p>更多api使用方式可参考：https ://github.com/gocarina/gocsv</p>
<h4 id="参考">参考</h4>
<ul>
<li><a href="https://pkg.go.dev/encoding/csv">https://pkg.go.dev/encoding/csv</a></li>
<li>https ://github.com/gocarina/gocsv</li>
<li><a href="https://medium.com/wesionary-team/read-and-write-csv-file-in-go-b445e34968e9">https://medium.com/wesionary-team/read-and-write-csv-file-in-go-b445e34968e9</a></li>
<li><a href="https://medium.com/wesionary-team/easy-working-with-csv-in-golang-using-gocsv-package-9c8424728bbe">https://medium.com/wesionary-team/easy-working-with-csv-in-golang-using-gocsv-package-9c8424728bbe</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/08/go%E8%AF%BB%E5%86%99csv%E6%96%87%E4%BB%B6/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/go%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" aria-label="">
      
          Go原子操作
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-23T22:51:37&#43;08:00">
        
   23, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="原子操作">原子操作</h3>
<blockquote>
<p>原子操作即执行过程不能被中断的操作。在针对某个值的原子操作执行过程当值，cpu绝不会再去执行其他针对该值的操作，无论这些其他操作是否为原子操作。</p>
</blockquote>
<h3 id="go-atomic">go-atomic</h3>
<p>查看Mutex、RWMutex的源码，底层是通过atomic包中的一些原子操作来实现。</p>
<p>Go标准库 sync/atomic 提供了对基础类型 int32、int64、uint32、uint64、uintptr、Pointer（Add 方法不支持） 的原子级内存操作。其中包括：</p>
<ul>
<li>Add （给第一个参数地址中的值增加一个 delta 值）</li>
<li>CompareAndSwap（判断相等即替换)）</li>
<li>Swap（不需要比较旧值，直接替换，返回旧值）</li>
<li>Load（方法会取出 addr 地址中的值）</li>
<li>Store（ 方法会把一个值存入到指定的 addr 地址中）</li>
</ul>
<p>我们通过一个例子可以快速了解atomic封装的这些api</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">0</span>

	<span style="color:#75715e">//func AddInt32(addr *int32, delta int32) (new int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">1</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;x=%d,y=%d \n&#34;</span>, <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
	<span style="color:#75715e">//OutPut: x=1,y=1
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// addr 地址里的值是不是 old，如果不等于 old，就返回 false；如果等于 old，就把此地址的值替换成 new 值，返回 true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isCompare</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">0</span>), int32(<span style="color:#ae81ff">2</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;isCompare=%v,x=%d  \n&#34;</span>, <span style="color:#a6e22e">isCompare</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: isCompare=false,x=1
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//不相等，故x还是1
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isCompare2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">1</span>), int32(<span style="color:#ae81ff">2</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;isCompare=%v,x=%d  \n&#34;</span>, <span style="color:#a6e22e">isCompare2</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: isCompare=true,x=2
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//相等，故x还是2
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func SwapInt32(addr *int32, new int32) (old int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">xOld</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">SwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">3</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;xOld=%d,x=%d  \n&#34;</span>, <span style="color:#a6e22e">xOld</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: xOld=2,x=3
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//不比较，故x替换3
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func LoadInt32(addr *int32) (val int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">vValue</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;vValue=%d \n&#34;</span>, <span style="color:#a6e22e">vValue</span>)
	<span style="color:#75715e">//OutPut: xOld=2,x=3
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//获取x的值3
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func StoreInt32(addr *int32, val int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">StoreInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, <span style="color:#ae81ff">8</span>)
	<span style="color:#a6e22e">vValue2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;vValue2=%d \n&#34;</span>, <span style="color:#a6e22e">vValue2</span>)
	<span style="color:#75715e">//OutPut:vValue2=8 
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="小试牛刀">小试牛刀</h3>
<p>atomic 比较常见的类型 还提供了一个特殊的类型：Value，但是只支持  load、store。
这里模拟一个场景：当配置变更后，期待其他goroutine可以收到通知和变更。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Network</span>      <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Addr</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">ReadTimeout</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">WriteTimeout</span> <span style="color:#66d9ef">int32</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">loadConfig</span>() <span style="color:#a6e22e">Config</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Network</span>:      <span style="color:#e6db74">&#34;redis&#34;</span>,
		<span style="color:#a6e22e">Addr</span>:         <span style="color:#e6db74">&#34;127.0.0.1:6379&#34;</span>,
		<span style="color:#a6e22e">ReadTimeout</span>:  <span style="color:#ae81ff">60</span>,
		<span style="color:#a6e22e">WriteTimeout</span>: <span style="color:#ae81ff">60</span>,
	}
}

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">done</span>   <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">config</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">loadConfig</span>())
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cond</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>{})
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">beginLoad</span>(<span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">beginLoad</span>(<span style="color:#a6e22e">cond</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">loadConfig</span>())
		<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Broadcast</span>()
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#a6e22e">node</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">cond</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">L</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">done</span> {
			<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
		}
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">Config</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;node: %d - redis config: %+v\n&#34;</span>, <span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">c</span>)

	}
	<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">L</span>.<span style="color:#a6e22e">Unlock</span>()
}

</code></pre></div><p>OutPut：</p>
<pre tabindex="0"><code>node: 2 - redis config: {Network:redis Addr:127.0.0.1:6379 ReadTimeout:60 WriteTimeout:60}
node: 1 - redis config: {Network:redis Addr:127.0.0.1:6379 ReadTimeout:60 WriteTimeout:60}
</code></pre><h3 id="uber-goatomic">uber-go/atomic</h3>
<p>uber-go/atomic对标准库进行进一步封装，采用面向对象的使用方式。
这些类型包括 Bool、Duration、Error、Float64、Int32、Int64、String、Uint32、Uint64 等
举个例子uint32的减法你可能是这么写的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddUint32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, ^(<span style="color:#a6e22e">delta</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
</code></pre></div><p>利用计算机补码的规则，把减法变成加法 。uber-go对它进行了封装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">atom</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Uint32</span>
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#ae81ff">10</span>)
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#ae81ff">2</span>)
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">CAS</span>(<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">1</span>)
</code></pre></div><h3 id="小结">小结</h3>
<p>本文简要介绍原子操作和go-atomic，使用场景，以及第三库uber-go/atomic。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/uber-go/atomic">https://github.com/uber-go/atomic</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/go%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/go-corntab/" aria-label="">
      
          Go Corntab
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-17T18:44:07&#43;08:00">
        
   17, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍golang 使用crontab实现定时任务。</p>
<h3 id="linux-crontab">linux crontab</h3>
<p>Linux crontab 是用来定期执行程序的命令。当安装完成操作系统之后，默认便会启动此任务调度命令</p>
<p>命令语法：</p>
<blockquote>
</blockquote>
<p>crontab [ -u user ] file</p>
<p>crontab [ -u user ] { -l | -r | -e }</p>
<pre tabindex="0"><code>*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    +----- 星期中星期几 (0 - 6) (星期天 为0)
|    |    |    +---------- 月份 (1 - 12) 
|    |    +--------------- 一个月中的第几天 (1 - 31)
|    +-------------------- 小时 (0 - 23)
+------------------------- 分钟 (0 - 59)
</code></pre><h3 id="go-cron">go cron</h3>
<p>第三方包“github.com/robfig/cron”来创建 crontab，以实现定时任务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>()
		<span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * &#34;</span>
		<span style="color:#a6e22e">count</span> = <span style="color:#ae81ff">0</span>
	)

	<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;count: &#34;</span>, <span style="color:#a6e22e">count</span>,<span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>())
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error : %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">entityID</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">select</span> {}
}

</code></pre></div><p>go run main.go</p>
<p>输出：</p>
<pre tabindex="0"><code>count:  1 now: 1658053860
count:  2 now: 1658053920
count:  3 now: 1658053980
count:  4 now: 1658054040
count:  5 now: 1658054100

</code></pre><p>可以看到每隔1分钟，执行一次Func，count++</p>
<p>默认情况下标准 cron 规范解析（第一个字段是“分钟”)
可以轻松选择进入秒字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>())
<span style="color:#75715e">//注意这里多了一个参数
</span><span style="color:#75715e"></span><span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * * &#34;</span>
</code></pre></div><p>执行输出</p>
<pre tabindex="0"><code>count:  1 now: 1658053640
count:  2 now: 1658053642
count:  3 now: 1658053644
count:  4 now: 1658053646
count:  5 now: 1658053648 

</code></pre><p>可以看到每隔两秒执行一次</p>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/go-corntab/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" aria-label="">
      
          Redis实现对象存储和列表分页
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-05T16:23:04&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h2 id="场景">场景</h2>
<p>在项目开发中，需要用到缓存和对一个列表数据分页查询，但由于redis是key-value的存储方式，我们期望的使用类似postgresql的offset和limit，不至于需要一个个key遍历过去。</p>
<h2 id="设计">设计</h2>
<p>分析一下我们需求，那么需求需要实现的接口大概是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">FindByPage</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) ([]<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>大致我们需要解决两个问题:</p>
<ul>
<li>存储对象</li>
<li>列表分页快速查找</li>
</ul>
<h3 id="对象存储">对象存储</h3>
<blockquote>
<p>Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</p>
<ul>
<li>HDEL key field1 [field2]删除一个或多个哈希表字段</li>
<li>HEXISTS key field查看哈希表 key 中，指定的字段是否存在。</li>
<li>HGET key field获取存储在哈希表中指定字段的值。</li>
<li>HGETALL key获取在哈希表中指定 key 的所有字段和值</li>
</ul>
</blockquote>
<p>如此，我们可以 redis hash 和 json.Encoding 来存储。
获得一个Object</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//【ObjectID】= &#34;{&#34;foo&#34;: &#34;123&#34;, &#34;bar&#34;:&#34;456&#34;}&#34;
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span>  <span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>

<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HGet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>()).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">YourObject</span>{}
<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte(<span style="color:#a6e22e">result</span>), <span style="color:#a6e22e">obj</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><p>增加一个Object：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">ob</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">Object</span>{}<span style="color:#960050;background-color:#1e0010">）</span>) 
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HSet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">ob</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">ob</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
</code></pre></div><h3 id="分页">分页</h3>
<p>我们的需求中，ObjectID是一个唯一的int，那么可以使用 zset</p>
<blockquote>
<p>ZXyy redis 有序集合的基本命令。</p>
<ul>
<li>ZADD key score1 member1 [score2 member2]向有序集合添加一个或多个成员，或者更新已存在成员的分数</li>
<li>ZCARD key获取有序集合的成员数</li>
<li>ZRANGE key start stop [WITHSCORES]通过索引区间返回有序集合指定区间内的成员</li>
</ul>
</blockquote>
<p>那么可以把 zset 的key 和 value 都设置为 ObjectID
增加一个Object的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
     <span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>),
     <span style="color:#a6e22e">Member</span>: <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>)),
}).<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>获取X分页的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> (
     <span style="color:#a6e22e">start</span> = int64((<span style="color:#a6e22e">page</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">size</span>)
     <span style="color:#a6e22e">end</span>   = <span style="color:#a6e22e">start</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">size</span>)
)
<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">end</span>).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><h3 id="测试">测试</h3>
<p>我们增加N个Object：</p>
<pre tabindex="0"><code>[1 a]
[2 b]
[3 c]
[11 aa]
[12 bb]
[13 cc]
[21 aaaa]
</code></pre><p>每页的长度为4，获取第一页</p>
<pre tabindex="0"><code>[1 2 3 11]
</code></pre><p>第二页：</p>
<pre tabindex="0"><code>[12 13 21]
</code></pre><p>第三页：</p>
<pre tabindex="0"><code>[ ]
</code></pre><h4 id="参考">参考</h4>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1802288">https://cloud.tencent.com/developer/article/1802288</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" aria-label="">
      
          Go Copier简介
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-22T16:44:15&#43;08:00">
        
   22, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍 jinzhu/copier 的使用和常用场景</p>
<h2 id="简介">简介</h2>
<p>在go后端项目开发中，内部rpc服务返回的字段跟api服务相差无几，一个个赋值比较费事儿。那么就需要Object、List、HashMap 等进行值拷贝。jinzhu/copier即提供了这些场景的支持。</p>
<p><strong>copier 特性</strong>：</p>
<ul>
<li>从方法复制到具有相同名称的字段</li>
<li>从字段复制到具有相同名称的方法</li>
<li>从一个切片复制到另一个切片</li>
<li>从结构体复制到切片</li>
<li>从map复制到map</li>
<li>强制复制带有标记的字段</li>
<li>忽略带有标记的字段</li>
<li>深拷贝</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="copy-from-struct">Copy from struct</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/jinzhu/copier&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Role</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Age</span>          <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeCode</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// specify field name
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// Explicitly ignored in the destination struct.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//目标结构体中的标签提供了copy指令。复制忽略
</span><span style="color:#75715e">//或强制复制，如果字段没有被复制则惊慌或返回错误。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Employee</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//告诉copier。如果没有复制此字段，则复制到panic。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`copier:&#34;must&#34;`</span>

	<span style="color:#75715e">//告诉copier。 如果没有复制此字段，则返回错误。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Age</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`copier:&#34;must,nopanic&#34;`</span>

	<span style="color:#75715e">// 告诉copier。 显式忽略复制此字段。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`copier:&#34;-&#34;`</span>

	<span style="color:#a6e22e">DoubleAge</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeId</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// 指定字段名
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SuperRole</span>  <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyStruct</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">user</span>     = <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">200000</span>}
		<span style="color:#a6e22e">employee</span> = <span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">150000</span>}
	)
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employee</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employee</span>)
}
</code></pre></div><p>output：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">47</span>: <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">150000</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>} 

</code></pre></div><h3 id="copy-from-slice-to-slice">Copy from slice to slice</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopySlice</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">users</span>     = []<span style="color:#a6e22e">User</span>{{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">100000</span>}, {<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Dev&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">60000</span>}}
		<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	)
	<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employees</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employees</span>)
}<span style="color:#960050;background-color:#1e0010">`</span>

</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">57</span>: []<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>}, <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">60</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Dev&#34;</span>}} 

</code></pre></div><h3 id="copy-from-map-to-map">Copy from Map to Map</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyMap</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">// Copy map to map
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">map1</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">3</span>: <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>: <span style="color:#ae81ff">8</span>}
	<span style="color:#a6e22e">map2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">map2</span>, <span style="color:#a6e22e">map1</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">map2</span>)
}
</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">66</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">8</span>} 
</code></pre></div><h2 id="场景-1rpcapi">场景 1（rpc&amp;api）</h2>
<p>实际开发中，免不了服务间通讯，比较前文所说的场景，一个内部的rpc服务返回的参数和api服务差不多，那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//伪代码如下
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ApiLogin</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,<span style="color:#a6e22e">request</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>)(<span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)  {
	<span style="color:#a6e22e">grpcClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NewGameGrpcClient</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Login</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>{ 
					})
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>.<span style="color:#a6e22e">User</span>{}
 	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">User</span>())
<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginReply</span>{
	<span style="color:#a6e22e">User</span>:<span style="color:#a6e22e">user</span>,
},<span style="color:#a6e22e">err</span>

</code></pre></div><h2 id="场景-2-model-objectaggregate">场景 2 (model-object/aggregate)</h2>
<p>实际开发中，不管是mvc\ddd 都会有从model到object/aggreate的repository,那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserRepo</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">int64</span>) (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">model</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">uid</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">obj</span><span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
	copy(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">obj</span>,<span style="color:#a6e22e">model</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">obj</span>,<span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="小结">小结</h2>
<p>copier提供不同类型之间相同的字段名，使用tag或者方法支持不同的字段名的赋值。减少一些重复的工作量,小巧实用。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/jinzhu/copier">https://github.com/jinzhu/copier</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/kratos%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AF%BB%E5%8F%96/" aria-label="">
      
          Kratos项目配置的定义和读取
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-14T22:18:53&#43;08:00">
        
   14, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要记录kratos项目配置的定义、读取和源码的学习</p>
<h2 id="at-first">at first</h2>
<p>服务在启动的基本都会用到配置文件，那么如果是你来写config工具库，它所能提供的功能是什么？</p>
<ol>
<li>读取不同场景的配置</li>
<li>读取不同格式的配置</li>
<li>支持热更</li>
<li>支持拓展，提供自定义实现</li>
</ol>
<h2 id="kratosconfig-有那些功能">kratos/config 有那些功能</h2>
<ol>
<li>kratos/config包支持多种配置源，包括
<ul>
<li>本地文件</li>
<li>本地环境</li>
<li>contrib/config支持配置中心</li>
</ul>
</li>
<li>kratos/config 支持多种配置格式
<ul>
<li>json</li>
<li>proto</li>
<li>xml</li>
<li>yaml</li>
</ul>
</li>
<li>支持热更</li>
<li>支持其它格式的配置文件</li>
</ol>
<h2 id="定义配置">定义配置</h2>
<p>在项目目录下创建文件: 
workspace/configs/config.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">service</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.0.0</span>
<span style="color:#f92672">http</span>:
  <span style="color:#f92672">server</span>:
    <span style="color:#f92672">address</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">8000</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">1s</span>
<span style="color:#f92672">grpc</span>:
  <span style="color:#f92672">server</span>:
    <span style="color:#f92672">address</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">9000</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">1s</span>
</code></pre></div><h2 id="加载配置文件">加载配置文件</h2>
<h3 id="withsource">WithSource</h3>
<p>使用withsoure指定数据源为本地文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;flag&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>

	<span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/config&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/config/file&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">flagconf</span> <span style="color:#66d9ef">string</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">StringVar</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">flagconf</span>, <span style="color:#e6db74">&#34;conf&#34;</span>, <span style="color:#e6db74">&#34;config.yaml&#34;</span>, <span style="color:#e6db74">&#34;config path, eg: -conf config.yaml&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithSource</span>(
			<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">NewSource</span>(<span style="color:#a6e22e">flagconf</span>),
		),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Load</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">//定义配置JSON字段
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Service</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>
			<span style="color:#a6e22e">Version</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;version&#34;`</span>
		} <span style="color:#e6db74">`json:&#34;service&#34;`</span>
	}

	<span style="color:#75715e">//将配置Unmarshal 到struct  
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;config: %+v&#34;</span>, <span style="color:#a6e22e">v</span>)

	<span style="color:#75715e">//获取与该键关联的值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#e6db74">&#34;service.name&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;service: %s&#34;</span>, <span style="color:#a6e22e">name</span>)

	<span style="color:#75715e">// 热更执行钩子
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#e6db74">&#34;service.name&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Value</span>) {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;config changed: %s = %v\n&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>)
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#f92672">&lt;-</span>make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
}
</code></pre></div><p>output：</p>
<pre tabindex="0"><code>$  config: {Service:{Name:config Version:v1.0.0}}
$  service: config
</code></pre><h3 id="withdecoder">WithDecoder</h3>
<p>Decoder用于将配置文件内容用特定的反序列化方法解析出来</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithSource</span>(
			<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">NewSource</span>(<span style="color:#a6e22e">flagconf</span>),
		),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithDecoder</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">src</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">KeyValue</span>, <span style="color:#a6e22e">target</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
				<span style="color:#75715e">// expand key &#34;aaa.bbb&#34; into map[aaa]map[bbb]interface{}
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">keys</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
				<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">keys</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> len(<span style="color:#a6e22e">keys</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
						<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Value</span>
					} <span style="color:#66d9ef">else</span> {
						<span style="color:#a6e22e">sub</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})
						<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">sub</span>
						<span style="color:#a6e22e">target</span> = <span style="color:#a6e22e">sub</span>
					}
				}
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">codec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">encoding</span>.<span style="color:#a6e22e">GetCodec</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span>); <span style="color:#a6e22e">codec</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">target</span>)
			}
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unsupported key: %s format: %s&#34;</span>, <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span>)
		}),
	)
</code></pre></div><p>output 和上例一致</p>
<h2 id="原理">原理</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Config is a config interface.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Load</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Scan</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">Value</span>
	<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">o</span> <span style="color:#a6e22e">Observer</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
}
</code></pre></div><ol>
<li>指定数据源的这样会将整个目录中的所有文件进行解析加载，合并到同一个map中</li>
</ol>
<pre tabindex="0"><code>    c := config.New(
            config.WithSource(
                file.NewSource(flagconf),
            ),
        )
        if err := c.Load(); err != nil {
            panic(err)
         }
</code></pre><ol start="2">
<li>使用之前创建好的config实例，调用.Scan方法，读取配置文件的内容到结构体中，这种方式适用于完整获取整个配置文件的内容</li>
</ol>
<pre tabindex="0"><code>    if err := c.Scan(&amp;v); err != nil {
      panic(err)
    }
    fmt.Printf(&quot;config: %+v&quot;, v)
</code></pre><ol start="3">
<li>New的时候会有一个默认的 decoder</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#a6e22e">Config</span> {
	<span style="color:#a6e22e">o</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">options</span>{
		<span style="color:#a6e22e">logger</span>:   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultLogger</span>,
		<span style="color:#a6e22e">decoder</span>:  <span style="color:#a6e22e">defaultDecoder</span>,
		<span style="color:#a6e22e">resolver</span>: <span style="color:#a6e22e">defaultResolver</span>,
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">opts</span> {
		<span style="color:#a6e22e">opt</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">o</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>{
		<span style="color:#a6e22e">opts</span>:   <span style="color:#a6e22e">o</span>,
		<span style="color:#a6e22e">reader</span>: <span style="color:#a6e22e">newReader</span>(<span style="color:#a6e22e">o</span>),
		<span style="color:#a6e22e">log</span>:    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewHelper</span>(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">logger</span>),
	}
}
</code></pre></div><p>通过option可以拓展自定义 decoder</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDecoder</span>(<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">Decoder</span>) <span style="color:#a6e22e">Option</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">options</span>) {
		<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">decoder</span> = <span style="color:#a6e22e">d</span>
	}
}
</code></pre></div><h2 id="参考">参考</h2>
<ol>
<li><a href="https://github.com/go-kratos/kratos/v2/config">https://github.com/go-kratos/kratos/v2/config</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config">https://github.com/go-kratos/kratos/tree/main/contrib/config</a></li>
<li><a href="https://go-kratos.dev/docs/component/config">https://go-kratos.dev/docs/component/config</a></li>
</ol>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/kratos%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AF%BB%E5%8F%96/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Berrors/" aria-label="">
      
          Go开发常用第三方库之errors
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-05T18:53:15&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍 在go开发中 errors 的处理和第三方库 <strong>github.com/pkg/errors</strong> 的使用。</p>
<h2 id="error-interface">error interface</h2>
<p>官方定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// The error built-in interface type is the conventional interface for
</span><span style="color:#75715e">// representing an error condition, with the nil value representing no error.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#66d9ef">error</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><h3 id="常用的声明方式">常用的声明方式</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//方式一
</span><span style="color:#75715e"></span><span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;io.EOF&#34;</span>)
<span style="color:#75715e">//方式二
</span><span style="color:#75715e"></span><span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;io.EOF&#34;</span>)
<span style="color:#75715e">//方式三: 实现interface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">err3</span> <span style="color:#66d9ef">struct</span>{
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">err3</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;err3&#34;</span>
}
</code></pre></div><p>go的错误常见是把错误层层传递，这样可能带来一些不友好的地方：</p>
<ul>
<li>错误判断，经过层次包裹的错误，使用层不好判断真实错误</li>
<li>定位错误，error库过于简单，没有提供粗错误堆栈，不好定位问题</li>
</ul>
<h3 id="错误判断">错误判断</h3>
<p>常见错误的判断方式是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">base</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">base</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;base error&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">wrapBase</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;wrapBase: %w&#34;</span>, <span style="color:#a6e22e">base</span>{})
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestErrors</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;==&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">foo</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">base</span>{}
		<span style="color:#a6e22e">bar</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">base</span>{}
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">foo</span>)
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">bar</span>)
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">foo</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">bar</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">foo</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">bar</span>)
	})
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;断言&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">base</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">False</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">ok</span>)
	})
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;Is&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">foo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span>{}
		<span style="color:#a6e22e">wrapFoo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wrapBase</span>()
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">False</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">foo</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">wrapFoo</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">wrapFoo</span>, <span style="color:#a6e22e">foo</span>))
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">False</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">wrapFoo</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">base</span>{}))
	})
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;As&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">foo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span>{}
		<span style="color:#a6e22e">wrapFoo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wrapBase</span>()
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">False</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">foo</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">wrapFoo</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">As</span>(<span style="color:#a6e22e">wrapFoo</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">base</span>{}))
	})
}
</code></pre></div><p>OutPut：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">--- PASS: TestErrors (0.00s)
--- PASS: TestErrors/== (0.00s)
--- PASS: TestErrors/断言 (0.00s)
--- PASS: TestErrors/Is (0.00s)
 --- PASS: TestErrors/As (0.00s)
</code></pre></div><ul>
<li>当没有嵌套错误，可以使用 ==来判断；</li>
<li>当有多层嵌套，可以使用 Is() ：
<ul>
<li>//一个错误被认为匹配一个目标，如果它等于那个目标或如果它实现了一个方法Is(error) bool，使Is(target)返回true。</li>
<li>// As在err&rsquo;s chain中找到第一个与target匹配的错误，如果找到，则设置指向错误值并返回true。否则，返回false</li>
</ul>
</li>
</ul>
<h3 id="定位错误">定位错误</h3>
<p>常用的第三方库</p>
<blockquote>
<p>github.com/pkg/errors/errors.go
提供了以下功能：</p>
</blockquote>
<ul>
<li>WithStack 包装堆栈</li>
<li>WithMessagef 包装异常</li>
<li>等</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestWithStackCompare</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;fmt.Errorf，无堆栈，不好定位&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;io.EOF&#34;</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err1: %+v&#34;</span>, <span style="color:#a6e22e">err1</span>)
	})
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;errors ，无堆栈，不好定位&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;io.EOF&#34;</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err2: %+v&#34;</span>, <span style="color:#a6e22e">err2</span>)
	})
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;pkgerrors，有堆栈，方便定位&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
		<span style="color:#a6e22e">err3</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pkgerrors</span>.<span style="color:#a6e22e">WithStack</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err3: %+v&#34;</span>, <span style="color:#a6e22e">err3</span>)
	})

}

</code></pre></div><p>OutPut:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">=== RUN   TestWithStackCompare
=== RUN   TestWithStackCompare/fmt.Errorf，无堆栈，不好定位
err1: io.EOF=== RUN   TestWithStackCompare/errors_，无堆栈，不好定位
err2: io.EOF=== RUN   TestWithStackCompare/pkgerrors，有堆栈，便以定位
err3: EOF
tkingo.vip/egs/goerrors-demo.TestWithStackCompare.func3
	$ workspace/goerrors-demo/errors_test.go:113
testing.tRunner
	$ workspace/Go/src/testing/testing.go:1439
runtime.goexit
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestWithMessagef</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">err</span>     <span style="color:#66d9ef">error</span>
		<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">string</span>
		<span style="color:#a6e22e">want</span>    <span style="color:#66d9ef">string</span>
	}{
		{<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span>, <span style="color:#e6db74">&#34;read error&#34;</span>, <span style="color:#e6db74">&#34;read error: EOF&#34;</span>},
		{<span style="color:#a6e22e">pkgerrors</span>.<span style="color:#a6e22e">WithMessagef</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span>, <span style="color:#e6db74">&#34;read error without format specifier&#34;</span>), <span style="color:#e6db74">&#34;client error&#34;</span>, <span style="color:#e6db74">&#34;client error: read error without format specifier: EOF&#34;</span>},
		{<span style="color:#a6e22e">pkgerrors</span>.<span style="color:#a6e22e">WithMessagef</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span>, <span style="color:#e6db74">&#34;read error with %d format specifier&#34;</span>, <span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#34;client error&#34;</span>, <span style="color:#e6db74">&#34;client error: read error with 1 format specifier: EOF&#34;</span>},
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
		<span style="color:#a6e22e">got</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pkgerrors</span>.<span style="color:#a6e22e">WithMessagef</span>(<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">message</span>).<span style="color:#a6e22e">Error</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">got</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">want</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;WithMessage(%v, %q): got: %q, want %q&#34;</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">message</span>, <span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">want</span>)
		}
	}
}
</code></pre></div><h3 id="总结">总结</h3>
<p>pkg errors 应该能够支持错误堆栈、不同的打印格式很好的补充了go errors 的一些短板</p>
<p>参考：</p>
<ul>
<li>github.com/pkg/errors</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Berrors/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Btime/" aria-label="">
      
          Go开发常用第三方库之time
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-05T18:53:15&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍一个好用的时间工具库，主要功能：</p>
<ul>
<li>当前时间</li>
<li>修改地区</li>
<li>解析字符串 等</li>
</ul>
<h2 id="usage">Usage</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/jinzhu/now&#34;</span>

<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>() <span style="color:#75715e">// 2013-11-18 17:51:49.123456789 Mon
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfMinute</span>()        <span style="color:#75715e">// 2013-11-18 17:51:00 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfHour</span>()          <span style="color:#75715e">// 2013-11-18 17:00:00 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfDay</span>()           <span style="color:#75715e">// 2013-11-18 00:00:00 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfWeek</span>()          <span style="color:#75715e">// 2013-11-17 00:00:00 Sun
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfMonth</span>()         <span style="color:#75715e">// 2013-11-01 00:00:00 Fri
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfQuarter</span>()       <span style="color:#75715e">// 2013-10-01 00:00:00 Tue
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">BeginningOfYear</span>()          <span style="color:#75715e">// 2013-01-01 00:00:00 Tue
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfMinute</span>()              <span style="color:#75715e">// 2013-11-18 17:51:59.999999999 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfHour</span>()                <span style="color:#75715e">// 2013-11-18 17:59:59.999999999 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfDay</span>()                 <span style="color:#75715e">// 2013-11-18 23:59:59.999999999 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfWeek</span>()                <span style="color:#75715e">// 2013-11-23 23:59:59.999999999 Sat
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfMonth</span>()               <span style="color:#75715e">// 2013-11-30 23:59:59.999999999 Sat
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfQuarter</span>()             <span style="color:#75715e">// 2013-12-31 23:59:59.999999999 Tue
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfYear</span>()                <span style="color:#75715e">// 2013-12-31 23:59:59.999999999 Tue
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">WeekStartDay</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Monday</span> <span style="color:#75715e">// Set Monday as first day, default is Sunday
</span><span style="color:#75715e"></span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">EndOfWeek</span>()                <span style="color:#75715e">// 2013-11-24 23:59:59.999999999 Sun
</span></code></pre></div><h2 id="修改地区">修改地区</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">location</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">LoadLocation</span>(<span style="color:#e6db74">&#34;Asia/Shanghai&#34;</span>)

<span style="color:#a6e22e">myConfig</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Config</span>{
	<span style="color:#a6e22e">WeekStartDay</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Monday</span>,
	<span style="color:#a6e22e">TimeLocation</span>: <span style="color:#a6e22e">location</span>,
	<span style="color:#a6e22e">TimeFormats</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;2006-01-02 15:04:05&#34;</span>},
}

<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#ae81ff">2013</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">51</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">123456789</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Location</span>()) <span style="color:#75715e">// // 2013-11-18 17:51:49.123456789 Mon
</span><span style="color:#75715e"></span><span style="color:#a6e22e">myConfig</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">t</span>).<span style="color:#a6e22e">BeginningOfWeek</span>()         <span style="color:#75715e">// 2013-11-18 00:00:00 Mon
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">myConfig</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2002-10-12 22:14:01&#34;</span>)     <span style="color:#75715e">// 2002-10-12 22:14:01
</span><span style="color:#75715e"></span><span style="color:#a6e22e">myConfig</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2002-10-12 22:14&#34;</span>)        <span style="color:#75715e">// returns error &#39;can&#39;t parse string as time: 2002-10-12 22:14&#39;
</span></code></pre></div><h2 id="解析字符串">解析字符串</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>() <span style="color:#75715e">// 2013-11-18 17:51:49.123456789 Mon
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Parse(string) (time.Time, error)
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2017&#34;</span>)                <span style="color:#75715e">// 2017-01-01 00:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2017-10&#34;</span>)             <span style="color:#75715e">// 2017-10-01 00:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2017-10-13&#34;</span>)          <span style="color:#75715e">// 2017-10-13 00:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;1999-12-12 12&#34;</span>)       <span style="color:#75715e">// 1999-12-12 12:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;1999-12-12 12:20&#34;</span>)    <span style="color:#75715e">// 1999-12-12 12:20:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;1999-12-12 12:20:21&#34;</span>) <span style="color:#75715e">// 1999-12-12 12:20:21, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;10-13&#34;</span>)               <span style="color:#75715e">// 2013-10-13 00:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;12:20&#34;</span>)               <span style="color:#75715e">// 2013-11-18 12:20:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;12:20:13&#34;</span>)            <span style="color:#75715e">// 2013-11-18 12:20:13, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;14&#34;</span>)                  <span style="color:#75715e">// 2013-11-18 14:00:00, nil
</span><span style="color:#75715e"></span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;99:99&#34;</span>)               <span style="color:#75715e">// 2013-11-18 12:20:00, Can&#39;t parse string as time: 99:99`
</span><span style="color:#75715e"></span>
</code></pre></div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/jinzhu/now">https://github.com/jinzhu/now</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Btime/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/04/go%E5%BE%AE%E6%9C%8D%E5%8A%A1-kratostransporter%E4%BC%A0%E8%BE%93%E5%B1%82/" aria-label="">
      
          Go微服务  KratosTransporter传输层
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-04-04T18:53:15&#43;08:00">
        
   4, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍Kratos Transport和源码的分析.</p>
<p>kratos 框架对传输层进行了抽象，用户可以通过实现接口来接入实现，框架默认实现了gRPC和HTTP两种通信协议传输层。</p>
<h2 id="抽象接口">抽象接口</h2>
<h3 id="server-interface">Server Interface</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 服务的启动和停止，用于管理服务生命周期。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
}
</code></pre></div><h3 id="transporter">Transporter</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Transporter</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#75715e">// 代表实现的通讯协议的种类，如内置的 http grpc，也可以实现其他的类型如 mqtt，websocket
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Kind</span>() <span style="color:#a6e22e">Kind</span>
    <span style="color:#75715e">// 提供的服务终端地址
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Endpoint</span>() <span style="color:#66d9ef">string</span>
    <span style="color:#75715e">// 用于标识服务的完整方法路径
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 示例: /helloworld.Greeter/SayHello
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Operation</span>() <span style="color:#66d9ef">string</span>
    <span style="color:#75715e">// http 的请求头或者 grpc 的元数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Header</span>() <span style="color:#a6e22e">Header</span>
}
</code></pre></div><h3 id="endpointer">Endpointer</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Endpointer</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#75715e">// 用于实现注册到注册中心的终端地址，如果不实现这个方法则不会注册到注册中心
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Endpoint</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>, <span style="color:#66d9ef">error</span>)
}

</code></pre></div><h2 id="example-for-http">Example For Http</h2>
<p>使用kratos-transport 创建一个http server 和 client ，在 client和server之间通讯</p>
<h3 id="server">server</h3>
<p>server的完整代码 server.go 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;os/signal&#34;</span>
	<span style="color:#e6db74">&#34;syscall&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#a6e22e">transporthttp</span> <span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">Server</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">ServerOption</span>{
		<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;0.0.0.0:8000&#34;</span>),
		<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">Timeout</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>),
	}
	<span style="color:#a6e22e">svr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">svr</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">helloHandler</span>{})
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">svr</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewServer</span>()

	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ErrServerClosed</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Server closed under request&#34;</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Server closed unexpected&#34;</span>)
		}
	}

	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>)
	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">done</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Interrupt</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Shutdown NewServer:&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
	}()
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Foo</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Bar</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">helloHandler</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">helloHandler</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ParseForm</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">formData</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})
	<span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">formData</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">formData</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">formData</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">k</span>, <span style="color:#e6db74">&#34;value&#34;</span>, <span style="color:#a6e22e">v</span>)
	}

	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Foo</span>{
		<span style="color:#a6e22e">Bar</span>: <span style="color:#e6db74">&#34;NiceToMeetYouToo&#34;</span>,
	}
	<span style="color:#a6e22e">replyBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, string(<span style="color:#a6e22e">replyBytes</span>))
}

</code></pre></div><p>启动服务</p>
<pre tabindex="0"><code> go run main.go
</code></pre><p>输出</p>
<pre tabindex="0"><code>API server listening at: [::]:60870
INFO msg=[HTTP] server listening on: [::]:8000
</code></pre><h3 id="client">client</h3>
<p>client 的完整代码 client.go 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#f92672">package</span> <span style="color:#a6e22e">client</span>

<span style="color:#f92672">import</span> (
   <span style="color:#e6db74">&#34;context&#34;</span>
   <span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
   <span style="color:#e6db74">&#34;testing&#34;</span>
   <span style="color:#e6db74">&#34;time&#34;</span>

   <span style="color:#e6db74">&#34;github.com/stretchr/testify/assert&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Foo</span> <span style="color:#66d9ef">struct</span> {
   <span style="color:#a6e22e">Bar</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewClient</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
   <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewClient</span>(
   	<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(),
   	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">WithEndpoint</span>(<span style="color:#e6db74">&#34;0.0.0.0:8000&#34;</span>),
   	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">WithMiddleware</span>(),
   	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>),
   )
   <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)

   <span style="color:#a6e22e">values</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
   	<span style="color:#e6db74">&#34;foo&#34;</span>:   <span style="color:#e6db74">&#34;bar&#34;</span>,
   	<span style="color:#e6db74">&#34;hello&#34;</span>: <span style="color:#e6db74">&#34;world&#34;</span>,
   } 
   <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
   <span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Foo</span>{}
   <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;POST&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">values</span>, <span style="color:#a6e22e">reply</span>)
   <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)

   <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;reply&#34;</span>, <span style="color:#a6e22e">reply</span>)
}

</code></pre></div><p>运行测试用例，</p>
<p>server 输出：</p>
<pre tabindex="0"><code>key foo value bar
key hello value world
</code></pre><p>client 输出：</p>
<pre tabindex="0"><code>=== RUN   TestNewClient
    client_test.go:42: reply &amp;{NiceToMeetYouToo}
</code></pre><h2 id="源码分析">源码分析</h2>
<h3 id="transport-server">Transport Server</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 服务的启动和停止，用于管理服务生命周期。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">interface</span> {
   <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
   <span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
}
</code></pre></div><p>Start：启动服务、监听端口、处理请求
Stop：停止服务</p>
<p>如上例 server.go 中，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">svr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</code></pre></div><p>这个用创建一个 Server Interface的Http实例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Server is an HTTP server wrapper.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>
	<span style="color:#a6e22e">lis</span>         <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>
	<span style="color:#a6e22e">tlsConf</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Config</span>
	<span style="color:#a6e22e">endpoint</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>
	<span style="color:#a6e22e">err</span>         <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">network</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">address</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">timeout</span>     <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#a6e22e">filters</span>     []<span style="color:#a6e22e">FilterFunc</span>
	<span style="color:#a6e22e">ms</span>          []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>
	<span style="color:#a6e22e">dec</span>         <span style="color:#a6e22e">DecodeRequestFunc</span>
	<span style="color:#a6e22e">enc</span>         <span style="color:#a6e22e">EncodeResponseFunc</span>
	<span style="color:#a6e22e">ene</span>         <span style="color:#a6e22e">EncodeErrorFunc</span>
	<span style="color:#a6e22e">strictSlash</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">router</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>
	<span style="color:#a6e22e">log</span>         <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Helper</span>
}

</code></pre></div><p>可以看到，Server是对标准库 net/http 中http.Server 的一个封装。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ServerOption is an HTTP server option.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ServerOption</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>)

</code></pre></div><p>可通过 option 设置服务参数，比如例子中的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">ServerOption</span>{
		<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;0.0.0.0:8000&#34;</span>),
		<span style="color:#a6e22e">transporthttp</span>.<span style="color:#a6e22e">Timeout</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>),
	}

</code></pre></div><p>Start 启动一个net/http.Server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Start start the HTTP server.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> { 
    <span style="color:#f92672">...</span>
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;[HTTP] server listening on: %s&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">lis</span>.<span style="color:#a6e22e">Addr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">tlsConf</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ServeTLS</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">lis</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">lis</span>)
	}
    <span style="color:#f92672">...</span>
} 

</code></pre></div><h3 id="启动流程">启动流程</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">App</span>) <span style="color:#a6e22e">Run</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>
		<span style="color:#a6e22e">eg</span>.<span style="color:#a6e22e">Go</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
			<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>() <span style="color:#75715e">// wait for stop signal
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">ctx</span>)
		})
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">eg</span>.<span style="color:#a6e22e">Go</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span>)
		})
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>kratos 的App 层无需关心底层服务协议的实现， 只需管理好应用配置、服务生命周期、加载顺序即可。</p>
<h3 id="transport-client">Transport Client</h3>
<p>Transport Client 是会 http CLient封装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Client is an HTTP client.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Client</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">opts</span>     <span style="color:#a6e22e">clientOptions</span>
	<span style="color:#a6e22e">target</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">Target</span>
	<span style="color:#a6e22e">r</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">resolver</span>
	<span style="color:#a6e22e">cc</span>       <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">insecure</span> <span style="color:#66d9ef">bool</span>
}
</code></pre></div><p>如client.go 中的一个Http Post</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">values</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
	}  
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Foo</span>{}
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;POST&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">values</span>, <span style="color:#a6e22e">reply</span>) 
</code></pre></div><p>Invoke封装了post，使用更加简洁。</p>
<h2 id="总结">总结</h2>
<p>kratos 的App 层无需关心底层服务协议的实现， 只需管理好应用配置、服务生命周期、加载顺序即可。抽象的服务协议可以专注应用配置、服务生命周期等。层次清晰，职责清楚。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/go-kratos/kratos/v2/transport">https://github.com/go-kratos/kratos/v2/transport</a></li>
<li><a href="https://go-kratos.dev/docs/component/transport/overview">https://go-kratos.dev/docs/component/transport/overview</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/04/go%E5%BE%AE%E6%9C%8D%E5%8A%A1-kratostransporter%E4%BC%A0%E8%BE%93%E5%B1%82/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            
  <div class="pagination-bar">
    <ul class="pagination">
      
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/go/" aria-label="">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span></span>
            </a>
          </li>
        
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/categories\/go\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="go">
<meta name="twitter:title" content="go">
<meta property="og:url" content="https://luckytking.github.io/categories/go/">
<meta property="twitter:url" content="https://luckytking.github.io/categories/go/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>go</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/categories/go/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/categories/go/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/12/go%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/" aria-label="">
      
          Go浅拷贝与深拷贝
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-12-04T16:44:31&#43;08:00">
        
   4, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍Go实现浅拷贝和深拷贝，以及工具库mohae/deepcopy。</p>
<h3 id="定义">定义</h3>
<blockquote>
<p>浅拷贝是按位拷贝对象，它会创建一个新对象，这个对象有着原始对象属性值的一份精确拷贝。如果属性是基本类型，拷贝的就是基本类型的值；如果属性是内存地址（引用类型），拷贝的就是内存地址 ，因此如果其中一个对象改变了这个地址，就会影响到另一个对象。即默认拷贝构造函数只是对对象进行浅拷贝复制(逐个成员依次拷贝)，即只复制对象空间而不复制资源</p>
</blockquote>
<blockquote>
<p>深拷贝是指源对象与拷贝对象互相独立，其中任何一个对象的改动都不会对另外一个对象造成影响。比较典型的就是Value（值）对象，如预定义类型Int32，Double，以及结构（struct），枚举（Enum）等</p>
</blockquote>
<h3 id="浅拷贝">浅拷贝</h3>
<p>go使用<strong>copy</strong>内置函数将源片中的元素复制到目标切片,如果拷贝的
结构中不包含指针是没问题，否则则数据源和拷贝之间对应指针会共同指向同一块内存。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">shallowCopyReference</span>() {
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{{<span style="color:#e6db74">&#34;Neymar&#34;</span>}, {<span style="color:#e6db74">&#34;Messi&#34;</span>}}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, len(<span style="color:#a6e22e">brazil</span>))
	copy(<span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">brazil</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %p\n&#34;</span>, <span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %p\n&#34;</span>, <span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">argentina</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %v, %p\n&#34;</span>, <span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %v, %p\n&#34;</span>, <span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">argentina</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#ae81ff">0xc0000412e0</span>, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc000041310</span>, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc0000412e0</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc000041310</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412f0</span> 
</code></pre></div><p>如上，修改了src（拷贝原始结构）的指针对象，dst（拷贝目标结构）的值也被改动了，显然是不行的。</p>
<h3 id="深拷贝">深拷贝</h3>
<h4 id="方法一gobjson-序列化成字节序列再反序列化生成克隆对象">方法一：gob、json 序列化成字节序列再反序列化生成克隆对象</h4>
<ul>
<li>gob序列化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByGobExample</span>() {
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: <span style="color:#a6e22e">players</span>}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepCopyByGob</span>(<span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">argentina</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;deepcopy error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByGob</span>(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">src</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">buf</span>).<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Bytes</span>())).<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">dst</span>)
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000184ff0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000185330</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc000184ff0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000184ff0</span> 
</code></pre></div><ul>
<li>json序列化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepcopyByJsonExample</span>() {
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: <span style="color:#a6e22e">players</span>}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepCopyByJson</span>(<span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">argentina</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;deepcopy error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByJson</span>(<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">dst</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tmp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">tmp</span>, <span style="color:#a6e22e">dst</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000041490</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
</code></pre></div><p>可以看到deepcopy出来的指针地址不一样，那么都dst的修改就不会影响到src了。</p>
<h4 id="方法二使用第三方工具库">方法二：使用第三方工具库</h4>
<p>DeepCopy对事物进行深度复制:未导出的字段值不会被复制。
feature:</p>
<ul>
<li>copy slice</li>
<li>copy map</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyExample</span>() {
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})}
	<span style="color:#a6e22e">argentinaIfc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepcopy</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">brazil</span>)
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">argentinaIfc</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000041330</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
</code></pre></div><h3 id="小结">小结</h3>
<p>浅拷贝是值的拷贝，如果属性是引用，拷贝的就是内存地址，需要使用深拷贝。深拷贝的实现原理本质上是通过反射实现。通过将源对象转换成接口，再对接口通过反射判断其类型。所以可以通过序列化成gob、json等来实现。工具库mohae/deepcopy可以对切片、map、结构体、接口进行深拷贝，是个不错的选择。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/mohae/deepcopy">modae/deepcopy</a></li>
<li><a href="https://juejin.cn/post/7143030425839992863">modae/deepcopy实现原理分析</a></li>
<li><a href="https://juejin.cn/post/7143030425839992863">go深拷贝常见方式及性能</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/12/go%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/go%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7-%E7%BB%98%E5%88%B6%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E5%92%8C%E4%BE%9D%E8%B5%96/" aria-label="">
      
          Go可视化工具 绘制项目代码结构和依赖
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-27T12:24:50&#43;08:00">
        
   27, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>比较常见pprof 可以把调用栈可视化成调用图，embedded-struct-visualizer 可以把Go 的项目的代码分层结构和依赖都可视化成流程图。</p>
<h3 id="安装-embedded-struct-visualizer">安装 embedded-struct-visualizer</h3>
<pre tabindex="0"><code> go install github.com/davidschlachter/embedded-struct-visualizer@latest
</code></pre><p>查看命令选项参数</p>
<pre tabindex="0"><code>embedded-struct-visualizer -h
Usage: [OPTIONS] DirToScan
If the directory to scan is not provided, it defaults to './'
OPTIONS:
  -out &lt;file&gt;  path to output file (default: write to stdout)
  -v           verbose logging
</code></pre><h3 id="example">Example</h3>
<p>以官方给的例子 main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">A</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">B</span>
	<span style="color:#a6e22e">C</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">D</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">E</span>, <span style="color:#a6e22e">F</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">G</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Timer</span> <span style="color:#a6e22e">H</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">D</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">I</span> <span style="color:#66d9ef">uint64</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">H</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Timer</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Ticker</span>
	<span style="color:#a6e22e">J</span>     <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">D</span>
}

</code></pre></div><p><strong>生成结构关系：</strong></p>
<pre tabindex="0"><code>&gt; embedded-struct-visualizer
digraph {
&quot;main.A&quot; -&gt; { &quot;main.B&quot; &quot;main.D&quot; };
&quot;main.B&quot; -&gt; { &quot;main.H&quot; };
&quot;main.H&quot; -&gt; { &quot;time.Ticker&quot; &quot;main.D&quot; };
}

</code></pre><p><strong>生成结构关系 并 输出到.gv 文件：</strong></p>
<pre tabindex="0"><code>&gt;embedded-struct-visualizer -out .\example.gv
&gt; ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        2022/11/27     10:54            112 example.gv
-a----        2022/11/26     22:06             31 go.mod
-a----        2022/11/26     22:07            208 main.go

</code></pre><p>项目目录下多出了example.gv ,具体内容如下</p>
<pre tabindex="0"><code>cat .\example.gv
digraph {
&quot;main.A&quot; -&gt; { &quot;main.B&quot; &quot;main.D&quot; };
&quot;main.B&quot; -&gt; { &quot;main.H&quot; };
&quot;main.H&quot; -&gt; { &quot;time.Ticker&quot; &quot;main.D&quot; };
</code></pre><h3 id="安装-graphviz">安装 graphviz </h3>
<blockquote>
<p>graphviz 是一种将结构信息表示为抽象图和网络的图的工具。</p>
</blockquote>
<p>接着，把生成的gv文件利用graphviz绘制的更美观。</p>
<p>首先下载安装:</p>
<blockquote>
<p><a href="https://graphviz.org/download/">https://graphviz.org/download/</a>
查看是否安装成功（Win）：</p>
</blockquote>
<pre tabindex="0"><code> dot -v
dot - graphviz version 7.0.2 (20221119.0110)
... &lt;为了不篇幅过长，省略一些细节&gt;
</code></pre><h3 id="利用graphviz绘图">利用graphviz绘图</h3>
<blockquote>
<p>dot  -Tformat[:renderer[:formatter]] -o 
将输出语言设置为支持的格式之一。默认情况下，生成带属性的点。</p>
</blockquote>
<p>接着把上一步生成的gv文件，生成PNG输出</p>
<pre tabindex="0"><code>dot -Tpng example.gv -o example.png
</code></pre><p>在项目目录下多出example.png
<img src="https://luckytking.github.io/images/embedded-struct-visualizer1.png" alt=""></p>
<p>接着，实用于一个相对复杂的Gin Engine的gv</p>
<ol>
<li>
<p>源码链接： <a href="https://github.com/gin-gonic/gin/blob/master/gin.go">https://github.com/gin-gonic/gin/blob/master/gin.go</a></p>
</li>
<li>
<p>生成的gv：</p>
</li>
</ol>
<pre tabindex="0"><code>embedded-struct-visualizer -out .\gin.gv
</code></pre><p>gin.gv 详细如下：</p>
<pre tabindex="0"><code class="language-gin.gv" data-lang="gin.gv">digraph {&quot;gin.mockWriter&quot; -&gt; { &quot;http.Header&quot; };&quot;binding.QueryTest&quot; -&gt; { &quot;binding.appkey&quot; };&quot;binding.FooBarStruct&quot; -&gt; { &quot;binding.FooStruct&quot; };&quot;binding.FooBarFileStruct&quot; -&gt; { &quot;binding.FooBarStruct&quot; 
&quot;multipart.FileHeader&quot; };&quot;binding.FooBarFileFailStruct&quot; -&gt; { &quot;binding.FooBarStruct&quot; 
&quot;multipart.FileHeader&quot; };&quot;binding.FooDefaultBarStruct&quot; -&gt; { &quot;binding.FooStruct&quot; };&quot;binding.FooStructUseNumber&quot; -&gt; { &quot;binding.any&quot; };&quot;binding.FooStructDisallowUnknownFields&quot; -&gt; { &quot;binding.any&quot; 
};&quot;binding.FooBarStructForTimeType&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeNotUnixFormat&quot; -&gt; { &quot;time.Time&quot; 
};&quot;binding.FooStructForTimeTypeNotFormat&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeFailFormat&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeFailLocation&quot; -&gt; { &quot;time.Time&quot; 
};&quot;binding.FooStructForMapType&quot; -&gt; { &quot;binding.any&quot; };&quot;binding.FooStructForIgnoreFormTag&quot; -&gt; { &quot;binding.string&quot; };&quot;binding.defaultValidator&quot; -&gt; { &quot;sync.Once&quot; 
&quot;validator.Validate&quot; };&quot;binding.structFull&quot; -&gt; { &quot;binding.&quot; &quot;time.Time&quot; 
&quot;binding.string&quot; };&quot;binding.S&quot; -&gt; { &quot;binding.S&quot; };&quot;binding.testFile&quot; -&gt; { &quot;binding.byte&quot; };&quot;binding.structNoValidationValues&quot; -&gt; { 
&quot;binding.substructNoValidation&quot; &quot;binding.int16&quot; 
&quot;binding.uint16&quot; &quot;time.Time&quot; &quot;binding.mapNoValidationSub&quot; 
&quot;binding.&quot; };&quot;binding.structNoValidationPointer&quot; -&gt; { 
&quot;binding.substructNoValidation&quot; &quot;binding.uint32&quot; 
&quot;binding.mapNoValidationSub&quot; &quot;binding.int8&quot; &quot;binding.int32&quot; 
&quot;binding.uint8&quot; &quot;binding.uint16&quot; &quot;binding.float64&quot; 
&quot;binding.map&quot; &quot;binding.int&quot; &quot;binding.int16&quot; &quot;binding.int64&quot; 
&quot;binding.float32&quot; &quot;time.Time&quot; &quot;binding.testInterface&quot; 
&quot;binding.uint&quot; &quot;binding.uint64&quot; &quot;binding.string&quot; };&quot;gin.Context&quot; -&gt; { &quot;url.Values&quot; &quot;gin.responseWriter&quot; 
&quot;gin.HandlersChain&quot; &quot;gin.any&quot; &quot;gin.errorMsgs&quot; 
&quot;gin.skippedNode&quot; &quot;sync.RWMutex&quot; &quot;gin.string&quot; 
&quot;http.SameSite&quot; &quot;http.Request&quot; &quot;gin.ResponseWriter&quot; 
&quot;gin.Params&quot; &quot;gin.Engine&quot; };&quot;gin.interceptedWriter&quot; -&gt; { &quot;gin.ResponseWriter&quot; 
&quot;bytes.Buffer&quot; };&quot;gin.Error&quot; -&gt; { &quot;gin.error&quot; &quot;gin.ErrorType&quot; &quot;gin.any&quot; };&quot;gin.onlyFilesFS&quot; -&gt; { &quot;http.FileSystem&quot; };&quot;gin.neuteredReaddirFile&quot; -&gt; { &quot;http.File&quot; };&quot;gin.RouteInfo&quot; -&gt; { &quot;gin.HandlerFunc&quot; };&quot;gin.Engine&quot; -&gt; { &quot;gin.RouterGroup&quot; &quot;gin.string&quot; 
&quot;render.HTMLRender&quot; &quot;gin.HandlersChain&quot; &quot;sync.Pool&quot; 
&quot;gin.methodTrees&quot; &quot;render.Delims&quot; &quot;template.FuncMap&quot; 
&quot;gin.uint16&quot; &quot;net.IPNet&quot; };&quot;gin.LoggerConfig&quot; -&gt; { &quot;gin.LogFormatter&quot; &quot;io.Writer&quot; 
&quot;gin.string&quot; };&quot;gin.LogFormatterParams&quot; -&gt; { &quot;http.Request&quot; &quot;time.Time&quot; 
&quot;time.Duration&quot; &quot;gin.any&quot; };&quot;render.Data&quot; -&gt; { &quot;render.byte&quot; };&quot;render.HTMLProduction&quot; -&gt; { &quot;template.Template&quot; 
&quot;render.Delims&quot; };&quot;render.HTMLDebug&quot; -&gt; { &quot;render.string&quot; &quot;render.Delims&quot; 
&quot;template.FuncMap&quot; };&quot;render.HTML&quot; -&gt; { &quot;template.Template&quot; &quot;render.any&quot; };&quot;render.JSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.IndentedJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.SecureJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.JsonpJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.AsciiJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.PureJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.MsgPack&quot; -&gt; { &quot;render.any&quot; };&quot;render.ProtoBuf&quot; -&gt; { &quot;render.any&quot; };&quot;render.Reader&quot; -&gt; { &quot;io.Reader&quot; };&quot;render.Redirect&quot; -&gt; { &quot;http.Request&quot; };&quot;render.String&quot; -&gt; { &quot;render.any&quot; };&quot;render.TOML&quot; -&gt; { &quot;render.any&quot; };&quot;render.XML&quot; -&gt; { &quot;render.any&quot; };&quot;render.YAML&quot; -&gt; { &quot;render.any&quot; };&quot;gin.responseWriter&quot; -&gt; { &quot;http.ResponseWriter&quot; };&quot;gin.RouterGroup&quot; -&gt; { &quot;gin.HandlersChain&quot; &quot;gin.Engine&quot; };&quot;protoexample.Test&quot; -&gt; { &quot;protoexample.int32&quot; 
&quot;protoexample.int64&quot; &quot;protoexample.TestOptionalGroup&quot; 
&quot;protoimpl.MessageState&quot; &quot;protoimpl.SizeCache&quot; 
&quot;protoimpl.UnknownFields&quot; &quot;protoexample.string&quot; };&quot;protoexample.Test_OptionalGroup&quot; -&gt; { 
&quot;protoimpl.MessageState&quot; &quot;protoimpl.SizeCache&quot; 
&quot;protoimpl.UnknownFields&quot; &quot;protoexample.string&quot; };&quot;gin.methodTree&quot; -&gt; { &quot;gin.node&quot; };&quot;gin.node&quot; -&gt; { &quot;gin.node&quot; &quot;gin.HandlersChain&quot; 
&quot;gin.nodeType&quot; };&quot;gin.nodeValue&quot; -&gt; { &quot;gin.HandlersChain&quot; &quot;gin.Params&quot; };&quot;gin.skippedNode&quot; -&gt; { &quot;gin.node&quot; &quot;gin.int16&quot; };}


</code></pre><ol start="3">
<li>绘制png</li>
</ol>
<pre tabindex="0"><code> dot -Tpng gin.gv -o gin.png
</code></pre><p><img src="https://luckytking.github.io/images/embedded-struct-visualizer-gin.png" alt="">
&lt;ps： 图片过大可下载预览&gt;</p>
<ul>
<li>graphviz guide优化: <a href="https://www.graphviz.org/pdf/dotguide.pdf">https://www.graphviz.org/pdf/dotguide.pdf</a></li>
</ul>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/davidschlachter/embedded-struct-visualizer">https://github.com/davidschlachter/embedded-struct-visualizer</a></li>
<li><a href="https://mp.weixin.qq.com/s/VGotQkmlnqFDNhmKuEBhwg">https://mp.weixin.qq.com/s/VGotQkmlnqFDNhmKuEBhwg</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/go%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7-%E7%BB%98%E5%88%B6%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E5%92%8C%E4%BE%9D%E8%B5%96/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" aria-label="">
      
          Golang使用RedisSortSets实现排行榜
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-30T15:43:28&#43;08:00">
        
   30, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="前言">前言</h3>
<p>游戏排行榜是一个常见需求，今天主要介绍go语言使用redis-sort-sets来实现排行榜常见功能。</p>
<h3 id="redis-sort-sets">Redis Sort Sets</h3>
<p>官方介绍：</p>
<blockquote>
<p>Redis排序集是按相关分数排序的惟一字符串(成员)的集合。当多个字符串具有相同的分数时，字符串将按字典顺序排列。排序集的一些用例包括:</p>
<p>游戏排行榜。例如，您可以使用排序集轻松地维护大型在线游戏中最高分数的有序列表。
速率限制器。特别是，您可以使用一个排序集来构建滑动窗口速率限制器，以防止过多的API请求。</p>
</blockquote>
<p>常用于排行榜的命令:</p>
<ul>
<li>ZRANGE 返回排序集的成员（升序）</li>
<li>ZREVANGE 返回排序集的成员（降序序）</li>
<li>ZADD 向排序集添加一个新成员和相关分数。如果成员已经存在，则更新评分。</li>
<li>ZREM 删除排序集一个成员</li>
<li>ZRANK 返回提供的成员的排名(升序)</li>
<li>ZREVRANK 返回提供的成员的排名(降序)</li>
</ul>
<h3 id="go-redis">Go Redis</h3>
<p>Go Redis为各种风格的Redis提供Go客户端，基础的使用例子如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	})
	<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
}
</code></pre></div><h3 id="examples">Examples</h3>
<p>这里我们用go-redis实现排行榜常见的功能，包括:</p>
<ul>
<li>获取排行榜成员和分数 （升序、降序）</li>
<li>加入排行榜成员</li>
<li>删除排行榜成员</li>
<li>更新排行榜成员分数</li>
<li>获取排行榜成员分数</li>
<li>获取排行榜名次成员</li>
<li>清空排行榜</li>
</ul>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	}) 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//增加玩家分数的变化
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
			<span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>)),
			<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">i</span>),
		}).<span style="color:#a6e22e">Err</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersWithScore</span>)

	<span style="color:#75715e">//查询排行榜成员-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRev</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-降序&#34;</span>, <span style="color:#a6e22e">membersRev</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//获取某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">user2Score</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZScore</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;获取某玩家 user:2 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//更新某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
		<span style="color:#a6e22e">Score</span>:  <span style="color:#a6e22e">user2Score</span>,
		<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:1&#34;</span>,
	}).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;更新某玩家 user:1 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜变化后的排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家  user:2 的排名&#34;</span>, <span style="color:#a6e22e">memberRank</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRevRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家 user:2 的排名-降序&#34;</span>, <span style="color:#a6e22e">memberRevRank</span>)

	<span style="color:#75715e">//删除排序集一个成员
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">zrem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRem</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:1&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除排序集一个成员&#34;</span>, <span style="color:#a6e22e">zrem</span>)

	<span style="color:#75715e">//删除后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)

	<span style="color:#75715e">//清空排行榜
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clear</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRemRangeByRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;err zrem&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空排行榜&#34;</span>, <span style="color:#a6e22e">clear</span>)
	<span style="color:#75715e">//清空后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>) 

</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>查询排行榜成员-升序 [user:3 user:4 user:1 user:5 user:2]
查询排行榜成员和分数-升序 [{87 user:2} {81 user:5} {81 user:1} {59 user:4} {47 user:3}]
查询排行榜成员-降序 [user:2 user:5 user:1 user:4 user:3]
查询排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:1} {81 user:5} {87 user:2}]
获取某玩家 user:2 的分数 87
更新某玩家 user:1 的分数 87
查询排行榜变化后的排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:5} {87 user:1} {87 user:2}]
查询排行榜某玩家  user:2 的排名 4
查询排行榜某玩家 user:2 的排名-降序 0
删除排序集一个成员 1
删除后查询排行榜成员-升序 [user:3 user:4 user:5 user:2]
清空排行榜 4
清空后查询排行榜成员-升序 []

</code></pre><h3 id="参考">参考</h3>
<ul>
<li>安装Redis <a href="https://redis.io/docs/getting-started/installation/">https://redis.io/docs/getting-started/installation/</a></li>
<li>Redis Sort Sets Docs <a href="https://redis.io/docs/data-types/sorted-sets/">https://redis.io/docs/data-types/sorted-sets/</a></li>
<li>Go Redis <a href="https://github.com/go-redis/redis/v9">https://github.com/go-redis/redis/v9</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" aria-label="">
      
          Go开发常用第三方库之ants
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-21T23:17:35&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>go语言提供非常方便的创建轻量级的协程goroutine来并发处理任务，但是 协程过多影响程序性能，所以，这时goroutine池就登场了。本文简要介绍ants goroutine 池的基本的使用方法。</p>
<h3 id="简介">简介</h3>
<p>ants是一个高性能的 goroutine 池，实现了对大规模 goroutine 的调度管理、goroutine 复用，允许使用者在开发并发程序的时候限制 goroutine 数量，复用资源，达到更高效执行任务的效果。 ants就是一个很多大厂广泛使用的goroute池。</p>
<p>官网地址</p>
<blockquote>
<p><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></p>
</blockquote>
<h3 id="功能">功能</h3>
<ul>
<li>自动调度海量的 goroutines，复用 goroutines</li>
<li>定期清理过期的 goroutines，进一步节省资源</li>
<li>提供了大量有用的接口：任务提交、获取运行中的 goroutine 数量、动态调整 Pool 大小、释放 Pool、重启 Pool</li>
<li>优雅处理 panic，防止程序崩溃</li>
<li>资源复用，极大节省内存使用量；在大规模批量并发任务场景下比原生 goroutine 并发具有更高的性能</li>
<li>非阻塞机制</li>
</ul>
<h3 id="quick-start">quick start</h3>
<p>使用 ants v1 版本:</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants</p>
</blockquote>
<p>使用 ants v2 版本 (开启 GO111MODULE=on):</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants/v2</p>
</blockquote>
<p>接下来看一下官方demo：实现一个计算大量整数和的程序</p>
<h3 id="newpool">NewPool</h3>
<p>NewPool生成ants池实例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoFunc</span>() {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()

	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>

	<span style="color:#75715e">//使用公共池。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#a6e22e">syncCalculateSum</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">demoFunc</span>()
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">syncCalculateSum</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Running</span>())
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks.\n&#34;</span>)
 }
</code></pre></div><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPool(size int,  options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.size  即池容量，即池中最多有 10 个 goroutine。
arg.Option  定制化 goroutine pool.</p>
</blockquote>
<ul>
<li>p.Submit向此池提交任务。</li>
<li>ants.Release关闭此池并释放工作队列。</li>
<li>defaultAntsPool 导入ants时初始化实例池。</li>
</ul>
<h3 id="newpoolwithfunc">NewPoolWithFunc</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#75715e">//使用带有函数的池
</span><span style="color:#75715e">//设置goroutine池的容量为10，过期时间为1秒。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	})
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#75715e">//逐个提交任务。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Invoke</span>(int32(<span style="color:#a6e22e">i</span>))
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks, result is %d\n&#34;</span>, <span style="color:#a6e22e">sum</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code class="language-shelll" data-lang="shelll">run with 1
run with 5
run with 11
run with 12
run with 13
run with 14
run with 7
...
run with 789
run with 809
running goroutines: 10
finish all tasks, result is 499500
</code></pre><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPoolWithFunc(size int, pf func(interface{}), options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.pf  即为执行任务的函数</p>
</blockquote>
<h3 id="优雅处理-panic">优雅处理 panic</h3>
<p>测试一些当任务触发panic的情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;panic from task:%d&#34;</span>, <span style="color:#a6e22e">n</span>)))
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}
</code></pre></div><p>output：</p>
<pre tabindex="0"><code>run with 3
run with 13
...
run with 999
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:6
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:0
2022/10/21 21:41:07 worker with func exits from panic: goroutine 14 [running]:
</code></pre><p>可以看到，main routine 没有因此受影响。</p>
<h3 id="options">Options</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Options包含实例化ants池时将应用的所有选项。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ExpiryDuration is a period for the scavenger goroutine to clean up those expired workers,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the scavenger scans all workers every `ExpiryDuration` and clean up those workers that haven&#39;t been
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used for more than `ExpiryDuration`.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExpiryDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#75715e">// PreAlloc indicates whether to make memory pre-allocation when initializing Pool.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreAlloc</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Max number of goroutine blocking on pool.Submit.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 0 (default value) means no such limit.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxBlockingTasks</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// When Nonblocking is true, Pool.Submit will never be blocked.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ErrPoolOverload will be returned when Pool.Submit cannot be done at once.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// When Nonblocking is true, MaxBlockingTasks is inoperative.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Nonblocking</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// PanicHandler is used to handle panics from each worker goroutine.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if nil, panics will be thrown out again from worker goroutines.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicHandler</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// Logger is the customized logger for logging info, if it is not set,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// default standard logger from log package is used.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">Logger</span>
}
</code></pre></div><p>比如 PanicHandler 遇到 panic会调用这里设置的处理函数,以上例中，我们遇到偶数会触发panic，修改NewPool函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">WithPanicHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;panic recover %v&#34;</span>, <span style="color:#a6e22e">i</span>)
	}))
</code></pre></div><p>out：</p>
<pre tabindex="0"><code>panic recover panic from i:992run with 880
panic recover panic from i:880run with 972
panic recover panic from i:972run with 994
run with 991
</code></pre><p>还有更多关于 Benchmarks 性能报告，可参考https://github.com/panjf2000/ants</p>
<h3 id="参考">参考：</h3>
<ul>
<li><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></li>
<li><a href="https://darjun.github.io/2021/06/03/godailylib/ants/">https://darjun.github.io/2021/06/03/godailylib/ants/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" aria-label="">
      
          浅谈kratos的表现层源码实现与解码器
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-02T17:25:55&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前后端数据常用传输格式有：json、xml 和 proto等，不管是mvc还是ddd，都会在表现层的对不同的格式进行转化下层依赖所需的类、Object、 aggregate等。</p>
<h2 id="kratos-表现层">Kratos 表现层</h2>
<p>在实际开发场景中，前后端传输采用json。 但kratos使用proto定义Api， 那么我们以一个Http请求为例，来看看kratos的表现层是如何处理的。</p>
<p>以下是一个Kratos-Example，由编写好的proto文件，proto-go 等自动生成表现层的代码。 大概步骤：</p>
<ol>
<li>编写proto，包括Service，Req，Reply</li>
<li>生成表现层代码</li>
<li>实现下层逻辑等</li>
</ol>
<p>Example完整代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>可以看到：</p>
<ol>
<li>这里对具体的格式无感，输入In还是输出Out都是一个proto生成的类。</li>
<li>具体的实现交给了ctx 上下文去实现
查看 ctx.Result的源码:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Result</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">code</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">enc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">v</span>)
}
</code></pre></div><p>这里的enc，没有特殊设置，使用默认的DefaultResponseEncoder，部分源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultResponseEncoder</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CodecForRequest</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;Accept&#34;</span>)
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ContentType</span>(<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Name</span>()))
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>通过codc接口隔离具体实现，调用接口的 codec.Marshal序列化。</p>
<h2 id="codec包">codec包</h2>
<p>Codec定义Transport用于编码和解码消息的接口。它的实现包括 json，xml，proto，yaml等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Codec</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Marshal returns the wire format of v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">// Unmarshal parses the wire format into v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">// Name returns the name of the Codec implementation. The returned string
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will be used as part of content type in transmission.  The result must be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// static; the result cannot change between calls.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>这里我们聚焦正在使用的Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">codec</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">codec</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshaler</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MarshalJSON</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	}
}
</code></pre></div><p>这里Marshal()使用第三方库“&ldquo;google.golang.org/protobuf/encoding/protojson&rdquo;</p>
<p>实现proto转json。</p>
<h2 id="protojson第三方包">protojson第三方包</h2>
<p>protojson是Google提供的proto和json的转化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">api_test</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;google.golang.org/protobuf/encoding/protojson&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;helloworld/api/helloworld/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestToJson</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">HelloReply</span>{
		<span style="color:#a6e22e">Message</span>: <span style="color:#e6db74">&#34;Jobs&#34;</span>,
	}
	<span style="color:#a6e22e">replyJson</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">ProtoReflect</span>().<span style="color:#a6e22e">Interface</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Marshal Error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;replyJson:  %v&#34;</span>, string(<span style="color:#a6e22e">replyJson</span>))
}
</code></pre></div><p>更多的接口请参考“https://google.golang.org/protobuf/encoding/protojson”</p>
<h2 id="小结">小结</h2>
<p>本文主要以kratos的表现层的组织方式，来介绍常用的框架表现层处理方式。
其中：</p>
<ul>
<li>kratos通过proto来生成表现层代码的类，包括http和grapc，内部对具体实现无感。</li>
<li>kratos通过解码器codec实现不同传输格式的解耦。</li>
<li>第三方包protojson实现proto和json转换。</li>
</ul>
<p>框架的主要功能之一就是标准化处理一下公共的问题场景,从源码中可以学习：通过接口隔离具体的实现，而使框架与具体实现解耦,且具备更好的拓展性。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://go-kratos.dev/docs/getting-started/usage">https://go-kratos.dev/docs/getting-started/usage</a></li>
<li><a href="https://google.golang.org/protobuf/encoding/protojson">https://google.golang.org/protobuf/encoding/protojson</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/08/go%E8%AF%BB%E5%86%99csv%E6%96%87%E4%BB%B6/" aria-label="">
      
          Go读写Csv文件
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-08-21T17:01:48&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍go如何读取和写入csv文件，以及使用第三方库gocsv转换为Struct。</p>
<h3 id="读取csv">读取csv</h3>
<p>go 标准库 &ldquo;encoding/csv&rdquo; 用于读写csv文件。</p>
<p>Reader从csv编码的文件中读取记录</p>
<ul>
<li>type Reader
<ul>
<li>func NewReader(r io.Reader) *Reader</li>
<li>func (r *Reader) Read() (record []string, err error) 。</li>
<li>func (r *Reader) ReadAll() (records [][]string, err error)</li>
</ul>
</li>
</ul>
<p>创建一个csv文件servers.csv,具体如下</p>
<pre tabindex="0"><code class="language-csv" data-lang="csv">world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><p>ReadAll从r中读取所有剩余的记录，每个记录都是字段的切片，成功的调用返回值err为nil而不是EOF。因为ReadAll方法定义为读取直到文件结尾，因此它不会将文件结尾视为应该报告的错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/csv&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">readeCsvAll</span>() 
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readerCsvReadAll</span>() {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;servers.csv&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">servers</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadAll</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;ReadAll:&#34;</span>, <span style="color:#a6e22e">servers</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>ReadAll:  [world-svc 1/1 Running 0 44m] [battle-svc 1/1 Running 0 7d]]
</code></pre><p>Read从r读取一条记录，返回值record是字符串的切片，每个字符串代表一个字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
<span style="color:#66d9ef">for</span> {
    <span style="color:#a6e22e">servers</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Read</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
        <span style="color:#66d9ef">break</span>
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error:&#34;</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">servers</span>)
}
</code></pre></div><p>输出和ReadAll是一样的。</p>
<p>csv读写逗号分隔值（csv）的文件，亦或可以定义数据的分隔符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Comma</span> = <span style="color:#e6db74">&#39;|&#39;</span> 
</code></pre></div><p>亦或可以定义忽略的的行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Comment</span> = <span style="color:#e6db74">&#39;#&#39;</span>
</code></pre></div><h3 id="写入csv">写入csv</h3>
<p>Writer类型的值将记录写入一个csv编码的文件</p>
<ul>
<li>type Writer
<ul>
<li>func NewWriter(w io.Writer) *Writer</li>
<li>func (w *Writer) Write(record []string) (err error)</li>
<li>func (w *Writer) WriteAll(records [][]string) (err error)</li>
<li>func (w *Writer) Flush()</li>
<li>func (w *Writer) Error() error</li>
</ul>
</li>
</ul>
<p>向w中写入一条记录，会自行添加必需的引号。记录是字符串切片，每个字符串代表一个字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writerOne</span>() {
	<span style="color:#a6e22e">servers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">Server</span>{
		{<span style="color:#e6db74">&#34;world-svc&#34;</span>, <span style="color:#e6db74">&#34;1/1&#34;</span>, <span style="color:#e6db74">&#34;Running&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;44m&#34;</span>},
		{<span style="color:#e6db74">&#34;battle-svc&#34;</span>, <span style="color:#e6db74">&#34;1/1&#34;</span>, <span style="color:#e6db74">&#34;Running&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;7d&#34;</span>},
	}
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;serversA.csv&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;failed to open file&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">file</span>)
   <span style="color:#75715e">//将缓存中的数据写入底层的io.Writer。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Flush</span>()
	<span style="color:#75715e">// 使用 Write
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Ready</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Restarts</span>), <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Age</span>}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">row</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;error writing server to file&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
	}

</code></pre></div><p>执行，在当前目录生成 serversA.csv,内容如下：</p>
<pre tabindex="0"><code>world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><p>WriteAll方法使用Write方法向w写入多条记录，并在最后调用Flush方法清空缓存</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">string</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Ready</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Restarts</span>), <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Age</span>}
		<span style="color:#a6e22e">data</span> = append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">row</span>)
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteAll</span>(<span style="color:#a6e22e">data</span>)

</code></pre></div><h3 id="to-struct">To Struct</h3>
<p>GoCSV包旨在提供 CSV 和 Go (golang) 值之间的快速和惯用的映射。
已有servers.csv 内容如下</p>
<pre tabindex="0"><code>Name,Ready,Status,Restart,Age
world-svc,1/1,Running,0,44m
battle-svc,1/1,Running,0,7d
</code></pre><blockquote>
<p>UnmarshalFile(in *os.File, out interface{}) error 
UnmarshalFile从接口中的文件解析CSV。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ToStruct</span>() {
	<span style="color:#a6e22e">clientsFile</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;servers.csv&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_RDWR</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ModePerm</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">clientsFile</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">servers</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>
    <span style="color:#75715e">//转换成 Server Object
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gocsv</span>.<span style="color:#a6e22e">UnmarshalFile</span>(<span style="color:#a6e22e">clientsFile</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">servers</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">servers</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Server&#34;</span>, <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Name</span>)
	}
}
</code></pre></div><p>OuPut：</p>
<pre tabindex="0"><code>Server world-svc
Server battle-svc
</code></pre><p>更多api使用方式可参考：https ://github.com/gocarina/gocsv</p>
<h4 id="参考">参考</h4>
<ul>
<li><a href="https://pkg.go.dev/encoding/csv">https://pkg.go.dev/encoding/csv</a></li>
<li>https ://github.com/gocarina/gocsv</li>
<li><a href="https://medium.com/wesionary-team/read-and-write-csv-file-in-go-b445e34968e9">https://medium.com/wesionary-team/read-and-write-csv-file-in-go-b445e34968e9</a></li>
<li><a href="https://medium.com/wesionary-team/easy-working-with-csv-in-golang-using-gocsv-package-9c8424728bbe">https://medium.com/wesionary-team/easy-working-with-csv-in-golang-using-gocsv-package-9c8424728bbe</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/08/go%E8%AF%BB%E5%86%99csv%E6%96%87%E4%BB%B6/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/go%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" aria-label="">
      
          Go原子操作
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-23T22:51:37&#43;08:00">
        
   23, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="原子操作">原子操作</h3>
<blockquote>
<p>原子操作即执行过程不能被中断的操作。在针对某个值的原子操作执行过程当值，cpu绝不会再去执行其他针对该值的操作，无论这些其他操作是否为原子操作。</p>
</blockquote>
<h3 id="go-atomic">go-atomic</h3>
<p>查看Mutex、RWMutex的源码，底层是通过atomic包中的一些原子操作来实现。</p>
<p>Go标准库 sync/atomic 提供了对基础类型 int32、int64、uint32、uint64、uintptr、Pointer（Add 方法不支持） 的原子级内存操作。其中包括：</p>
<ul>
<li>Add （给第一个参数地址中的值增加一个 delta 值）</li>
<li>CompareAndSwap（判断相等即替换)）</li>
<li>Swap（不需要比较旧值，直接替换，返回旧值）</li>
<li>Load（方法会取出 addr 地址中的值）</li>
<li>Store（ 方法会把一个值存入到指定的 addr 地址中）</li>
</ul>
<p>我们通过一个例子可以快速了解atomic封装的这些api</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">0</span>

	<span style="color:#75715e">//func AddInt32(addr *int32, delta int32) (new int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">1</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;x=%d,y=%d \n&#34;</span>, <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
	<span style="color:#75715e">//OutPut: x=1,y=1
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// addr 地址里的值是不是 old，如果不等于 old，就返回 false；如果等于 old，就把此地址的值替换成 new 值，返回 true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isCompare</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">0</span>), int32(<span style="color:#ae81ff">2</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;isCompare=%v,x=%d  \n&#34;</span>, <span style="color:#a6e22e">isCompare</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: isCompare=false,x=1
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//不相等，故x还是1
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isCompare2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">1</span>), int32(<span style="color:#ae81ff">2</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;isCompare=%v,x=%d  \n&#34;</span>, <span style="color:#a6e22e">isCompare2</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: isCompare=true,x=2
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//相等，故x还是2
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func SwapInt32(addr *int32, new int32) (old int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">xOld</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">SwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, int32(<span style="color:#ae81ff">3</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;xOld=%d,x=%d  \n&#34;</span>, <span style="color:#a6e22e">xOld</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#75715e">//OutPut: xOld=2,x=3
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//不比较，故x替换3
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func LoadInt32(addr *int32) (val int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">vValue</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;vValue=%d \n&#34;</span>, <span style="color:#a6e22e">vValue</span>)
	<span style="color:#75715e">//OutPut: xOld=2,x=3
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//获取x的值3
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//func StoreInt32(addr *int32, val int32)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">StoreInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, <span style="color:#ae81ff">8</span>)
	<span style="color:#a6e22e">vValue2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;vValue2=%d \n&#34;</span>, <span style="color:#a6e22e">vValue2</span>)
	<span style="color:#75715e">//OutPut:vValue2=8 
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="小试牛刀">小试牛刀</h3>
<p>atomic 比较常见的类型 还提供了一个特殊的类型：Value，但是只支持  load、store。
这里模拟一个场景：当配置变更后，期待其他goroutine可以收到通知和变更。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Network</span>      <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Addr</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">ReadTimeout</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">WriteTimeout</span> <span style="color:#66d9ef">int32</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">loadConfig</span>() <span style="color:#a6e22e">Config</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Network</span>:      <span style="color:#e6db74">&#34;redis&#34;</span>,
		<span style="color:#a6e22e">Addr</span>:         <span style="color:#e6db74">&#34;127.0.0.1:6379&#34;</span>,
		<span style="color:#a6e22e">ReadTimeout</span>:  <span style="color:#ae81ff">60</span>,
		<span style="color:#a6e22e">WriteTimeout</span>: <span style="color:#ae81ff">60</span>,
	}
}

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">done</span>   <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">config</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">loadConfig</span>())
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cond</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>{})
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">beginLoad</span>(<span style="color:#a6e22e">cond</span>)
	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">beginLoad</span>(<span style="color:#a6e22e">cond</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">loadConfig</span>())
		<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Broadcast</span>()
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">waitForLoad</span>(<span style="color:#a6e22e">node</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">cond</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">L</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">done</span> {
			<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
		}
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">Config</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;node: %d - redis config: %+v\n&#34;</span>, <span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">c</span>)

	}
	<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">L</span>.<span style="color:#a6e22e">Unlock</span>()
}

</code></pre></div><p>OutPut：</p>
<pre tabindex="0"><code>node: 2 - redis config: {Network:redis Addr:127.0.0.1:6379 ReadTimeout:60 WriteTimeout:60}
node: 1 - redis config: {Network:redis Addr:127.0.0.1:6379 ReadTimeout:60 WriteTimeout:60}
</code></pre><h3 id="uber-goatomic">uber-go/atomic</h3>
<p>uber-go/atomic对标准库进行进一步封装，采用面向对象的使用方式。
这些类型包括 Bool、Duration、Error、Float64、Int32、Int64、String、Uint32、Uint64 等
举个例子uint32的减法你可能是这么写的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddUint32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>, ^(<span style="color:#a6e22e">delta</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
</code></pre></div><p>利用计算机补码的规则，把减法变成加法 。uber-go对它进行了封装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">atom</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Uint32</span>
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#ae81ff">10</span>)
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#ae81ff">2</span>)
<span style="color:#a6e22e">atom</span>.<span style="color:#a6e22e">CAS</span>(<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">1</span>)
</code></pre></div><h3 id="小结">小结</h3>
<p>本文简要介绍原子操作和go-atomic，使用场景，以及第三库uber-go/atomic。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/uber-go/atomic">https://github.com/uber-go/atomic</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/go%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/go-corntab/" aria-label="">
      
          Go Corntab
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-17T18:44:07&#43;08:00">
        
   17, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍golang 使用crontab实现定时任务。</p>
<h3 id="linux-crontab">linux crontab</h3>
<p>Linux crontab 是用来定期执行程序的命令。当安装完成操作系统之后，默认便会启动此任务调度命令</p>
<p>命令语法：</p>
<blockquote>
</blockquote>
<p>crontab [ -u user ] file</p>
<p>crontab [ -u user ] { -l | -r | -e }</p>
<pre tabindex="0"><code>*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    +----- 星期中星期几 (0 - 6) (星期天 为0)
|    |    |    +---------- 月份 (1 - 12) 
|    |    +--------------- 一个月中的第几天 (1 - 31)
|    +-------------------- 小时 (0 - 23)
+------------------------- 分钟 (0 - 59)
</code></pre><h3 id="go-cron">go cron</h3>
<p>第三方包“github.com/robfig/cron”来创建 crontab，以实现定时任务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>()
		<span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * &#34;</span>
		<span style="color:#a6e22e">count</span> = <span style="color:#ae81ff">0</span>
	)

	<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;count: &#34;</span>, <span style="color:#a6e22e">count</span>,<span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>())
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error : %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">entityID</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">select</span> {}
}

</code></pre></div><p>go run main.go</p>
<p>输出：</p>
<pre tabindex="0"><code>count:  1 now: 1658053860
count:  2 now: 1658053920
count:  3 now: 1658053980
count:  4 now: 1658054040
count:  5 now: 1658054100

</code></pre><p>可以看到每隔1分钟，执行一次Func，count++</p>
<p>默认情况下标准 cron 规范解析（第一个字段是“分钟”)
可以轻松选择进入秒字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>())
<span style="color:#75715e">//注意这里多了一个参数
</span><span style="color:#75715e"></span><span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * * &#34;</span>
</code></pre></div><p>执行输出</p>
<pre tabindex="0"><code>count:  1 now: 1658053640
count:  2 now: 1658053642
count:  3 now: 1658053644
count:  4 now: 1658053646
count:  5 now: 1658053648 

</code></pre><p>可以看到每隔两秒执行一次</p>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/go-corntab/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" aria-label="">
      
          Redis实现对象存储和列表分页
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-05T16:23:04&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h2 id="场景">场景</h2>
<p>在项目开发中，需要用到缓存和对一个列表数据分页查询，但由于redis是key-value的存储方式，我们期望的使用类似postgresql的offset和limit，不至于需要一个个key遍历过去。</p>
<h2 id="设计">设计</h2>
<p>分析一下我们需求，那么需求需要实现的接口大概是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">FindByPage</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) ([]<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>大致我们需要解决两个问题:</p>
<ul>
<li>存储对象</li>
<li>列表分页快速查找</li>
</ul>
<h3 id="对象存储">对象存储</h3>
<blockquote>
<p>Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</p>
<ul>
<li>HDEL key field1 [field2]删除一个或多个哈希表字段</li>
<li>HEXISTS key field查看哈希表 key 中，指定的字段是否存在。</li>
<li>HGET key field获取存储在哈希表中指定字段的值。</li>
<li>HGETALL key获取在哈希表中指定 key 的所有字段和值</li>
</ul>
</blockquote>
<p>如此，我们可以 redis hash 和 json.Encoding 来存储。
获得一个Object</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//【ObjectID】= &#34;{&#34;foo&#34;: &#34;123&#34;, &#34;bar&#34;:&#34;456&#34;}&#34;
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span>  <span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>

<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HGet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>()).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">YourObject</span>{}
<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte(<span style="color:#a6e22e">result</span>), <span style="color:#a6e22e">obj</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><p>增加一个Object：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">ob</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">Object</span>{}<span style="color:#960050;background-color:#1e0010">）</span>) 
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HSet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">ob</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">ob</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
</code></pre></div><h3 id="分页">分页</h3>
<p>我们的需求中，ObjectID是一个唯一的int，那么可以使用 zset</p>
<blockquote>
<p>ZXyy redis 有序集合的基本命令。</p>
<ul>
<li>ZADD key score1 member1 [score2 member2]向有序集合添加一个或多个成员，或者更新已存在成员的分数</li>
<li>ZCARD key获取有序集合的成员数</li>
<li>ZRANGE key start stop [WITHSCORES]通过索引区间返回有序集合指定区间内的成员</li>
</ul>
</blockquote>
<p>那么可以把 zset 的key 和 value 都设置为 ObjectID
增加一个Object的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
     <span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>),
     <span style="color:#a6e22e">Member</span>: <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>)),
}).<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>获取X分页的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> (
     <span style="color:#a6e22e">start</span> = int64((<span style="color:#a6e22e">page</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">size</span>)
     <span style="color:#a6e22e">end</span>   = <span style="color:#a6e22e">start</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">size</span>)
)
<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">end</span>).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><h3 id="测试">测试</h3>
<p>我们增加N个Object：</p>
<pre tabindex="0"><code>[1 a]
[2 b]
[3 c]
[11 aa]
[12 bb]
[13 cc]
[21 aaaa]
</code></pre><p>每页的长度为4，获取第一页</p>
<pre tabindex="0"><code>[1 2 3 11]
</code></pre><p>第二页：</p>
<pre tabindex="0"><code>[12 13 21]
</code></pre><p>第三页：</p>
<pre tabindex="0"><code>[ ]
</code></pre><h4 id="参考">参考</h4>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1802288">https://cloud.tencent.com/developer/article/1802288</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" aria-label="">
      
          Go Copier简介
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-22T16:44:15&#43;08:00">
        
   22, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍 jinzhu/copier 的使用和常用场景</p>
<h2 id="简介">简介</h2>
<p>在go后端项目开发中，内部rpc服务返回的字段跟api服务相差无几，一个个赋值比较费事儿。那么就需要Object、List、HashMap 等进行值拷贝。jinzhu/copier即提供了这些场景的支持。</p>
<p><strong>copier 特性</strong>：</p>
<ul>
<li>从方法复制到具有相同名称的字段</li>
<li>从字段复制到具有相同名称的方法</li>
<li>从一个切片复制到另一个切片</li>
<li>从结构体复制到切片</li>
<li>从map复制到map</li>
<li>强制复制带有标记的字段</li>
<li>忽略带有标记的字段</li>
<li>深拷贝</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="copy-from-struct">Copy from struct</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/jinzhu/copier&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Role</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Age</span>          <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeCode</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// specify field name
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// Explicitly ignored in the destination struct.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//目标结构体中的标签提供了copy指令。复制忽略
</span><span style="color:#75715e">//或强制复制，如果字段没有被复制则惊慌或返回错误。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Employee</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//告诉copier。如果没有复制此字段，则复制到panic。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`copier:&#34;must&#34;`</span>

	<span style="color:#75715e">//告诉copier。 如果没有复制此字段，则返回错误。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Age</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`copier:&#34;must,nopanic&#34;`</span>

	<span style="color:#75715e">// 告诉copier。 显式忽略复制此字段。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`copier:&#34;-&#34;`</span>

	<span style="color:#a6e22e">DoubleAge</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeId</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// 指定字段名
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SuperRole</span>  <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyStruct</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">user</span>     = <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">200000</span>}
		<span style="color:#a6e22e">employee</span> = <span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">150000</span>}
	)
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employee</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employee</span>)
}
</code></pre></div><p>output：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">47</span>: <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">150000</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>} 

</code></pre></div><h3 id="copy-from-slice-to-slice">Copy from slice to slice</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopySlice</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">users</span>     = []<span style="color:#a6e22e">User</span>{{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">100000</span>}, {<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Dev&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">60000</span>}}
		<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	)
	<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employees</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employees</span>)
}<span style="color:#960050;background-color:#1e0010">`</span>

</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">57</span>: []<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>}, <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">60</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Dev&#34;</span>}} 

</code></pre></div><h3 id="copy-from-map-to-map">Copy from Map to Map</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyMap</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">// Copy map to map
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">map1</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">3</span>: <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>: <span style="color:#ae81ff">8</span>}
	<span style="color:#a6e22e">map2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">map2</span>, <span style="color:#a6e22e">map1</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">map2</span>)
}
</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">66</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">8</span>} 
</code></pre></div><h2 id="场景-1rpcapi">场景 1（rpc&amp;api）</h2>
<p>实际开发中，免不了服务间通讯，比较前文所说的场景，一个内部的rpc服务返回的参数和api服务差不多，那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//伪代码如下
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ApiLogin</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,<span style="color:#a6e22e">request</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>)(<span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)  {
	<span style="color:#a6e22e">grpcClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NewGameGrpcClient</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Login</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>{ 
					})
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>.<span style="color:#a6e22e">User</span>{}
 	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">User</span>())
<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginReply</span>{
	<span style="color:#a6e22e">User</span>:<span style="color:#a6e22e">user</span>,
},<span style="color:#a6e22e">err</span>

</code></pre></div><h2 id="场景-2-model-objectaggregate">场景 2 (model-object/aggregate)</h2>
<p>实际开发中，不管是mvc\ddd 都会有从model到object/aggreate的repository,那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserRepo</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">int64</span>) (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">model</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">uid</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">obj</span><span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
	copy(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">obj</span>,<span style="color:#a6e22e">model</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">obj</span>,<span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="小结">小结</h2>
<p>copier提供不同类型之间相同的字段名，使用tag或者方法支持不同的字段名的赋值。减少一些重复的工作量,小巧实用。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/jinzhu/copier">https://github.com/jinzhu/copier</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            
  <div class="pagination-bar">
    <ul class="pagination">
      
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/go/" aria-label="">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span></span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/go/page/3/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


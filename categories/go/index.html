<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/categories\/go\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="go">
<meta name="twitter:title" content="go">
<meta property="og:url" content="https://luckytking.github.io/categories/go/">
<meta property="twitter:url" content="https://luckytking.github.io/categories/go/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>go</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/categories/go/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/categories/go/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/go%E7%BB%98%E5%88%B6%E5%9B%BE%E8%A1%A8%E5%BA%93go-echarts/" aria-label="">
      
          Go绘制图表库go Echarts
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-30T18:48:38&#43;08:00">
        
   30, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="简介">简介</h3>
<p>ECharts是一款基于JavaScript的数据可视化图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。ECharts最初由百度团队开源，并于2018年初捐赠给Apache基金会，成为ASF孵化级项目。</p>
<p>在 Golang 这门语言中，目前数据可视化的第三方库还是特别少，go-echarts 的开发就是为了填补这部分的空隙。Apache ECharts 是非常优秀的可视化图表库，凭借着良好的交互性，精巧的图表设计，得到了众多开发者的认可。也有其他语言为其实现了相应语言版本的接口，如 Python 的 pyecharts，go-echarts 也是借鉴了 pyecharts 的一些设计思想。</p>
<p>特性</p>
<ul>
<li>简洁的 API 设计，使用如丝滑般流畅</li>
<li>囊括了 25+ 种常见图表，应有尽有</li>
<li>高度灵活的配置项，可轻松搭配出精美的图表</li>
<li>详细的文档和示例，帮助开发者更快的上手项目</li>
<li>多达 400+ 地图，为地理数据可视化提供强有力的支持</li>
</ul>
<h3 id="如何使用">如何使用</h3>
<p>1.安装go-echarts库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">go get -u github.com/go-echarts/go-echarts/v2
</code></pre></div><p>2.接着，我们来创建一个图表实例，绘制一个条形图，来演示如何使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>

	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
)

<span style="color:#75715e">// generate random data for bar chartg
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateBarItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个新的bar实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewBar</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first bar chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateBarItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateBarItems</span>())
	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;bar.html&#34;</span>)
	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">f</span>)
}

</code></pre></div><p>运行上例，会生成bar.html，详细：
<img src="https://luckytking.github.io/images/go-echars-1.png" alt=""></p>
<ol start="3">
<li>如果想把上例改成折线图呢</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#75715e">// generate random data for line chart
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateLineItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个折线图实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewLine</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first lines chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">SetSeriesOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithLineChartOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineChart</span>{<span style="color:#a6e22e">Smooth</span>: <span style="color:#66d9ef">true</span>}))

	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;lines.html&#34;</span>)
	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">f</span>)
}

</code></pre></div><p>运行上例，会生成lines.html，详细：</p>
<p><img src="https://luckytking.github.io/images/go-echars-2.png" alt=""></p>
<ol start="4">
<li>如果想直接生成图表的 http serve呢：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#75715e">// generate random data for line chart
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateLineItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">httpserver</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#75715e">//创建一个折线图实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewLine</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first lines chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">SetSeriesOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithLineChartOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineChart</span>{<span style="color:#a6e22e">Smooth</span>: <span style="color:#66d9ef">true</span>}))

	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">w</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">httpserver</span>)
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)
}
</code></pre></div><p>访问，http://localhost:8080/ ，详细如下
<img src="https://luckytking.github.io/images/go-echars-3.png" alt=""></p>
<h3 id="三总结">三、总结</h3>
<p>本文简要介绍go-echarts和使用方法，并通过绘制条形图、折线图和图表的http server 的例子演示了使用方法。更多功能待续。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="%C2%A0%C2%A0https://github.com/go-echarts/go-echarts">go-echarts</a></li>
<li><a href="%C2%A0https://github.com/go-echarts/examples">go-echarts/examples</a></li>
<li><a href="https://echrts.apache.org/zh/index.html">echrts</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/go%E7%BB%98%E5%88%B6%E5%9B%BE%E8%A1%A8%E5%BA%93go-echarts/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" aria-label="">
      
          Golang实现AES加解密
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-10T21:30:32&#43;08:00">
        
   10, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在数据的传输过程，为了安全，我们需要对其进行加密。加密算法分为双向加密和单向加密。单向加密包括MD5、SHA等摘要算法，它们是不可逆的。双向加密包括对称加密和非对称加密，对称加密包括AES加密、DES加密等。双向加密是可逆的，它使用相同的密钥进行加密和解密。本文主要介绍AES算法以及如何使用golang实现AES加解密。</p>
<h3 id="aes简介">AES简介</h3>
<blockquote>
<p>AES是高级加密标准，在密码学中又称Rijndael加密法，是美国联邦政府采用的一种区块加密标准。这个标准用来替代原先的DES，目前已经被全世界广泛使用，同时AES已经成为对称密钥加密中最流行的算法之一。AES支持三种长度的密钥：128位，192位，256位。</p>
</blockquote>
<p>加解密过程为：字节代替、行移位、列混淆、轮密钥加。</p>
<p>相关概念：</p>
<ol>
<li>
<p>密钥：AES128，AES192，AES256，实际上就是指的AES算法对不同长度密钥的使用</p>
</li>
<li>
<p>分组： 把明文拆分成一个个独立的明文块，每一个明文块长度128bit。加密生成一个个独立的密文块，这些密文块拼接在一起。填充模式有：</p>
<ol>
<li>NoPadding :不做任何填充，但是要求明文必须是16字节的整数倍。</li>
<li>PKCS5Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字符，且每个字节的值等于缺少的字符数。</li>
<li>ISO10126Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字节，最后一个字符值等于缺少的字符数，其他字符填充随机数</li>
</ol>
</li>
<li>
<p>加密模式：</p>
<ol>
<li>电码本模式（Electronic Codebook Book (ECB)） 模式是将整个明文分成若干段相同的小段，然后对每一小段进行加密。</li>
<li>密码分组链接模式（Cipher Block Chaining (CBC)） 模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算，再与密钥进行加密</li>
<li>计算器模式（Counter (CTR)）不常用，在 CTR 模式中， 有一个自增的算子，这个算子用密钥加密之后输出和明文异或的结果得到密文，相当于一次一密</li>
<li>密码反馈模式（Cipher FeedBack (CFB)）不常用</li>
<li>输出反馈模式（Output FeedBack (OFB)）</li>
</ol>
</li>
</ol>
<h3 id="golang实现aes加解密">golang实现AES加解密</h3>
<p>golang使用“crypto/aes”进行AES加解密 。接着我们通过一个使用CBC模式对原文进行加解密的例子来演示如何实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;crypto/aes&#34;</span>
    <span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
    <span style="color:#e6db74">&#34;encoding/base64&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 原始数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)

    <span style="color:#75715e">// 密钥，长度必须为 16、24 或 32 字节(128位，192位，256位)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

    <span style="color:#75715e">// 使用 AES 创建加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        panic(<span style="color:#a6e22e">err</span>)
    }

    <span style="color:#75715e">// 对数据进行填充，使其长度为块大小的整数倍
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

    <span style="color:#75715e">// 创建 CBC 模式的加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>) <span style="color:#75715e">// 初始化向量，长度必须为块大小
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

    <span style="color:#75715e">// 将密文进行 base64 编码
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">encoded</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 解码 base64 编码的密文
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 创建 CBC 模式的解密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> = <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

    <span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decrypted</span>))
}

<span style="color:#75715e">// 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
    <span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
    <span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
    <span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}
</code></pre></div><p>输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">+</span><span style="color:#f92672">HzZQh0Do42Kg1PQsdhdcw</span><span style="color:#f92672">==</span>
<span style="color:#f92672">Hello</span><span style="color:#f92672">,</span> <span style="color:#f92672">world</span><span style="color:#f92672">!</span>
</code></pre></div><p>上例中，分别演示了</p>
<ol>
<li>对加密过程：创建加密对象、原文填充、创建CBC模式，加密。</li>
<li>解密过程： 创建CBC解密模式，解密，去除填充。</li>
</ol>
<p>为了方便使用，我们对上例的加解密进行封装，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/aes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
	<span style="color:#e6db74">&#34;encoding/base64&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)
	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)
	<span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

	<span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

	<span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decoded</span>))
}

<span style="color:#75715e">// AesCBCEncrypt 使用 AES CBC 模式加密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// AesCBCDecrypt 使用 AES CBC 模式解密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">ciphertext</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">ciphertext</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">decoded</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;ciphertext is not a multiple of the block size&#34;</span>)
	}

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

	<span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decrypted</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// PKCS5Padding 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
	<span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
	<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// PKCS5UnPadding 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
	<span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}

</code></pre></div><h3 id="总结">总结</h3>
<p>本文主要介绍对称加密算法AES，AES使用不同指定长度的密钥，对原文进行分组，可选用更安全的加密模式CBC。在 golang中，可以使用“crypto/aes”快速实现原文填充、加密模式、加密、解密、去除填充等AES加解密过程。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/golang/crypto">golang/crypto</a></li>
<li><a href="https://xie.infoq.cn/article/1b405dfbe6d0acf06dea0f9f6">AES加密模式</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023025778520640">NodeJs-AES加密</a></li>
<li><a href="https://overstarry.vip/posts/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BD%BF%E7%94%A8aes%E5%8A%A0%E5%AF%86%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE/">前后端使用aes加密传输数据</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/562256846">什么是AES加密？详解AES加密算法原理流程</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" aria-label="">
      
          Go使用RedisStream实现消息队列
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-08T22:33:14&#43;08:00">
        
   8, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>上篇我们介绍了RedisStream实现消息队列和发布订阅模式 ，今天我们将介绍Go语言的实现方法。</p>
<h3 id="消息队列">消息队列</h3>
<p>接上篇的例子，我们通过go-redis库的接口XAdd、XReadGroup、XGroupCreateMkStream来实现，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>      = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span> = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">stream</span>   = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>    = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">start</span>    = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>    = <span style="color:#ae81ff">10</span>
	)

	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
		<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
		<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
		<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
		<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
		<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	} 
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
	}
}

</code></pre></div><p>上例实现了一个简单的消息队列，可以实现消息的发送和接收，并保证每条消息只被处理一次 。</p>
<h3 id="阻塞超时">阻塞超时</h3>
<p>通过修改Block（单位为ms）参数来实现阻塞，详细修改如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
		<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
			<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
			<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
			<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
			<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
			<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
			<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
		}).<span style="color:#a6e22e">Result</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>()) 
    <span style="color:#f92672">...</span>
	}
</code></pre></div><p>输出如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">23</span>.<span style="color:#a6e22e">9669498</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">529310801</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">Length</span><span style="color:#f92672">=</span> <span style="color:#f92672">1</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">message</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">name</span>:<span style="color:#a6e22e">foo</span><span style="color:#f92672">]</span>
<span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">panic</span><span style="color:#f92672">:</span> <span style="color:#f92672">read</span> <span style="color:#f92672">tcp</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">63777-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">6379</span><span style="color:#f92672">:</span> <span style="color:#f92672">i</span><span style="color:#f92672">/</span><span style="color:#f92672">o</span> <span style="color:#f92672">timeout</span>
</code></pre></div><p>可见,XReadGroup一直阻塞等待新的消息，直到 Redis 连接超时或者命令被中断。
ps: 如若不需要阻塞等待可修改Block为&lt;0 的值实现。</p>
<h3 id="发布订阅模式">发布订阅模式</h3>
<p>接着，我们实现上篇提到的发布订阅模式，XGroupCreateMkStream创建另外一个订阅组group2，两个协程XReadGroup接收消息，往stream中XAdd消息，两个订阅者将都收到消息，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>       = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span>  = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">consumer2</span> = <span style="color:#e6db74">&#34;consumer2&#34;</span>
		<span style="color:#a6e22e">stream</span>    = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>     = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">group2</span>    = <span style="color:#e6db74">&#34;group2&#34;</span>
		<span style="color:#a6e22e">start</span>     = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>     = <span style="color:#ae81ff">10</span>
	)
	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:        <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>:    <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:          <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">ReadTimeout</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">// 创建消费者组2
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group2</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}

		}
	}()
	<span style="color:#75715e">//读取消息2
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Start Receiving &#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group2</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer2</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;2Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}
		}
	}()
	<span style="color:#66d9ef">for</span> {
	}
}
</code></pre></div><p>输出如下：</p>
<pre tabindex="0"><code>Start Receiving 2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
2 Start Receiving  2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
Received Length= 1 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
Received message: map[name:foo]
Start Receiving 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
2 Received Length= 1 2023-04-08 22:19:42.3628412 +0800 CST m=+0.711897201
2Received message: map[name:foo]
</code></pre><h3 id="参考">参考</h3>
<ul>
<li><a href="https://redis.io/commands/xread">redis.io</a></li>
<li><a href="https://redis.io/docs/data-types/streams-tutorial">redis.io streams-tutorial</a></li>
<li><a href="https://mp.weixin.qq.com/s/RthQvzLHZRGNo-z6X_7jQQ">一篇List、PubSub、Stream实现消息队列的博客</a></li>
<li><a href="https://overstarry.vip/posts/%E4%BD%BF%E7%94%A8redis%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97-/">golang适用用List、PubSub、Stream 实现消息队列</a></li>
<li><a href="%E5%88%97/https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">redisstream实现消息队</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" aria-label="">
      
          Postgres事务隔离级别与MVCC
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-26T16:30:12&#43;08:00">
        
   26, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Postgres 中基于 MVCC（多版本并发控制）技术 ,使用一种称为“版本链”的技术来维护对数据库中行的并发访问, 来实现事务隔离级别的。</p>
<h3 id="mvcc-多版本并发控制">MVCC-多版本并发控制</h3>
<p>在 Postgres 中，每当一行被修改时，Postgres 就会创建一个新版本的该行，并将其添加到版本链的末尾。版本链包含了所有当前和以前的行版本，这样可以避免并发读写时的数据竞争和数据不一致问题。</p>
<p>MVCC避免了传统的数据库系统的锁定方法，将锁争夺最小化来允许多用户环境中的合理性能。</p>
<h3 id="常见并发问题">常见并发问题</h3>
<ol>
<li>脏读: 
一个事务读取了另一个并行未提交事务写入的数据</li>
<li>不可重复读
一个事务重新读取之前读取过的数据，发现该数据已经被另一个事务（在初始读之后提交）修改。</li>
<li>幻读
一个事务重新执行一个返回符合一个搜索条件的行集合的查询， 发现满足条件的行集合因为另一个最近提交的事务而发生了改变。</li>
<li>序列化异常
成功提交一组事务的结果与这些事务所有可能的串行执行结果都不一致。</li>
</ol>
<h3 id="事务隔离级解决方案">事务隔离级（解决方案）</h3>
<p>事务隔离级别指的是多个并发事务之间的可见性和可操作性，SQL标准定义了四种隔离级别，分别是：</p>
<ol>
<li>Read Uncommitted（读未提交）
这是最低的事务隔离级别，它允许一个事务读取其他事务未提交的数据。这可能会导致脏读、不可重复读和幻读问题。</li>
<li>Read Committed（读提交）
在该隔离级别下，事务只能看到已经提交的数据。它解决了脏读问题，但仍然存在不可重复读和幻读问题。</li>
<li>Repeatable Read（可重复读）
在该隔离级别下，事务在执行期间看到的所有数据都是一致的。它解决了不可重复读问题，但仍然存在幻读问题。</li>
<li>Serializable（可串行化）
在该隔离级别下，事务看到的所有数据都是一致的，并且完全避免了脏读、不可重复读和幻读问题。这是最高的事务隔离级别，但也是最慢的，因为它会导致大量的锁竞争。</li>
</ol>
<p>在PostgreSQL中，你可以请求四种标准事务隔离级别中的任意一种，但是内部只实现了三种不同的隔离级别，即 PostgreSQL 的读未提交模式的行为和读已提交相同。</p>
<h3 id="golang-libpq设置隔离等级">golang lib/pq设置隔离等级</h3>
<p>在golang中，使用lib/pq包，通过执行“SET TRANSACTION ISOLATION LEVEL &hellip;”来设置隔离等级。以下测试脏读的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;database/sql&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 连接数据库
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>, <span style="color:#a6e22e">dsn</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#75715e">// 设置隔离级别为读未提交
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED&#34;</span>)
	<span style="color:#75715e">//_, err = db.Exec(&#34;SET TRANSACTION ISOLATION LEVEL READ COMMITTED&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 开始第一个事务，修改用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;UPDATE users SET age = 6 WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx1 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	}()

	<span style="color:#75715e">// 暂停 1 秒钟，以便让第二个事务读取到未提交的数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">// 开始第二个事务，读取用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx2 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	<span style="color:#75715e">// 提交第一个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 提交第二个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

</code></pre></div><p>执行输出如下:</p>
<pre tabindex="0"><code>tx1 Bob's age is 6
tx2 Bob's age is 5
</code></pre><p>上例中，分别开启两个隔离级别为“读未提交”事务tx1、tx2，其中tx1对一行数据（Bob）的字段（Age）进行了修改，接着两个事务分别读取，即使在tx1提交之前，tx2也不会读取到未提交的数据,有效避免脏读等并发问题。</p>
<h3 id="小结">小结</h3>
<p>PostgreSQL 的事务隔离级别和 MVCC 技术为开发人员提供了强大的并发性能和数据一致性保证。同时MVCC并发控制模型，降低了锁竞争和死锁的风险，允许并发事务访问相同的数据而不会相互干扰。对查询（读）数据的锁请求与写数据的锁请求不冲突，所以读不会阻塞写，而写也从不阻塞读。但是，在选择事务隔离级别时，需要考虑不同事务隔离级别的性能以及<strong>应用程序的需求和性能特征</strong>，并根据实际情况进行权衡，充分利用 MVCC 技术的优点。</p>
<h3 id="参考">参考</h3>
<ul>
<li>postgres.cn  <a href="http://postgres.cn/docs/14/transaction-iso.html">http://postgres.cn/docs/14/transaction-iso.html</a></li>
<li>设置隔离级别blog <a href="https://juejin.cn/post/6992097803778392077">https://juejin.cn/post/6992097803778392077</a></li>
<li>go实例脏读、可不重复读、序列化异常 blog  <a href="https://blog.csdn.net/dfsgwe1231/article/details/107261355">https://blog.csdn.net/dfsgwe1231/article/details/107261355</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/go%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BA%93robfig-cron%E4%B8%80%E4%BA%9B%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" aria-label="">
      
          Go定时任务库robfig Cron一些主要功能、实际应用场景
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-04T22:21:37&#43;08:00">
        
   4, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>github.com/robfig/cron/v3 是一个功能强大且易于使用的定时任务管理库。本文进一步介绍robfig/cron在定时任务一些主要功能、如何使用它以及一些实际应用场景的例子。主要包括</p>
<ol>
<li>添加任务方法AddJob</li>
<li>指定执行时间</li>
<li>动态添加和删除任务</li>
<li>Option选项</li>
<li>JobWrapper与DefaultWrapper</li>
</ol>
<h3 id="addjob添加任务">AddJob添加任务</h3>
<p>Cron实例可以通过调用AddJob() 方法用于添加一个实现了 Job 接口的对象作为任务，Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingJob</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#a6e22e">GreetingJob</span>) <span style="color:#a6e22e">Run</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hi: &#34;</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>()
	<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddJob</span>(<span style="color:#e6db74">&#34;@every 2s&#34;</span>, <span style="color:#a6e22e">GreetingJob</span>{<span style="color:#e6db74">&#34;Greeter&#34;</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error : %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID:&#34;</span>, <span style="color:#a6e22e">entityID</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#75715e">//output:
</span><span style="color:#75715e">//entityID: 1
</span><span style="color:#75715e">//Hi:  Greeter now: 2023-03-04 17:50:07.0169185 +0800 CST m=+1.716253301
</span><span style="color:#75715e">//Hi:  Greeter now: 2023-03-04 17:50:09.0068064 +0800 CST m=+3.706141201
</span></code></pre></div><p>此例中，GreetingJob实现了cron.Job 接口，cron实例调用AddJob，加入一个每2秒执行的任务，务并传递参数。</p>
<h3 id="指定执行时间">指定执行时间</h3>
<p>可以通过修改 cron 表达式来指定任务的执行时间。Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>()) 
<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;0 05 18 * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hi now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
})
</code></pre></div><p>此例中，将在每天的傍晚18点5分执行指定的函数。</p>
<h3 id="动态添加和删除任务">动态添加和删除任务</h3>
<p>cron/v3 允许开发人员在运行时动态添加和删除任务。Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>())
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
     <span style="color:#75715e">// 添加第一个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entityID1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;*/2 * * * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Job1: &#34;</span>, <span style="color:#a6e22e">count</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
	})
	<span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID1:&#34;</span>, <span style="color:#a6e22e">entityID1</span>)
     <span style="color:#75715e">// 等待 6 秒钟，让第一个任务执行3次
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>)
    <span style="color:#75715e">// 添加第二个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entityID2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;*/2 * * * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Job2: &#34;</span>, <span style="color:#a6e22e">count</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
	})
	<span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span>)
     <span style="color:#75715e">// 等待 10秒钟，让两个任务交替执行几次
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
     <span style="color:#75715e">// 删除第2个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">entityID2</span>)
     <span style="color:#75715e">// 等待 10秒钟，发现只有任务1在执行了
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
     <span style="color:#75715e">// 删除第2个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">EntryID</span>(<span style="color:#ae81ff">1</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID2&#34;</span>, <span style="color:#a6e22e">entityID2</span>)
    <span style="color:#75715e">//发现只有没有任务在执行了 
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">err</span>))
	}
}

</code></pre></div><h3 id="option选项">Option选项</h3>
<p>Option 是一种用于配置 Cron 实例的结构体类型。Option 类型有多个可选字段，可用于配置定时任务的行为，上例中有使用到的WithSeconds。</p>
<p>以下是 Option 类型的一些字段及其说明：</p>
<ul>
<li>WithSeconds()：在 cron 表达式中包含秒（0-59），默认为不包含秒。</li>
<li>WithLocation()：设置时区，可以使用标准时区名称或时区偏移量。</li>
<li>WithChain()：将多个函数连接成单个函数。</li>
<li>WithParser()：指定 cron 表达式的解析器，默认为 StandardParser。</li>
<li>WithLogger()：指定日志记录器，默认为 DefaultLogger。</li>
</ul>
<p>下面 WithLogger Option Cron Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithLogger</span>(
			<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">VerbosePrintfLogger</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>, <span style="color:#e6db74">&#34;cron: &#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">LstdFlags</span>))))
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;@every 1s&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
	})
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}
<span style="color:#75715e">//output:
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:17 start
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:17 schedule, now=2023-03-04T21:31:17+08:00, entry=1, next=2023-03-04T21:31:18+08:00
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:18 wake, now=2023-03-04T21:31:18+08:00
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:18 run, now=2023-03-04T21:31:18+08:00, entry=1, next=2023-03-04T21:31:19+08:00
</span><span style="color:#75715e">//hello world
</span></code></pre></div><p>上例中，调用cron.VerbosPrintfLogger()包装log.Logger，这个logger会详细记录cron内部的调度过程</p>
<h3 id="jobwrapper与defaultwrapper">JobWrapper与DefaultWrapper</h3>
<p>//NewChain返回一个由给定JobWrappers组成的Chain，类似中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JobWrapper</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Job</span>) <span style="color:#a6e22e">Job</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Chain</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">wrappers</span> []<span style="color:#a6e22e">JobWrapper</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChain</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">JobWrapper</span>) <span style="color:#a6e22e">Chain</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Chain</span>{<span style="color:#a6e22e">c</span>}
}
</code></pre></div><p>cron内置了 3 个用得比较多的JobWrapper</p>
<ul>
<li>Recover 捕获内部Job产生的 panic</li>
<li>DelayIfStillRunning 序列化作业，延迟后续的运行直到前一个是完整的。</li>
<li>SkipIfStillRunning 跳过Job的调用，如果之前的调用是仍在运行。 
以Reover为例：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>(),
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithChain</span>(
			<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">Recover</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">DefaultLogger</span>),
		),
	)

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;@every 2s&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start...&#34;</span>)
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;ohno....&#34;</span>))
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;End...&#34;</span>)
	})

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()

	<span style="color:#66d9ef">select</span> {}
}
</code></pre></div><p>output:</p>
<pre tabindex="0"><code>Start...
cron: 2023/03/04 21:59:32 panic, error=ohno...., stack=...
goroutine 7 [running]:
github.com/robfig/cron/v3.Recover.func1.1.1()
	E:/gopath/pkg/mod/github.com/robfig/cron/v3@v3.0.1/chain.go:45 +0xa5
panic({0x7370c0, 0x75b930})
	...
</code></pre><p>在上例中，使用 cron.Recover() 方法来捕获任务执行过程中的 panic，并记录日志。如果不进行 panic 捕获的话，程序将会因为 panic 而退出。需要注意的是，当使用 Recover() 方法时，不应该让任务函数返回一个 error，否则它将不会被正确地捕获。如果任务函数可能会返回 error，建议使用 Try() 方法进行捕获。</p>
<p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/robfig/cron/v3">github.com/robfig/cron/v3</a></li>
<li><a href="https://darjun.github.io/2020/06/25/godailylib/cron/">一篇讲的比较详细的Blog</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/go%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BA%93robfig-cron%E4%B8%80%E4%BA%9B%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" aria-label="">
      
          Go分布式任务队列Asynq入门
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-18T21:37:06&#43;08:00">
        
   18, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        分布式任务任务调度与管理在微服务开发中是很有必要的。例如，当需要执行一些计算密集型或网络I/O密集型操作时，为了不影响主线程的性能，我们可以将这些任务放到后台异步执行。此外，异步任务处理还可以改善应用程序的可伸缩性和可靠性，因为它可以将任务分布到多个处理器上并允许任务的重试。
Asynq 介绍  Asynq Simple, reliable, and efficient distributed task queue in Go
 Asynq 是一个 Go 库，用于排队任务并与 worker 异步处理它们。它由Redis提供支持，旨在实现可扩展且易于上手。
特性：
 保证至少执行一次任务 任务调度 失败任务的重试 工作人员崩溃时自动恢复任务 加权优先级队列 严格的优先队列 添加任务的延迟低，因为 Redis 中的写入速度很快 使用唯一选项对任务进行重复数据删除 允许每个任务超时和截止日期 允许聚合任务组以批处理多个连续操作 支持中间件的灵活处理程序接口 能够暂停队列以停止处理队列中的任务 定期任务 支持 Redis Cluster实现自动分片和高可用 支持 Redis Sentinels以实现高可用性 与Prometheus集成以收集和可视化队列指标 用于检查和远程控制队列和任务的Web UI CLI检查和远程控制队列和任务  总的来说:
 分布式任务队列：Asynq提供了一个任务队列，可以分布式地处理异步任务，使得任务可以在多个处理器之间分配。 可靠性：Asynq具有高可靠性，可以确保任务不会丢失或重复执行。 异常处理：Asynq提供了对任务异常的处理机制，以便在任务执行失败时进行重试或处理。 优先级和延迟任务：Asynq允许您为任务设置优先级和延迟执行，以便您可以控制任务的执行顺序。 Web UI和CLI：Asynq提供了一个易于使用的Web UI和CLI工具，可以方便地监控和管理异步任务。  本文主要记录Asynq的入门、基本使用和工作原理。
安装 使用go get命令安装Asynq库
go get -u github.com/hibiken/asynq工作原理 高级概述：
  Client客户端将任务放入队列 Server服务器从队列中拉取任务并为每个任务启动一个工作协程 任务由多个worker同时处理   Client 创建异步任务 asynq.
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" aria-label="">
      
          深入了解KratosMiddlewar的实现原理
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-12T16:10:45&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。</p>
<h3 id="使用示例">使用示例</h3>
<p>Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// http
</span><span style="color:#75715e">// 定义opts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ServerOption</span>{
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Middleware</span>(
        <span style="color:#a6e22e">recovery</span>.<span style="color:#a6e22e">Recovery</span>(), <span style="color:#75715e">// 把middleware按照需要的顺序加入
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">tracing</span>.<span style="color:#a6e22e">Server</span>(),
        <span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Server</span>(),
    ),
}
<span style="color:#75715e">// 创建server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</code></pre></div><p>自定义中间件的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>() <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">ok</span> {
                <span style="color:#75715e">// Do something on entering
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                <span style="color:#75715e">// Do something on exiting
</span><span style="color:#75715e"></span>                 }()
            }
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
        }
    }
}
</code></pre></div><h3 id="链式调用">链式调用</h3>
<p>Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。</p>
<p>每一个中间件都是一个函数，具有相同的签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Handler定义中间件调用的处理程序
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Middleware</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Middleware</span>) <span style="color:#a6e22e">Middleware</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">m</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> {
			<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>](<span style="color:#a6e22e">next</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>
	}
}
</code></pre></div><p>Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestChain</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">next</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;reply&#34;</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">test1Middleware</span>, <span style="color:#a6e22e">test2Middleware</span>, <span style="color:#a6e22e">test3Middleware</span>)(<span style="color:#a6e22e">next</span>)(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;hello kratos!&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expect %v, got %v&#34;</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>)
        }
  }
  
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test1Middleware</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 before&#34;</span>)
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 after&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
}  
<span style="color:#f92672">...</span> <span style="color:#a6e22e">篇幅限制</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">省略部分代码</span>
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">before</span>
    <span style="color:#a6e22e">middleware_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">14</span>: <span style="color:#a6e22e">hello</span> <span style="color:#a6e22e">kratos</span>!
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">after</span>
</code></pre></div><h3 id="调用过程">调用过程</h3>
<p>对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：</p>
<ol>
<li>option方式配置中间件</li>
<li>url路由匹配中间件</li>
<li>组装中间件添加到调用链</li>
<li>注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件</li>
</ol>
<p>以Transport.Server Http服务为例，重点关注middleware和router 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Server is an HTTP server wrapper.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>
	<span style="color:#a6e22e">middleware</span>  <span style="color:#a6e22e">matcher</span>.<span style="color:#a6e22e">Matcher</span>
	<span style="color:#a6e22e">router</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>
	<span style="color:#f92672">...</span>
}
<span style="color:#75715e">// Matcher is a middleware matcher.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Matcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">selector</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>
}
</code></pre></div><ul>
<li>Matcher是一个中间件匹配器，operation 为path，实现路由查找。</li>
<li>router 为gorilla.Mux, Http路由器和Url匹配器</li>
</ul>
<p>一个完成的调用api-service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>其中ctx.Middleware的实现是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Context</span>()); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">tr</span>.<span style="color:#a6e22e">Operation</span>())<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>)<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
} 

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">matcher</span>) <span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
	<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>))
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">operation</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">next</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">prefix</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">prefix</span>) {
			<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">prefix</span>]<span style="color:#f92672">...</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ms</span>
}
</code></pre></div><p>以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。</p>
<h3 id="小结">小结</h3>
<p>文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。</p>
<h3 id="参考">参考</h3>
<ul>
<li>kratos doc <a href="https://go-kratos.dev/docs/component/middleware/overview">https://go-kratos.dev/docs/component/middleware/overview</a></li>
<li>kratos middleware pkg  <a href="https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go">https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" aria-label="">
      
          Gorilla Mux的基础使用和常用功能
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-04T21:28:28&#43;08:00">
        
   4, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>gorilla/mux一个良好质量的Http路由器和Url匹配器，很好补充net/http包HTTP协议复杂的路由请求。本文主要记录gorilla的基础使用、和常用功能提取网址参数、路径前缀和子路由器、中间件。</p>
<h3 id="基础使用">基础使用</h3>
<h4 id="安装">安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">go get -u github.com/gorilla/mux
</code></pre></div><h4 id="创建路由器">创建路由器</h4>
<p>通过 mux.NewRouter() 创建路由器，稍后将作为参数传递给服务器。它将接收所有 HTTP 连接并将其传递给您将在其上注册的请求处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gorilla/mux&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个新的路由器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">NewRouter</span>()

	<span style="color:#75715e">//等效于http.HandleFunc()工作原理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/foo&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;foo&#34;</span>)
	})
	<span style="color:#75715e">//等效于http.Handler()工作原理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;bar&#34;</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;bar&#34;</span>)
	}))
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/foo&#34;</span>, <span style="color:#a6e22e">handler</span>)
    <span style="color:#75715e">//作为服务参数传入
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:80&#34;</span>, <span style="color:#a6e22e">r</span>) 
  }  
  <span style="color:#75715e">//请求http://yourip:80/foo  http://yourip:80/bar 
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//foo bar 
</span></code></pre></div><h3 id="网址参数">网址参数</h3>
<p>gorilla/mux的优势之一是：从url中提前参数，例如一个restful api：/country/{country}/province/{province} ，从request参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">oneHander</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Vars</span>(<span style="color:#a6e22e">r</span>)
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;country&#34;</span>]
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;province&#34;</span>]
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Welcome to  %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Welcome to  %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//URL 中提取段/变量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/country/{country}/province/{province}&#34;</span>, <span style="color:#a6e22e">oneHander</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china/province/fujian   
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to china fujian
</span></code></pre></div><h3 id="路径前缀和子路由器">路径前缀和子路由器</h3>
<p>有些场景将请求处理程序限制为特定路径前缀，比如api、admin、cheat 或 v1、v2、v3 或 beta 、prod。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#a6e22e">allHanler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Vars</span>(<span style="color:#a6e22e">r</span>)
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;country&#34;</span>]
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;province&#34;</span>]
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Welcome to %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//路径前缀和子路由器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">countryRouter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PathPrefix</span>(<span style="color:#e6db74">&#34;/country&#34;</span>).<span style="color:#a6e22e">Subrouter</span>()
	<span style="color:#a6e22e">countryRouter</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">allHanler</span>)
	<span style="color:#a6e22e">countryRouter</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/{province}&#34;</span>, <span style="color:#a6e22e">oneHander</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china  
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to china
</span></code></pre></div><h3 id="中间件">中间件</h3>
<p>Mux 支持向Router添加中间件，如果找到匹配项，中间件将按照添加的顺序执行，包括其子路由器。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>) <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">MiddlewareFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;do something before handler&#34;</span>)
			<span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;do something after handler&#34;</span>)
		})
	}
}

	<span style="color:#75715e">//中间件
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">middleware1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Middleware1</span>(<span style="color:#a6e22e">r</span>)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Use</span>([]<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">MiddlewareFunc</span>{<span style="color:#a6e22e">middleware1</span>}<span style="color:#f92672">...</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china/province/fujian   
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//do something before handler
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to  china fujian
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//do something after handler
</span></code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/gorilla/mux">https://github.com/gorilla/mux</a></li>
<li><a href="https://gowebexamples.com/routes-using-gorilla-mux/">https://gowebexamples.com/routes-using-gorilla-mux/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/01/go%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" aria-label="">
      
          Go基于Redis实现分布式锁
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-01-08T16:00:30&#43;08:00">
        
   8, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="写在前面">写在前面</h3>
<p>随着分布式系统的快速发展和广泛应用，如何处理共享资源的互斥访问场景呢？即分布式锁，常见采用有开源的 MySQL，Redis，ZooKeeper，Etcd 等三方组件来实现。今天主要介绍Golang基于Redis实现分布式互斥锁。</p>
<h3 id="分布式锁特性">分布式锁特性</h3>
<p>那么分布式锁需要处理哪些问题场景呢，或者说特性有哪些？
这是redis.io的原文：</p>
<blockquote>
<p>安全和活力保证：</p>
<ol>
<li>安全特性：互斥。在任何给定时刻，只有一个客户端可以持有一把锁。</li>
<li>活性属性 A：无死锁。最终总是有可能获得锁，即使锁定资源的客户端崩溃或分区。</li>
<li>活性属性 B：容错性。只要大多数 Redis 节点正常运行，客户端就可以获取和释放锁</li>
</ol>
</blockquote>
<p>结合实际场景，翻译一下：</p>
<ol>
<li>互斥性。锁的基础特性，只能被第一个持有者持有；</li>
<li>防死锁。在持有方发生异常时，设置锁的超时释放机制，规避死锁风险</li>
<li>高可用、高性能。</li>
</ol>
<h3 id="go-redsyn">go-redsyn</h3>
<p>Redsync 为 Go 提供了基于 Redis 的分布式互斥锁实现
安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ go get github.com/go-redsync/redsync/v4
</code></pre></div><p>例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">goredislib</span> <span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redsync/redsync/v4&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redsync/redsync/v4/redis/goredis/v8&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//使用go-redis(或redigo)创建一个池，该池是redisync will
</span><span style="color:#75715e">//在与Redis通信时使用这也可以是任何一个池子
</span><span style="color:#75715e">//实现&#39; redis. properties &#39;池的接口。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">goredislib</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">goredislib</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>: <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
	})
    
    <span style="color:#75715e">//redis集群
</span><span style="color:#75715e">//client := goredislib.NewClusterClient(&amp;goredislib.ClusterOptions{        //Addr: []string{&#34;localhost:6379&#34;},    })
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">pool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">goredis</span>.<span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">client</span>) <span style="color:#75715e">// or, pool := redigo.NewPool(...)
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//创建redisync实例，用于获得互斥锁。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">pool</span>)

	<span style="color:#75715e">//为所有需要互斥对象的实例使用相同的名称来获取一个新的互斥对象
</span><span style="color:#75715e">//相同的锁。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutexname</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;my-global-mutex&#34;</span>
	<span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>)

	<span style="color:#75715e">//获取互斥锁在这个成功之后，没有其他人
</span><span style="color:#75715e">//可以获得相同的锁(相同的互斥锁名)，直到我们解锁它。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">//做你需要锁的工作。
</span><span style="color:#75715e"></span>    
<span style="color:#75715e">//释放锁，以便其他进程或线程可以获得锁。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>(); !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#e6db74">&#34;unlock failed&#34;</span>)
	}
}
</code></pre></div><h3 id="实现原理">实现原理</h3>
<h4 id="加锁">加锁</h4>
<p>在New一个互斥锁mutex后，通过mutex.Lock()加锁，查看源码实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">acquire</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pool</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetNX</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expiry</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>可见，是通过Redis命令Setnx操作来实现。</p>
<p><strong>Redis Setnx（SET if Not eXists） 命令在指定的 key 不存在时，为 key 设置指定的值。设置成功，返回 1 。 设置失败，返回 0 。相对于Set，Setnx具有原子性。</strong></p>
<h4 id="释放锁">释放锁</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">release</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pool</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Eval</span>(<span style="color:#a6e22e">deleteScript</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">value</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> int64(<span style="color:#ae81ff">0</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deleteScript</span> = <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewScript</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">`
</span><span style="color:#e6db74">	if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span><span style="color:#e6db74">		return redis.call(&#34;DEL&#34;, KEYS[1])
</span><span style="color:#e6db74">	else
</span><span style="color:#e6db74">		return 0
</span><span style="color:#e6db74">	end
</span><span style="color:#e6db74">`</span>)
</code></pre></div><p>可见，Redis使用Lua脚本命令来Delete Key操作。</p>
<p><strong>这里需要关注到Del的时候，需要传入value，value是在加锁时设置的随机唯一值。在删除前进行校验value是否一致，防止误删</strong>。</p>
<h4 id="锁超时-防死锁">锁超时-防死锁</h4>
<p>如果持有锁的系统宕机、异常了导致没法release锁，那么其他方就无法活动该锁，导致死锁。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewMutex returns a new distributed mutex with given name.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Redsync</span>) <span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Mutex</span>{
		<span style="color:#a6e22e">name</span>:   <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">expiry</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
		<span style="color:#a6e22e">tries</span>:  <span style="color:#ae81ff">32</span>,
		<span style="color:#a6e22e">delayFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">tries</span> <span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">maxRetryDelayMilliSec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">minRetryDelayMilliSec</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">minRetryDelayMilliSec</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>
		},
		<span style="color:#a6e22e">genValueFunc</span>:  <span style="color:#a6e22e">genValue</span>,
		<span style="color:#a6e22e">driftFactor</span>:   <span style="color:#ae81ff">0.01</span>,
		<span style="color:#a6e22e">timeoutFactor</span>: <span style="color:#ae81ff">0.05</span>,
		<span style="color:#a6e22e">quorum</span>:        len(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pools</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">pools</span>:         <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pools</span>,
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">o</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">options</span> {
		<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">m</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}
</code></pre></div><p>可见，Mutex.expiy 设置了超时时间，默认为8秒，可以通过Option修改超时时间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// WithExpiry can be used to set the expiry of a mutex to the given value.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">expiry</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#a6e22e">Option</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">OptionFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) {
		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expiry</span> = <span style="color:#a6e22e">expiry</span>
	})
}
</code></pre></div><p>Example（设置超时时间、重复加锁）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//设置锁超时3秒
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>,<span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
    <span style="color:#75715e">//重复加锁
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>

<span style="color:#a6e22e">panic</span>: <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">already</span> <span style="color:#a6e22e">taken</span>, <span style="color:#a6e22e">locked</span> <span style="color:#a6e22e">nodes</span>: [<span style="color:#ae81ff">0</span>]
</code></pre></div><p>Example（设置超时时间、超时释放锁）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//设置锁超时10秒
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>,<span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
    <span style="color:#75715e">//11秒后锁超时，释放
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">11</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
    <span style="color:#75715e">//重复加锁但已释放、无异常
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
</code></pre></div><h3 id="总结">总结</h3>
<p>本文主要介绍分布式锁的基础概念、特性互斥性、防死锁、高可用高性能。以及golang基于redis，使用go-redsync库实现分布式锁。通过例子简单介绍go-redsync的入门使用，以及通过源码阅读来刨析简介实现原理： 1.利用Redis Setnx原子性实现互斥性 ，2.利用Redis执行lua脚本、检查value值避免误删操作， 3.通过设置ExpiryOption设置超时时间，实现锁超时、避免死锁。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://redis.io/docs/manual/patterns/distributed-locks/">redis.io/docs 使用 Redis 的分布式锁</a></li>
<li><a href="https://github.com/go-redsync/redsync">redsync</a></li>
<li><a href="https://www.modb.pro/db/531964/">redsync源码介绍</a></li>
<li><a href="https://mp.weixin.qq.com/s/k_dX2HF8hTf6XseeeXYivg">redis go实现方式</a></li>
<li><a href="https://xiaorui.cc/archives/3028">峰云 -redigo实现</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/01/go%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/12/golang-linters%E8%81%9A%E5%90%88%E5%99%A8golangci-lint/" aria-label="">
      
          Golang Linters聚合器golangci Lint
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-12-18T17:23:05&#43;08:00">
        
   18, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍go实现lint和golangci-lint使用。</p>
<h3 id="what">what</h3>
<p>linter为静态代码检查、分析工具，golang常见的有govet\golint\errcheck 等。通过工具其一，可以提前发现一些语法问题，比如变量作用域问题、数组下标越界、内存泄露等；其二可以根据团队规范定制lint规则，提升可读性，可维护性。</p>
<p>golang的linters比较多，比如 <a href="https://github.com/golangci/awesome-go-linters">awesome-go-linters</a>中 golint检查变量、函数名、注释等。errcheck为未检查错误等。golangci-lint是一个 Go linters 聚合器，通过配置来选择需要的linters。其特征如下：</p>
<ul>
<li>⚡非常快:并行运行linters，重用Go构建缓存和缓存分析结果。</li>
<li>⚙️基于yaml的配置</li>
<li>🖥集成VS Code, Sublime Text, GoLand, GNU Emacs, Vim, Atom, GitHub动作。</li>
<li>🥇包含了很多linters，不需要安装它们。</li>
<li>📈由于调优的默认设置导致的最小误报数。</li>
<li>🔥漂亮的输出颜色，源代码行和标记的标识符。</li>
</ul>
<h3 id="install">install</h3>
<h4 id="mac">mac</h4>
<p>macOS你可以使用brew在macOS上安装二进制版本:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew install golangci-lint
brew upgrade golangci-lint
</code></pre></div><h4 id="install-from-source">Install from Source</h4>
<p>源码安装:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&gt; go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.50.1
</code></pre></div><p>查看安装是否成功：</p>
<pre tabindex="0"><code>&gt;golangci-lint --version
&gt;golangci-lint has version v1.50.1 built from (unknown, mod sum: &quot;h1:C829clMcZXEORakZlwpk7M4iDw2XiwxxKaG504SZ9zY=&quot;) on (unknown)
</code></pre><h3 id="how">how</h3>
<p>GolangCI-Lint 可以零配置使用。默认情况下启用以下 linters</p>
<pre tabindex="0"><code>&gt;golangci-lint help linters
&gt;Enabled by default linters:
errcheck: Errcheck is a program for checking for unchecked errors in go programs. These unchecked errors can be critical bugs in some cases [fast: false, auto-fix: false]
gosimple (megacheck): Linter for Go source code that specializes in simplifying code [fast: false, auto-fix: false]
govet (vet, vetshadow): Vet examines Go source code and reports suspicious constructs, such as Printf calls whose arguments do not align with the format string [fast: false, auto-fix: false]
ineffassign: Detects when assignments to existing variables are not used [fast: true, auto-fix: false]
staticcheck (megacheck): It's a set of rules from staticcheck. It's not the same thing as the staticcheck binary. The author of staticcheck doesn't support or approve the use of staticcheck as a library inside golangci-lint. [fast: false, auto-fix: false]
typecheck: Like the front-end of a Go compiler, parses and type-checks Go code [fast: false, auto-fix: false]
unused (megacheck): Checks Go code for unused constants, variables, functions and types [fast: false, auto-fix: false]
</code></pre><p>如何执行golangci-lint呢？在需要执行的项目目录下：</p>
<pre tabindex="0"><code>golangci-lint run
</code></pre><p>这相当于执行</p>
<pre tabindex="0"><code>golangci-lint run ./...
</code></pre><p>您可以选择要分析的目录和文件:</p>
<pre tabindex="0"><code>golangci-lint run dir1 dir2/... dir3/file1.go
</code></pre><p>接着，我们创建一个Example代码：linter_example.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">People</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">People</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;print: %v&#34;</span>, <span style="color:#a6e22e">p</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">People</span>{}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">String</span>()
}


</code></pre></div><p>执行lint，如果没有相关的配置文件，会走默认的lint配置</p>
<pre tabindex="0"><code>&gt; golangci-lint run
level=warning msg=&quot;[runner] The linter 'golint' is deprecated (since v1.41.0) due to: The repository of the linter has been archived b
y the owner.  Replaced by revive.&quot;
linter_example.go:5:6: exported type `People` should have comment or be unexported (golint)
type People struct {
     ^
linter_example.go:10:9: printf: fmt.Sprintf format %v with arg p causes recursive (*demos/linter-demo.People).String method call (gove
t)
        return fmt.Sprintf(&quot;print: %v&quot;, p)
               ^
linter_example.go:15:10: unusedresult: result of (*demos/linter-demo.People).String call not used (govet)
        p.String()
                ^

</code></pre><p>我们可以根据lint提示修改</p>
<pre tabindex="0"><code> printf: fmt。Sprintf格式%v与arg p导致递归( demos/ lininter -demo. people)。字符串方法调用(govet)。
</code></pre><p>在使⽤  fmt 包中的打印⽅法时，如果类型实现了这个接⼝，会直接调⽤。⽽中打印  p 的时候会直接调⽤  p 实现的  String() ⽅法，然后就产⽣了循环调⽤。</p>
<h4 id="custom-configuration">Custom Configuration</h4>
<p>GolangCI-Lint  通过当前工作目录的以下路径中增加配置文件：</p>
<ul>
<li>.golangci.yml</li>
<li>.golangci.yaml</li>
<li>.golangci.toml</li>
<li>.golangci.json</li>
</ul>
<p>来实现自定义linters</p>
<p>例如我们添加了.golangci.yml</p>
<pre tabindex="0"><code>run:
  timeout: 5m
  modules-download-mode: readonly

linters:
  disable-all: true
  enable: # 下面是开启的lint列表
    - errcheck
    - goimports
    - golint
   # - govet 为了测试是否生效，关闭
    - staticcheck

linters-settings:
  golint:
    # minimal confidence for issues, default is 0.8
    min-confidence: 0.8

issues:
  exclude-use-default: false
  max-issues-per-linter: 0
  max-same-issues: 0
</code></pre><p>这里我们把govet 关闭了，在执行run</p>
<pre tabindex="0"><code>golangci-lint run
level=warning msg=&quot;[runner] The linter 'golint' is deprecated (since v1.41.0) due to: The repository of the linter has been archived b
y the owner.  Replaced by revive.&quot;
linter_example.go:5:6: exported type `People` should have comment or be unexported (golint)
type People struct {
     ^
</code></pre><p>可见关闭govet生效了。</p>
<h3 id="reference">reference</h3>
<ul>
<li>golangci-lint  <a href="https://github.com/golangci/golangci-lint">https://github.com/golangci/golangci-lint</a></li>
<li>golangci-lint doc <a href="https://golangci-lint.run/">https://golangci-lint.run/</a></li>
<li>lint  <a href="https://github.com/golang/lint">https://github.com/golang/lint</a></li>
<li>awesome-go-linters <a href="https://github.com/golangci/awesome-go-linters">https://github.com/golangci/awesome-go-linters</a></li>
<li>bolg gocn  <a href="https://mp.weixin.qq.com/s/kNh0TP59fCFJhbmr-YMz4Q">https://mp.weixin.qq.com/s/kNh0TP59fCFJhbmr-YMz4Q</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/12/golang-linters%E8%81%9A%E5%90%88%E5%99%A8golangci-lint/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/go/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


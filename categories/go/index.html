<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/categories\/go\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="go">
<meta name="twitter:title" content="go">
<meta property="og:url" content="https://luckytking.github.io/categories/go/">
<meta property="twitter:url" content="https://luckytking.github.io/categories/go/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>go</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/categories/go/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/categories/go/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" aria-label="">
      
          Go分布式任务队列Asynq入门
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-18T21:37:06&#43;08:00">
        
   18, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        分布式任务任务调度与管理在微服务开发中是很有必要的。例如，当需要执行一些计算密集型或网络I/O密集型操作时，为了不影响主线程的性能，我们可以将这些任务放到后台异步执行。此外，异步任务处理还可以改善应用程序的可伸缩性和可靠性，因为它可以将任务分布到多个处理器上并允许任务的重试。
Asynq 介绍  Asynq Simple, reliable, and efficient distributed task queue in Go
 Asynq 是一个 Go 库，用于排队任务并与 worker 异步处理它们。它由Redis提供支持，旨在实现可扩展且易于上手。
特性：
 保证至少执行一次任务 任务调度 失败任务的重试 工作人员崩溃时自动恢复任务 加权优先级队列 严格的优先队列 添加任务的延迟低，因为 Redis 中的写入速度很快 使用唯一选项对任务进行重复数据删除 允许每个任务超时和截止日期 允许聚合任务组以批处理多个连续操作 支持中间件的灵活处理程序接口 能够暂停队列以停止处理队列中的任务 定期任务 支持 Redis Cluster实现自动分片和高可用 支持 Redis Sentinels以实现高可用性 与Prometheus集成以收集和可视化队列指标 用于检查和远程控制队列和任务的Web UI CLI检查和远程控制队列和任务  总的来说:
 分布式任务队列：Asynq提供了一个任务队列，可以分布式地处理异步任务，使得任务可以在多个处理器之间分配。 可靠性：Asynq具有高可靠性，可以确保任务不会丢失或重复执行。 异常处理：Asynq提供了对任务异常的处理机制，以便在任务执行失败时进行重试或处理。 优先级和延迟任务：Asynq允许您为任务设置优先级和延迟执行，以便您可以控制任务的执行顺序。 Web UI和CLI：Asynq提供了一个易于使用的Web UI和CLI工具，可以方便地监控和管理异步任务。  本文主要记录Asynq的入门、基本使用和工作原理。
安装 使用go get命令安装Asynq库
go get -u github.com/hibiken/asynq工作原理 高级概述：
  Client客户端将任务放入队列 Server服务器从队列中拉取任务并为每个任务启动一个工作协程 任务由多个worker同时处理   Client 创建异步任务 asynq.
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" aria-label="">
      
          深入了解KratosMiddlewar的实现原理
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-12T16:10:45&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。</p>
<h3 id="使用示例">使用示例</h3>
<p>Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// http
</span><span style="color:#75715e">// 定义opts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ServerOption</span>{
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Middleware</span>(
        <span style="color:#a6e22e">recovery</span>.<span style="color:#a6e22e">Recovery</span>(), <span style="color:#75715e">// 把middleware按照需要的顺序加入
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">tracing</span>.<span style="color:#a6e22e">Server</span>(),
        <span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Server</span>(),
    ),
}
<span style="color:#75715e">// 创建server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</code></pre></div><p>自定义中间件的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>() <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">ok</span> {
                <span style="color:#75715e">// Do something on entering
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                <span style="color:#75715e">// Do something on exiting
</span><span style="color:#75715e"></span>                 }()
            }
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
        }
    }
}
</code></pre></div><h3 id="链式调用">链式调用</h3>
<p>Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。</p>
<p>每一个中间件都是一个函数，具有相同的签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Handler定义中间件调用的处理程序
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Middleware</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Middleware</span>) <span style="color:#a6e22e">Middleware</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">m</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> {
			<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>](<span style="color:#a6e22e">next</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>
	}
}
</code></pre></div><p>Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestChain</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">next</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;reply&#34;</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">test1Middleware</span>, <span style="color:#a6e22e">test2Middleware</span>, <span style="color:#a6e22e">test3Middleware</span>)(<span style="color:#a6e22e">next</span>)(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;hello kratos!&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expect %v, got %v&#34;</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>)
        }
  }
  
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test1Middleware</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 before&#34;</span>)
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 after&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
}  
<span style="color:#f92672">...</span> <span style="color:#a6e22e">篇幅限制</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">省略部分代码</span>
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">before</span>
    <span style="color:#a6e22e">middleware_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">14</span>: <span style="color:#a6e22e">hello</span> <span style="color:#a6e22e">kratos</span>!
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">after</span>
</code></pre></div><h3 id="调用过程">调用过程</h3>
<p>对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：</p>
<ol>
<li>option方式配置中间件</li>
<li>url路由匹配中间件</li>
<li>组装中间件添加到调用链</li>
<li>注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件</li>
</ol>
<p>以Transport.Server Http服务为例，重点关注middleware和router 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Server is an HTTP server wrapper.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>
	<span style="color:#a6e22e">middleware</span>  <span style="color:#a6e22e">matcher</span>.<span style="color:#a6e22e">Matcher</span>
	<span style="color:#a6e22e">router</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>
	<span style="color:#f92672">...</span>
}
<span style="color:#75715e">// Matcher is a middleware matcher.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Matcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">selector</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>
}
</code></pre></div><ul>
<li>Matcher是一个中间件匹配器，operation 为path，实现路由查找。</li>
<li>router 为gorilla.Mux, Http路由器和Url匹配器</li>
</ul>
<p>一个完成的调用api-service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>其中ctx.Middleware的实现是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Context</span>()); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">tr</span>.<span style="color:#a6e22e">Operation</span>())<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>)<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
} 

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">matcher</span>) <span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
	<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>))
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">operation</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">next</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">prefix</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">prefix</span>) {
			<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">prefix</span>]<span style="color:#f92672">...</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ms</span>
}
</code></pre></div><p>以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。</p>
<h3 id="小结">小结</h3>
<p>文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。</p>
<h3 id="参考">参考</h3>
<ul>
<li>kratos doc <a href="https://go-kratos.dev/docs/component/middleware/overview">https://go-kratos.dev/docs/component/middleware/overview</a></li>
<li>kratos middleware pkg  <a href="https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go">https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" aria-label="">
      
          Gorilla Mux的基础使用和常用功能
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-04T21:28:28&#43;08:00">
        
   4, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>gorilla/mux一个良好质量的Http路由器和Url匹配器，很好补充net/http包HTTP协议复杂的路由请求。本文主要记录gorilla的基础使用、和常用功能提取网址参数、路径前缀和子路由器、中间件。</p>
<h3 id="基础使用">基础使用</h3>
<h4 id="安装">安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">go get -u github.com/gorilla/mux
</code></pre></div><h4 id="创建路由器">创建路由器</h4>
<p>通过 mux.NewRouter() 创建路由器，稍后将作为参数传递给服务器。它将接收所有 HTTP 连接并将其传递给您将在其上注册的请求处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gorilla/mux&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个新的路由器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">NewRouter</span>()

	<span style="color:#75715e">//等效于http.HandleFunc()工作原理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/foo&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;foo&#34;</span>)
	})
	<span style="color:#75715e">//等效于http.Handler()工作原理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;bar&#34;</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;bar&#34;</span>)
	}))
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/foo&#34;</span>, <span style="color:#a6e22e">handler</span>)
    <span style="color:#75715e">//作为服务参数传入
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:80&#34;</span>, <span style="color:#a6e22e">r</span>) 
  }  
  <span style="color:#75715e">//请求http://yourip:80/foo  http://yourip:80/bar 
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//foo bar 
</span></code></pre></div><h3 id="网址参数">网址参数</h3>
<p>gorilla/mux的优势之一是：从url中提前参数，例如一个restful api：/country/{country}/province/{province} ，从request参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">oneHander</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Vars</span>(<span style="color:#a6e22e">r</span>)
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;country&#34;</span>]
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;province&#34;</span>]
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Welcome to  %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Welcome to  %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//URL 中提取段/变量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/country/{country}/province/{province}&#34;</span>, <span style="color:#a6e22e">oneHander</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china/province/fujian   
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to china fujian
</span></code></pre></div><h3 id="路径前缀和子路由器">路径前缀和子路由器</h3>
<p>有些场景将请求处理程序限制为特定路径前缀，比如api、admin、cheat 或 v1、v2、v3 或 beta 、prod。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#a6e22e">allHanler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Vars</span>(<span style="color:#a6e22e">r</span>)
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;country&#34;</span>]
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;province&#34;</span>]
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Welcome to %s %s\n&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//路径前缀和子路由器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">countryRouter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PathPrefix</span>(<span style="color:#e6db74">&#34;/country&#34;</span>).<span style="color:#a6e22e">Subrouter</span>()
	<span style="color:#a6e22e">countryRouter</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">allHanler</span>)
	<span style="color:#a6e22e">countryRouter</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/{province}&#34;</span>, <span style="color:#a6e22e">oneHander</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china  
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to china
</span></code></pre></div><h3 id="中间件">中间件</h3>
<p>Mux 支持向Router添加中间件，如果找到匹配项，中间件将按照添加的顺序执行，包括其子路由器。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>) <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">MiddlewareFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;do something before handler&#34;</span>)
			<span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;do something after handler&#34;</span>)
		})
	}
}

	<span style="color:#75715e">//中间件
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">middleware1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Middleware1</span>(<span style="color:#a6e22e">r</span>)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Use</span>([]<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">MiddlewareFunc</span>{<span style="color:#a6e22e">middleware1</span>}<span style="color:#f92672">...</span>)
    <span style="color:#75715e">//请求 http://yourip/country/china/province/fujian   
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//output
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//do something before handler
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Welcome to  china fujian
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//do something after handler
</span></code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/gorilla/mux">https://github.com/gorilla/mux</a></li>
<li><a href="https://gowebexamples.com/routes-using-gorilla-mux/">https://gowebexamples.com/routes-using-gorilla-mux/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/01/go%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" aria-label="">
      
          Go基于Redis实现分布式锁
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-01-08T16:00:30&#43;08:00">
        
   8, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="写在前面">写在前面</h3>
<p>随着分布式系统的快速发展和广泛应用，如何处理共享资源的互斥访问场景呢？即分布式锁，常见采用有开源的 MySQL，Redis，ZooKeeper，Etcd 等三方组件来实现。今天主要介绍Golang基于Redis实现分布式互斥锁。</p>
<h3 id="分布式锁特性">分布式锁特性</h3>
<p>那么分布式锁需要处理哪些问题场景呢，或者说特性有哪些？
这是redis.io的原文：</p>
<blockquote>
<p>安全和活力保证：</p>
<ol>
<li>安全特性：互斥。在任何给定时刻，只有一个客户端可以持有一把锁。</li>
<li>活性属性 A：无死锁。最终总是有可能获得锁，即使锁定资源的客户端崩溃或分区。</li>
<li>活性属性 B：容错性。只要大多数 Redis 节点正常运行，客户端就可以获取和释放锁</li>
</ol>
</blockquote>
<p>结合实际场景，翻译一下：</p>
<ol>
<li>互斥性。锁的基础特性，只能被第一个持有者持有；</li>
<li>防死锁。在持有方发生异常时，设置锁的超时释放机制，规避死锁风险</li>
<li>高可用、高性能。</li>
</ol>
<h3 id="go-redsyn">go-redsyn</h3>
<p>Redsync 为 Go 提供了基于 Redis 的分布式互斥锁实现
安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ go get github.com/go-redsync/redsync/v4
</code></pre></div><p>例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">goredislib</span> <span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redsync/redsync/v4&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redsync/redsync/v4/redis/goredis/v8&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//使用go-redis(或redigo)创建一个池，该池是redisync will
</span><span style="color:#75715e">//在与Redis通信时使用这也可以是任何一个池子
</span><span style="color:#75715e">//实现&#39; redis. properties &#39;池的接口。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">goredislib</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">goredislib</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>: <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
	})
    
    <span style="color:#75715e">//redis集群
</span><span style="color:#75715e">//client := goredislib.NewClusterClient(&amp;goredislib.ClusterOptions{        //Addr: []string{&#34;localhost:6379&#34;},    })
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">pool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">goredis</span>.<span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">client</span>) <span style="color:#75715e">// or, pool := redigo.NewPool(...)
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//创建redisync实例，用于获得互斥锁。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">pool</span>)

	<span style="color:#75715e">//为所有需要互斥对象的实例使用相同的名称来获取一个新的互斥对象
</span><span style="color:#75715e">//相同的锁。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutexname</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;my-global-mutex&#34;</span>
	<span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>)

	<span style="color:#75715e">//获取互斥锁在这个成功之后，没有其他人
</span><span style="color:#75715e">//可以获得相同的锁(相同的互斥锁名)，直到我们解锁它。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">//做你需要锁的工作。
</span><span style="color:#75715e"></span>    
<span style="color:#75715e">//释放锁，以便其他进程或线程可以获得锁。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>(); !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#e6db74">&#34;unlock failed&#34;</span>)
	}
}
</code></pre></div><h3 id="实现原理">实现原理</h3>
<h4 id="加锁">加锁</h4>
<p>在New一个互斥锁mutex后，通过mutex.Lock()加锁，查看源码实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">acquire</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pool</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetNX</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expiry</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>可见，是通过Redis命令Setnx操作来实现。</p>
<p><strong>Redis Setnx（SET if Not eXists） 命令在指定的 key 不存在时，为 key 设置指定的值。设置成功，返回 1 。 设置失败，返回 0 。相对于Set，Setnx具有原子性。</strong></p>
<h4 id="释放锁">释放锁</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">release</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pool</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Eval</span>(<span style="color:#a6e22e">deleteScript</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">value</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> int64(<span style="color:#ae81ff">0</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deleteScript</span> = <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewScript</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">`
</span><span style="color:#e6db74">	if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span><span style="color:#e6db74">		return redis.call(&#34;DEL&#34;, KEYS[1])
</span><span style="color:#e6db74">	else
</span><span style="color:#e6db74">		return 0
</span><span style="color:#e6db74">	end
</span><span style="color:#e6db74">`</span>)
</code></pre></div><p>可见，Redis使用Lua脚本命令来Delete Key操作。</p>
<p><strong>这里需要关注到Del的时候，需要传入value，value是在加锁时设置的随机唯一值。在删除前进行校验value是否一致，防止误删</strong>。</p>
<h4 id="锁超时-防死锁">锁超时-防死锁</h4>
<p>如果持有锁的系统宕机、异常了导致没法release锁，那么其他方就无法活动该锁，导致死锁。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewMutex returns a new distributed mutex with given name.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Redsync</span>) <span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Mutex</span>{
		<span style="color:#a6e22e">name</span>:   <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">expiry</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
		<span style="color:#a6e22e">tries</span>:  <span style="color:#ae81ff">32</span>,
		<span style="color:#a6e22e">delayFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">tries</span> <span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">maxRetryDelayMilliSec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">minRetryDelayMilliSec</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">minRetryDelayMilliSec</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>
		},
		<span style="color:#a6e22e">genValueFunc</span>:  <span style="color:#a6e22e">genValue</span>,
		<span style="color:#a6e22e">driftFactor</span>:   <span style="color:#ae81ff">0.01</span>,
		<span style="color:#a6e22e">timeoutFactor</span>: <span style="color:#ae81ff">0.05</span>,
		<span style="color:#a6e22e">quorum</span>:        len(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pools</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">pools</span>:         <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pools</span>,
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">o</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">options</span> {
		<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">m</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}
</code></pre></div><p>可见，Mutex.expiy 设置了超时时间，默认为8秒，可以通过Option修改超时时间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// WithExpiry can be used to set the expiry of a mutex to the given value.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">expiry</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#a6e22e">Option</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">OptionFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) {
		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expiry</span> = <span style="color:#a6e22e">expiry</span>
	})
}
</code></pre></div><p>Example（设置超时时间、重复加锁）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//设置锁超时3秒
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>,<span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
    <span style="color:#75715e">//重复加锁
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>

<span style="color:#a6e22e">panic</span>: <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">already</span> <span style="color:#a6e22e">taken</span>, <span style="color:#a6e22e">locked</span> <span style="color:#a6e22e">nodes</span>: [<span style="color:#ae81ff">0</span>]
</code></pre></div><p>Example（设置超时时间、超时释放锁）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//设置锁超时10秒
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mutex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">NewMutex</span>(<span style="color:#a6e22e">mutexname</span>,<span style="color:#a6e22e">redsync</span>.<span style="color:#a6e22e">WithExpiry</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
    <span style="color:#75715e">//11秒后锁超时，释放
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">11</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
    <span style="color:#75715e">//重复加锁但已释放、无异常
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
</code></pre></div><h3 id="总结">总结</h3>
<p>本文主要介绍分布式锁的基础概念、特性互斥性、防死锁、高可用高性能。以及golang基于redis，使用go-redsync库实现分布式锁。通过例子简单介绍go-redsync的入门使用，以及通过源码阅读来刨析简介实现原理： 1.利用Redis Setnx原子性实现互斥性 ，2.利用Redis执行lua脚本、检查value值避免误删操作， 3.通过设置ExpiryOption设置超时时间，实现锁超时、避免死锁。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://redis.io/docs/manual/patterns/distributed-locks/">redis.io/docs 使用 Redis 的分布式锁</a></li>
<li><a href="https://github.com/go-redsync/redsync">redsync</a></li>
<li><a href="https://www.modb.pro/db/531964/">redsync源码介绍</a></li>
<li><a href="https://mp.weixin.qq.com/s/k_dX2HF8hTf6XseeeXYivg">redis go实现方式</a></li>
<li><a href="https://xiaorui.cc/archives/3028">峰云 -redigo实现</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/01/go%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/12/golang-linters%E8%81%9A%E5%90%88%E5%99%A8golangci-lint/" aria-label="">
      
          Golang Linters聚合器golangci Lint
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-12-18T17:23:05&#43;08:00">
        
   18, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍go实现lint和golangci-lint使用。</p>
<h3 id="what">what</h3>
<p>linter为静态代码检查、分析工具，golang常见的有govet\golint\errcheck 等。通过工具其一，可以提前发现一些语法问题，比如变量作用域问题、数组下标越界、内存泄露等；其二可以根据团队规范定制lint规则，提升可读性，可维护性。</p>
<p>golang的linters比较多，比如 <a href="https://github.com/golangci/awesome-go-linters">awesome-go-linters</a>中 golint检查变量、函数名、注释等。errcheck为未检查错误等。golangci-lint是一个 Go linters 聚合器，通过配置来选择需要的linters。其特征如下：</p>
<ul>
<li>⚡非常快:并行运行linters，重用Go构建缓存和缓存分析结果。</li>
<li>⚙️基于yaml的配置</li>
<li>🖥集成VS Code, Sublime Text, GoLand, GNU Emacs, Vim, Atom, GitHub动作。</li>
<li>🥇包含了很多linters，不需要安装它们。</li>
<li>📈由于调优的默认设置导致的最小误报数。</li>
<li>🔥漂亮的输出颜色，源代码行和标记的标识符。</li>
</ul>
<h3 id="install">install</h3>
<h4 id="mac">mac</h4>
<p>macOS你可以使用brew在macOS上安装二进制版本:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew install golangci-lint
brew upgrade golangci-lint
</code></pre></div><h4 id="install-from-source">Install from Source</h4>
<p>源码安装:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&gt; go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.50.1
</code></pre></div><p>查看安装是否成功：</p>
<pre tabindex="0"><code>&gt;golangci-lint --version
&gt;golangci-lint has version v1.50.1 built from (unknown, mod sum: &quot;h1:C829clMcZXEORakZlwpk7M4iDw2XiwxxKaG504SZ9zY=&quot;) on (unknown)
</code></pre><h3 id="how">how</h3>
<p>GolangCI-Lint 可以零配置使用。默认情况下启用以下 linters</p>
<pre tabindex="0"><code>&gt;golangci-lint help linters
&gt;Enabled by default linters:
errcheck: Errcheck is a program for checking for unchecked errors in go programs. These unchecked errors can be critical bugs in some cases [fast: false, auto-fix: false]
gosimple (megacheck): Linter for Go source code that specializes in simplifying code [fast: false, auto-fix: false]
govet (vet, vetshadow): Vet examines Go source code and reports suspicious constructs, such as Printf calls whose arguments do not align with the format string [fast: false, auto-fix: false]
ineffassign: Detects when assignments to existing variables are not used [fast: true, auto-fix: false]
staticcheck (megacheck): It's a set of rules from staticcheck. It's not the same thing as the staticcheck binary. The author of staticcheck doesn't support or approve the use of staticcheck as a library inside golangci-lint. [fast: false, auto-fix: false]
typecheck: Like the front-end of a Go compiler, parses and type-checks Go code [fast: false, auto-fix: false]
unused (megacheck): Checks Go code for unused constants, variables, functions and types [fast: false, auto-fix: false]
</code></pre><p>如何执行golangci-lint呢？在需要执行的项目目录下：</p>
<pre tabindex="0"><code>golangci-lint run
</code></pre><p>这相当于执行</p>
<pre tabindex="0"><code>golangci-lint run ./...
</code></pre><p>您可以选择要分析的目录和文件:</p>
<pre tabindex="0"><code>golangci-lint run dir1 dir2/... dir3/file1.go
</code></pre><p>接着，我们创建一个Example代码：linter_example.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">People</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">People</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;print: %v&#34;</span>, <span style="color:#a6e22e">p</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">People</span>{}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">String</span>()
}


</code></pre></div><p>执行lint，如果没有相关的配置文件，会走默认的lint配置</p>
<pre tabindex="0"><code>&gt; golangci-lint run
level=warning msg=&quot;[runner] The linter 'golint' is deprecated (since v1.41.0) due to: The repository of the linter has been archived b
y the owner.  Replaced by revive.&quot;
linter_example.go:5:6: exported type `People` should have comment or be unexported (golint)
type People struct {
     ^
linter_example.go:10:9: printf: fmt.Sprintf format %v with arg p causes recursive (*demos/linter-demo.People).String method call (gove
t)
        return fmt.Sprintf(&quot;print: %v&quot;, p)
               ^
linter_example.go:15:10: unusedresult: result of (*demos/linter-demo.People).String call not used (govet)
        p.String()
                ^

</code></pre><p>我们可以根据lint提示修改</p>
<pre tabindex="0"><code> printf: fmt。Sprintf格式%v与arg p导致递归( demos/ lininter -demo. people)。字符串方法调用(govet)。
</code></pre><p>在使⽤  fmt 包中的打印⽅法时，如果类型实现了这个接⼝，会直接调⽤。⽽中打印  p 的时候会直接调⽤  p 实现的  String() ⽅法，然后就产⽣了循环调⽤。</p>
<h4 id="custom-configuration">Custom Configuration</h4>
<p>GolangCI-Lint  通过当前工作目录的以下路径中增加配置文件：</p>
<ul>
<li>.golangci.yml</li>
<li>.golangci.yaml</li>
<li>.golangci.toml</li>
<li>.golangci.json</li>
</ul>
<p>来实现自定义linters</p>
<p>例如我们添加了.golangci.yml</p>
<pre tabindex="0"><code>run:
  timeout: 5m
  modules-download-mode: readonly

linters:
  disable-all: true
  enable: # 下面是开启的lint列表
    - errcheck
    - goimports
    - golint
   # - govet 为了测试是否生效，关闭
    - staticcheck

linters-settings:
  golint:
    # minimal confidence for issues, default is 0.8
    min-confidence: 0.8

issues:
  exclude-use-default: false
  max-issues-per-linter: 0
  max-same-issues: 0
</code></pre><p>这里我们把govet 关闭了，在执行run</p>
<pre tabindex="0"><code>golangci-lint run
level=warning msg=&quot;[runner] The linter 'golint' is deprecated (since v1.41.0) due to: The repository of the linter has been archived b
y the owner.  Replaced by revive.&quot;
linter_example.go:5:6: exported type `People` should have comment or be unexported (golint)
type People struct {
     ^
</code></pre><p>可见关闭govet生效了。</p>
<h3 id="reference">reference</h3>
<ul>
<li>golangci-lint  <a href="https://github.com/golangci/golangci-lint">https://github.com/golangci/golangci-lint</a></li>
<li>golangci-lint doc <a href="https://golangci-lint.run/">https://golangci-lint.run/</a></li>
<li>lint  <a href="https://github.com/golang/lint">https://github.com/golang/lint</a></li>
<li>awesome-go-linters <a href="https://github.com/golangci/awesome-go-linters">https://github.com/golangci/awesome-go-linters</a></li>
<li>bolg gocn  <a href="https://mp.weixin.qq.com/s/kNh0TP59fCFJhbmr-YMz4Q">https://mp.weixin.qq.com/s/kNh0TP59fCFJhbmr-YMz4Q</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/12/golang-linters%E8%81%9A%E5%90%88%E5%99%A8golangci-lint/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/12/go%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/" aria-label="">
      
          Go浅拷贝与深拷贝
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-12-04T16:44:31&#43;08:00">
        
   4, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍Go实现浅拷贝和深拷贝，以及工具库mohae/deepcopy。</p>
<h3 id="定义">定义</h3>
<blockquote>
<p>浅拷贝是按位拷贝对象，它会创建一个新对象，这个对象有着原始对象属性值的一份精确拷贝。如果属性是基本类型，拷贝的就是基本类型的值；如果属性是内存地址（引用类型），拷贝的就是内存地址 ，因此如果其中一个对象改变了这个地址，就会影响到另一个对象。即默认拷贝构造函数只是对对象进行浅拷贝复制(逐个成员依次拷贝)，即只复制对象空间而不复制资源</p>
</blockquote>
<blockquote>
<p>深拷贝是指源对象与拷贝对象互相独立，其中任何一个对象的改动都不会对另外一个对象造成影响。比较典型的就是Value（值）对象，如预定义类型Int32，Double，以及结构（struct），枚举（Enum）等</p>
</blockquote>
<h3 id="浅拷贝">浅拷贝</h3>
<p>go使用<strong>copy</strong>内置函数将源片中的元素复制到目标切片,如果拷贝的
结构中不包含指针是没问题，否则则数据源和拷贝之间对应指针会共同指向同一块内存。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">shallowCopyReference</span>() {
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{{<span style="color:#e6db74">&#34;Neymar&#34;</span>}, {<span style="color:#e6db74">&#34;Messi&#34;</span>}}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, len(<span style="color:#a6e22e">brazil</span>))
	copy(<span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">brazil</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %p\n&#34;</span>, <span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %p\n&#34;</span>, <span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">argentina</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %v, %p\n&#34;</span>, <span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p, %v, %p\n&#34;</span>, <span style="color:#a6e22e">argentina</span>, <span style="color:#a6e22e">argentina</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>[<span style="color:#ae81ff">0</span>])
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#ae81ff">0xc0000412e0</span>, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc000041310</span>, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc0000412e0</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412f0</span>
<span style="color:#ae81ff">0xc000041310</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412f0</span> 
</code></pre></div><p>如上，修改了src（拷贝原始结构）的指针对象，dst（拷贝目标结构）的值也被改动了，显然是不行的。</p>
<h3 id="深拷贝">深拷贝</h3>
<h4 id="方法一gobjson-序列化成字节序列再反序列化生成克隆对象">方法一：gob、json 序列化成字节序列再反序列化生成克隆对象</h4>
<ul>
<li>gob序列化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByGobExample</span>() {
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: <span style="color:#a6e22e">players</span>}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepCopyByGob</span>(<span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">argentina</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;deepcopy error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByGob</span>(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">src</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">buf</span>).<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Bytes</span>())).<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">dst</span>)
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000184ff0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000185330</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc000184ff0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000184ff0</span> 
</code></pre></div><ul>
<li>json序列化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepcopyByJsonExample</span>() {
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: <span style="color:#a6e22e">players</span>}
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepCopyByJson</span>(<span style="color:#a6e22e">brazil</span>, <span style="color:#a6e22e">argentina</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;deepcopy error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyByJson</span>(<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">dst</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tmp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">tmp</span>, <span style="color:#a6e22e">dst</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000041490</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
</code></pre></div><p>可以看到deepcopy出来的指针地址不一样，那么都dst的修改就不会影响到src了。</p>
<h4 id="方法二使用第三方工具库">方法二：使用第三方工具库</h4>
<p>DeepCopy对事物进行深度复制:未导出的字段值不会被复制。
feature:</p>
<ul>
<li>copy slice</li>
<li>copy map</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deepCopyExample</span>() {
	<span style="color:#a6e22e">brazil</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Team</span>{<span style="color:#a6e22e">Players</span>: append([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Neymar&#34;</span>}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Messi&#34;</span>})}
	<span style="color:#a6e22e">argentinaIfc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deepcopy</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">brazil</span>)
	<span style="color:#a6e22e">argentina</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">argentinaIfc</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Team</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v,%v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Anthony&#34;</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;brazil&#34;</span>, <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v, %v, %p\n&#34;</span>, <span style="color:#e6db74">&#34;argentina&#34;</span>, <span style="color:#a6e22e">argentina</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">brazil</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#ae81ff">0</span>])
}
<span style="color:#75715e">//output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">brazil</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>,<span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc000041330</span>
<span style="color:#a6e22e">brazil</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Anthony</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
<span style="color:#a6e22e">argentina</span>, <span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">Neymar</span>}, <span style="color:#ae81ff">0xc0000412e0</span>
</code></pre></div><h3 id="小结">小结</h3>
<p>浅拷贝是值的拷贝，如果属性是引用，拷贝的就是内存地址，需要使用深拷贝。深拷贝的实现原理本质上是通过反射实现。通过将源对象转换成接口，再对接口通过反射判断其类型。所以可以通过序列化成gob、json等来实现。工具库mohae/deepcopy可以对切片、map、结构体、接口进行深拷贝，是个不错的选择。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/mohae/deepcopy">modae/deepcopy</a></li>
<li><a href="https://juejin.cn/post/7143030425839992863">modae/deepcopy实现原理分析</a></li>
<li><a href="https://juejin.cn/post/7143030425839992863">go深拷贝常见方式及性能</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/12/go%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/go%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7-%E7%BB%98%E5%88%B6%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E5%92%8C%E4%BE%9D%E8%B5%96/" aria-label="">
      
          Go可视化工具 绘制项目代码结构和依赖
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-27T12:24:50&#43;08:00">
        
   27, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>比较常见pprof 可以把调用栈可视化成调用图，embedded-struct-visualizer 可以把Go 的项目的代码分层结构和依赖都可视化成流程图。</p>
<h3 id="安装-embedded-struct-visualizer">安装 embedded-struct-visualizer</h3>
<pre tabindex="0"><code> go install github.com/davidschlachter/embedded-struct-visualizer@latest
</code></pre><p>查看命令选项参数</p>
<pre tabindex="0"><code>embedded-struct-visualizer -h
Usage: [OPTIONS] DirToScan
If the directory to scan is not provided, it defaults to './'
OPTIONS:
  -out &lt;file&gt;  path to output file (default: write to stdout)
  -v           verbose logging
</code></pre><h3 id="example">Example</h3>
<p>以官方给的例子 main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">A</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">B</span>
	<span style="color:#a6e22e">C</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">D</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">E</span>, <span style="color:#a6e22e">F</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">G</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Timer</span> <span style="color:#a6e22e">H</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">D</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">I</span> <span style="color:#66d9ef">uint64</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">H</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Timer</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Ticker</span>
	<span style="color:#a6e22e">J</span>     <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">D</span>
}

</code></pre></div><p><strong>生成结构关系：</strong></p>
<pre tabindex="0"><code>&gt; embedded-struct-visualizer
digraph {
&quot;main.A&quot; -&gt; { &quot;main.B&quot; &quot;main.D&quot; };
&quot;main.B&quot; -&gt; { &quot;main.H&quot; };
&quot;main.H&quot; -&gt; { &quot;time.Ticker&quot; &quot;main.D&quot; };
}

</code></pre><p><strong>生成结构关系 并 输出到.gv 文件：</strong></p>
<pre tabindex="0"><code>&gt;embedded-struct-visualizer -out .\example.gv
&gt; ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        2022/11/27     10:54            112 example.gv
-a----        2022/11/26     22:06             31 go.mod
-a----        2022/11/26     22:07            208 main.go

</code></pre><p>项目目录下多出了example.gv ,具体内容如下</p>
<pre tabindex="0"><code>cat .\example.gv
digraph {
&quot;main.A&quot; -&gt; { &quot;main.B&quot; &quot;main.D&quot; };
&quot;main.B&quot; -&gt; { &quot;main.H&quot; };
&quot;main.H&quot; -&gt; { &quot;time.Ticker&quot; &quot;main.D&quot; };
</code></pre><h3 id="安装-graphviz">安装 graphviz </h3>
<blockquote>
<p>graphviz 是一种将结构信息表示为抽象图和网络的图的工具。</p>
</blockquote>
<p>接着，把生成的gv文件利用graphviz绘制的更美观。</p>
<p>首先下载安装:</p>
<blockquote>
<p><a href="https://graphviz.org/download/">https://graphviz.org/download/</a>
查看是否安装成功（Win）：</p>
</blockquote>
<pre tabindex="0"><code> dot -v
dot - graphviz version 7.0.2 (20221119.0110)
... &lt;为了不篇幅过长，省略一些细节&gt;
</code></pre><h3 id="利用graphviz绘图">利用graphviz绘图</h3>
<blockquote>
<p>dot  -Tformat[:renderer[:formatter]] -o 
将输出语言设置为支持的格式之一。默认情况下，生成带属性的点。</p>
</blockquote>
<p>接着把上一步生成的gv文件，生成PNG输出</p>
<pre tabindex="0"><code>dot -Tpng example.gv -o example.png
</code></pre><p>在项目目录下多出example.png
<img src="https://luckytking.github.io/images/embedded-struct-visualizer1.png" alt=""></p>
<p>接着，实用于一个相对复杂的Gin Engine的gv</p>
<ol>
<li>
<p>源码链接： <a href="https://github.com/gin-gonic/gin/blob/master/gin.go">https://github.com/gin-gonic/gin/blob/master/gin.go</a></p>
</li>
<li>
<p>生成的gv：</p>
</li>
</ol>
<pre tabindex="0"><code>embedded-struct-visualizer -out .\gin.gv
</code></pre><p>gin.gv 详细如下：</p>
<pre tabindex="0"><code class="language-gin.gv" data-lang="gin.gv">digraph {&quot;gin.mockWriter&quot; -&gt; { &quot;http.Header&quot; };&quot;binding.QueryTest&quot; -&gt; { &quot;binding.appkey&quot; };&quot;binding.FooBarStruct&quot; -&gt; { &quot;binding.FooStruct&quot; };&quot;binding.FooBarFileStruct&quot; -&gt; { &quot;binding.FooBarStruct&quot; 
&quot;multipart.FileHeader&quot; };&quot;binding.FooBarFileFailStruct&quot; -&gt; { &quot;binding.FooBarStruct&quot; 
&quot;multipart.FileHeader&quot; };&quot;binding.FooDefaultBarStruct&quot; -&gt; { &quot;binding.FooStruct&quot; };&quot;binding.FooStructUseNumber&quot; -&gt; { &quot;binding.any&quot; };&quot;binding.FooStructDisallowUnknownFields&quot; -&gt; { &quot;binding.any&quot; 
};&quot;binding.FooBarStructForTimeType&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeNotUnixFormat&quot; -&gt; { &quot;time.Time&quot; 
};&quot;binding.FooStructForTimeTypeNotFormat&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeFailFormat&quot; -&gt; { &quot;time.Time&quot; };&quot;binding.FooStructForTimeTypeFailLocation&quot; -&gt; { &quot;time.Time&quot; 
};&quot;binding.FooStructForMapType&quot; -&gt; { &quot;binding.any&quot; };&quot;binding.FooStructForIgnoreFormTag&quot; -&gt; { &quot;binding.string&quot; };&quot;binding.defaultValidator&quot; -&gt; { &quot;sync.Once&quot; 
&quot;validator.Validate&quot; };&quot;binding.structFull&quot; -&gt; { &quot;binding.&quot; &quot;time.Time&quot; 
&quot;binding.string&quot; };&quot;binding.S&quot; -&gt; { &quot;binding.S&quot; };&quot;binding.testFile&quot; -&gt; { &quot;binding.byte&quot; };&quot;binding.structNoValidationValues&quot; -&gt; { 
&quot;binding.substructNoValidation&quot; &quot;binding.int16&quot; 
&quot;binding.uint16&quot; &quot;time.Time&quot; &quot;binding.mapNoValidationSub&quot; 
&quot;binding.&quot; };&quot;binding.structNoValidationPointer&quot; -&gt; { 
&quot;binding.substructNoValidation&quot; &quot;binding.uint32&quot; 
&quot;binding.mapNoValidationSub&quot; &quot;binding.int8&quot; &quot;binding.int32&quot; 
&quot;binding.uint8&quot; &quot;binding.uint16&quot; &quot;binding.float64&quot; 
&quot;binding.map&quot; &quot;binding.int&quot; &quot;binding.int16&quot; &quot;binding.int64&quot; 
&quot;binding.float32&quot; &quot;time.Time&quot; &quot;binding.testInterface&quot; 
&quot;binding.uint&quot; &quot;binding.uint64&quot; &quot;binding.string&quot; };&quot;gin.Context&quot; -&gt; { &quot;url.Values&quot; &quot;gin.responseWriter&quot; 
&quot;gin.HandlersChain&quot; &quot;gin.any&quot; &quot;gin.errorMsgs&quot; 
&quot;gin.skippedNode&quot; &quot;sync.RWMutex&quot; &quot;gin.string&quot; 
&quot;http.SameSite&quot; &quot;http.Request&quot; &quot;gin.ResponseWriter&quot; 
&quot;gin.Params&quot; &quot;gin.Engine&quot; };&quot;gin.interceptedWriter&quot; -&gt; { &quot;gin.ResponseWriter&quot; 
&quot;bytes.Buffer&quot; };&quot;gin.Error&quot; -&gt; { &quot;gin.error&quot; &quot;gin.ErrorType&quot; &quot;gin.any&quot; };&quot;gin.onlyFilesFS&quot; -&gt; { &quot;http.FileSystem&quot; };&quot;gin.neuteredReaddirFile&quot; -&gt; { &quot;http.File&quot; };&quot;gin.RouteInfo&quot; -&gt; { &quot;gin.HandlerFunc&quot; };&quot;gin.Engine&quot; -&gt; { &quot;gin.RouterGroup&quot; &quot;gin.string&quot; 
&quot;render.HTMLRender&quot; &quot;gin.HandlersChain&quot; &quot;sync.Pool&quot; 
&quot;gin.methodTrees&quot; &quot;render.Delims&quot; &quot;template.FuncMap&quot; 
&quot;gin.uint16&quot; &quot;net.IPNet&quot; };&quot;gin.LoggerConfig&quot; -&gt; { &quot;gin.LogFormatter&quot; &quot;io.Writer&quot; 
&quot;gin.string&quot; };&quot;gin.LogFormatterParams&quot; -&gt; { &quot;http.Request&quot; &quot;time.Time&quot; 
&quot;time.Duration&quot; &quot;gin.any&quot; };&quot;render.Data&quot; -&gt; { &quot;render.byte&quot; };&quot;render.HTMLProduction&quot; -&gt; { &quot;template.Template&quot; 
&quot;render.Delims&quot; };&quot;render.HTMLDebug&quot; -&gt; { &quot;render.string&quot; &quot;render.Delims&quot; 
&quot;template.FuncMap&quot; };&quot;render.HTML&quot; -&gt; { &quot;template.Template&quot; &quot;render.any&quot; };&quot;render.JSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.IndentedJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.SecureJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.JsonpJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.AsciiJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.PureJSON&quot; -&gt; { &quot;render.any&quot; };&quot;render.MsgPack&quot; -&gt; { &quot;render.any&quot; };&quot;render.ProtoBuf&quot; -&gt; { &quot;render.any&quot; };&quot;render.Reader&quot; -&gt; { &quot;io.Reader&quot; };&quot;render.Redirect&quot; -&gt; { &quot;http.Request&quot; };&quot;render.String&quot; -&gt; { &quot;render.any&quot; };&quot;render.TOML&quot; -&gt; { &quot;render.any&quot; };&quot;render.XML&quot; -&gt; { &quot;render.any&quot; };&quot;render.YAML&quot; -&gt; { &quot;render.any&quot; };&quot;gin.responseWriter&quot; -&gt; { &quot;http.ResponseWriter&quot; };&quot;gin.RouterGroup&quot; -&gt; { &quot;gin.HandlersChain&quot; &quot;gin.Engine&quot; };&quot;protoexample.Test&quot; -&gt; { &quot;protoexample.int32&quot; 
&quot;protoexample.int64&quot; &quot;protoexample.TestOptionalGroup&quot; 
&quot;protoimpl.MessageState&quot; &quot;protoimpl.SizeCache&quot; 
&quot;protoimpl.UnknownFields&quot; &quot;protoexample.string&quot; };&quot;protoexample.Test_OptionalGroup&quot; -&gt; { 
&quot;protoimpl.MessageState&quot; &quot;protoimpl.SizeCache&quot; 
&quot;protoimpl.UnknownFields&quot; &quot;protoexample.string&quot; };&quot;gin.methodTree&quot; -&gt; { &quot;gin.node&quot; };&quot;gin.node&quot; -&gt; { &quot;gin.node&quot; &quot;gin.HandlersChain&quot; 
&quot;gin.nodeType&quot; };&quot;gin.nodeValue&quot; -&gt; { &quot;gin.HandlersChain&quot; &quot;gin.Params&quot; };&quot;gin.skippedNode&quot; -&gt; { &quot;gin.node&quot; &quot;gin.int16&quot; };}


</code></pre><ol start="3">
<li>绘制png</li>
</ol>
<pre tabindex="0"><code> dot -Tpng gin.gv -o gin.png
</code></pre><p><img src="https://luckytking.github.io/images/embedded-struct-visualizer-gin.png" alt="">
&lt;ps： 图片过大可下载预览&gt;</p>
<ul>
<li>graphviz guide优化: <a href="https://www.graphviz.org/pdf/dotguide.pdf">https://www.graphviz.org/pdf/dotguide.pdf</a></li>
</ul>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/davidschlachter/embedded-struct-visualizer">https://github.com/davidschlachter/embedded-struct-visualizer</a></li>
<li><a href="https://mp.weixin.qq.com/s/VGotQkmlnqFDNhmKuEBhwg">https://mp.weixin.qq.com/s/VGotQkmlnqFDNhmKuEBhwg</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/go%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7-%E7%BB%98%E5%88%B6%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E5%92%8C%E4%BE%9D%E8%B5%96/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" aria-label="">
      
          Golang使用RedisSortSets实现排行榜
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-30T15:43:28&#43;08:00">
        
   30, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="前言">前言</h3>
<p>游戏排行榜是一个常见需求，今天主要介绍go语言使用redis-sort-sets来实现排行榜常见功能。</p>
<h3 id="redis-sort-sets">Redis Sort Sets</h3>
<p>官方介绍：</p>
<blockquote>
<p>Redis排序集是按相关分数排序的惟一字符串(成员)的集合。当多个字符串具有相同的分数时，字符串将按字典顺序排列。排序集的一些用例包括:</p>
<p>游戏排行榜。例如，您可以使用排序集轻松地维护大型在线游戏中最高分数的有序列表。
速率限制器。特别是，您可以使用一个排序集来构建滑动窗口速率限制器，以防止过多的API请求。</p>
</blockquote>
<p>常用于排行榜的命令:</p>
<ul>
<li>ZRANGE 返回排序集的成员（升序）</li>
<li>ZREVANGE 返回排序集的成员（降序序）</li>
<li>ZADD 向排序集添加一个新成员和相关分数。如果成员已经存在，则更新评分。</li>
<li>ZREM 删除排序集一个成员</li>
<li>ZRANK 返回提供的成员的排名(升序)</li>
<li>ZREVRANK 返回提供的成员的排名(降序)</li>
</ul>
<h3 id="go-redis">Go Redis</h3>
<p>Go Redis为各种风格的Redis提供Go客户端，基础的使用例子如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	})
	<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
}
</code></pre></div><h3 id="examples">Examples</h3>
<p>这里我们用go-redis实现排行榜常见的功能，包括:</p>
<ul>
<li>获取排行榜成员和分数 （升序、降序）</li>
<li>加入排行榜成员</li>
<li>删除排行榜成员</li>
<li>更新排行榜成员分数</li>
<li>获取排行榜成员分数</li>
<li>获取排行榜名次成员</li>
<li>清空排行榜</li>
</ul>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	}) 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//增加玩家分数的变化
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
			<span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>)),
			<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">i</span>),
		}).<span style="color:#a6e22e">Err</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersWithScore</span>)

	<span style="color:#75715e">//查询排行榜成员-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRev</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-降序&#34;</span>, <span style="color:#a6e22e">membersRev</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//获取某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">user2Score</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZScore</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;获取某玩家 user:2 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//更新某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
		<span style="color:#a6e22e">Score</span>:  <span style="color:#a6e22e">user2Score</span>,
		<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:1&#34;</span>,
	}).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;更新某玩家 user:1 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜变化后的排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家  user:2 的排名&#34;</span>, <span style="color:#a6e22e">memberRank</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRevRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家 user:2 的排名-降序&#34;</span>, <span style="color:#a6e22e">memberRevRank</span>)

	<span style="color:#75715e">//删除排序集一个成员
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">zrem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRem</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:1&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除排序集一个成员&#34;</span>, <span style="color:#a6e22e">zrem</span>)

	<span style="color:#75715e">//删除后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)

	<span style="color:#75715e">//清空排行榜
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clear</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRemRangeByRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;err zrem&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空排行榜&#34;</span>, <span style="color:#a6e22e">clear</span>)
	<span style="color:#75715e">//清空后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>) 

</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>查询排行榜成员-升序 [user:3 user:4 user:1 user:5 user:2]
查询排行榜成员和分数-升序 [{87 user:2} {81 user:5} {81 user:1} {59 user:4} {47 user:3}]
查询排行榜成员-降序 [user:2 user:5 user:1 user:4 user:3]
查询排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:1} {81 user:5} {87 user:2}]
获取某玩家 user:2 的分数 87
更新某玩家 user:1 的分数 87
查询排行榜变化后的排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:5} {87 user:1} {87 user:2}]
查询排行榜某玩家  user:2 的排名 4
查询排行榜某玩家 user:2 的排名-降序 0
删除排序集一个成员 1
删除后查询排行榜成员-升序 [user:3 user:4 user:5 user:2]
清空排行榜 4
清空后查询排行榜成员-升序 []

</code></pre><h3 id="参考">参考</h3>
<ul>
<li>安装Redis <a href="https://redis.io/docs/getting-started/installation/">https://redis.io/docs/getting-started/installation/</a></li>
<li>Redis Sort Sets Docs <a href="https://redis.io/docs/data-types/sorted-sets/">https://redis.io/docs/data-types/sorted-sets/</a></li>
<li>Go Redis <a href="https://github.com/go-redis/redis/v9">https://github.com/go-redis/redis/v9</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" aria-label="">
      
          Go开发常用第三方库之ants
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-21T23:17:35&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>go语言提供非常方便的创建轻量级的协程goroutine来并发处理任务，但是 协程过多影响程序性能，所以，这时goroutine池就登场了。本文简要介绍ants goroutine 池的基本的使用方法。</p>
<h3 id="简介">简介</h3>
<p>ants是一个高性能的 goroutine 池，实现了对大规模 goroutine 的调度管理、goroutine 复用，允许使用者在开发并发程序的时候限制 goroutine 数量，复用资源，达到更高效执行任务的效果。 ants就是一个很多大厂广泛使用的goroute池。</p>
<p>官网地址</p>
<blockquote>
<p><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></p>
</blockquote>
<h3 id="功能">功能</h3>
<ul>
<li>自动调度海量的 goroutines，复用 goroutines</li>
<li>定期清理过期的 goroutines，进一步节省资源</li>
<li>提供了大量有用的接口：任务提交、获取运行中的 goroutine 数量、动态调整 Pool 大小、释放 Pool、重启 Pool</li>
<li>优雅处理 panic，防止程序崩溃</li>
<li>资源复用，极大节省内存使用量；在大规模批量并发任务场景下比原生 goroutine 并发具有更高的性能</li>
<li>非阻塞机制</li>
</ul>
<h3 id="quick-start">quick start</h3>
<p>使用 ants v1 版本:</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants</p>
</blockquote>
<p>使用 ants v2 版本 (开启 GO111MODULE=on):</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants/v2</p>
</blockquote>
<p>接下来看一下官方demo：实现一个计算大量整数和的程序</p>
<h3 id="newpool">NewPool</h3>
<p>NewPool生成ants池实例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoFunc</span>() {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()

	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>

	<span style="color:#75715e">//使用公共池。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#a6e22e">syncCalculateSum</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">demoFunc</span>()
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">syncCalculateSum</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Running</span>())
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks.\n&#34;</span>)
 }
</code></pre></div><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPool(size int,  options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.size  即池容量，即池中最多有 10 个 goroutine。
arg.Option  定制化 goroutine pool.</p>
</blockquote>
<ul>
<li>p.Submit向此池提交任务。</li>
<li>ants.Release关闭此池并释放工作队列。</li>
<li>defaultAntsPool 导入ants时初始化实例池。</li>
</ul>
<h3 id="newpoolwithfunc">NewPoolWithFunc</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#75715e">//使用带有函数的池
</span><span style="color:#75715e">//设置goroutine池的容量为10，过期时间为1秒。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	})
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#75715e">//逐个提交任务。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Invoke</span>(int32(<span style="color:#a6e22e">i</span>))
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks, result is %d\n&#34;</span>, <span style="color:#a6e22e">sum</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code class="language-shelll" data-lang="shelll">run with 1
run with 5
run with 11
run with 12
run with 13
run with 14
run with 7
...
run with 789
run with 809
running goroutines: 10
finish all tasks, result is 499500
</code></pre><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPoolWithFunc(size int, pf func(interface{}), options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.pf  即为执行任务的函数</p>
</blockquote>
<h3 id="优雅处理-panic">优雅处理 panic</h3>
<p>测试一些当任务触发panic的情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;panic from task:%d&#34;</span>, <span style="color:#a6e22e">n</span>)))
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}
</code></pre></div><p>output：</p>
<pre tabindex="0"><code>run with 3
run with 13
...
run with 999
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:6
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:0
2022/10/21 21:41:07 worker with func exits from panic: goroutine 14 [running]:
</code></pre><p>可以看到，main routine 没有因此受影响。</p>
<h3 id="options">Options</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Options包含实例化ants池时将应用的所有选项。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ExpiryDuration is a period for the scavenger goroutine to clean up those expired workers,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the scavenger scans all workers every `ExpiryDuration` and clean up those workers that haven&#39;t been
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used for more than `ExpiryDuration`.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExpiryDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#75715e">// PreAlloc indicates whether to make memory pre-allocation when initializing Pool.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreAlloc</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Max number of goroutine blocking on pool.Submit.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 0 (default value) means no such limit.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxBlockingTasks</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// When Nonblocking is true, Pool.Submit will never be blocked.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ErrPoolOverload will be returned when Pool.Submit cannot be done at once.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// When Nonblocking is true, MaxBlockingTasks is inoperative.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Nonblocking</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// PanicHandler is used to handle panics from each worker goroutine.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if nil, panics will be thrown out again from worker goroutines.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicHandler</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// Logger is the customized logger for logging info, if it is not set,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// default standard logger from log package is used.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">Logger</span>
}
</code></pre></div><p>比如 PanicHandler 遇到 panic会调用这里设置的处理函数,以上例中，我们遇到偶数会触发panic，修改NewPool函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">WithPanicHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;panic recover %v&#34;</span>, <span style="color:#a6e22e">i</span>)
	}))
</code></pre></div><p>out：</p>
<pre tabindex="0"><code>panic recover panic from i:992run with 880
panic recover panic from i:880run with 972
panic recover panic from i:972run with 994
run with 991
</code></pre><p>还有更多关于 Benchmarks 性能报告，可参考https://github.com/panjf2000/ants</p>
<h3 id="参考">参考：</h3>
<ul>
<li><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></li>
<li><a href="https://darjun.github.io/2021/06/03/godailylib/ants/">https://darjun.github.io/2021/06/03/godailylib/ants/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" aria-label="">
      
          浅谈kratos的表现层源码实现与解码器
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-02T17:25:55&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前后端数据常用传输格式有：json、xml 和 proto等，不管是mvc还是ddd，都会在表现层的对不同的格式进行转化下层依赖所需的类、Object、 aggregate等。</p>
<h2 id="kratos-表现层">Kratos 表现层</h2>
<p>在实际开发场景中，前后端传输采用json。 但kratos使用proto定义Api， 那么我们以一个Http请求为例，来看看kratos的表现层是如何处理的。</p>
<p>以下是一个Kratos-Example，由编写好的proto文件，proto-go 等自动生成表现层的代码。 大概步骤：</p>
<ol>
<li>编写proto，包括Service，Req，Reply</li>
<li>生成表现层代码</li>
<li>实现下层逻辑等</li>
</ol>
<p>Example完整代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>可以看到：</p>
<ol>
<li>这里对具体的格式无感，输入In还是输出Out都是一个proto生成的类。</li>
<li>具体的实现交给了ctx 上下文去实现
查看 ctx.Result的源码:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Result</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">code</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">enc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">v</span>)
}
</code></pre></div><p>这里的enc，没有特殊设置，使用默认的DefaultResponseEncoder，部分源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultResponseEncoder</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CodecForRequest</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;Accept&#34;</span>)
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ContentType</span>(<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Name</span>()))
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>通过codc接口隔离具体实现，调用接口的 codec.Marshal序列化。</p>
<h2 id="codec包">codec包</h2>
<p>Codec定义Transport用于编码和解码消息的接口。它的实现包括 json，xml，proto，yaml等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Codec</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Marshal returns the wire format of v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">// Unmarshal parses the wire format into v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">// Name returns the name of the Codec implementation. The returned string
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will be used as part of content type in transmission.  The result must be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// static; the result cannot change between calls.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>这里我们聚焦正在使用的Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">codec</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">codec</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshaler</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MarshalJSON</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	}
}
</code></pre></div><p>这里Marshal()使用第三方库“&ldquo;google.golang.org/protobuf/encoding/protojson&rdquo;</p>
<p>实现proto转json。</p>
<h2 id="protojson第三方包">protojson第三方包</h2>
<p>protojson是Google提供的proto和json的转化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">api_test</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;google.golang.org/protobuf/encoding/protojson&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;helloworld/api/helloworld/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestToJson</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">HelloReply</span>{
		<span style="color:#a6e22e">Message</span>: <span style="color:#e6db74">&#34;Jobs&#34;</span>,
	}
	<span style="color:#a6e22e">replyJson</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">ProtoReflect</span>().<span style="color:#a6e22e">Interface</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Marshal Error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;replyJson:  %v&#34;</span>, string(<span style="color:#a6e22e">replyJson</span>))
}
</code></pre></div><p>更多的接口请参考“https://google.golang.org/protobuf/encoding/protojson”</p>
<h2 id="小结">小结</h2>
<p>本文主要以kratos的表现层的组织方式，来介绍常用的框架表现层处理方式。
其中：</p>
<ul>
<li>kratos通过proto来生成表现层代码的类，包括http和grapc，内部对具体实现无感。</li>
<li>kratos通过解码器codec实现不同传输格式的解耦。</li>
<li>第三方包protojson实现proto和json转换。</li>
</ul>
<p>框架的主要功能之一就是标准化处理一下公共的问题场景,从源码中可以学习：通过接口隔离具体的实现，而使框架与具体实现解耦,且具备更好的拓展性。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://go-kratos.dev/docs/getting-started/usage">https://go-kratos.dev/docs/getting-started/usage</a></li>
<li><a href="https://google.golang.org/protobuf/encoding/protojson">https://google.golang.org/protobuf/encoding/protojson</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/categories/go/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


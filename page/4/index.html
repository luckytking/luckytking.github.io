<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="jefffff&#39;s Blog">
<meta name="twitter:title" content="jefffff&#39;s Blog">
<meta property="og:url" content="https://luckytking.github.io/">
<meta property="twitter:url" content="https://luckytking.github.io/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>jefffff&#39;s Blog</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/go-corntab/" aria-label="">
      
          Go Corntab
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-17T18:44:07&#43;08:00">
        
   17, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍golang 使用crontab实现定时任务。</p>
<h3 id="linux-crontab">linux crontab</h3>
<p>Linux crontab 是用来定期执行程序的命令。当安装完成操作系统之后，默认便会启动此任务调度命令</p>
<p>命令语法：</p>
<blockquote>
</blockquote>
<p>crontab [ -u user ] file</p>
<p>crontab [ -u user ] { -l | -r | -e }</p>
<pre tabindex="0"><code>*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    +----- 星期中星期几 (0 - 6) (星期天 为0)
|    |    |    +---------- 月份 (1 - 12) 
|    |    +--------------- 一个月中的第几天 (1 - 31)
|    +-------------------- 小时 (0 - 23)
+------------------------- 分钟 (0 - 59)
</code></pre><h3 id="go-cron">go cron</h3>
<p>第三方包“github.com/robfig/cron”来创建 crontab，以实现定时任务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>()
		<span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * &#34;</span>
		<span style="color:#a6e22e">count</span> = <span style="color:#ae81ff">0</span>
	)

	<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;count: &#34;</span>, <span style="color:#a6e22e">count</span>,<span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>())
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error : %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">entityID</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cronS</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">select</span> {}
}

</code></pre></div><p>go run main.go</p>
<p>输出：</p>
<pre tabindex="0"><code>count:  1 now: 1658053860
count:  2 now: 1658053920
count:  3 now: 1658053980
count:  4 now: 1658054040
count:  5 now: 1658054100

</code></pre><p>可以看到每隔1分钟，执行一次Func，count++</p>
<p>默认情况下标准 cron 规范解析（第一个字段是“分钟”)
可以轻松选择进入秒字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cronS</span> = <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>())
<span style="color:#75715e">//注意这里多了一个参数
</span><span style="color:#75715e"></span><span style="color:#a6e22e">spec</span>  = <span style="color:#e6db74">&#34;*/2 * * * * * &#34;</span>
</code></pre></div><p>执行输出</p>
<pre tabindex="0"><code>count:  1 now: 1658053640
count:  2 now: 1658053642
count:  3 now: 1658053644
count:  4 now: 1658053646
count:  5 now: 1658053648 

</code></pre><p>可以看到每隔两秒执行一次</p>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/go-corntab/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9Fgrafanaloki-%E4%BA%8C%E6%94%B6%E9%9B%86%E6%9C%AC%E5%9C%B0docker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97/" aria-label="">
      
          日志聚合系统GrafanaLoki  二、收集本地docker容器日志
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-09T17:52:50&#43;08:00">
        
   9, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/devops">DevOps</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>上篇<a href="https://luckytking.github.io/2022/07/%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9Fgrafanaloki-%E4%B8%80%E5%88%9D%E8%AF%95/">传送门</a>介绍和搭建 GrafanaLoki，今天学习实战收集dockers容器的日志。</p>
<p>Grafana Loki 支持以下官方客户端发送日志：</p>
<ul>
<li>Promtail</li>
<li>Docker Driver</li>
<li>Fluentd</li>
<li>Fluent Bit</li>
<li>Logstash</li>
<li>Lambda Promtail</li>
</ul>
<p>其中我们关注比较多是：</p>
<ul>
<li>Promtail 是运行 Kubernetes 时的首选客户端，因为您可以将其配置为自动从运行 Promtail 的同一节点上运行的 pod 中抓取日志</li>
<li>Docker Logging Driver  当使用 Docker 而不是 Kubernetes 时，应该使用 Loki 的 Docker 日志记录驱动程序，因为它会自动添加适合正在运行的容器的标签。</li>
</ul>
<h3 id="docker-driver">Docker Driver</h3>
<p>Grafana Loki 官方支持一个 Docker 插件，该插件将从 Docker 容器中读取日志并将它们发送到 Loki</p>
<h3 id="安装">安装</h3>
<p>在每台 Docker 主机安装插件</p>
<blockquote>
<p>docker plugin install grafana/loki-docker-driver:latest &ndash;alias loki &ndash;grant-all-permissions</p>
</blockquote>
<p>检查是否安装成功:</p>
<blockquote>
<p>docker plugin ls</p>
</blockquote>
<pre tabindex="0"><code>$ docker plugin ls
ID             NAME          DESCRIPTION           ENABLED
2aa05FooBar   loki:latest   Loki Logging Driver   true
</code></pre><p>插件的使用可以有两种方式：</p>
<ul>
<li>配置全局 daemon.json,收集此后创建的所有容器的日志。</li>
<li>运行容器时指定logging类型为loki</li>
</ul>
<p>这里我们采用第一种方式</p>
<h3 id="配置全局-daemonjson">配置全局 daemon.json</h3>
<blockquote>
<p>sudo vi /etc/docker/daemon.json</p>
</blockquote>
<pre tabindex="0"><code>{
    &quot;log-driver&quot;: &quot;loki&quot;,
    &quot;log-opts&quot;: {
        &quot;loki-url&quot;: &quot;http://127.0.0.1:3100/loki/api/v1/push&quot;
    }
}
</code></pre><p>重启docker服务</p>
<blockquote>
<p>sudo systemctl restart docker</p>
</blockquote>
<p>查看是否生效</p>
<blockquote>
<p>docker info</p>
</blockquote>
<pre tabindex="0"><code>$docker info
...
Logging Driver: loki
</code></pre><p>说明配置生效。</p>
<h3 id="测试">测试</h3>
<p>启动测试服务，打开grafana查看，数据源选择 “Loki”。
搜索选择 compose-service ，由于这边是使用docker-compose启动的服务。
选择 “你的测试服务”，显示如下。</p>
<p><img src="https://luckytking.github.io/images/loki-docker.png" alt=""></p>
<p>至此，已经成功收集docker的日志。</p>
<h3 id="小结">小结</h3>
<p>本篇主要介绍如何利用 Docker Driver插件和配置本地环境来收集dockers日志到loki。</p>
<h3 id="reference">reference</h3>
<ul>
<li><a href="https://grafana.com/docs/loki/latest/clients/">https://grafana.com/docs/loki/latest/clients/</a></li>
<li><a href="http://t.zoukankan.com/turingguo-p-13847003.html">http://t.zoukankan.com/turingguo-p-13847003.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9Fgrafanaloki-%E4%BA%8C%E6%94%B6%E9%9B%86%E6%9C%AC%E5%9C%B0docker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9Fgrafanaloki-%E4%B8%80%E5%88%9D%E8%AF%95/" aria-label="">
      
          日志聚合系统GrafanaLoki  一、初试
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-02T17:34:59&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/devops">DevOps</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>为了快速定位、排查问题的，那么需要一个日志聚合、搜索的工具或者系统。</p>
<h3 id="简介">简介</h3>
<blockquote>
<p>Loki是一个受普罗米修斯启发的水平可伸缩、高可用性、多租户日志聚合系统。它的设计是非常有效的成本和易于操作。它不索引日志的内容，而是为每个日志流设置一组标签。</p>
</blockquote>
<h3 id="相关组件">相关组件</h3>
<ul>
<li>Loki是主服务器，负责存储日志和处理查询。</li>
<li>Promtail是代理，负责收集日志并将其发送给 loki 。</li>
<li>Grafana用于 UI 展示。</li>
</ul>
<h3 id="部署">部署</h3>
<p>这里在Linux环境下，使用docker-compose的方式部署, 采集os的日志，主要分以下几个步骤：</p>
<ol>
<li>启动 loki 、promtail、grafana</li>
<li>配置日志收集方式</li>
<li>观测日志是否采集、聚合</li>
</ol>
<h4 id="启动-loki-promtailgrafana">启动 loki 、promtail、grafana</h4>
<p>在工作目录底下创建 docker-compose.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>

<span style="color:#f92672">networks</span>:
  <span style="color:#f92672">loki</span>:

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">loki</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/loki:latest</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;3100:3100&#34;</span>
    <span style="color:#f92672">command</span>: -<span style="color:#ae81ff">config.file=/etc/loki/local-config.yaml</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">loki</span>

  <span style="color:#f92672">promtail</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/promtail:latest</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">/var/log:/var/log</span>
    <span style="color:#f92672">command</span>: -<span style="color:#ae81ff">config.file=/etc/promtail/config.yml</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">loki</span>

  <span style="color:#f92672">grafana</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/grafana:latest</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;3000:3000&#34;</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">loki</span>
</code></pre></div><p>查看是否启动：</p>
<blockquote>
<p>docker-compose ls</p>
</blockquote>
<p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">smartgo$ docker-compose ls
NAME                STATUS              CONFIG FILES
xloki               running(3)          /home/smartgo/xloki/docker-compose.yaml
</code></pre></div><h4 id="配置数据源">配置数据源</h4>
<p>访问Grafana： yournode:3000
,选择数据源：<strong>Explore&ndash;DataSource</strong>
<img src="https://luckytking.github.io/images/loki_data_source1.png" alt="">
可以看到Grafana支持的数据源,点击选择  <strong>Loki</strong>
<img src="https://luckytking.github.io/images/loki_data_source2.png" alt="">
设置地址为：</p>
<blockquote>
<p>http://loki:3100</p>
</blockquote>
<p>保存即可,点击 <strong>SaveAndTest</strong> 
<img src="https://luckytking.github.io/images/loki_data_source3.png" alt=""></p>
<h4 id="观测日志是否采集聚合">观测日志是否采集、聚合</h4>
<p>搜索日志，选择数据源Loki，选择文件类型和文件路径，具体如下
<img src="https://luckytking.github.io/images/loki_output.png" alt=""></p>
<h3 id="小结">小结</h3>
<p>本文主要初步介绍日志聚合、搜索系统Loki，以及如何docker部署，Grafana配置，搜索日志。</p>
<h3 id="todo">ToDo</h3>
<ul>
<li>收集Dockers的日志</li>
<li>LogQL <a href="https://grafana.com/docs/loki/latest/logql/">https://grafana.com/docs/loki/latest/logql/</a></li>
</ul>
<h3 id="reference">reference</h3>
<ul>
<li>Loki Github： <a href="https://github.com/grafana/loki/">https://github.com/grafana/loki/</a></li>
<li>Loki DockerCompose 安装 <a href="https://grafana.com/docs/loki/latest/installation/docker/">https://grafana.com/docs/loki/latest/installation/docker/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9Fgrafanaloki-%E4%B8%80%E5%88%9D%E8%AF%95/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0locust-boomer%E4%B9%8B%E4%BA%8C/" aria-label="">
      
          性能测试平台（locust&#43;boomer）之二
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-23T21:53:01&#43;08:00">
        
   23, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>上一篇（<a href="https://luckytking.github.io/2022/06/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0locust-boomer%E4%B9%8B%E4%B8%80/">传送门</a>）介绍了测试平台 locust + boomer 的环境搭建，以及运行http压测用例，观测性能指数、图表。这篇接上篇，继续讲go boomer如何实现。</p>
<h4 id="setup">setup</h4>
<h5 id="install-the-master-branch">Install the master branch</h5>
<blockquote>
<p>$ go get github.com/myzhan/boomer</p>
</blockquote>
<h5 id="install-a-tagged-version-that-works-with-locust-160">Install a tagged version that works with locust 1.6.0</h5>
<blockquote>
<p>$ go get <a href="mailto:github.com/myzhan/boomer@v1.6.0">github.com/myzhan/boomer@v1.6.0</a></p>
</blockquote>
<h5 id="install-gomq">install gomq</h5>
<blockquote>
<p>$ go get -u github.com/zeromq/gomq</p>
</blockquote>
<h4 id="quick-start">quick start</h4>
<h5 id="run-master">run master</h5>
<p>创建python文件 workspace/dummy.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> Locust, TaskSet, task
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTaskSet</span>(TaskSet):
    <span style="color:#a6e22e">@task</span>(<span style="color:#ae81ff">20</span>)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>(self):
        <span style="color:#66d9ef">pass</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dummy</span>(Locust):
    task_set <span style="color:#f92672">=</span> MyTaskSet
</code></pre></div><p>运行：</p>
<blockquote>
<p>$ locust &ndash;master -f dummy.py
output：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$locust.main: Starting web interface at http://0.0.0.0:8089 <span style="color:#f92672">(</span>accepting connections from all network interfaces<span style="color:#f92672">)</span>
$locust.main: Starting Locust 2.9.1.dev23
</code></pre></div><h5 id="run-slave">run slave</h5>
<p>创建go文件 workspace/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span>(
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;github.com/myzhan/boomer&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">helloTask</span>() {
	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">HttpGet</span>(<span style="color:#e6db74">&#34;hello&#34;</span>)
	<span style="color:#a6e22e">elapsed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">RecordFailure</span>(<span style="color:#e6db74">&#34;http&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>, <span style="color:#a6e22e">elapsed</span>.<span style="color:#a6e22e">Nanoseconds</span>()<span style="color:#f92672">/</span>int64(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>), <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#66d9ef">return</span>
	}
    
<span style="color:#75715e">/*    Report your test result as a success, if you write it in locust, it will looks like this    events.request_success.fire(request_type=&#34;http&#34;, name=&#34;world&#34;, response_time=100, response_length=10)    */</span>
	<span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">RecordSuccess</span>(<span style="color:#e6db74">&#34;http&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>, <span style="color:#a6e22e">elapsed</span>.<span style="color:#a6e22e">Nanoseconds</span>()<span style="color:#f92672">/</span>int64(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>), int64(<span style="color:#ae81ff">10</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worldTask</span>() {
	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">HttpGet</span>(<span style="color:#e6db74">&#34;world&#34;</span>)
	<span style="color:#a6e22e">elapsed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">RecordFailure</span>(<span style="color:#e6db74">&#34;udp&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>, <span style="color:#a6e22e">elapsed</span>.<span style="color:#a6e22e">Nanoseconds</span>()<span style="color:#f92672">/</span>int64(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>), <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#66d9ef">return</span>
	} 
<span style="color:#75715e">/*  Report your test result as a failure, if you write it in locust, it will looks like this    events.request_failure.fire(request_type=&#34;udp&#34;, name=&#34;hello&#34;, response_time=100, exception=Exception(&#34;udp error&#34;))    */</span>
	<span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">RecordSuccess</span>(<span style="color:#e6db74">&#34;udp&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>, <span style="color:#a6e22e">elapsed</span>.<span style="color:#a6e22e">Nanoseconds</span>()<span style="color:#f92672">/</span>int64(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>), int64(<span style="color:#ae81ff">10</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">task1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">Task</span>{
		<span style="color:#75715e">// 同时跑多个 tasks 的时候，Weight 字段用于分配 goroutines
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Weight</span>: <span style="color:#ae81ff">10</span>,
		<span style="color:#a6e22e">Fn</span>:     <span style="color:#a6e22e">helloTask</span>,
	}

	<span style="color:#a6e22e">task2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">Task</span>{
		<span style="color:#a6e22e">Weight</span>: <span style="color:#ae81ff">10</span>,
		<span style="color:#a6e22e">Fn</span>:     <span style="color:#a6e22e">worldTask</span>,
	}

	<span style="color:#75715e">// 连接到 master，等待页面上下发指令，支持多个 Task
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">boomer</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">task1</span>, <span style="color:#a6e22e">task2</span>)
}


<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HttpGet</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;http://localhost:8090/%s&#34;</span>, <span style="color:#a6e22e">path</span>)
	<span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;GET&#34;</span>

	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>{}
	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">url</span>, <span style="color:#66d9ef">nil</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">body</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}


</code></pre></div><blockquote>
<p>go run main.go</p>
</blockquote>
<p>output</p>
<pre tabindex="0"><code>$ Boomer is built with gomq support.
$ Boomer is connected to master(tcp://127.0.0.1:5557) press Ctrl+c to quit.

</code></pre><p>说明启动slave成功，查看是否连接上master</p>
<pre tabindex="0"><code>$ locust.runners: Client 'crazyMac.local_axxbyy123456' reported as ready. Currently 1 clients ready to swarm.

</code></pre><p>说明已经连接上master
。</p>
<h4 id="testing">testing</h4>
<p>启动测试，output
<img src="https://luckytking.github.io/images/locust-boomer.png" alt=""></p>
<p>succeed</p>
<h4 id="小结">小结</h4>
<p>本文主要介绍了如何利用go boomer 实现locust的通讯协议，以及使用boomer实现一个上一篇的http压测例子。</p>
<h4 id="reference">reference</h4>
<ul>
<li>Locust Website: <a href="locust.io">locust.io</a></li>
<li>Locust Documentation: <a href="docs.locust.io">docs.locust.io</a></li>
<li>Boomer Documentation: <a href="boomer.readthedocs.io">boomer.readthedocs.io</a></li>
<li>Examples :<a href="https://github.com/myzhan/boomer/blob/master/_examples/default/main.go"> https://github.com/myzhan/boomer/blob/master/_examples/default/main.go</a></li>
<li>Dummy.py : <a href="https://www.cnblogs.com/Detector/p/11469233.html">https://www.cnblogs.com/Detector/p/11469233.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0locust-boomer%E4%B9%8B%E4%BA%8C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0locust-boomer%E4%B9%8B%E4%B8%80/" aria-label="">
      
          性能测试平台（locust&#43;boomer）之一
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-19T16:11:18&#43;08:00">
        
   19, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>最近公司打算对后端服务进行压力测试，考虑后端的主要使用golang实现，因此作者准备使用 locust + boomer 实现一个性能测试平台，mark一下实现过程。</p>
<h3 id="what-is-locust">what is locust</h3>
<blockquote>
<p>Locust 是一种易于使用、可编写脚本且可扩展的性能测试工具。
您可以在常规 Python 代码中定义用户的行为，而不是停留在 UI 或限制性特定领域的语言中。</p>
</blockquote>
<h3 id="what-is-boomer">what is boomer</h3>
<blockquote>
<p>boomer 完整地实现了 locust 的通讯协议，运行在 slave 模式下，用 goroutine 来执行用户提供的测试函数，然后将测试结果上报给运行在 master 模式下的 locust。</p>
<p><strong>与 locust 原生的实现相比，解决了两个问题</strong>。
一是单台施压机上，能充分利用多个 CPU 核心来施压，
二是再也不用提防阻塞 IO 操作导致 gevent 阻塞。</p>
</blockquote>
<h3 id="环境">环境</h3>
<ul>
<li>服务器
<ul>
<li>Ubuntu （2核4G300G）</li>
</ul>
</li>
<li>压测机
<ul>
<li>Mac</li>
<li>Python 版本 Python 3.10.2</li>
<li>Go 版本 go version go1.17.1 darwin/arm64</li>
</ul>
</li>
</ul>
<h3 id="压测机">压测机</h3>
<h4 id="安装-locust">安装 locust</h4>
<ol>
<li>安装python3.7或者版本大于3.7 （mac 自带python2.X版本）</li>
</ol>
<pre tabindex="0"><code>brew install python
</code></pre><p>查看安装版本</p>
<pre tabindex="0"><code># python3 -V
Python 3.10.2
</code></pre><ol start="2">
<li>Install Locust</li>
</ol>
<pre tabindex="0"><code># pip3 install locust
</code></pre><ol start="3">
<li>检查安装是否成功</li>
</ol>
<pre tabindex="0"><code># locust -V
locust 2.9.1.dev23
</code></pre><h4 id="运行-locust-hello-world">运行 locust: hello-world</h4>
<p>要把大象放冰箱一共分三步：第一步打开冰箱&ndash;，不不不，第一步：先试试把小象(hello-world)看看能不能放的进去</p>
<p>在当前目录 workspace/ 底下创建 locustfile.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloWorldUser</span>(HttpUser):
    <span style="color:#a6e22e">@task</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world</span>(self):
        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/hello&#34;</span>)
        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/world&#34;</span>)
</code></pre></div><h5 id="启动-locust"><strong>启动 locust</strong></h5>
<pre tabindex="0"><code> # locust
 locust 
$: Starting web interface at http://0.0.0.0:8089 (accepting connections from all network interfaces)
$: Starting Locust 2.9.1.dev23

</code></pre><p>访问 http://localhost:8089/ 可以看到
<img src="https://luckytking.github.io/images/locust-dashboard.png" alt=""></p>
<p>接着，这边使用golang启动一个http服务 localhost:80（path：/hello &amp; /world）</p>
<h5 id="locust---helloworld">locust - HelloWorld</h5>
<p>进行一个简单测试 50 个并发用户，加速速度为 1个用户/秒，将其指向响应/hello和的服务器/world
<img src="https://luckytking.github.io/images/locust-helloworld-test.png" alt=""></p>
<p>点击 &ldquo;start swarming&rdquo;
<img src="https://luckytking.github.io/images/locust-helloworld.png" alt=""></p>
<p>切换标签页 “Charts”
可以查看：显示每秒请求数 (RPS)
<img src="https://luckytking.github.io/images/locust-dashboard-rps.png" alt=""></p>
<p>查看：响应时间（以毫秒为单位） 
<img src="https://luckytking.github.io/images/locust-dashboard-responsetime.png" alt=""></p>
<p>查看： 用户数量
<img src="https://luckytking.github.io/images/locust-dashboard-user.png" alt=""></p>
<h4 id="小结">小结</h4>
<p>本文主要介绍性能测试平台 locust + boomer 的环境搭建，以及运行http 测试用例helloworld，使用locust观测性能指数、图表等。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://locust.io/">https://locust.io/</a></li>
<li><a href="https://github.com/myzhan/boomer">https://github.com/myzhan/boomer</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0locust-boomer%E4%B9%8B%E4%B8%80/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/%E5%9C%A8macm1%E4%B8%8A%E6%9E%84%E5%BB%BAx86%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84docker%E9%95%9C%E5%83%8F/" aria-label="">
      
          在MacM1上构建x86系统架构Docker镜像
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-09T21:52:17&#43;08:00">
        
   9, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/dockers">Dockers</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="问题">问题</h3>
<p>在mac m1 构建的docker镜像（image:v1.0），在ubuntu上面运行报错：</p>
<blockquote>
<p>smart-service | standard_init_linux.go:228: exec user process caused: exec format error</p>
</blockquote>
<pre tabindex="0"><code>$ uname -m
 arm64
</code></pre><p>由于m1是arm64架构,而ubuntu的是x86_64架构，那有没有可以在mac上面构建x86_64的镜像的方法呢？</p>
<h3 id="解决步骤">解决步骤</h3>
<p>在 Docker 19.03+ 版本中可以使用</p>
<pre tabindex="0"><code>$ docker buildx build
</code></pre><p>命令使用 BuildKit 构建镜像。该命令支持 &ndash;platform 参数可以同时构建支持多种系统架构的 Docker 镜像。
更多参考：</p>
<blockquote>
<p><a href="https://docs.docker.com/engine/reference/commandline/buildx/">https://docs.docker.com/engine/reference/commandline/buildx/</a></p>
</blockquote>
<h4 id="sep1--启用experimental-features">Sep1  启用experimental features</h4>
<p>Docker 的 buildx 还是实验性功能，需要在 Docker Desktop 设置中开启。</p>
<blockquote>
<p>Preferences &gt; Experimental Features &gt; Enable CLI experimental features</p>
</blockquote>
<h4 id="sep2--创建builder">Sep2  创建builder</h4>
<p>由于 Docker 默认的 builder 实例不支持同时指定多个 &ndash;platform，我们必须首先创建一个新的 builder 实例。</p>
<pre tabindex="0"><code>$ docker buildx create --use --name my_builder
</code></pre><p>国内环境使用:</p>
<ul>
<li>网易云镜像</li>
</ul>
<pre tabindex="0"><code>$ docker buildx create --use --name=mybuilder --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master
</code></pre><ul>
<li>百度云镜像</li>
</ul>
<pre tabindex="0"><code>$ docker buildx create --use --name=mybuilder --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-baidu
</code></pre><p>查看实例详情：</p>
<pre tabindex="0"><code>docker buildx inspect --bootstrap
</code></pre><p>output:</p>
<pre tabindex="0"><code>$ docker buildx inspect --bootstrap
[+] Building 4.9s (1/1) FINISHED
 =&gt; [internal] booting buildkit                           
 =&gt; =&gt; starting container buildx_buildkit_my_builder0     
Name:   my_builder
Driver: docker-container

Nodes:
Name:      my_builder0
Endpoint:  unix:///var/run/docker.sock
Status:    running
Platforms: linux/arm64, linux/amd64, linux/amd64/v2, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6
</code></pre><h4 id="sep3-构建">Sep3 构建</h4>
<p>使用 $ docker buildx build 命令构建镜像</p>
<blockquote>
<p>     docker buildx build <br>
      &ndash;platform linux/amd64,linux/arm64  &ndash;push -t  myusername:v2.0 .</p>
</blockquote>
<ul>
<li>&ndash;platfrom 不同的架构</li>
<li>&ndash;push   将构建好的镜像推送到 Docker 仓库</li>
</ul>
<p>构建完 push 上去以后，可以查看远程仓库的 manifest：</p>
<pre tabindex="0"><code> docker buildx imagetools inspect myusername:v2.0 
</code></pre><p>output:</p>
<pre tabindex="0"><code>$ docker buildx imagetools inspect myusername:v2.0 
Name:      myusername:v2.0 
MediaType: application/vnd.docker.distribution.manifest.list.v2+json
Digest:    sha256:c234123456XXXyyyy3a7123456XXXyyyyd28de6c376d2f123456XXXyyyy9edf2

Manifests:
  Name:      myusername:v2.0 @sha123456XXXyyyy777122
  MediaType: application/vnd.docker.distribution.manifest.v2+json
  Platform:  linux/amd64

  Name:      myusername:v2.0 @sha123456XXXyyyy777123
  MediaType: application/vnd.docker.distribution.manifest.v2+json
  Platform:  linux/arm64
</code></pre><p>显示已经支持不同架构</p>
<h4 id="sep4-测试">Sep4 测试</h4>
<p>在Ubuntu下（v2.0镜像）运行</p>
<pre tabindex="0"><code>Status: Downloaded newer image for 
myusername:v0.2
Recreating my-service ... done 
my-service | INFO msg=[HTTP] server listening on: [::]:8000

</code></pre><p>正常运行 Succeed</p>
<h3 id="总结">总结</h3>
<p>本文主要介绍 使用 buildx 构建多种系统架构支持的 Docker 镜像</p>
<h3 id="参考">参考：</h3>
<ul>
<li><a href="https://docs.docker.com/desktop/mac/apple-silicon/">https://docs.docker.com/desktop/mac/apple-silicon/</a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/buildx/">https://docs.docker.com/engine/reference/commandline/buildx/</a></li>
<li><a href="https://yeasy.gitbook.io/docker_practice/buildx/multi-arch-images">https://yeasy.gitbook.io/docker_practice/buildx/multi-arch-images</a></li>
<li><a href="https://prinsss.github.io/build-x86-docker-images-on-an-m1-macs">https://prinsss.github.io/build-x86-docker-images-on-an-m1-macs</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/%E5%9C%A8macm1%E4%B8%8A%E6%9E%84%E5%BB%BAx86%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84docker%E9%95%9C%E5%83%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" aria-label="">
      
          Redis实现对象存储和列表分页
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-06-05T16:23:04&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h2 id="场景">场景</h2>
<p>在项目开发中，需要用到缓存和对一个列表数据分页查询，但由于redis是key-value的存储方式，我们期望的使用类似postgresql的offset和limit，不至于需要一个个key遍历过去。</p>
<h2 id="设计">设计</h2>
<p>分析一下我们需求，那么需求需要实现的接口大概是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">FindByPage</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) ([]<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>大致我们需要解决两个问题:</p>
<ul>
<li>存储对象</li>
<li>列表分页快速查找</li>
</ul>
<h3 id="对象存储">对象存储</h3>
<blockquote>
<p>Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</p>
<ul>
<li>HDEL key field1 [field2]删除一个或多个哈希表字段</li>
<li>HEXISTS key field查看哈希表 key 中，指定的字段是否存在。</li>
<li>HGET key field获取存储在哈希表中指定字段的值。</li>
<li>HGETALL key获取在哈希表中指定 key 的所有字段和值</li>
</ul>
</blockquote>
<p>如此，我们可以 redis hash 和 json.Encoding 来存储。
获得一个Object</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//【ObjectID】= &#34;{&#34;foo&#34;: &#34;123&#34;, &#34;bar&#34;:&#34;456&#34;}&#34;
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span>  <span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>

<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HGet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">String</span>()).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">YourObject</span>{}
<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte(<span style="color:#a6e22e">result</span>), <span style="color:#a6e22e">obj</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><p>增加一个Object：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">ob</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">Object</span>{}<span style="color:#960050;background-color:#1e0010">）</span>) 
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">HSet</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">ob</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">ob</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
</code></pre></div><h3 id="分页">分页</h3>
<p>我们的需求中，ObjectID是一个唯一的int，那么可以使用 zset</p>
<blockquote>
<p>ZXyy redis 有序集合的基本命令。</p>
<ul>
<li>ZADD key score1 member1 [score2 member2]向有序集合添加一个或多个成员，或者更新已存在成员的分数</li>
<li>ZCARD key获取有序集合的成员数</li>
<li>ZRANGE key start stop [WITHSCORES]通过索引区间返回有序集合指定区间内的成员</li>
</ul>
</blockquote>
<p>那么可以把 zset 的key 和 value 都设置为 ObjectID
增加一个Object的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
     <span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>),
     <span style="color:#a6e22e">Member</span>: <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">Object</span>.<span style="color:#a6e22e">ID</span>)),
}).<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>获取X分页的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> (
     <span style="color:#a6e22e">start</span> = int64((<span style="color:#a6e22e">page</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">size</span>)
     <span style="color:#a6e22e">end</span>   = <span style="color:#a6e22e">start</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">size</span>)
)
<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">end</span>).<span style="color:#a6e22e">Result</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
     <span style="color:#66d9ef">return</span>
}
</code></pre></div><h3 id="测试">测试</h3>
<p>我们增加N个Object：</p>
<pre tabindex="0"><code>[1 a]
[2 b]
[3 c]
[11 aa]
[12 bb]
[13 cc]
[21 aaaa]
</code></pre><p>每页的长度为4，获取第一页</p>
<pre tabindex="0"><code>[1 2 3 11]
</code></pre><p>第二页：</p>
<pre tabindex="0"><code>[12 13 21]
</code></pre><p>第三页：</p>
<pre tabindex="0"><code>[ ]
</code></pre><h4 id="参考">参考</h4>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1802288">https://cloud.tencent.com/developer/article/1802288</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/06/redis%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/googlemeta%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%85%A5%E5%90%8E%E7%AB%AF%E9%AA%8C%E8%AF%81/" aria-label="">
      
          Google、meta第三方登入后端验证
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-29T16:01:18&#43;08:00">
        
   29, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要记录 Android app 第三方（google和meta/facebook)登入的后端(go)验证。</p>
<h2 id="android-sdk-接入流程">android sdk 接入流程</h2>
<p>可参考
<a href="https://juejin.cn/post/7094889100389384228">https://juejin.cn/post/7094889100389384228</a></p>
<h2 id="google">google</h2>
<p>官网链接: (<a href="https://developers.google.com/identity/sign-in/web/backend-auth">https://developers.google.com/identity/sign-in/web/backend-auth</a>)
官网推荐两中验证方式 ：</p>
<ol>
<li><strong>使用谷歌API客户端库</strong>，包括Java、Node.js、PHP、Python，是在生产环境中验证谷歌ID令牌的推荐方法。<strong>go客户端库</strong>：https://github.com/googleapis/google-api-go-client)</li>
<li><strong>调用谷歌API</strong>（https://oauth2.googleapis.com/tokeninfo?id_token=XYZ123）</li>
</ol>
<p>这里采用第一种，参考代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span> 
	<span style="color:#e6db74">&#34;google.golang.org/api/oauth2/v2&#34;</span>
	<span style="color:#e6db74">&#34;google.golang.org/api/option&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
   <span style="color:#75715e">// 从客户端获取的谷歌token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">googleToken</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`user token from client`</span>
	<span style="color:#a6e22e">oatuService</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">NewService</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">WithHTTPClient</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultClient</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { 
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">tokenInfoCall</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oatuService</span>.<span style="color:#a6e22e">Tokeninfo</span>()
	<span style="color:#a6e22e">tokenInfoCall</span>.<span style="color:#a6e22e">IdToken</span>(<span style="color:#a6e22e">googleToken</span>)
	<span style="color:#a6e22e">tokenInfo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tokenInfoCall</span>.<span style="color:#a6e22e">Do</span>() 
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { 
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">tokenInfo</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#a6e22e">tokenInfo</span>)
    <span style="color:#75715e">//可以拿客户端发送的id，和 tokenInfo.Id 做校验
</span><span style="color:#75715e"></span>}
</code></pre></div><h2 id="metafacebook-登入">meta(facebook) 登入</h2>
<p>meta 的验证和 google 类型，调用验证api</p>
<p>官网链接:</p>
<ol>
<li><strong>Android版本Facebook快速入门</strong>：https://developers.facebook.com/docs/facebook-login/android</li>
<li><strong>后端验证</strong> : (<a href="https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info">https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info</a>)</li>
</ol>
<p>请求格式：</p>
<pre tabindex="0"><code>GET /debug_token?
  input_token={session-info-token}&amp;
  access_token={your-access-token}
</code></pre><p><strong>go-api</strong> : <a href="https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info">https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#a6e22e">fb</span> <span style="color:#e6db74">&#34;github.com/huandu/facebook/v2&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
   <span style="color:#75715e">//客户端传递过来的 token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">inputToken</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;token from client&#34;</span>
	<span style="color:#a6e22e">globalApp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fb</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;developer-app-client-id&#34;</span>, <span style="color:#e6db74">&#34;develop-app-client-secret&#34;</span>)
    <span style="color:#75715e">//生成 access_token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">globalApp</span>.<span style="color:#a6e22e">AppAccessToken</span>()
	<span style="color:#a6e22e">session</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">globalApp</span>.<span style="color:#a6e22e">Session</span>(<span style="color:#a6e22e">token</span>)
	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;debug_token&#34;</span>, <span style="color:#a6e22e">fb</span>.<span style="color:#a6e22e">Params</span>{
		<span style="color:#e6db74">&#34;input_token&#34;</span>: <span style="color:#a6e22e">inputToken</span>,
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
}
</code></pre></div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://developers.google.com/identity/sign-in/web/backend-auth">https://developers.google.com/identity/sign-in/web/backend-auth</a></li>
<li><a href="https://github.com/googleapis/google-api-go-client">https://github.com/googleapis/google-api-go-client</a></li>
<li><a href="https://juejin.cn/post/7094889100389384228">https://juejin.cn/post/7094889100389384228</a></li>
<li><a href="https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info">https://developers.facebook.com/docs/facebook-login/guides/%20access-tokens/get-session-info</a></li>
<li><a href="https://github.com/huandu/facebook/v2">https://github.com/huandu/facebook/v2</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/googlemeta%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%85%A5%E5%90%8E%E7%AB%AF%E9%AA%8C%E8%AF%81/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" aria-label="">
      
          Go Copier简介
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-22T16:44:15&#43;08:00">
        
   22, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍 jinzhu/copier 的使用和常用场景</p>
<h2 id="简介">简介</h2>
<p>在go后端项目开发中，内部rpc服务返回的字段跟api服务相差无几，一个个赋值比较费事儿。那么就需要Object、List、HashMap 等进行值拷贝。jinzhu/copier即提供了这些场景的支持。</p>
<p><strong>copier 特性</strong>：</p>
<ul>
<li>从方法复制到具有相同名称的字段</li>
<li>从字段复制到具有相同名称的方法</li>
<li>从一个切片复制到另一个切片</li>
<li>从结构体复制到切片</li>
<li>从map复制到map</li>
<li>强制复制带有标记的字段</li>
<li>忽略带有标记的字段</li>
<li>深拷贝</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="copy-from-struct">Copy from struct</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/jinzhu/copier&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Role</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Age</span>          <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeCode</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// specify field name
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// Explicitly ignored in the destination struct.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//目标结构体中的标签提供了copy指令。复制忽略
</span><span style="color:#75715e">//或强制复制，如果字段没有被复制则惊慌或返回错误。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Employee</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//告诉copier。如果没有复制此字段，则复制到panic。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`copier:&#34;must&#34;`</span>

	<span style="color:#75715e">//告诉copier。 如果没有复制此字段，则返回错误。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Age</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`copier:&#34;must,nopanic&#34;`</span>

	<span style="color:#75715e">// 告诉copier。 显式忽略复制此字段。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Salary</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`copier:&#34;-&#34;`</span>

	<span style="color:#a6e22e">DoubleAge</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">EmployeeId</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`copier:&#34;EmployeeNum&#34;`</span> <span style="color:#75715e">// 指定字段名
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SuperRole</span>  <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyStruct</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">user</span>     = <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">200000</span>}
		<span style="color:#a6e22e">employee</span> = <span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">150000</span>}
	)
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employee</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employee</span>)
}
</code></pre></div><p>output：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">47</span>: <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">150000</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>} 

</code></pre></div><h3 id="copy-from-slice-to-slice">Copy from slice to slice</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopySlice</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">users</span>     = []<span style="color:#a6e22e">User</span>{{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">100000</span>}, {<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Role</span>: <span style="color:#e6db74">&#34;Dev&#34;</span>, <span style="color:#a6e22e">Salary</span>: <span style="color:#ae81ff">60000</span>}}
		<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	)
	<span style="color:#a6e22e">employees</span> = []<span style="color:#a6e22e">Employee</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">employees</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">employees</span>)
}<span style="color:#960050;background-color:#1e0010">`</span>

</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">57</span>: []<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;Jinzhu&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">18</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">36</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Admin&#34;</span>}, <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">Employee</span>{<span style="color:#a6e22e">Name</span>:<span style="color:#e6db74">&#34;jinzhu 2&#34;</span>, <span style="color:#a6e22e">Age</span>:<span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Salary</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">DoubleAge</span>:<span style="color:#ae81ff">60</span>, <span style="color:#a6e22e">EmployeeId</span>:<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">SuperRole</span>:<span style="color:#e6db74">&#34;Super Dev&#34;</span>}} 

</code></pre></div><h3 id="copy-from-map-to-map">Copy from Map to Map</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCopyMap</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">// Copy map to map
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">map1</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">3</span>: <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>: <span style="color:#ae81ff">8</span>}
	<span style="color:#a6e22e">map2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{}
	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">map2</span>, <span style="color:#a6e22e">map1</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%#v \n&#34;</span>, <span style="color:#a6e22e">map2</span>)
}
</code></pre></div><p>output :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">copier_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">66</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#66d9ef">int8</span>{<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">8</span>} 
</code></pre></div><h2 id="场景-1rpcapi">场景 1（rpc&amp;api）</h2>
<p>实际开发中，免不了服务间通讯，比较前文所说的场景，一个内部的rpc服务返回的参数和api服务差不多，那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//伪代码如下
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ApiLogin</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,<span style="color:#a6e22e">request</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>)(<span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)  {
	<span style="color:#a6e22e">grpcClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NewGameGrpcClient</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Login</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginRequest</span>{ 
					})
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LogingReply</span>.<span style="color:#a6e22e">User</span>{}
 	<span style="color:#a6e22e">copier</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">User</span>())
<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">LoginReply</span>{
	<span style="color:#a6e22e">User</span>:<span style="color:#a6e22e">user</span>,
},<span style="color:#a6e22e">err</span>

</code></pre></div><h2 id="场景-2-model-objectaggregate">场景 2 (model-object/aggregate)</h2>
<p>实际开发中，不管是mvc\ddd 都会有从model到object/aggreate的repository,那么就可以使用copier。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserRepo</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">int64</span>) (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>,<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">model</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">uid</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">obj</span><span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
	copy(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">obj</span>,<span style="color:#a6e22e">model</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">obj</span>,<span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="小结">小结</h2>
<p>copier提供不同类型之间相同的字段名，使用tag或者方法支持不同的字段名的赋值。减少一些重复的工作量,小巧实用。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/jinzhu/copier">https://github.com/jinzhu/copier</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/go-copier%E7%AE%80%E4%BB%8B/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/05/kratos%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AF%BB%E5%8F%96/" aria-label="">
      
          Kratos项目配置的定义和读取
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-05-14T22:18:53&#43;08:00">
        
   14, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要记录kratos项目配置的定义、读取和源码的学习</p>
<h2 id="at-first">at first</h2>
<p>服务在启动的基本都会用到配置文件，那么如果是你来写config工具库，它所能提供的功能是什么？</p>
<ol>
<li>读取不同场景的配置</li>
<li>读取不同格式的配置</li>
<li>支持热更</li>
<li>支持拓展，提供自定义实现</li>
</ol>
<h2 id="kratosconfig-有那些功能">kratos/config 有那些功能</h2>
<ol>
<li>kratos/config包支持多种配置源，包括
<ul>
<li>本地文件</li>
<li>本地环境</li>
<li>contrib/config支持配置中心</li>
</ul>
</li>
<li>kratos/config 支持多种配置格式
<ul>
<li>json</li>
<li>proto</li>
<li>xml</li>
<li>yaml</li>
</ul>
</li>
<li>支持热更</li>
<li>支持其它格式的配置文件</li>
</ol>
<h2 id="定义配置">定义配置</h2>
<p>在项目目录下创建文件: 
workspace/configs/config.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">service</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.0.0</span>
<span style="color:#f92672">http</span>:
  <span style="color:#f92672">server</span>:
    <span style="color:#f92672">address</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">8000</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">1s</span>
<span style="color:#f92672">grpc</span>:
  <span style="color:#f92672">server</span>:
    <span style="color:#f92672">address</span>: <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">9000</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">1s</span>
</code></pre></div><h2 id="加载配置文件">加载配置文件</h2>
<h3 id="withsource">WithSource</h3>
<p>使用withsoure指定数据源为本地文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;flag&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>

	<span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/config&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-kratos/kratos/v2/config/file&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">flagconf</span> <span style="color:#66d9ef">string</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">StringVar</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">flagconf</span>, <span style="color:#e6db74">&#34;conf&#34;</span>, <span style="color:#e6db74">&#34;config.yaml&#34;</span>, <span style="color:#e6db74">&#34;config path, eg: -conf config.yaml&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithSource</span>(
			<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">NewSource</span>(<span style="color:#a6e22e">flagconf</span>),
		),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Load</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">//定义配置JSON字段
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Service</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>
			<span style="color:#a6e22e">Version</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;version&#34;`</span>
		} <span style="color:#e6db74">`json:&#34;service&#34;`</span>
	}

	<span style="color:#75715e">//将配置Unmarshal 到struct  
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;config: %+v&#34;</span>, <span style="color:#a6e22e">v</span>)

	<span style="color:#75715e">//获取与该键关联的值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#e6db74">&#34;service.name&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;service: %s&#34;</span>, <span style="color:#a6e22e">name</span>)

	<span style="color:#75715e">// 热更执行钩子
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#e6db74">&#34;service.name&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Value</span>) {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;config changed: %s = %v\n&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>)
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#f92672">&lt;-</span>make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
}
</code></pre></div><p>output：</p>
<pre tabindex="0"><code>$  config: {Service:{Name:config Version:v1.0.0}}
$  service: config
</code></pre><h3 id="withdecoder">WithDecoder</h3>
<p>Decoder用于将配置文件内容用特定的反序列化方法解析出来</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithSource</span>(
			<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">NewSource</span>(<span style="color:#a6e22e">flagconf</span>),
		),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WithDecoder</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">src</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">KeyValue</span>, <span style="color:#a6e22e">target</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
				<span style="color:#75715e">// expand key &#34;aaa.bbb&#34; into map[aaa]map[bbb]interface{}
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">keys</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
				<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">keys</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> len(<span style="color:#a6e22e">keys</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
						<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Value</span>
					} <span style="color:#66d9ef">else</span> {
						<span style="color:#a6e22e">sub</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})
						<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">sub</span>
						<span style="color:#a6e22e">target</span> = <span style="color:#a6e22e">sub</span>
					}
				}
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">codec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">encoding</span>.<span style="color:#a6e22e">GetCodec</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span>); <span style="color:#a6e22e">codec</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">target</span>)
			}
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unsupported key: %s format: %s&#34;</span>, <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">Format</span>)
		}),
	)
</code></pre></div><p>output 和上例一致</p>
<h2 id="原理">原理</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Config is a config interface.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Load</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Scan</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">Value</span>
	<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">o</span> <span style="color:#a6e22e">Observer</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
}
</code></pre></div><ol>
<li>指定数据源的这样会将整个目录中的所有文件进行解析加载，合并到同一个map中</li>
</ol>
<pre tabindex="0"><code>    c := config.New(
            config.WithSource(
                file.NewSource(flagconf),
            ),
        )
        if err := c.Load(); err != nil {
            panic(err)
         }
</code></pre><ol start="2">
<li>使用之前创建好的config实例，调用.Scan方法，读取配置文件的内容到结构体中，这种方式适用于完整获取整个配置文件的内容</li>
</ol>
<pre tabindex="0"><code>    if err := c.Scan(&amp;v); err != nil {
      panic(err)
    }
    fmt.Printf(&quot;config: %+v&quot;, v)
</code></pre><ol start="3">
<li>New的时候会有一个默认的 decoder</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#a6e22e">Config</span> {
	<span style="color:#a6e22e">o</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">options</span>{
		<span style="color:#a6e22e">logger</span>:   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultLogger</span>,
		<span style="color:#a6e22e">decoder</span>:  <span style="color:#a6e22e">defaultDecoder</span>,
		<span style="color:#a6e22e">resolver</span>: <span style="color:#a6e22e">defaultResolver</span>,
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">opts</span> {
		<span style="color:#a6e22e">opt</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">o</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>{
		<span style="color:#a6e22e">opts</span>:   <span style="color:#a6e22e">o</span>,
		<span style="color:#a6e22e">reader</span>: <span style="color:#a6e22e">newReader</span>(<span style="color:#a6e22e">o</span>),
		<span style="color:#a6e22e">log</span>:    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewHelper</span>(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">logger</span>),
	}
}
</code></pre></div><p>通过option可以拓展自定义 decoder</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDecoder</span>(<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">Decoder</span>) <span style="color:#a6e22e">Option</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">options</span>) {
		<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">decoder</span> = <span style="color:#a6e22e">d</span>
	}
}
</code></pre></div><h2 id="参考">参考</h2>
<ol>
<li><a href="https://github.com/go-kratos/kratos/v2/config">https://github.com/go-kratos/kratos/v2/config</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config">https://github.com/go-kratos/kratos/tree/main/contrib/config</a></li>
<li><a href="https://go-kratos.dev/docs/component/config">https://go-kratos.dev/docs/component/config</a></li>
</ol>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/05/kratos%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AF%BB%E5%8F%96/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/page/3/" aria-label="">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span></span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/page/5/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


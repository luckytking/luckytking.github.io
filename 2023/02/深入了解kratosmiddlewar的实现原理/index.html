<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"\u003cp\u003eKratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。\u003c\/p\u003e\n\u003ch3 id=\u0022使用示例\u0022\u003e使用示例\u003c\/h3\u003e\n\u003cp\u003eKratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,\n您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ http\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ 定义opts\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003evar\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eopts\u003c\/span\u003e = []\u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eServerOption\u003c\/span\u003e{\n    \u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e(\n        \u003cspan style=\u0022color:#a6e22e\u0022\u003erecovery\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eRecovery\u003c\/span\u003e(), \u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ 把middleware按照需要的顺序加入\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e        \u003cspan style=\u0022color:#a6e22e\u0022\u003etracing\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eServer\u003c\/span\u003e(),\n        \u003cspan style=\u0022color:#a6e22e\u0022\u003elogging\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eServer\u003c\/span\u003e(),\n    ),\n}\n\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ 创建server\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eNewServer\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eopts\u003c\/span\u003e\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cp\u003e自定义中间件的例子：\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware1\u003c\/span\u003e() \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e {\n    \u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ehandler\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e {\n        \u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}) (\u003cspan style=\u0022color:#a6e22e\u0022\u003ereply\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e) {\n            \u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003etr\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003etransport\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eFromServerContext\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e); \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e {\n                \u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ Do something on entering\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e                \u003cspan style=\u0022color:#66d9ef\u0022\u003edefer\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e() {\n                \u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ Do something on exiting\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e                 }()\n            }\n            \u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ehandler\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e)\n        }\n    }\n}\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003ch3 id=\u0022链式调用\u0022\u003e链式调用\u003c\/h3\u003e\n\u003cp\u003eKratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。\u003c\/p\u003e\n\u003cp\u003e每一个中间件都是一个函数，具有相同的签名：\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ Handler定义中间件调用的处理程序\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003etype\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}) (\u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}, \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e)\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cp\u003e再看看\/go-kratos\/kratos\/blob\/main\/middleware\/middleware包中Middleware和Chain的实现，Middleware 是HTTP\/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003etype\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e\n\n\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eChain\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003efor\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e len(\u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e) \u003cspan style=\u0022color:#f92672\u0022\u003e-\u003c\/span\u003e \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c\/span\u003e; \u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e\u0026gt;=\u003c\/span\u003e \u003cspan style=\u0022color:#ae81ff\u0022\u003e0\u003c\/span\u003e; \u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e\u003cspan style=\u0022color:#f92672\u0022\u003e--\u003c\/span\u003e {\n\t\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e = \u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e[\u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e](\u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e)\n\t\t}\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e\n\t}\n}\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cp\u003eExample,以https:\/\/github.com\/go-kratos\/kratos\/blob\/main\/middleware\/middleware_test.go为例:\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eTestChain\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003et\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003etesting\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eT\u003c\/span\u003e) {\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}) (\u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}, \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e) {\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003et\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eLog\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e\u002b=\u003c\/span\u003e \u003cspan style=\u0022color:#ae81ff\u0022\u003e10\u003c\/span\u003e\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;reply\u0026#34;\u003c\/span\u003e, \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e\n\t}\n\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003egot\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eChain\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003etest1Middleware\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003etest2Middleware\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003etest3Middleware\u003c\/span\u003e)(\u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e)(\u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eBackground\u003c\/span\u003e(), \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;hello kratos!\u0026#34;\u003c\/span\u003e)\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e!=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003et\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eErrorf\u003c\/span\u003e(\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;expect %v, got %v\u0026#34;\u003c\/span\u003e, \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e)\n        }\n  }\n  \n\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003etest1Middleware\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ehandler\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}) (\u003cspan style=\u0022color:#a6e22e\u0022\u003ereply\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e) {\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003efmt\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ePrintln\u003c\/span\u003e(\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;test1 before\u0026#34;\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ei\u003c\/span\u003e\u003cspan style=\u0022color:#f92672\u0022\u003e\u002b\u002b\u003c\/span\u003e\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ereply\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e = \u003cspan style=\u0022color:#a6e22e\u0022\u003ehandler\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003efmt\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ePrintln\u003c\/span\u003e(\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;test1 after\u0026#34;\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e\n\t}\n}  \n\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003e篇幅限制\u003c\/span\u003e\u003cspan style=\u0022color:#960050;background-color:#1e0010\u0022\u003e，\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003e省略部分代码\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003eOutPut\u003c\/span\u003e\u003cspan style=\u0022color:#960050;background-color:#1e0010\u0022\u003e：\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest1\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ebefore\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest2\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ebefore\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest3\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ebefore\u003c\/span\u003e\n    \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware_test\u003c\/span\u003e.\u003cspan style=\u0022color:#66d9ef\u0022\u003ego\u003c\/span\u003e:\u003cspan style=\u0022color:#ae81ff\u0022\u003e14\u003c\/span\u003e: \u003cspan style=\u0022color:#a6e22e\u0022\u003ehello\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ekratos\u003c\/span\u003e!\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest3\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eafter\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest2\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eafter\u003c\/span\u003e\n\u003cspan style=\u0022color:#a6e22e\u0022\u003etest1\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eafter\u003c\/span\u003e\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003ch3 id=\u0022调用过程\u0022\u003e调用过程\u003c\/h3\u003e\n\u003cp\u003e对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：\u003c\/p\u003e\n\u003col\u003e\n\u003cli\u003eoption方式配置中间件\u003c\/li\u003e\n\u003cli\u003eurl路由匹配中间件\u003c\/li\u003e\n\u003cli\u003e组装中间件添加到调用链\u003c\/li\u003e\n\u003cli\u003e注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件\u003c\/li\u003e\n\u003c\/ol\u003e\n\u003cp\u003e以Transport.Server Http服务为例，重点关注middleware和router 。\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ Server is an HTTP server wrapper.\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003etype\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eServer\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003estruct\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eServer\u003c\/span\u003e\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e  \u003cspan style=\u0022color:#a6e22e\u0022\u003ematcher\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMatcher\u003c\/span\u003e\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003erouter\u003c\/span\u003e      \u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003emux\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eRouter\u003c\/span\u003e\n\t\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e\n}\n\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ Matcher is a middleware matcher.\n\u003c\/span\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c\/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003etype\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eMatcher\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003eUse\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e)\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003eAdd\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eselector\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003estring\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e)\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003eMatch\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eoperation\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003estring\u003c\/span\u003e) []\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e\n}\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cul\u003e\n\u003cli\u003eMatcher是一个中间件匹配器，operation 为path，实现路由查找。\u003c\/li\u003e\n\u003cli\u003erouter 为gorilla.Mux, Http路由器和Url匹配器\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cp\u003e一个完成的调用api-service:\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003e_Greeter_SayHello0_HTTP_Handler\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003esrv\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eGreeterHTTPServer\u003c\/span\u003e) \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e) \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e) \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003evar\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ein\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eHelloRequest\u003c\/span\u003e\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eBindQuery\u003c\/span\u003e(\u003cspan style=\u0022color:#f92672\u0022\u003e\u0026amp;\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ein\u003c\/span\u003e); \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e!=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e {\n\t\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e\n\t\t}\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eBindVars\u003c\/span\u003e(\u003cspan style=\u0022color:#f92672\u0022\u003e\u0026amp;\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ein\u003c\/span\u003e); \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e!=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e {\n\t\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e\n\t\t}\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ehttp\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eSetOperation\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e, \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\/helloworld.v1.Greeter\/SayHello\u0026#34;\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003eh\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e(\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003econtext\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}) (\u003cspan style=\u0022color:#66d9ef\u0022\u003einterface\u003c\/span\u003e{}, \u003cspan style=\u0022color:#66d9ef\u0022\u003eerror\u003c\/span\u003e) {\n\t\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003esrv\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eSayHello\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e.(\u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003eHelloRequest\u003c\/span\u003e))\n\t\t})\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003eout\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eh\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e, \u003cspan style=\u0022color:#f92672\u0022\u003e\u0026amp;\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ein\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e!=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003enil\u003c\/span\u003e {\n\t\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eerr\u003c\/span\u003e\n\t\t}\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ereply\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003eout\u003c\/span\u003e.(\u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003eHelloReply\u003c\/span\u003e)\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ectx\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eResult\u003c\/span\u003e(\u003cspan style=\u0022color:#ae81ff\u0022\u003e200\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003ereply\u003c\/span\u003e)\n\t}\n}\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cp\u003e其中ctx.Middleware的实现是：\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e (\u003cspan style=\u0022color:#a6e22e\u0022\u003ec\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ewrapper\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eh\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eHandler\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003etr\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003etransport\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eFromServerContext\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ec\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eContext\u003c\/span\u003e()); \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eChain\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ec\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003erouter\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003esrv\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMatch\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003etr\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eOperation\u003c\/span\u003e())\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)(\u003cspan style=\u0022color:#a6e22e\u0022\u003eh\u003c\/span\u003e)\n\t}\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eChain\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ec\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003erouter\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003esrv\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMatch\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003ec\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ereq\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eURL\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ePath\u003c\/span\u003e)\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)(\u003cspan style=\u0022color:#a6e22e\u0022\u003eh\u003c\/span\u003e)\n} \n\n\u003cspan style=\u0022color:#66d9ef\u0022\u003efunc\u003c\/span\u003e (\u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e*\u003c\/span\u003e\u003cspan style=\u0022color:#a6e22e\u0022\u003ematcher\u003c\/span\u003e) \u003cspan style=\u0022color:#a6e22e\u0022\u003eMatch\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eoperation\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003estring\u003c\/span\u003e) []\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e {\n\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e make([]\u003cspan style=\u0022color:#a6e22e\u0022\u003emiddleware\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eMiddleware\u003c\/span\u003e, \u003cspan style=\u0022color:#ae81ff\u0022\u003e0\u003c\/span\u003e, len(\u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003edefaults\u003c\/span\u003e))\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e len(\u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003edefaults\u003c\/span\u003e) \u0026gt; \u003cspan style=\u0022color:#ae81ff\u0022\u003e0\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e = append(\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003edefaults\u003c\/span\u003e\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)\n\t}\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ematchs\u003c\/span\u003e[\u003cspan style=\u0022color:#a6e22e\u0022\u003eoperation\u003c\/span\u003e]; \u003cspan style=\u0022color:#a6e22e\u0022\u003eok\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e append(\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003enext\u003c\/span\u003e\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)\n\t}\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003efor\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003e_\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eprefix\u003c\/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e:=\u003c\/span\u003e \u003cspan style=\u0022color:#66d9ef\u0022\u003erange\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eprefix\u003c\/span\u003e {\n\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003estrings\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003eHasPrefix\u003c\/span\u003e(\u003cspan style=\u0022color:#a6e22e\u0022\u003eoperation\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003eprefix\u003c\/span\u003e) {\n\t\t\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e append(\u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e, \u003cspan style=\u0022color:#a6e22e\u0022\u003em\u003c\/span\u003e.\u003cspan style=\u0022color:#a6e22e\u0022\u003ematchs\u003c\/span\u003e[\u003cspan style=\u0022color:#a6e22e\u0022\u003eprefix\u003c\/span\u003e]\u003cspan style=\u0022color:#f92672\u0022\u003e...\u003c\/span\u003e)\n\t\t}\n\t}\n\t\u003cspan style=\u0022color:#66d9ef\u0022\u003ereturn\u003c\/span\u003e \u003cspan style=\u0022color:#a6e22e\u0022\u003ems\u003c\/span\u003e\n}\n\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e\u003cp\u003e以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。\u003c\/p\u003e\n\u003ch3 id=\u0022小结\u0022\u003e小结\u003c\/h3\u003e\n\u003cp\u003e文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。\u003c\/p\u003e\n\u003ch3 id=\u0022参考\u0022\u003e参考\u003c\/h3\u003e\n\u003cul\u003e\n\u003cli\u003ekratos doc \u003ca href=\u0022https:\/\/go-kratos.dev\/docs\/component\/middleware\/overview\u0022\u003ehttps:\/\/go-kratos.dev\/docs\/component\/middleware\/overview\u003c\/a\u003e\u003c\/li\u003e\n\u003cli\u003ekratos middleware pkg  \u003ca href=\u0022https:\/\/github.com\/go-kratos\/kratos\/blob\/main\/middleware\/middleware.go\u0022\u003ehttps:\/\/github.com\/go-kratos\/kratos\/blob\/main\/middleware\/middleware.go\u003c\/a\u003e\u003c\/li\u003e\n\u003c\/ul\u003e",
  "url":"https:\/\/luckytking.github.io\/2023\/02\/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86\/",
  "keywords":"[kratos middleware]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="kratos middleware">
<meta name="description" content="Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。
使用示例
Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。
// http
// 定义opts
var opts = []http.ServerOption{
    http.Middleware(
        recovery.Recovery(), // 把middleware按照需要的顺序加入
        tracing.Server(),
        logging.Server(),
    ),
}
// 创建server
http.NewServer(opts...)
自定义中间件的例子：
func Middleware1() middleware.Middleware {
    return func(handler middleware.Handler) middleware.Handler {
        return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
            if tr, ok := transport.FromServerContext(ctx); ok {
                // Do something on entering
                defer func() {
                // Do something on exiting
                 }()
            }
            return handler(ctx, req)
        }
    }
}
链式调用
Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。
每一个中间件都是一个函数，具有相同的签名：
// Handler定义中间件调用的处理程序
type Handler func(ctx context.Context, req interface{}) (interface{}, error)
再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。
type Middleware func(Handler) Handler

func Chain(m ...Middleware) Middleware {
	return func(next Handler) Handler {
		for i := len(m) - 1; i &gt;= 0; i-- {
			next = m[i](next)
		}
		return next
	}
}
Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:
func TestChain(t *testing.T) {
	next := func(ctx context.Context, req interface{}) (interface{}, error) {
		t.Log(req)
		i &#43;= 10
		return &#34;reply&#34;, nil
	}

	got, err := Chain(test1Middleware, test2Middleware, test3Middleware)(next)(context.Background(), &#34;hello kratos!&#34;)
	if err != nil {
		t.Errorf(&#34;expect %v, got %v&#34;, nil, err)
        }
  }
  
func test1Middleware(handler Handler) Handler {
	return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
		fmt.Println(&#34;test1 before&#34;)
		i&#43;&#43;
		reply, err = handler(ctx, req)
		fmt.Println(&#34;test1 after&#34;)
		return
	}
}  
... 篇幅限制，省略部分代码
OutPut：
test1 before
test2 before
test3 before
    middleware_test.go:14: hello kratos!
test3 after
test2 after
test1 after
调用过程
对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：

option方式配置中间件
url路由匹配中间件
组装中间件添加到调用链
注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件

以Transport.Server Http服务为例，重点关注middleware和router 。
// Server is an HTTP server wrapper.
type Server struct {
	*http.Server
	middleware  matcher.Matcher
	router      *mux.Router
	...
}
// Matcher is a middleware matcher.
type Matcher interface {
	Use(ms ...middleware.Middleware)
	Add(selector string, ms ...middleware.Middleware)
	Match(operation string) []middleware.Middleware
}

Matcher是一个中间件匹配器，operation 为path，实现路由查找。
router 为gorilla.Mux, Http路由器和Url匹配器

一个完成的调用api-service:
func _Greeter_SayHello0_HTTP_Handler(srv GreeterHTTPServer) func(ctx http.Context) error {
	return func(ctx http.Context) error {
		var in HelloRequest
		if err := ctx.BindQuery(&amp;in); err != nil {
			return err
		}
		if err := ctx.BindVars(&amp;in); err != nil {
			return err
		}
		http.SetOperation(ctx, &#34;/helloworld.v1.Greeter/SayHello&#34;)
		h := ctx.Middleware(func(ctx context.Context, req interface{}) (interface{}, error) {
			return srv.SayHello(ctx, req.(*HelloRequest))
		})
		out, err := h(ctx, &amp;in)
		if err != nil {
			return err
		}
		reply := out.(*HelloReply)
		return ctx.Result(200, reply)
	}
}
其中ctx.Middleware的实现是：
func (c *wrapper) Middleware(h middleware.Handler) middleware.Handler {
	if tr, ok := transport.FromServerContext(c.req.Context()); ok {
		return middleware.Chain(c.router.srv.middleware.Match(tr.Operation())...)(h)
	}
	return middleware.Chain(c.router.srv.middleware.Match(c.req.URL.Path)...)(h)
} 

func (m *matcher) Match(operation string) []middleware.Middleware {
	ms := make([]middleware.Middleware, 0, len(m.defaults))
	if len(m.defaults) &gt; 0 {
		ms = append(ms, m.defaults...)
	}
	if next, ok := m.matchs[operation]; ok {
		return append(ms, next...)
	}
	for _, prefix := range m.prefix {
		if strings.HasPrefix(operation, prefix) {
			return append(ms, m.matchs[prefix]...)
		}
	}
	return ms
}
以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。
小结
文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。
参考

kratos doc https://go-kratos.dev/docs/component/middleware/overview
kratos middleware pkg  https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go
">


<meta property="og:description" content="Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。
使用示例
Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。
// http
// 定义opts
var opts = []http.ServerOption{
    http.Middleware(
        recovery.Recovery(), // 把middleware按照需要的顺序加入
        tracing.Server(),
        logging.Server(),
    ),
}
// 创建server
http.NewServer(opts...)
自定义中间件的例子：
func Middleware1() middleware.Middleware {
    return func(handler middleware.Handler) middleware.Handler {
        return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
            if tr, ok := transport.FromServerContext(ctx); ok {
                // Do something on entering
                defer func() {
                // Do something on exiting
                 }()
            }
            return handler(ctx, req)
        }
    }
}
链式调用
Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。
每一个中间件都是一个函数，具有相同的签名：
// Handler定义中间件调用的处理程序
type Handler func(ctx context.Context, req interface{}) (interface{}, error)
再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。
type Middleware func(Handler) Handler

func Chain(m ...Middleware) Middleware {
	return func(next Handler) Handler {
		for i := len(m) - 1; i &gt;= 0; i-- {
			next = m[i](next)
		}
		return next
	}
}
Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:
func TestChain(t *testing.T) {
	next := func(ctx context.Context, req interface{}) (interface{}, error) {
		t.Log(req)
		i &#43;= 10
		return &#34;reply&#34;, nil
	}

	got, err := Chain(test1Middleware, test2Middleware, test3Middleware)(next)(context.Background(), &#34;hello kratos!&#34;)
	if err != nil {
		t.Errorf(&#34;expect %v, got %v&#34;, nil, err)
        }
  }
  
func test1Middleware(handler Handler) Handler {
	return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
		fmt.Println(&#34;test1 before&#34;)
		i&#43;&#43;
		reply, err = handler(ctx, req)
		fmt.Println(&#34;test1 after&#34;)
		return
	}
}  
... 篇幅限制，省略部分代码
OutPut：
test1 before
test2 before
test3 before
    middleware_test.go:14: hello kratos!
test3 after
test2 after
test1 after
调用过程
对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：

option方式配置中间件
url路由匹配中间件
组装中间件添加到调用链
注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件

以Transport.Server Http服务为例，重点关注middleware和router 。
// Server is an HTTP server wrapper.
type Server struct {
	*http.Server
	middleware  matcher.Matcher
	router      *mux.Router
	...
}
// Matcher is a middleware matcher.
type Matcher interface {
	Use(ms ...middleware.Middleware)
	Add(selector string, ms ...middleware.Middleware)
	Match(operation string) []middleware.Middleware
}

Matcher是一个中间件匹配器，operation 为path，实现路由查找。
router 为gorilla.Mux, Http路由器和Url匹配器

一个完成的调用api-service:
func _Greeter_SayHello0_HTTP_Handler(srv GreeterHTTPServer) func(ctx http.Context) error {
	return func(ctx http.Context) error {
		var in HelloRequest
		if err := ctx.BindQuery(&amp;in); err != nil {
			return err
		}
		if err := ctx.BindVars(&amp;in); err != nil {
			return err
		}
		http.SetOperation(ctx, &#34;/helloworld.v1.Greeter/SayHello&#34;)
		h := ctx.Middleware(func(ctx context.Context, req interface{}) (interface{}, error) {
			return srv.SayHello(ctx, req.(*HelloRequest))
		})
		out, err := h(ctx, &amp;in)
		if err != nil {
			return err
		}
		reply := out.(*HelloReply)
		return ctx.Result(200, reply)
	}
}
其中ctx.Middleware的实现是：
func (c *wrapper) Middleware(h middleware.Handler) middleware.Handler {
	if tr, ok := transport.FromServerContext(c.req.Context()); ok {
		return middleware.Chain(c.router.srv.middleware.Match(tr.Operation())...)(h)
	}
	return middleware.Chain(c.router.srv.middleware.Match(c.req.URL.Path)...)(h)
} 

func (m *matcher) Match(operation string) []middleware.Middleware {
	ms := make([]middleware.Middleware, 0, len(m.defaults))
	if len(m.defaults) &gt; 0 {
		ms = append(ms, m.defaults...)
	}
	if next, ok := m.matchs[operation]; ok {
		return append(ms, next...)
	}
	for _, prefix := range m.prefix {
		if strings.HasPrefix(operation, prefix) {
			return append(ms, m.matchs[prefix]...)
		}
	}
	return ms
}
以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。
小结
文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。
参考

kratos doc https://go-kratos.dev/docs/component/middleware/overview
kratos middleware pkg  https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go
">
<meta property="og:type" content="article">
<meta property="og:title" content="深入了解KratosMiddlewar的实现原理">
<meta name="twitter:title" content="深入了解KratosMiddlewar的实现原理">
<meta property="og:url" content="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
<meta property="twitter:url" content="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。
使用示例
Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。
// http
// 定义opts
var opts = []http.ServerOption{
    http.Middleware(
        recovery.Recovery(), // 把middleware按照需要的顺序加入
        tracing.Server(),
        logging.Server(),
    ),
}
// 创建server
http.NewServer(opts...)
自定义中间件的例子：
func Middleware1() middleware.Middleware {
    return func(handler middleware.Handler) middleware.Handler {
        return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
            if tr, ok := transport.FromServerContext(ctx); ok {
                // Do something on entering
                defer func() {
                // Do something on exiting
                 }()
            }
            return handler(ctx, req)
        }
    }
}
链式调用
Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。
每一个中间件都是一个函数，具有相同的签名：
// Handler定义中间件调用的处理程序
type Handler func(ctx context.Context, req interface{}) (interface{}, error)
再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。
type Middleware func(Handler) Handler

func Chain(m ...Middleware) Middleware {
	return func(next Handler) Handler {
		for i := len(m) - 1; i &gt;= 0; i-- {
			next = m[i](next)
		}
		return next
	}
}
Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:
func TestChain(t *testing.T) {
	next := func(ctx context.Context, req interface{}) (interface{}, error) {
		t.Log(req)
		i &#43;= 10
		return &#34;reply&#34;, nil
	}

	got, err := Chain(test1Middleware, test2Middleware, test3Middleware)(next)(context.Background(), &#34;hello kratos!&#34;)
	if err != nil {
		t.Errorf(&#34;expect %v, got %v&#34;, nil, err)
        }
  }
  
func test1Middleware(handler Handler) Handler {
	return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
		fmt.Println(&#34;test1 before&#34;)
		i&#43;&#43;
		reply, err = handler(ctx, req)
		fmt.Println(&#34;test1 after&#34;)
		return
	}
}  
... 篇幅限制，省略部分代码
OutPut：
test1 before
test2 before
test3 before
    middleware_test.go:14: hello kratos!
test3 after
test2 after
test1 after
调用过程
对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：

option方式配置中间件
url路由匹配中间件
组装中间件添加到调用链
注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件

以Transport.Server Http服务为例，重点关注middleware和router 。
// Server is an HTTP server wrapper.
type Server struct {
	*http.Server
	middleware  matcher.Matcher
	router      *mux.Router
	...
}
// Matcher is a middleware matcher.
type Matcher interface {
	Use(ms ...middleware.Middleware)
	Add(selector string, ms ...middleware.Middleware)
	Match(operation string) []middleware.Middleware
}

Matcher是一个中间件匹配器，operation 为path，实现路由查找。
router 为gorilla.Mux, Http路由器和Url匹配器

一个完成的调用api-service:
func _Greeter_SayHello0_HTTP_Handler(srv GreeterHTTPServer) func(ctx http.Context) error {
	return func(ctx http.Context) error {
		var in HelloRequest
		if err := ctx.BindQuery(&amp;in); err != nil {
			return err
		}
		if err := ctx.BindVars(&amp;in); err != nil {
			return err
		}
		http.SetOperation(ctx, &#34;/helloworld.v1.Greeter/SayHello&#34;)
		h := ctx.Middleware(func(ctx context.Context, req interface{}) (interface{}, error) {
			return srv.SayHello(ctx, req.(*HelloRequest))
		})
		out, err := h(ctx, &amp;in)
		if err != nil {
			return err
		}
		reply := out.(*HelloReply)
		return ctx.Result(200, reply)
	}
}
其中ctx.Middleware的实现是：
func (c *wrapper) Middleware(h middleware.Handler) middleware.Handler {
	if tr, ok := transport.FromServerContext(c.req.Context()); ok {
		return middleware.Chain(c.router.srv.middleware.Match(tr.Operation())...)(h)
	}
	return middleware.Chain(c.router.srv.middleware.Match(c.req.URL.Path)...)(h)
} 

func (m *matcher) Match(operation string) []middleware.Middleware {
	ms := make([]middleware.Middleware, 0, len(m.defaults))
	if len(m.defaults) &gt; 0 {
		ms = append(ms, m.defaults...)
	}
	if next, ok := m.matchs[operation]; ok {
		return append(ms, next...)
	}
	for _, prefix := range m.prefix {
		if strings.HasPrefix(operation, prefix) {
			return append(ms, m.matchs[prefix]...)
		}
	}
	return ms
}
以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。
小结
文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。
参考

kratos doc https://go-kratos.dev/docs/component/middleware/overview
kratos middleware pkg  https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go
">
<meta name="twitter:description" content="Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。
使用示例
Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。
// http
// 定义opts
var opts = []http.ServerOption{
    http.Middleware(
        recovery.Recovery(), // 把middleware按照需要的顺序加入
        tracing.Server(),
        logging.Server(),
    ),
}
// 创建server
http.NewServer(opts...)
自定义中间件的例子：
func Middleware1() middleware.Middleware {
    return func(handler middleware.Handler) middleware.Handler {
        return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
            if tr, ok := transport.FromServerContext(ctx); ok {
                // Do something on entering
                defer func() {
                // Do something on exiting
                 }()
            }
            return handler(ctx, req)
        }
    }
}
链式调用
Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。
每一个中间件都是一个函数，具有相同的签名：
// Handler定义中间件调用的处理程序
type Handler func(ctx context.Context, req interface{}) (interface{}, error)
再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。
type Middleware func(Handler) Handler

func Chain(m ...Middleware) Middleware {
	return func(next Handler) Handler {
		for i := len(m) - 1; i &gt;= 0; i-- {
			next = m[i](next)
		}
		return next
	}
}
Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:
func TestChain(t *testing.T) {
	next := func(ctx context.Context, req interface{}) (interface{}, error) {
		t.Log(req)
		i &#43;= 10
		return &#34;reply&#34;, nil
	}

	got, err := Chain(test1Middleware, test2Middleware, test3Middleware)(next)(context.Background(), &#34;hello kratos!&#34;)
	if err != nil {
		t.Errorf(&#34;expect %v, got %v&#34;, nil, err)
        }
  }
  
func test1Middleware(handler Handler) Handler {
	return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
		fmt.Println(&#34;test1 before&#34;)
		i&#43;&#43;
		reply, err = handler(ctx, req)
		fmt.Println(&#34;test1 after&#34;)
		return
	}
}  
... 篇幅限制，省略部分代码
OutPut：
test1 before
test2 before
test3 before
    middleware_test.go:14: hello kratos!
test3 after
test2 after
test1 after
调用过程
对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：

option方式配置中间件
url路由匹配中间件
组装中间件添加到调用链
注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件

以Transport.Server Http服务为例，重点关注middleware和router 。
// Server is an HTTP server wrapper.
type Server struct {
	*http.Server
	middleware  matcher.Matcher
	router      *mux.Router
	...
}
// Matcher is a middleware matcher.
type Matcher interface {
	Use(ms ...middleware.Middleware)
	Add(selector string, ms ...middleware.Middleware)
	Match(operation string) []middleware.Middleware
}

Matcher是一个中间件匹配器，operation 为path，实现路由查找。
router 为gorilla.Mux, Http路由器和Url匹配器

一个完成的调用api-service:
func _Greeter_SayHello0_HTTP_Handler(srv GreeterHTTPServer) func(ctx http.Context) error {
	return func(ctx http.Context) error {
		var in HelloRequest
		if err := ctx.BindQuery(&amp;in); err != nil {
			return err
		}
		if err := ctx.BindVars(&amp;in); err != nil {
			return err
		}
		http.SetOperation(ctx, &#34;/helloworld.v1.Greeter/SayHello&#34;)
		h := ctx.Middleware(func(ctx context.Context, req interface{}) (interface{}, error) {
			return srv.SayHello(ctx, req.(*HelloRequest))
		})
		out, err := h(ctx, &amp;in)
		if err != nil {
			return err
		}
		reply := out.(*HelloReply)
		return ctx.Result(200, reply)
	}
}
其中ctx.Middleware的实现是：
func (c *wrapper) Middleware(h middleware.Handler) middleware.Handler {
	if tr, ok := transport.FromServerContext(c.req.Context()); ok {
		return middleware.Chain(c.router.srv.middleware.Match(tr.Operation())...)(h)
	}
	return middleware.Chain(c.router.srv.middleware.Match(c.req.URL.Path)...)(h)
} 

func (m *matcher) Match(operation string) []middleware.Middleware {
	ms := make([]middleware.Middleware, 0, len(m.defaults))
	if len(m.defaults) &gt; 0 {
		ms = append(ms, m.defaults...)
	}
	if next, ok := m.matchs[operation]; ok {
		return append(ms, next...)
	}
	for _, prefix := range m.prefix {
		if strings.HasPrefix(operation, prefix) {
			return append(ms, m.matchs[prefix]...)
		}
	}
	return ms
}
以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。
小结
文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。
参考

kratos doc https://go-kratos.dev/docs/component/middleware/overview
kratos middleware pkg  https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go
">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2023-02-12T16:10:45">
  
  
    <meta property="article:modified_time" content="2023-02-12T16:10:45">
  
  
  
    
      <meta property="article:section" content="go">
    
  
  
    
      <meta property="article:tag" content="micro service">
    
      <meta property="article:tag" content="kratos middleware">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>深入了解KratosMiddlewar的实现原理</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      深入了解KratosMiddlewar的实现原理
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-12T16:10:45&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。</p>
<h3 id="使用示例">使用示例</h3>
<p>Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// http
</span><span style="color:#75715e">// 定义opts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ServerOption</span>{
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Middleware</span>(
        <span style="color:#a6e22e">recovery</span>.<span style="color:#a6e22e">Recovery</span>(), <span style="color:#75715e">// 把middleware按照需要的顺序加入
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">tracing</span>.<span style="color:#a6e22e">Server</span>(),
        <span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Server</span>(),
    ),
}
<span style="color:#75715e">// 创建server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</code></pre></div><p>自定义中间件的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>() <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">ok</span> {
                <span style="color:#75715e">// Do something on entering
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                <span style="color:#75715e">// Do something on exiting
</span><span style="color:#75715e"></span>                 }()
            }
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
        }
    }
}
</code></pre></div><h3 id="链式调用">链式调用</h3>
<p>Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。</p>
<p>每一个中间件都是一个函数，具有相同的签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Handler定义中间件调用的处理程序
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Middleware</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Middleware</span>) <span style="color:#a6e22e">Middleware</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">m</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> {
			<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>](<span style="color:#a6e22e">next</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>
	}
}
</code></pre></div><p>Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestChain</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">next</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;reply&#34;</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">test1Middleware</span>, <span style="color:#a6e22e">test2Middleware</span>, <span style="color:#a6e22e">test3Middleware</span>)(<span style="color:#a6e22e">next</span>)(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;hello kratos!&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expect %v, got %v&#34;</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>)
        }
  }
  
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test1Middleware</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 before&#34;</span>)
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 after&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
}  
<span style="color:#f92672">...</span> <span style="color:#a6e22e">篇幅限制</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">省略部分代码</span>
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">before</span>
    <span style="color:#a6e22e">middleware_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">14</span>: <span style="color:#a6e22e">hello</span> <span style="color:#a6e22e">kratos</span>!
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">after</span>
</code></pre></div><h3 id="调用过程">调用过程</h3>
<p>对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：</p>
<ol>
<li>option方式配置中间件</li>
<li>url路由匹配中间件</li>
<li>组装中间件添加到调用链</li>
<li>注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件</li>
</ol>
<p>以Transport.Server Http服务为例，重点关注middleware和router 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Server is an HTTP server wrapper.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>
	<span style="color:#a6e22e">middleware</span>  <span style="color:#a6e22e">matcher</span>.<span style="color:#a6e22e">Matcher</span>
	<span style="color:#a6e22e">router</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>
	<span style="color:#f92672">...</span>
}
<span style="color:#75715e">// Matcher is a middleware matcher.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Matcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">selector</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>
}
</code></pre></div><ul>
<li>Matcher是一个中间件匹配器，operation 为path，实现路由查找。</li>
<li>router 为gorilla.Mux, Http路由器和Url匹配器</li>
</ul>
<p>一个完成的调用api-service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>其中ctx.Middleware的实现是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Context</span>()); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">tr</span>.<span style="color:#a6e22e">Operation</span>())<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>)<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
} 

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">matcher</span>) <span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
	<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>))
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">operation</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">next</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">prefix</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">prefix</span>) {
			<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">prefix</span>]<span style="color:#f92672">...</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ms</span>
}
</code></pre></div><p>以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。</p>
<h3 id="小结">小结</h3>
<p>文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。</p>
<h3 id="参考">参考</h3>
<ul>
<li>kratos doc <a href="https://go-kratos.dev/docs/component/middleware/overview">https://go-kratos.dev/docs/component/middleware/overview</a></li>
<li>kratos middleware pkg  <a href="https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go">https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go</a></li>
</ul>
              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://luckytking.github.io/tags/micro-service/">micro service</a>

  <a class="tag tag--primary tag--small" href="https://luckytking.github.io/tags/kratos-middleware/">kratos middleware</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" data-tooltip="Gorilla Mux的基础使用和常用功能" aria-label=": Gorilla Mux的基础使用和常用功能">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml"></span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" data-tooltip="Go分布式任务队列Asynq入门" aria-label=": Go分布式任务队列Asynq入门">
          
              <span class="hide-xs hide-sm text-small icon-mr"></span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://luckytking.github.io/2023/02/gorilla-mux%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%92%8C%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD/" data-tooltip="Gorilla Mux的基础使用和常用功能" aria-label=": Gorilla Mux的基础使用和常用功能">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml"></span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" data-tooltip="Go分布式任务队列Asynq入门" aria-label=": Go分布式任务队列Asynq入门">
          
              <span class="hide-xs hide-sm text-small icon-mr"></span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>k8s on jefffff&#39;s Blog</title>
    <link>https://luckytking.github.io/tags/k8s/</link>
    <description>Recent content in k8s on jefffff&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Sun, 02 Jul 2023 14:47:46 +0800</lastBuildDate><atom:link href="https://luckytking.github.io/tags/k8s/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Sealos V4.2.2删除再增加节点失败</title>
      <link>https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/</link>
      <pubDate>Sun, 02 Jul 2023 14:47:46 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/</guid>
      <description>&lt;p&gt;背景：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;sealos安装的Kubernetes集群，删除后增加节点失败。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;环境：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;应用&lt;/th&gt;
&lt;th&gt;信息&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;os&lt;/td&gt;
&lt;td&gt;Ubuntu&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sealos&lt;/td&gt;
&lt;td&gt;v4.2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kubernetes&lt;/td&gt;
&lt;td&gt;v1.25.7&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;问题1文件时md5校验失败&#34;&gt;问题1：文件时md5校验失败&lt;/h3&gt;
&lt;p&gt;操作步骤：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;delete&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--nodes&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;X&lt;/span&gt; 
&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;add&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--nodes&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;X&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行报错:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;sha256 sum not match
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Sealos 的 &amp;ndash;debug 参数是一个全局参数，用于开启调试模式，以便在出现问题时能更详细地了解系统的运行情况。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;add&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--nodes&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;X&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;--debug&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Sealos传输文件时比较md5查看是否报错，issues给了一个解决办法：可以关闭校验。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#  export SEALOS_SCP_CHECKSUM=false
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;修改完，出现了另外一个问题：&lt;/p&gt;
&lt;h3 id=&#34;问题2sealctl-增加host失败&#34;&gt;问题2：sealctl 增加host失败&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt; debug模式查看详细&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2023-06-28T09:56:43 debug show registry info, IP: 10.0.0.X:22, Domain: sealos.hub, Data: /var/lib/registry2023-06-28T09:56:43 debug start to exec /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:222023-06-28T09:56:44 error Applied to cluster error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:22, output: , error: Process exited with status 139 from signal SEGV,2023-06-28T09:56:44 debug save objects into local: /root/.sealos/default/Clusterfile, objects: [apiVersion: apps.sealos.io/v1beta1kind: Cluster
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可见，是seactl执行&amp;quot;sealctl hosts add &amp;ndash;ip 10.0.0.X &amp;ndash;domain sealos.hub&amp;quot; 失败。此文件是从master拷贝过来的：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;/var/lib/containers/storage/overlay/5dd64dde7bc046cfd7554458e2950c41c0d86536e4e96532cfa2ee60685404d4/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:40 debug remote copy files src /var/lib/containers/storage/overlay/44ce75c1b3e483c61ecfbc07a72f87da8627ce40d9df9451f2d04dfad8dffc65/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:42 debug remote copy files src
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们试着手动拷贝过去，执行是正常的。初步判断是传输的文件出错 ,issure沟通,建议试着“scp进程可能有问题，比较md5查看是否有问题。export SEALOS_SCP_CHECKSUM = true”，还是出现 &amp;ldquo;sha256 sum not match&amp;rdquo;。无效。&lt;/p&gt;
&lt;h3 id=&#34;解决&#34;&gt;解决&lt;/h3&gt;
&lt;p&gt;这个v4.2.2 的一个bug，希望下个版本能修复。最终一个临时处理办法：重置集群&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# sealos reset 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我尝试重置集群，再加入node是可行的。&lt;/p&gt;
&lt;h3 id=&#34;小结&#34;&gt;小结&lt;/h3&gt;
&lt;p&gt;本文主要记录排查、解决【sealos-v4.2.2删除节点后再增加节点失败】的过程，原因sealos的版本v4.2.2 问题，，其一，旧版本在拷贝seactl文件到node时会抛出失败：sha256比较文件时，经排查判断是传输过程文件出错了。其二,可以临时通过重置集群来恢复。  希望对你有所帮助。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://sealos.io/docs/lifecycle-management/reference/sealos/commands/#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4&#34;&gt; sealos env 命令 &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/2605&#34;&gt; sha256 not match&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/3413&#34;&gt; sealos delete &amp;ndash;nodes XXX sealos add &amp;ndash;nodes XXX failed &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>K8s安装metrics Server</title>
      <link>https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/</link>
      <pubDate>Fri, 23 Jun 2023 18:17:24 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/</guid>
      <description>&lt;p&gt;Metrics Server是一个可扩展的、高效的容器资源度量源，用于Kubernetes内置的自动伸缩管道。&lt;/p&gt;
&lt;p&gt;kubectl top 可以查看node、pod 的实时资源使用情况：如CPU、内存。但需要预装 Metrics Server ，不然会出现如下错误提示：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;top&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pods&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Metrics&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;API&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;available&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Metrics Server 从 Kubelet 收集资源指标，并通过Metrics API在 Kubernetes apiserver 中公开， 以供Horizo​​ntal Pod Autoscaler和Vertical Pod Autoscaler使用。指标 API 也可以通过 访问kubectl top，从而更容易调试自动缩放管道。&lt;/p&gt;
&lt;p&gt;今天主要介绍安装的过程，以及记录安装过程遇到一些问题。&lt;/p&gt;
&lt;h3 id=&#34;开始安装&#34;&gt;开始安装&lt;/h3&gt;
&lt;p&gt;这里我们采用官网给的清单 components.yaml安装最新的 Metrics Server 版本:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;apply&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;https&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;://&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;github&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;com&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;kubernetes-sigs&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;metrics-server&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;releases&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;latest&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;download&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;components&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;yaml&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看是否安装成功:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# kubectl get deployment metrics-server -n kube-system
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
metrics-server   0/1     1            0           118s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;发现安装失败。&lt;/p&gt;
&lt;h3 id=&#34;问题1镜像拉取失败&#34;&gt;问题1：镜像拉取失败&lt;/h3&gt;
&lt;p&gt;查看pod详细信息：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;get&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pod&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;NAME&lt;/span&gt;                              &lt;span style=&#34;color:#f92672&#34;&gt;READY&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;STATUS&lt;/span&gt;         &lt;span style=&#34;color:#f92672&#34;&gt;RESTARTS&lt;/span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;AGE&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metrics-server-55c774cdbb-jmfz8&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;     &lt;span style=&#34;color:#f92672&#34;&gt;ErrImagePull&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;0&lt;/span&gt;             &lt;span style=&#34;color:#f92672&#34;&gt;2m34s&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看pod日志:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;logs&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pods&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;metrics-server-55c774cdbb-jmfz8&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;Error&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;server&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;BadRequest&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;):&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;container&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;metrics-server&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pod&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;metrics-server-55c774cdbb-jmfz8&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;is&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;waiting&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;start&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;trying&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;and&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;failing&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pull&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;从日志可知是镜像拉取不下来，我们可以修改镜像地址。可以从dockerhub，查找最新版本，如作者安装的版本是：metrics-server:v0.6.1。打开components.yaml , 修改Deployment，spec.containers.coimage 为搜索到的，如“registry.aliyuncs.com/google_containers/metrics-server:v0.6.1&amp;quot;,修改完详细如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;strategy&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;rollingUpdate&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;maxUnavailable&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
        &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
      - &lt;span style=&#34;color:#f92672&#34;&gt;args&lt;/span&gt;:
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cert-dir=/tmp&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;secure-port=4443&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubelet-use-node-status-port&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;metric-resolution=15s&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;registry.aliyuncs.com/google_containers/metrics-server:v0.6.1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;更新部署deployment：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;delete&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;deployment&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;metrics-server&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;deployment&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;apps&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;metrics-server&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;deleted&lt;/span&gt;

&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kubectl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;apply&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;components&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;yaml&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;问题2证书&#34;&gt;问题2：证书&lt;/h3&gt;
&lt;p&gt;更新后，发现另外一个问题：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;server&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;go&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;132&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;unable&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;fully&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;scrape&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;metrics&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;unable&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;fully&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;scrape&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;metrics&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;docker-desktop&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;unable&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;fetch&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;metrics&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;docker-desktop&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Get&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://192.168.1.88:10250/stats/summary?only_cpu_and_memory=true&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;x509&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;cannot&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;validate&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;certificate&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;192&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;168&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;88&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;because&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;it&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;doesn&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;t&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;contain&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;any&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;IP&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;SANs&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;从日志可知是权限验证（证书）出了问题，通过搜索github issues ，issue回复里提供了一个解决方法是在可以关闭证书验证，详细如下：&lt;/p&gt;
&lt;p&gt;修改清单components.yam, 增加：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;- --kubelet-insecure-tls
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;修改完 Deplyment详细如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;strategy&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;rollingUpdate&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;maxUnavailable&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
        &lt;span style=&#34;color:#f92672&#34;&gt;k8s-app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;metrics-server&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
      - &lt;span style=&#34;color:#f92672&#34;&gt;args&lt;/span&gt;:
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cert-dir=/tmp&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;secure-port=4443&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubelet-use-node-status-port&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubelet-insecure-tls&lt;/span&gt;
        - --&lt;span style=&#34;color:#ae81ff&#34;&gt;metric-resolution=15s&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;ndash;kubelet-preferred-address-types：
优先使用 InternalIP 来访问 kubelet，这样可以避免节点名称没有 DNS 解析记录时，通过节点名称调用节点 kubelet API 失败的情况（未配置时默认的情况）；&lt;/p&gt;
&lt;p&gt;&amp;ndash;kubelet-insecure-tls：
kubelet 的 10250 端口使用的是 https 协议，连接需要验证 tls 证书。&amp;ndash;kubelet-insecure-tls 不验证客户端证书。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;然后，检查是否启动成功：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;#kubectl &lt;span style=&#34;color:#f92672&#34;&gt;get&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;deployment&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;metrics-server&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;NAME&lt;/span&gt;             &lt;span style=&#34;color:#f92672&#34;&gt;READY&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;UP-TO-DATE&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;AVAILABLE&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;AGE&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metrics-server&lt;/span&gt;   &lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;     &lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;           &lt;span style=&#34;color:#f92672&#34;&gt;14m&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;success。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-sigs/metrics-server&#34;&gt; 官网 &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://cloud.tencent.com/developer/article/1818865&#34;&gt; 容器 &amp;amp; 服务：metrics-server 安装探索   &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-sigs/metrics-server/issues/131&#34;&gt; github issues 关闭证书  &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>导入k8s集群到rancher报错no Secret Assigned to Service Account Cattle System</title>
      <link>https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/</link>
      <pubDate>Sun, 18 Jun 2023 15:30:58 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/</guid>
      <description>&lt;p&gt;背景：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在导入外部集群到rancher时，cattle-cluster-agent报错&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;level&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;fatal&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;msg&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;looking up cattle-system/cattle ca/token: no secret exists for service account cattle-system/cattle&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;环境：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;应用&lt;/th&gt;
&lt;th&gt;信息&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Kubernetes&lt;/td&gt;
&lt;td&gt;v1.25.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Rancher&lt;/td&gt;
&lt;td&gt;v2.6.6&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;解决&#34;&gt;解决&lt;/h3&gt;
&lt;p&gt;经查，K8s在版本v1.24启用新测试功能特性-LegacyServiceAccountTokenNoAutoGeneration，默认是开启的。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的持有者令牌来验证请求。&lt;/p&gt;
&lt;p&gt;服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们可以通过k8s 组件上指定的各种特性开关控制 -
【特性门控是描述 Kubernetes 特性的一组键值对。你可以在 Kubernetes 的各个组件中使用 &amp;ndash;feature-gates 标志来启用或禁用这些特性。】
关闭该特性：&lt;/p&gt;
&lt;p&gt;打开 /etc/kubernetes/manifest/kube-controller-manager.yml的
spec.container.command中增加&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--feature-gates&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;LegacyServiceAccountTokenNoAutoGeneration&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;false&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;修改完，例如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Pod&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;creationTimestamp&lt;/span&gt;: &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;component&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-controller-manager&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;control-plane&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-controller-manager&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-system&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
  - &lt;span style=&#34;color:#f92672&#34;&gt;command&lt;/span&gt;:
    - &lt;span style=&#34;color:#ae81ff&#34;&gt;kube-controller-manager&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;allocate-node-cidrs=true&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;authentication-kubeconfig=/etc/kubernetes/controller-manager.conf&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;authorization-kubeconfig=/etc/kubernetes/controller-manager.conf&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;bind-address=0.0.0.0&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;client-ca-file=/etc/kubernetes/pki/ca.crt&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cluster-cidr=1.2.0.0/10&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cluster-name=kubernetes&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;cluster-signing-key-file=/etc/kubernetes/pki/ca.key&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;controllers=*,bootstrapsigner,tokencleaner&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;feature-gates=EphemeralContainers=true&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;kubeconfig=/etc/kubernetes/controller-manager.conf&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;leader-elect=true&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;root-ca-file=/etc/kubernetes/pki/ca.crt&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;service-account-private-key-file=/etc/kubernetes/pki/sa.key&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;service-cluster-ip-range=10.88.0.0/22&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;use-service-account-credentials=true&lt;/span&gt;
    - --&lt;span style=&#34;color:#ae81ff&#34;&gt;feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false&lt;/span&gt;
    &lt;span style=&#34;color:#ae81ff&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;重启 kube-controller-manager，ps：如果是多个master，需要每个都修改。&lt;/p&gt;
&lt;h3 id=&#34;小结&#34;&gt;小结&lt;/h3&gt;
&lt;p&gt;本文记录导入外部集群到rancher时，遇到的用户认证密钥不正确的问题。回顾k8s在1.23~1.25的更新日志，以及查阅issues，原因是1.24启用了新测试特性LegacyServiceAccountTokenNoAutoGeneration，该特性使用经过签名的持有者令牌来验证请求。可以通过k8s组件上指定的各种特性开关控制来关闭此特性来解决报错，最终正常导入到rancher。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/feature-gates/&#34;&gt; k8s-features &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#service-account-tokens&#34;&gt;service-account-tokens &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;htps://github.com/rancher/rancher/issues/37027&#34;&gt; issues &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;htps://blog.isweluiz.com.br/2022/09/kubenetes-v1244-rancher-agent-error-no.html&#34;&gt; blog 解决用户secret &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Kubernetes集群image-cri-him大量端口占用</title>
      <link>https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/</link>
      <pubDate>Sat, 27 May 2023 18:11:54 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/</guid>
      <description>&lt;p&gt;背景：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;sealos安装的Kubernetes集群，master节点出现大量端口占用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;环境：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;应用&lt;/th&gt;
&lt;th&gt;信息&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;os&lt;/td&gt;
&lt;td&gt;Ubuntu&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sealos&lt;/td&gt;
&lt;td&gt;v4.1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kubernetes&lt;/td&gt;
&lt;td&gt;v1.23.9&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;排查问题&#34;&gt;排查问题&lt;/h3&gt;
&lt;p&gt;按照本地端口对输出进行排序&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;netstat&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-anp&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;grep&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ESTABLISHED&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;awk&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{print $4}&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sort&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;uniq&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-c&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sort&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;28&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;6443&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;111&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;127&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;2379&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;9009&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查找本地端口对应的应用程序&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;lsof&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-i&lt;/span&gt; :&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;image-cri&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2811249&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4120u&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;IPv4&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;291818320&lt;/span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;0t0&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;TCP&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41710-&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;ESTABLISHED&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可见，是image-cri-shim占用的端口数。&lt;/p&gt;
&lt;h3 id=&#34;image-cri-shim-工作原理&#34;&gt;image-cri-shim 工作原理&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;image-cri-shim 是一个基于 CRI (Container Runtime Interface) 和 kubelet 的 gRPC (Google Remote Procedure Call) shim。CRI 是 Kubernetes 中用于与容器运行时进行交互的接口，而 kubelet 是负责维护容器运行状态和节点级别的资源管理的 Kubernetes 组件。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;常用操作:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;启动服务： systemctl start image-cri-shim&lt;/li&gt;
&lt;li&gt;停止服务： systemctl stop image-cri-shim&lt;/li&gt;
&lt;li&gt;重启服务： systemctl restart image-cri-shim&lt;/li&gt;
&lt;li&gt;查看服务状态： systemctl status image-cri-shim&lt;/li&gt;
&lt;li&gt;&lt;/li&gt;
&lt;li&gt;参考日志:  journalctl -u image-cri-shim -f&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;重现问题&#34;&gt;重现问题&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在测试环境安装相同版本的sealos版本4.1.7，这里就不赘述，可以参考(&lt;a href=&#34;https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle&#34;&gt;https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle&lt;/a&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;安装好之后，发现image-cri-shim的版本（4.1.3）不对，&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--version&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;3-ed0a75b9&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;更新image-cri-shim版本为4.1.7&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;wget https://github.com/labring/sealos/releases/download/v4.1.7/sealos_4.1.7_linux_amd64.tar.gz &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tar xvf sealos_4.1.7_linux_amd64.tar.gz.1 image-cri-shim
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl stop image-cri-shim&amp;#34;&lt;/span&gt;
sealos scp &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./image-cri-shim&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/usr/bin/image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl start image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;image-cri-shim -v&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出类似以下内容，表示成功:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;192&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;168&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;22&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;192&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;168&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;102&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;22&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;启动后，观察日志：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;journalctl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-u&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Logs&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;begin&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;at&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Wed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-04-19&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;22&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;32&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;UTC&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;监控端口数的变化&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;netstat -na | grep &lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; | wc -l
&lt;span style=&#34;color:#ae81ff&#34;&gt;96&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;116&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;120&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;可见，每个5分钟，占用的端口数就增加20左右。问题复现了，接着我们来看看怎么处理。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;更新版本为420&#34;&gt;更新版本为4.2.0&lt;/h3&gt;
&lt;p&gt;从sealos的github的issues有提供一个修复方案：升级image-cri-shim的版本为4.2.0&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;wget https://github.com/labring/sealos/releases/download/v4.2.0/sealos_4.2.0_linux_amd64.tar.gz &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tar xvf sealos_4.2.0_linux_amd64.tar.gz image-cri-shim
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl stop image-cri-shim&amp;#34;&lt;/span&gt;
sealos scp &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./image-cri-shim&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/usr/bin/image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl start image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;image-cri-shim -v&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出如下，表示成功：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;image-cri-shim version 4.2.0-f696a621
192.168.1.101:22: image-cri-shim version 4.2.0-f696a621
192.168.1.102:22: image-cri-shim version 4.2.0-f696a621
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;观察是否已修复&#34;&gt;观察是否已修复&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;观察inamge-cri-shim日志：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;journalctl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-u&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Logs&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;begin&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;at&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Wed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-04-19&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;22&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;32&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;UTC&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Timeout&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; {&lt;span style=&#34;color:#f92672&#34;&gt;15m0s&lt;/span&gt;}
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;criRegistryAuth&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;criOfflineAuth&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;{Username:admin Password&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;passw0rd Auth&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; Email&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; ServerAddress&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;http&lt;span style=&#34;color:#f92672&#34;&gt;://&lt;/span&gt;sealos&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;hub&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; IdentityToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; RegistryToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;}&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;var&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;sock&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;containerd&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;containerd&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;sock&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;registry&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;http&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;://&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;changed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ownership&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/var/run/image-cri-shim.sock&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;changed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;permissions&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/var/run/image-cri-shim.sock&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-rw-rw----&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;监控端口数的变化&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;netstat&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-na&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;grep&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;wc&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-l&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt; 
&lt;span style=&#34;color:#f92672&#34;&gt;6&lt;/span&gt; 
&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;可见，请求是还有，但并没有增加端口数，看来问题修复了。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ps： 我们重现问题的Kubenetes版本是v1.23.9，在实际开发中发现其他版本的v1.25.7也会出现类似问题，验证此版本待后续更新。&lt;/p&gt;
&lt;h3 id=&#34;小结&#34;&gt;小结&lt;/h3&gt;
&lt;p&gt;本文主要记录排查、复现、处理【sealos安装的Kubenetes集群master节点大量占用端口】的过程，原因系image-cri-shim的版本问题，旧版本会频繁请求master，导致创建大量的连接，占用端口数。通过升级image-cri-shim版本可以解决该问题。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://sealos.io/zh-Hans/docs/design/image-cri-shim&#34;&gt; sealos Doc： image-cri-shim 介绍&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/2965&#34;&gt; 为什么sealos4.2部分的群，注册表库连接数很高 &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/3052&#34;&gt; BUG: image-cri-shim导致端口大量占用，耗尽服务器socket资源 &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>CRI与使用crictl调试k8s节点</title>
      <link>https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/</link>
      <pubDate>Sun, 12 Mar 2023 17:24:41 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/</guid>
      <description>&lt;p&gt;在 Kubernetes 中，Kubelet 是在每个节点上运行的重要组件之一，它负责管理容器的生命周期。而 CRI（Container Runtime Interface）则是 Kubelet 用于与容器运行时进行通信的接口（如下图）。&lt;/p&gt;
&lt;p&gt;CRI 采用了 ProtoBuffer 和 gPRC，规定 kubelet 该如何调用容器运行时去管理容器和镜像，Kubernetes 通过CRI可支持多种类型的OCI容器运行时，例如 docker、contained、CRI-O、runC、fraki和Kata Containers 等）。&lt;/p&gt;
&lt;p&gt;为了方便用户进行容器运行时的调试工作，社区提供了 crictl 工具，用于与 CRI 接口进行交互，本文简要介绍如何使用 crictl 对 Kubernetes节点进行调试 。&lt;/p&gt;
&lt;p&gt;kubelet-layout：&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;p&gt;&lt;img src=&#34;https://luckytking.github.io/images/kubelet-layout.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;安装&#34;&gt;安装&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;你可以从 cri-tools &lt;a href=&#34;https://github.com/kubernetes-sigs/cri-tools/releases&#34;&gt;发布页面&lt;/a&gt; 下载一个压缩的 crictl 归档文件，用于几种不同的架构。 下载与你的 kubernetes 版本相对应的版本。 提取它并将其移动到系统路径上的某个位置，例如 /usr/local/bin/。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;查看版本，验证安装&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl --version
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出例如如下，说明安装成功:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;crictl version v1.23.0 
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;查看或编辑配置&#34;&gt;查看或编辑配置&lt;/h4&gt;
&lt;p&gt;要查看或编辑当前配置，请查看或编辑 /etc/crictl.yaml 的内容。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;cat /etc/crictl.yaml
image-endpoint: unix:///var/run/image-cri-shim.sock
runtime-endpoint: unix:///run/containerd/containerd.sock
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;调试节点&#34;&gt;调试节点&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;列出运行中的容器：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl ps
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;例如我们列出k8s集群的所有容器，例如输出：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID
508e30da66ce7       7a71aca7b60fc       3 days ago          Running             calico-node               0                   e0ec650992997
9daa288a68426       f822f80398b9a       3 days ago          Running             calico-typha              0                   f5c4bd6471941
300d948e75019       f6bc1b780606f       3 days ago          Running             kube-controller-manager   1                   d5d681744a377
1cfdc1a6726ae       0198979b7707e       3 days ago          Running             kube-scheduler            1                   eb6ff07ees98c
3699c312c56f9       9e6a540eeeb62       3 days ago          Running             kube-proxy                0                   e8707140d12941
4159d7ec37b29       5bc0062e9555c       3 days ago          Running             kube-apiserver            0                   22d043569737f
8f56a047e8627      25f8c7f3da61c       3 days ago          Restart             etcd                      0                   458e540c798c8
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;本例中，etcd容器一直启动，可以使用以下命令获取容器的日志：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl logs container-id
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如此，通过日志帮助定位问题。&lt;/p&gt;
&lt;h4 id=&#34;更多命令&#34;&gt;更多命令&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;列出所有的pods&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl pods
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;创建容器&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl run --runtime&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;remote &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  docker.io/library/nginx:latest &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  nginx-container
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ps:使用远程容器CRI来使用最新的 nginx 镜像启动nginx-container的容器。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;删除容器：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;crictl rm nginx-container
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;列出所有镜像：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;crictl images
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;帮助&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt; crictl -h 
NAME:
   crictl - client &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; CRI

USAGE:
   crictl &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;global options&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; command &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;command options&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;arguments...&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;

VERSION:
   v1.23.0

COMMANDS:
   attach              Attach to a running container
   create              Create a new container
   exec                Run a command in a running container
   version             Display runtime version information
   images, image, img  List images
   inspect             Display the status of one or more containers
   inspecti            Return the status of one or more images
   imagefsinfo         Return image filesystem info
   inspectp            Display the status of one or more pods
   logs                Fetch the logs of a container
   port-forward        Forward local port to a pod
   ps                  List containers
   pull                Pull an image from a registry
   run                 Run a new container inside a sandbox
   runp                Run a new pod
   rm                  Remove one or more containers
   rmi                 Remove one or more images
   rmp                 Remove one or more pods
   pods                List pods
   start               Start one or more created containers
   info                Display information of the container runtime
   stop                Stop one or more running containers
   stopp               Stop one or more running pods
   update              Update one or more running containers
   config              Get and set crictl client configuration options
   stats               List container&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;s&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; resource usage statistics
   completion          Output shell completion code
   help, h             Shows a list of commands or help &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; one command

GLOBAL OPTIONS:
   --config value, -c value            Location of the client config file. If not specified and the default does not exist, the program&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;s directory is searched as well (default: &amp;#34;/etc/crictl.yaml&amp;#34;) [$CRI_CONFIG_FILE]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;   --debug, -D                         Enable debug mode (default: false)
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;   --image-endpoint value, -i value    Endpoint of CRI image manager service (default: uses &amp;#39;&lt;/span&gt;runtime-endpoint&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; setting&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;$IMAGE_SERVICE_ENDPOINT&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;default: uses in order the first successful one of &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock&lt;span style=&#34;color:#f92672&#34;&gt;])&lt;/span&gt;. Default is now deprecated and the endpoint should be set instead. &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;$CONTAINER_RUNTIME_ENDPOINT&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
   --timeout value, -t value           Timeout of connecting to the server in seconds &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;e.g. 2s, 20s.&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;. &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; or less is set to default &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;default: 2s&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
   --help, -h                          show help &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;default: false&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
   --version, -v                       print the version &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;default: false&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;以上。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/&#34;&gt;kubernetes.io 使用 crictl 对 Kubernetes 节点进行调试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;%C2%A0https://item.jd.com/13140598.html&#34;&gt;《Kubernetes进阶实战-第2版》CRI 与OCI &lt;/a&gt;
 &lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Docker、Go、PostgreSQL如何修改时区</title>
      <link>https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/</link>
      <pubDate>Sat, 25 Feb 2023 15:55:06 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/</guid>
      <description>&lt;p&gt;本文主要介绍Docker、Go、PostgreSQL如何修改它们的时区。&lt;/p&gt;
&lt;p&gt;首先需要知道一些基础概念:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Unix 时间戳 -是从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数，不考虑闰秒。&lt;/li&gt;
&lt;li&gt;UTC &amp;ndash;协调世界时，又称世界统一时间、世界标准时间、国际协调时间。&lt;/li&gt;
&lt;li&gt;CST&amp;ndash;可视为中国、古巴的标准时间或美国、澳大利亚的中部时间。北京时间，也就是东八区时间。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;docker&#34;&gt;Docker&lt;/h3&gt;
&lt;p&gt;Docker 作为部署和运行应用程序的环境，默认使用 UTC 作为其容器的时区，但我们可以通过设置环境变量来修改时区。&lt;/p&gt;
&lt;p&gt;修改的方法&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在 Dockerfile 中添加以下行：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;ENV TZ=Asia/Shanghai&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;在 Kubernetes 中的 Pod 配置文件中，添加 env 字段，设置环境变量。Example:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
  - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-container&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-image&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;env&lt;/span&gt;:
      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;TZ&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Asia/Shanghai&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;验证在容器中使用 env 命令查看环境变量，例如&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;env
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出会有key为TZ，value为Asia/Shanghai表示成功&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;TZ&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Asia/Shanghai
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;go&#34;&gt;Go&lt;/h3&gt;
&lt;p&gt;在 Go 中修改时区需要使用标准库中的 time 包。我们可以通过FixedZone来修改时区。
Example：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;

&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; (
	&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
)

&lt;span style=&#34;color:#66d9ef&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;() {
	&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;utcZone&lt;/span&gt; = &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;FixedZone&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UTC&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3600&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;// UTC
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Local&lt;/span&gt; = &lt;span style=&#34;color:#a6e22e&#34;&gt;utcZone&lt;/span&gt;
	&lt;span style=&#34;color:#a6e22e&#34;&gt;utcNow&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Now&lt;/span&gt;()
	&lt;span style=&#34;color:#a6e22e&#34;&gt;utcDate&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Date&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;utcNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Year&lt;/span&gt;(), &lt;span style=&#34;color:#a6e22e&#34;&gt;utcNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Month&lt;/span&gt;(), &lt;span style=&#34;color:#a6e22e&#34;&gt;utcNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Day&lt;/span&gt;(), &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;utcNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Location&lt;/span&gt;())
	&lt;span style=&#34;color:#a6e22e&#34;&gt;fmt&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Printf&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UTC time: %s\n&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;utcDate&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;String&lt;/span&gt;())
	&lt;span style=&#34;color:#a6e22e&#34;&gt;fmt&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Printf&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UTC timestamp: %d\n&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;utcDate&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Unix&lt;/span&gt;())

	&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cstZone&lt;/span&gt; = &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;FixedZone&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CST&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3600&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;// 东八
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Local&lt;/span&gt; = &lt;span style=&#34;color:#a6e22e&#34;&gt;cstZone&lt;/span&gt;
	&lt;span style=&#34;color:#a6e22e&#34;&gt;cstNow&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Now&lt;/span&gt;()
	&lt;span style=&#34;color:#a6e22e&#34;&gt;cstDate&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;time&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Date&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;cstNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Year&lt;/span&gt;(), &lt;span style=&#34;color:#a6e22e&#34;&gt;cstNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Month&lt;/span&gt;(), &lt;span style=&#34;color:#a6e22e&#34;&gt;cstNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Day&lt;/span&gt;(), &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;cstNow&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Location&lt;/span&gt;())
	&lt;span style=&#34;color:#a6e22e&#34;&gt;fmt&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Printf&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CST time: %s\n&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;cstDate&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;String&lt;/span&gt;())
	&lt;span style=&#34;color:#a6e22e&#34;&gt;fmt&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Printf&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CST timestamp: %d\n&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;cstDate&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Unix&lt;/span&gt;())
}
&lt;span style=&#34;color:#75715e&#34;&gt;//output
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;//UTC time: 2023-02-25 00:00:00 +0000 UTC
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;//UTC timestamp: 1677283200
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;//CST time: 2023-02-25 00:00:00 +0800 CST
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;//CST timestamp: 1677254400
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在上面的代码中，我们使用time.FixedZone分别设置UTC、上海时区，并获取当天零点的时间戳 _date。&lt;/p&gt;
&lt;h3 id=&#34;postgresql&#34;&gt;PostgreSQL&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;在PostgreSQL系统内部，所有日期和时间都用全球统一时间UTC格式存储， 时间在发给客户前端前由数据库服务器根据TimeZone 配置参数声明的时区转换成本地时间&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;在 PostgreSQL 中，我们可以通过修改 postgresql.conf 文件来修改时区。
以下是如何在 Docker运行 PostgreSQL 中修改时区的步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;拷贝dockers中的 postgresql.conf到宿主主机&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo docker cp &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;your_docker_contariner_id&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:/var/lib/postgresql/data/postgresql.conf /&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;your_work_space&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;修改配置&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;sudo vi /[your_work_space]/postgresql.conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查找替换timezone为上海时区&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;timezone = &#39;Asia/Shanghai&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以通过sql查找支持的时区：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt; pg_timezone_names;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;保存并覆盖dockers中配置&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo docker cp /&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;your_work_space&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;/postgresql.conf &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;your_docker_contariner_id&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:/var/lib/postgresql/data/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;重新容器&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;sudo docker restart [your_docker_contariner_id
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;现在，你的 PostgreSQL 数据库就使用了正确的时区。&lt;/p&gt;
&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;检查是否设置成功
通过sql获取设置：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt; pg_db_role_setting;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;也可以查看数据库中表字段格式为TimestampTZ，Example
修改前&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2023-02-25 00:00:00 +0000 +00&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;修改后台&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2023-02-25 08:00:00 +0000 +08&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;以上。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://yeasy.gitbook.io/docker_practice/image/dockerfile/env&#34;&gt; docker 修改Env&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.postgres.cn/docs/14/datatype-datetime.html&#34;&gt;postgres.cn/docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://hjxlog.com/posts/20210902215616.html&#34;&gt; 博客dockers-postgre 修改TimeZone&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Ingress与IngressController</title>
      <link>https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/</link>
      <pubDate>Sun, 20 Nov 2022 15:31:51 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/</guid>
      <description>&lt;p&gt;本文主要学习记录Kubernetes集群暴露服务的方式: Ingress。&lt;/p&gt;
&lt;h3 id=&#34;简介&#34;&gt;简介&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。&lt;/p&gt;
&lt;p&gt;IngressController  为了让 Ingress 资源工作，集群必须有一个正在运行的 Ingress 控制器。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://luckytking.github.io/images/ingress_layout.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上图清晰标识出了Ingress的流量走向，其中：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ingress基于DNS名称（host）或URL路径把请求转发⾄指定的Service资源的规则。它仅是⼀组路由规则的集合。&lt;/li&gt;
&lt;li&gt;Ingress控制器是真正实现“流量穿透”，可以由具有反向代理（HTTP/HTTPS）功能的服务程序实现 , 然后根据这些规则的匹配机制路由请求流量&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;ingress-资源声明&#34;&gt;Ingress 资源声明&lt;/h3&gt;
&lt;p&gt;Ingress是Kubernetes API的标准资源类型之⼀ ,一个最小Ingress例子：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;networking.k8s.io/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Ingress&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;minimal-ingress&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;annotations&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;nginx.ingress.kubernetes.io/rewrite-target&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;ingressClassName&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-example&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;rules&lt;/span&gt;:
  - &lt;span style=&#34;color:#f92672&#34;&gt;http&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;paths&lt;/span&gt;:
      - &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/testpath&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;pathType&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Prefix&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;backend&lt;/span&gt;:
          &lt;span style=&#34;color:#f92672&#34;&gt;service&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;test&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;port&lt;/span&gt;:
              &lt;span style=&#34;color:#f92672&#34;&gt;number&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ingress 需要指定 apiVersion、kind、 metadata和 spec 字段。&lt;/li&gt;
&lt;li&gt;Ingress 对象的命名必须是合法的 DNS 子域名名称。&lt;/li&gt;
&lt;li&gt;Ingress annotations 来配置一些选项,  ⽤于识别其所属的Ingress控制器的类别。&lt;/li&gt;
&lt;li&gt;Ingress rules 提供了配置负载均衡器或者代理服务器所需的所有信息。 最重要的是，其中包含与所有传入请求匹配的规则列表。 Ingress 资源仅支持用于转发 HTTP(S) 流量的规则。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多参考： &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/&#34;&gt;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;ingress-controller&#34;&gt;Ingress Controller&lt;/h3&gt;
&lt;p&gt;Ingress控制器可以由任何具有反向代理（HTTP/HTTPS）功能的服务程序实现，目前支持和维护 AWS、 GCE 和 Nginx Ingress 控制器。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Nginx Ingress 作为反向代理和负载均衡器。&lt;/li&gt;
&lt;li&gt;Apache APISIX Ingress 控制器 是一个基于 Apache APISIX 网关 的 Ingress 控制器。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多参考：https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/&lt;/p&gt;
&lt;h3 id=&#34;安装-ingress-nginx&#34;&gt;安装 Ingress Nginx&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/cloud/deploy.yaml  -O ingress-nginx-deploy.yaml

kubectl apply -f  ingress-nginx-deploy.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;观测是否成功：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl get pods -n ingress-nginx --watch
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果成功的话，查看namespace下所有的资源信息&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@master:/home/master# kubectl get all -n ingress-nginx
NAME                                            READY   STATUS    RESTARTS   AGE
pod/ingress-nginx-controller-123456   1/1     Running   0          1h

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.104.182.98    192.168.1.100   80:31666/TCP,443:31888/TCP   1d
service/ingress-nginx-controller-admission   ClusterIP      10.111.228.99   &amp;lt;none&amp;gt;         443/TCP                      1d

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           1d

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-123456   1         1         1      1d

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           1s         1d
job.batch/ingress-nginx-admission-patch    1/1           2s         1d
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;使用ingress-发布-tomcat&#34;&gt;使用Ingress 发布 Tomcat&lt;/h3&gt;
&lt;p&gt;部署Tomcat Service&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;创建deployment&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;    kubectl create deployment web --image=tomcat:8.0.50-jre8-alpine
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;将 Deployment 暴露出来&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl expose deployment web --type=NodePort --port=8080

&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;将 Deployment 暴露出来&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@master:/home/master# kubectl get service web
    NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
    web    NodePort   10.100.183.22   &amp;lt;none&amp;gt;        8080:32562/TCP   30s
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;验证nodeport 是否正常访问 tomcat ，浏览器访问  http://matster_ip:32562
&lt;img src=&#34;https://luckytking.github.io/images/ingress_tomcat.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;创建 ingress&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt; &lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;networking.k8s.io/v1&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Ingress&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;ingressfoo&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;annotations&lt;/span&gt;:
        &lt;span style=&#34;color:#f92672&#34;&gt;kubernetes.io/ingress.class&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nginx&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;default&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;rules&lt;/span&gt;:
      - &lt;span style=&#34;color:#f92672&#34;&gt;host&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;ingressfoo.io&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;http&lt;/span&gt;:
          &lt;span style=&#34;color:#f92672&#34;&gt;paths&lt;/span&gt;:
          - &lt;span style=&#34;color:#f92672&#34;&gt;backend&lt;/span&gt;:
              &lt;span style=&#34;color:#f92672&#34;&gt;service&lt;/span&gt;:
                &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;web&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;port&lt;/span&gt;:
                  &lt;span style=&#34;color:#f92672&#34;&gt;number&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;8080&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/bar&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;pathType&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Prefix&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看ingress是否创建成功&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@master:/home/master# kubectl get ingress
NAME         CLASS    HOSTS                     ADDRESS        PORTS   AGE
ingressfoo   &amp;lt;none&amp;gt;   ingressfoo.io   192.168.1.100   80      1h
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;说明Ingress创建成功，修改hosts ：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ingressfoo.io 192.168.1.100&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;验证访问 ingressfoo.io/bar&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://luckytking.github.io/images/ingress_tomcat2.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;success&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Ingress  介绍 &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/&#34;&gt;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;IngressController 介绍  &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/&#34;&gt;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/apache/apisix-ingress-controller&#34;&gt;https://github.com/apache/apisix-ingress-controller&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;NGINX Ingress 控制器配置 Ingress &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8&#34;&gt;https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;在K8S上的Web服务该怎么做域名解析 &lt;a href=&#34;https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA&#34;&gt;https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Kubernetes集群资源监控一机制和资源指标</title>
      <link>https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/</link>
      <pubDate>Sat, 05 Nov 2022 22:50:36 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/</guid>
      <description>本文主要介绍Kubernetes集群资源监控机制和资源指标
前言 临近双11，对于码农，尤其是后端，尤其是某宝某东的后端，那是多么激动人心（心惊胆战）的一夜，为什么？怕宕机呀~。那么就让我们来构建护城河&amp;ndash;监控与自动扩容，来抵挡千军万马&amp;ndash;高并发场景。首先让我们学习一些基础：k8s集群资源监控机制和资源指标。
分析 从需求出发，我们自然需要收集一些数据(资源指标)，再根据指标做一系列的操作(control)，比如说预警警告、统计、自动扩容等。
首先，我们希望可以监控整个Kubernetes集群的健康状况，包括：
 整个集群的资源利⽤率 集群中的所有⼯作节点是否运⾏正常、系统资源容量⼤⼩ 每个⼯作节点上运⾏的容器化应⽤的数量  k8s资源控制 我们看看k8s如何资源控制
限制节点 以购物平台为例，微服务广受推崇，比如双11当天，用户进首页是流畅的，但是进活动主页就卡顿，到了零点时，加入购物车的按钮都转圈了。设想你的设计可能是三个微服务（主页服务 、双十一活动服务、订单服务），可想而知，活动服务是压力最大的，我们希望，就算宕机，不要影响其他的服务。所以可以把活动服务限制运行在某节点。
 创建一个会被调度到特定节点上的 Pod，你也可以通过设置 nodeName 将某个 Pod 调度到特定的节点
 nodeName: foo-node # 调度 Pod 到特定的节点 限制内存 还是上面的例子，我们把活动服务调度到了 foo-node。那么剩下的服务没有去限制，但想想订单服务的压力也不小，这里我们希望限制它的资源上限。
 要为容器指定内存请求，请在容器资源清单中包含 resources：requests 字段。 同理，要指定内存限制，请包含 resources：limits。
 resources: requests: memory: &amp;#34;1000Gi&amp;#34; limits: memory: &amp;#34;1000Gi&amp;#34; 限制CPU  要为容器指定 CPU 请求，请在容器资源清单中包含 resources: requests 字段。 要指定 CPU 限制，请包含 resources:limits
 resources: limits: cpu: &amp;#34;100&amp;#34; requests: cpu: &amp;#34;100&amp;#34; Example 环境准备:
 k8s集群（master * 1，node * 2 ) kubectl 命令行工具( 笔者使用rancher)   创建一个namespace（stress）。 增加一个deployment, 修改内存上限为10M 1.</description>
    </item>
    
    <item>
      <title>利用k8s储存卷来部署redis之三StatefulSet</title>
      <link>https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/</link>
      <pubDate>Sun, 11 Sep 2022 18:20:54 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/</guid>
      <description>&lt;p&gt;前两篇(1.&lt;a href=&#34;https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/&#34;&gt;volume&lt;/a&gt;2.&lt;a href=&#34;https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/&#34;&gt;pv&amp;amp;pvc&lt;/a&gt;)通过部署redis学习实战了k8s的来Volume、PV和PVC。但是，应⽤程序存在“有状态”和“⽆状态”两种类别，显然redis属于读写磁盘需求的有状态应⽤程序，如⽀持事务功能的RDBMS存储系统，所以，本文学习实战k8s有状态应用的部署。&lt;/p&gt;
&lt;h3 id=&#34;stateful基础&#34;&gt;Stateful基础&lt;/h3&gt;
&lt;p&gt;StatefulSet是Pod资源控制器的⼀种实现，⽤于部署和扩展有状态应⽤的Pod资源，确保它们的运⾏顺序及每个Pod资源的唯⼀性。适用以下需求的应用：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;稳定且唯⼀的⽹络标识符。&lt;/li&gt;
&lt;li&gt;稳定且持久的存储。&lt;/li&gt;
&lt;li&gt;有序、优雅地部署和扩展。&lt;/li&gt;
&lt;li&gt;有序、优雅地删除和终⽌。&lt;/li&gt;
&lt;li&gt;有序⽽⾃动地滚动更新。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;部署&#34;&gt;部署&lt;/h3&gt;
&lt;p&gt;接着，这里把之前的redis存储修改为stateful的方式，修改后的步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建 ConfigMap （参考第一篇）&lt;/li&gt;
&lt;li&gt;修改 Deployment 为StatefulSets&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;修改部署statefulsets&#34;&gt;修改部署StatefulSets&lt;/h4&gt;
&lt;p&gt;mkdir my-redis-statefulsets.yaml&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;StatefulSet&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;replicas&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;serviceName&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
        &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;resources&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;requests&lt;/span&gt;:
              &lt;span style=&#34;color:#f92672&#34;&gt;cpu&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100m&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;memory&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100Mi&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#          command: [&amp;#34;redis-server&amp;#34;,&amp;#34;/etc/redis/redis.conf&amp;#34;]&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;command&lt;/span&gt;:
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;redis-server&lt;/span&gt;
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;containerPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;volumeMounts&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;subPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-storage&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/data&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;volumes&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-storage&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;emptyDir&lt;/span&gt;: {}
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;configMap&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;items&lt;/span&gt;:
              - &lt;span style=&#34;color:#f92672&#34;&gt;key&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
 
---
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Service&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;type&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;NodePort&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
  - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;port&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;targetPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;nodePort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;30379&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis          &lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Headless Service：⽤于为Pod资源标识符⽣成可解析的DNS资源记录&lt;/li&gt;
&lt;li&gt;StatefulSet ⽤于管控Pod资源&lt;/li&gt;
&lt;li&gt;volumeClaimTemplate则基于静态或动态的PV供给⽅式为Pod资源提供
专有且固定的存储（这里我们直接使用了第二篇创建的pv）&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;测试&#34;&gt;测试&lt;/h3&gt;
&lt;p&gt;redis-client 连接 NodeId:NodePort&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&amp;gt; info
# Serverredis_version:7.0.4
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;连接成功!&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;官方stateful介绍 &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage&#34;&gt;https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>利用k8s储存卷来部署redis之二PV与PVC</title>
      <link>https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/</link>
      <pubDate>Fri, 02 Sep 2022 23:28:57 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/</guid>
      <description>&lt;p&gt;之前学习实践使用熟悉卷（Volume）来存储&lt;a href=&#34;https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/&#34;&gt;利用k8s储存卷来部署redis&lt;/a&gt;，本文接着学习实践k8s的存储，主要通过redis存储例子学习实战PV和PVC。&lt;/p&gt;
&lt;h3 id=&#34;pv--pvc&#34;&gt;PV &amp;amp; PVC&lt;/h3&gt;
&lt;p&gt;Kubernetes为例⽤户和开发隐藏底层架构的⽬标，在用户和存储服务之间添加了一个中间层，也就是PersistentVolume和PersistentVolumeClaim。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PersistentVolume 持久卷 (是集群中的一块存储，可以由管理员事先制备， 或者使用存储类（Storage Class）来动态制备。）&lt;/li&gt;
&lt;li&gt;PersistentVolumeClaim 持久卷申领 （
表达的是用户对存储的请求。概念上与 Pod 类似。）
更多详细参见参考 &lt;a href=&#34;https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes&#34;&gt;https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;redisvolume修改为pvpvc&#34;&gt;RedisVolume修改为PV&amp;amp;PVC&lt;/h3&gt;
&lt;p&gt;接着，这里把之前的redis存储修改为pv-pvc的方式，修改后的步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建 ConfigMap （参考第一篇）&lt;/li&gt;
&lt;li&gt;增加声明PV和PVC （新增）&lt;/li&gt;
&lt;li&gt;增加 Deployment （把Volume修改为 步骤2 的PVC）&lt;/li&gt;
&lt;li&gt;暴露 Service （参考第一篇）&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;步骤2增加声明pv和pvc&#34;&gt;步骤2，增加声明PV和PVC&lt;/h4&gt;
&lt;p&gt;mkdir my-redis-pv-pvc.yaml&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;PersistentVolume&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-pv&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
     &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;capacity&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;storage&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;1Gi&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;accessModes&lt;/span&gt;:
  - &lt;span style=&#34;color:#ae81ff&#34;&gt;ReadWriteOnce&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;hostPath&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/mnt/data/my-redis&amp;#34;&lt;/span&gt;
---
&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;PersistentVolumeClaim&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis-pvc&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;accessModes&lt;/span&gt;:
  - &lt;span style=&#34;color:#ae81ff&#34;&gt;ReadWriteOnce&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;resources&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;requests&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;storage&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;1Gi&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行创建&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;master# kubectl apply -f my-redis-pv-pvc.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看pv状态&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;master# kubectl get pv 
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM     STORAGECLASS    REASON   AGE
my-redis-pv     1Gi        RWO            Retain           Bound    my-ns/redis-pvc                                                 50m

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看pvc状态&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;master# kubectl get pvc -n my-ns
NAME               STATUS   VOLUME         CAPACITY   ACCESS MODES   STORAGECLASS   AGE
redis-pvc          Bound    my-redis-pv    1Gi             RWO                                          54m
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;pv和pvc已经Bound成功。&lt;/p&gt;
&lt;h4 id=&#34;步骤3增加-deployment-把volume修改为-步骤2-的pvc&#34;&gt;步骤3，增加 Deployment （把Volume修改为 步骤2 的PVC）&lt;/h4&gt;
&lt;p&gt;mkdir my-redis-deployment-pvc.yaml&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Unique name for the deployment&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;myns&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis      &lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Labels to be applied to this deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:     &lt;span style=&#34;color:#75715e&#34;&gt;# This deployment applies to the Pods matching these labels&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;replicas&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Run a single pod in the deployment&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:          &lt;span style=&#34;color:#75715e&#34;&gt;# Template for the pods that will be created by this deployment&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:        &lt;span style=&#34;color:#75715e&#34;&gt;# Labels to be applied to the Pods in this deployment&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:            &lt;span style=&#34;color:#75715e&#34;&gt;# Spec for the container which will be run inside the Pod.&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;resources&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;requests&lt;/span&gt;:
              &lt;span style=&#34;color:#f92672&#34;&gt;cpu&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100m&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;memory&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100Mi&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#          command: [&amp;#34;redis-server&amp;#34;,&amp;#34;/etc/redis/redis.conf&amp;#34;]&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;command&lt;/span&gt;:
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;redis-server&lt;/span&gt;
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;containerPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;volumeMounts&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;subPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-storage&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/data&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;volumes&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-persistent-storage &lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;persistentVolumeClaim&lt;/span&gt;:
          &lt;span style=&#34;color:#f92672&#34;&gt;claimName&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis-pvc&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# 这里修改为步骤2声明的pvc&lt;/span&gt;
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;configMap&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;items&lt;/span&gt;:
              - &lt;span style=&#34;color:#f92672&#34;&gt;key&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行创建deployment&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;master# kubectl apply -f my-redis-deployment-pvc.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;检查状态&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;master# kubectl get pod -n my-ns
NAME                                   READY   STATUS    RESTARTS   AGE 
my-redis-6565459689-mbptf              1/1     Running   0          53m
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;测试&#34;&gt;测试&lt;/h4&gt;
&lt;p&gt;redis-client 连接 NodeId:NodePort&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&amp;gt; info
# Server
redis_version:7.0.4
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;连接成功。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes&#34;&gt;https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&#34;&gt;https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>利用k8s储存卷来部署redis</title>
      <link>https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/</link>
      <pubDate>Sun, 28 Aug 2022 16:29:07 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/</guid>
      <description>&lt;p&gt;本文主要通过利用k8s如何部署Redis,来学习使用k8s的存储卷Volume。&lt;/p&gt;
&lt;p&gt;Pod本⾝具有⽣命周期，故其内部运⾏的容器及其相关数据⾃⾝均⽆法持久存在。Kubernetes也⽀持类似Docker的存储卷功能，不过，其存储卷Volume是与Pod资源绑定⽽⾮容器。&lt;/p&gt;
&lt;h3 id=&#34;pod-volume&#34;&gt;Pod Volume&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;如何要在一个Pod里声明 Volume&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;⼀是通过.spec.volumes字段定义在Pod之上的存储卷列表，其⽀持使⽤多种不同类型的存储卷且配置参数差别很⼤；&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
&lt;span style=&#34;color:#ae81ff&#34;&gt;…&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;volumes&lt;/span&gt;:
&lt;span style=&#34;color:#f92672&#34;&gt;* name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;logdata&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;emptyDir&lt;/span&gt;: {}
&lt;span style=&#34;color:#f92672&#34;&gt;* name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;example&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;gitRepo&lt;/span&gt;:
&lt;span style=&#34;color:#f92672&#34;&gt;repository&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;https://github.com/iKubernetes/k8s_book.git&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;revision&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;directory&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;另⼀个是通过.spec.containers.volumeMounts字段在容器上定义的存储卷挂载列表，它只能挂载当前Pod资源中定义的具体存储卷，当然，也可以不挂载任何存储卷&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
&lt;span style=&#34;color:#ae81ff&#34;&gt;…&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
&lt;span style=&#34;color:#f92672&#34;&gt;* name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;&amp;lt;String&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;…&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;volumeMounts&lt;/span&gt;:
* &lt;span style=&#34;color:#ae81ff&#34;&gt;name &amp;lt;string&amp;gt; -required-&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;mountPath &amp;lt;string&amp;gt; -required-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在之前（&lt;a href=&#34;https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/&#34;&gt;声明式对象配置&lt;/a&gt;）有介绍过nginx的部署，接着来部署Redis，和Nginx有所不同的是，这里多了一个 ConfigMap 和Volume ,用来配置管理redis和储存。&lt;/p&gt;
&lt;h3 id=&#34;环境&#34;&gt;环境&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;一个k8s 集群（mater* 1，node* 1）&lt;/li&gt;
&lt;li&gt;一个正常连接k8smater的主机的终端&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;创建-config-map&#34;&gt;创建 Config-Map&lt;/h3&gt;
&lt;p&gt;使用 ConfigMap 来配置 Redis ，包含了Redis配置文件里需要的配置项，在创建Pod时会作为配置文件挂载到应用所在的容器中。 my-config-map.yaml 具体如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;ConfigMap&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;data&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;redis.conf&lt;/span&gt;: |&lt;span style=&#34;color:#e6db74&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    requirepass 123456
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    protected-mode no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    port 6379
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    tcp-backlog 511
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    timeout 0
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    tcp-keepalive 300
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    daemonize no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    supervised no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    pidfile /var/run/redis_6379.pid
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    loglevel notice
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    logfile &amp;#34;&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    databases 16
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    always-show-logo yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    save 900 1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    save 300 10
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    save 60 10000
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    stop-writes-on-bgsave-error yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    rdbcompression yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    rdbchecksum yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    dbfilename dump.rdb
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    dir /data
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slave-serve-stale-data yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slave-read-only yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    repl-diskless-sync no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    repl-diskless-sync-delay 5
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    repl-disable-tcp-nodelay no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slave-priority 100
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    lazyfree-lazy-eviction no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    lazyfree-lazy-expire no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    lazyfree-lazy-server-del no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slave-lazy-flush no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    appendonly no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    appendfilename &amp;#34;appendonly.aof&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    appendfsync everysec
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    no-appendfsync-on-rewrite no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    auto-aof-rewrite-percentage 100
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    auto-aof-rewrite-min-size 64mb
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    aof-load-truncated yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    aof-use-rdb-preamble no
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    lua-time-limit 5000
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slowlog-log-slower-than 10000
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    slowlog-max-len 128
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    latency-monitor-threshold 0
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    notify-keyspace-events Ex
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    hash-max-ziplist-entries 512
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    hash-max-ziplist-value 64
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    list-max-ziplist-size -2
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    list-compress-depth 0
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    set-max-intset-entries 512
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    zset-max-ziplist-entries 128
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    zset-max-ziplist-value 64
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    hll-sparse-max-bytes 3000
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    activerehashing yes
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    client-output-buffer-limit normal 0 0 0
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    client-output-buffer-limit slave 256mb 64mb 60
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    client-output-buffer-limit pubsub 32mb 8mb 60
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    hz 10
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    aof-rewrite-incremental-fsync yes&lt;/span&gt;    
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行命令&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# kubectl apply -f my-redis-config.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;创建-deployment&#34;&gt;创建 Deployment&lt;/h3&gt;
&lt;p&gt;创建Deployment 作为调度Pod运行 Redis 的载体。my-redis-deployment.yaml具体如下&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Unique name for the deployment&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis      &lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Labels to be applied to this deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:     &lt;span style=&#34;color:#75715e&#34;&gt;# This deployment applies to the Pods matching these labels&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;replicas&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Run a single pod in the deployment&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:          &lt;span style=&#34;color:#75715e&#34;&gt;# Template for the pods that will be created by this deployment&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:        &lt;span style=&#34;color:#75715e&#34;&gt;# Labels to be applied to the Pods in this deployment&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:            &lt;span style=&#34;color:#75715e&#34;&gt;# Spec for the container which will be run inside the Pod.&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;resources&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;requests&lt;/span&gt;:
              &lt;span style=&#34;color:#f92672&#34;&gt;cpu&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100m&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;memory&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;100Mi&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#          command: [&amp;#34;redis-server&amp;#34;,&amp;#34;/etc/redis/redis.conf&amp;#34;]&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;command&lt;/span&gt;:
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;redis-server&lt;/span&gt;
            - &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;containerPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;volumeMounts&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/etc/redis/redis.conf&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;subPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
            - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-storage&lt;/span&gt;
              &lt;span style=&#34;color:#f92672&#34;&gt;mountPath&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;/data&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;volumes&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-storage&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;emptyDir&lt;/span&gt;: {}
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;configMap&lt;/span&gt;:
            &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-config&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;items&lt;/span&gt;:
              - &lt;span style=&#34;color:#f92672&#34;&gt;key&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;path&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;redis.conf&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# kubectl apply -f my-redis-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;创建-service&#34;&gt;创建 service&lt;/h3&gt;
&lt;p&gt;NodePort 方式向外暴露服务。my-redis-service.yaml 具体如下&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Service       &lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Type of Kubernetes resource&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis-svc&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# Name of the Kubernetes resource&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;namespace&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-ns&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:            &lt;span style=&#34;color:#75715e&#34;&gt;# Labels that will be applied to this resource&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;type&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;NodePort&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
    - &lt;span style=&#34;color:#f92672&#34;&gt;port&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;       &lt;span style=&#34;color:#75715e&#34;&gt;# Map incoming connections on port 6379 to the target port 6379 of the Pod&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;targetPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;6379&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;nodePort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;30379&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:          &lt;span style=&#34;color:#75715e&#34;&gt;# Map any Pod with the specified labels to this service&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;my-redis&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;role&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;tier&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;backend&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# kubectl apply -f my-redis-service.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;测试&#34;&gt;测试&lt;/h3&gt;
&lt;p&gt;redis-client 测试NodeId:NodePort&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;redis-cli -h YourNodeIp -p 30379 -a 123456
YourNodeIp:30379&amp;gt; info
# Server
redis_version:7.0.4
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;连接成功。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/tutorials/configuration/configure-redis-using-configmap/&#34;&gt;https://kubernetes.io/zh-cn/docs/tutorials/configuration/configure-redis-using-configmap/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kevinyan815/LearningKubernetes/tree/master/redis-singleton&#34;&gt;https://github.com/kevinyan815/LearningKubernetes/tree/master/redis-singleton&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;《Kubernetes进阶实战-第2版》  &lt;a href=&#34;https://item.jd.com/13140598.html&#34;&gt;https://item.jd.com/13140598.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Rancher2.6.6更新ssl为公认CA证书</title>
      <link>https://luckytking.github.io/2022/08/rancher2.6.6%E6%9B%B4%E6%96%B0ssl%E4%B8%BA%E5%85%AC%E8%AE%A4ca%E8%AF%81%E4%B9%A6/</link>
      <pubDate>Sat, 13 Aug 2022 17:34:12 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/08/rancher2.6.6%E6%9B%B4%E6%96%B0ssl%E4%B8%BA%E5%85%AC%E8%AE%A4ca%E8%AF%81%E4%B9%A6/</guid>
      <description>&lt;p&gt;访问Rancher后台提示“证书无效”。&lt;/p&gt;
&lt;p&gt;排查原因是由于挂载的ssl证书失败，rancher启用了生成的默认 CA 证书。这里打算
更新为公认的 CA 签名证书，其中&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rancher版本 v2.6.6&lt;/li&gt;
&lt;li&gt;Racher为Docker单节点安装&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;解决步骤&#34;&gt;解决步骤&lt;/h3&gt;
&lt;p&gt;考虑到单机版是没有Volume的，为了保证数据不丢失。处理大致分为以下几个步骤&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;从你的 Rancher 服务器容器创建数据的副本&lt;/li&gt;
&lt;li&gt;创建一个备份压缩包&lt;/li&gt;
&lt;li&gt;使用新的证书 启动新的Rancher服务器容器&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;1-从你的-rancher-服务器容器创建数据的副本&#34;&gt;1. 从你的 Rancher 服务器容器创建数据的副本&lt;/h4&gt;
&lt;h5 id=&#34;11-停止当前运行-rancher-服务器的容器替换rancher_container_name为您的-rancher-容器的名称&#34;&gt;1.1 停止当前运行 Rancher 服务器的容器。替换&amp;lt;RANCHER_CONTAINER_NAME&amp;gt;为您的 Rancher 容器的名称&lt;/h5&gt;
&lt;p&gt;&lt;img src=&#34;https://luckytking.github.io/images/rancher-ssl.png&#34; alt=&#34;&#34;&gt;
运行停止RancherDocker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;docker stop &amp;lt;RANCHER_CONTAINER_NAME&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h5 id=&#34;12-使用以下命令替换每个占位符从您刚刚停止的-rancher-容器创建一个数据容器&#34;&gt;1.2 使用以下命令替换每个占位符，从您刚刚停止的 Rancher 容器创建一个数据容器。&lt;/h5&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;docker create --volumes-from &amp;lt;RANCHER_CONTAINER_NAME&amp;gt; --name rancher-data rancher/rancher&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;&amp;lt;RANCHER_CONTAINER_TAG&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;2-创建一个备份压缩包&#34;&gt;2. 创建一个备份压缩包&lt;/h4&gt;
&lt;p&gt;从您刚刚创建的数据容器 ( rancher-data)，创建一个备份 tarball ( rancher-data-backup-&amp;lt;RANCHER_VERSION&amp;gt;-&lt;!-- raw HTML omitted --&gt;.tar.gz)。如果升级期间出现问题，此 tarball 将用作回滚点。使用以下命令，替换每个占位符。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;docker run --volumes-from rancher-data -v &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;$PWD:/backup&amp;#34;&lt;/span&gt; --rm busybox tar zcvf /backup/rancher-data-backup-&amp;lt;RANCHER_VERSION&amp;gt;-&amp;lt;DATE&amp;gt;.tar.gz /var/lib/rancher
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;3-启动新的rancher服务器容器&#34;&gt;3. 启动新的Rancher服务器容器&lt;/h4&gt;
&lt;p&gt;如果您选择使用由公认的 CA 签名的证书，您将添加&amp;ndash;volumes-from rancher-data到您启动原始 Rancher 服务器容器的命令中，并且需要访问您最初安装时使用的相同证书。请记住将&amp;ndash;no-cacerts作为参数包含在容器中以禁用 Rancher 生成的默认 CA 证书。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;docker run -d --volumes-from rancher-data \
  --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  -v /[your-workspace]/certs:/etc/rancher/ssl \ 
  --privileged \
  rancher/rancher:v2.6.6 \
  --no-cacerts
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里的 [your-workspace]替换为你的证书存放路径。其中包括 
cert.pem 和 key.pem&lt;/p&gt;
&lt;p&gt;再访问rancher dashboard，提示“有效证书”。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;使用 Docker 在单节点上安装 Rancher &lt;a href=&#34;https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/&#34;&gt;https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;升级安装了Docker的Rancher &lt;a href=&#34;https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/single-node-upgrades/&#34;&gt;https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/single-node-upgrades/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Rancher导入k8s集群后状态长时间处于Pending状态</title>
      <link>https://luckytking.github.io/2022/08/rancher%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%90%8E%E7%8A%B6%E6%80%81%E9%95%BF%E6%97%B6%E9%97%B4%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81/</link>
      <pubDate>Wed, 03 Aug 2022 22:02:43 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/08/rancher%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%90%8E%E7%8A%B6%E6%80%81%E9%95%BF%E6%97%B6%E9%97%B4%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81/</guid>
      <description>&lt;h4 id=&#34;问题描述&#34;&gt;问题描述:&lt;/h4&gt;
&lt;p&gt;在Rancher导入外部k8s集群 ,导入的集群一直处于“pending”状态。&lt;/p&gt;
&lt;p&gt;这里简要记录一下排查过程和临时解决办法。&lt;/p&gt;
&lt;h4 id=&#34;问题环境&#34;&gt;问题环境&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;rancher v2.6.6&lt;/li&gt;
&lt;li&gt;kubernetes v1.24&lt;/li&gt;
&lt;li&gt;vm1 ubuntu （rancer）&lt;/li&gt;
&lt;li&gt;vm2-3-4 k8s集群&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;导入步骤:“集群”&amp;ndash;“添加”&amp;ndash;“集群名称”&amp;ndash;创建&amp;ndash;&lt;/p&gt;
&lt;h4 id=&#34;排查解决&#34;&gt;排查&amp;amp;解决&lt;/h4&gt;
&lt;p&gt;Rancher 通过 CusterAgent 与集群进行通信（通过cattle-cluster-agent调用 Kubernetes API 与集群通讯），并通过cattle-node-agent与节点进行通信。如果 cattle-cluster-agent 无法连接到已有的 Rancher Server 也就是server-url，集群将保留在 Pending 状态。&lt;/p&gt;
&lt;h5 id=&#34;1--在k8smaster节点上面查看clusteragent的pod状态是否正常默认的namespace为cattle-system&#34;&gt;1 . 在k8smaster节点上面，查看ClusterAgent的pod状态是否正常，默认的namespace为“cattle-system”&lt;/h5&gt;
&lt;blockquote&gt;
&lt;p&gt;kubectl get pods -n cattle-system&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master:~# kubectl get pods -n cattle-system
NAME                             READY   STATUS    RESTARTS   AGE
cattle-cluster-agent-79749...   1/0     Pending   0              8m52s
cattle-cluster-agent-79749...   1/0     Pending   0              5m21s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;看到pod未正常启动&lt;/p&gt;
&lt;h5 id=&#34;2-进一步查看pod错误日志&#34;&gt;2. 进一步查看pod错误日志&lt;/h5&gt;
&lt;blockquote&gt;
&lt;p&gt;kubectl logs -f [contariner-id] -n cattle-system&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master:~# kubectl logs -f cattle-cluster-agent-79749... -n cattle-system
...
no secret assigned to service account cattle-system/rancher
...
&lt;/code&gt;&lt;/pre&gt;&lt;h5 id=&#34;3-查找error处理办法&#34;&gt;3. 查找error处理办法&lt;/h5&gt;
&lt;p&gt;通过查阅官方issures有提到&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2.6.6版本说明建议:&lt;/p&gt;
&lt;p&gt;Rancher v2.6.6是v2.6.5的镜像版本，只做了一个修改，以解决以下问题:&lt;/p&gt;
&lt;p&gt;-当Rancher试图控制来自下游集群的大量流量时，出现了一个主要的性能问题。这种机制没有正确地处理断开，并将导致无限锁定。看到# 37250。&lt;/p&gt;
&lt;p&gt;所以我猜他们没有在这个版本中添加K8S 1.24兼容性，因为v2.6.6中的兼容版本是:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;v1.18.20-rancher1-3&lt;/li&gt;
&lt;li&gt;v1.19.16-rancher1-5&lt;/li&gt;
&lt;li&gt;v1.20.15-rancher1-3&lt;/li&gt;
&lt;li&gt;v1.21.12-rancher1-1&lt;/li&gt;
&lt;li&gt;v1.22.9-rancher1-1&lt;/li&gt;
&lt;li&gt;v1.23.6-rancher1-1&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;Rancher 2.6.6 不支持 1.24。根据在此问题上设置的里程碑，计划为 2.6.7 提供支持。&lt;/p&gt;
&lt;h5 id=&#34;4尝试回滚版本&#34;&gt;4.尝试回滚版本&lt;/h5&gt;
&lt;p&gt;回滚k8s版本v1.23，rancher重新导入集群，再查看pods状态&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl get pods -n cattle-system
NAME                                    READY   STATUS    RESTARTS   AGE
cattle-cluster-agent-79749...   1/1     Running   0          8m52s
cattle-cluster-agent-79749...   1/1     Running   0          5m21s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;回到rancher查看导入的k8s状态为 “Active”&lt;/p&gt;
&lt;p&gt;至此，问题已暂时解决。持续关注Rancher2.6.7版本。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index&#34;&gt;https://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/rancher/rancher/issues/37027&#34;&gt;https://github.com/rancher/rancher/issues/37027&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/rancher/rancher/issues/37711&#34;&gt;https://github.com/rancher/rancher/issues/37711&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://lequ7.com/guan-yu-kubernetesrancher-dao-ru-kubernetes-ji-qun.html&#34;&gt;https://lequ7.com/guan-yu-kubernetesrancher-dao-ru-kubernetes-ji-qun.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>K8s学习笔记  资源配置和声明式对象配置</title>
      <link>https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/</link>
      <pubDate>Sun, 31 Jul 2022 18:04:12 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/</guid>
      <description>&lt;p&gt;本文主要记录Kubernetes的资源管理，包括资源配置，声明式管理。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Kubernetes提供了RESTful风格的API，它将各类组件均抽象为“资源”，并通过属性赋值完成实例化 。API主要由资源类型和控制器两部分组成，资源通常以json、yaml格式并写入集群的对象，控制器则在集群资源存储完成后自动创建并启动。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;常用的K8s资源有&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod&lt;/li&gt;
&lt;li&gt;Deployment&lt;/li&gt;
&lt;li&gt;Service&lt;/li&gt;
&lt;li&gt;Ingress&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;资源分类&#34;&gt;资源分类&lt;/h3&gt;
&lt;p&gt;依据资源的主要功能作为分类标准，Kubernetes的API对象⼤体可分为&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;⼯作负载 （Workload）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ReplicationController&lt;/li&gt;
&lt;li&gt;ReplicaSet&lt;/li&gt;
&lt;li&gt;Deploymen&lt;/li&gt;
&lt;li&gt;StatefulSet&lt;/li&gt;
&lt;li&gt;DaemonSet&lt;/li&gt;
&lt;li&gt;Job&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;发现和负载均衡 （Discovery&amp;amp;LB）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;配置和存储 （Config&amp;amp;Storage&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;集群 （Cluster）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Namespace&lt;/li&gt;
&lt;li&gt;Node&lt;/li&gt;
&lt;li&gt;Role&lt;/li&gt;
&lt;li&gt;ClusterRole&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;元数据 （Metadata）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;它们基本上都是围绕⼀个核⼼⽬的⽽设计：如何更好地运⾏和丰富Pod资源，从⽽为容器化应⽤提供更灵活、更完善的操作与管理组件。&lt;/p&gt;
&lt;h3 id=&#34;资源配置&#34;&gt;资源配置&lt;/h3&gt;
&lt;p&gt;标准格式一般包括一级字段&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kind&lt;/li&gt;
&lt;li&gt;apiVersion&lt;/li&gt;
&lt;li&gt;metadata （对象元数据)&lt;/li&gt;
&lt;li&gt;spec（描述所期望的对象应该具有的状态）&lt;/li&gt;
&lt;li&gt;status（字段在对象创建后由系统⾃⾏维护）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以一个nginx的pod.yaml为例&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Pod&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-pod&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-pod&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
    - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx:1.7.9&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
          - &lt;span style=&#34;color:#f92672&#34;&gt;containerPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;metadata:
&lt;ul&gt;
&lt;li&gt;name 当前的对象名称&lt;/li&gt;
&lt;li&gt;labels： 当前对象的标签（键值对）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;spec
&lt;ul&gt;
&lt;li&gt;containers，它的值是⼀个容器对象列表，⽀持嵌套创建⼀到
多个容器。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;声明式对象配置&#34;&gt;声明式对象配置&lt;/h3&gt;
&lt;p&gt;提供配置清单文件给k8s系统，并委托系统来跟踪活动对象的状态变动。管理操作的命令通过apply&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创建&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$kubectl apply -f &amp;lt;directory&amp;gt;/
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;更新&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl apply -f &amp;lt;directory&amp;gt;/
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;删除&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl apply -f &amp;lt;directory&amp;gt;/ --prune -l your-label 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;建议使用命令式的方法&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl delete -f  &amp;lt;filename&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;实战声明式部署nginx&#34;&gt;实战声明式部署nginx&lt;/h3&gt;
&lt;p&gt;定义的deployment文件: nginx_dp.yaml&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;apps/v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-deployment&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-dp&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;replicas&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;matchLabels&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-pod&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;labels&lt;/span&gt;:
        &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-pod&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
        - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx:1.7.9&lt;/span&gt;
          &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
            - &lt;span style=&#34;color:#f92672&#34;&gt;containerPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;暴露服务，定义service文件nginx_svc.yaml&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Service&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-svc&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;type&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;NodePort&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;selector&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;app&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;nginx-pod&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;ports&lt;/span&gt;:
    - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;default&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;protocol&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;TCP&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;port&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;targetPort&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;访问nginx，output
&lt;img src=&#34;https://luckytking.github.io/images/k8s-nginx.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes进阶实战-第2版》  &lt;a href=&#34;https://item.jd.com/13140598.html&#34;&gt;https://item.jd.com/13140598.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;k8s 部署nginx  &lt;a href=&#34;https://github.com/kevinyan815/LearningKubernetes&#34;&gt;https://github.com/kevinyan815/LearningKubernetes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
  </channel>
</rss>

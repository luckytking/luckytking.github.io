<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/tags\/k8s\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="k8s">
<meta name="twitter:title" content="k8s">
<meta property="og:url" content="https://luckytking.github.io/tags/k8s/">
<meta property="twitter:url" content="https://luckytking.github.io/tags/k8s/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>k8s</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/tags/k8s/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/tags/k8s/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
        

      
      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        
          <section class="postShorten-group main-content-wrap">
            
            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" aria-label="">
      
          CRI与使用crictl调试k8s节点
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-12T17:24:41&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Kubernetes 中，Kubelet 是在每个节点上运行的重要组件之一，它负责管理容器的生命周期。而 CRI（Container Runtime Interface）则是 Kubelet 用于与容器运行时进行通信的接口（如下图）。</p>
<p>CRI 采用了 ProtoBuffer 和 gPRC，规定 kubelet 该如何调用容器运行时去管理容器和镜像，Kubernetes 通过CRI可支持多种类型的OCI容器运行时，例如 docker、contained、CRI-O、runC、fraki和Kata Containers 等）。</p>
<p>为了方便用户进行容器运行时的调试工作，社区提供了 crictl 工具，用于与 CRI 接口进行交互，本文简要介绍如何使用 crictl 对 Kubernetes节点进行调试 。</p>
<p>kubelet-layout：</p>
<!-- raw HTML omitted -->
<p><img src="https://luckytking.github.io/images/kubelet-layout.png" alt=""></p>
<h4 id="安装">安装</h4>
<blockquote>
<p>你可以从 cri-tools <a href="https://github.com/kubernetes-sigs/cri-tools/releases">发布页面</a> 下载一个压缩的 crictl 归档文件，用于几种不同的架构。 下载与你的 kubernetes 版本相对应的版本。 提取它并将其移动到系统路径上的某个位置，例如 /usr/local/bin/。</p>
</blockquote>
<ul>
<li>查看版本，验证安装</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl --version
</code></pre></div><p>输出例如如下，说明安装成功:</p>
<pre tabindex="0"><code>crictl version v1.23.0 
</code></pre><h4 id="查看或编辑配置">查看或编辑配置</h4>
<p>要查看或编辑当前配置，请查看或编辑 /etc/crictl.yaml 的内容。</p>
<pre tabindex="0"><code>cat /etc/crictl.yaml
image-endpoint: unix:///var/run/image-cri-shim.sock
runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><h4 id="调试节点">调试节点</h4>
<ul>
<li>列出运行中的容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl ps
</code></pre></div><p>例如我们列出k8s集群的所有容器，例如输出：</p>
<pre tabindex="0"><code>CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID
508e30da66ce7       7a71aca7b60fc       3 days ago          Running             calico-node               0                   e0ec650992997
9daa288a68426       f822f80398b9a       3 days ago          Running             calico-typha              0                   f5c4bd6471941
300d948e75019       f6bc1b780606f       3 days ago          Running             kube-controller-manager   1                   d5d681744a377
1cfdc1a6726ae       0198979b7707e       3 days ago          Running             kube-scheduler            1                   eb6ff07ees98c
3699c312c56f9       9e6a540eeeb62       3 days ago          Running             kube-proxy                0                   e8707140d12941
4159d7ec37b29       5bc0062e9555c       3 days ago          Running             kube-apiserver            0                   22d043569737f
8f56a047e8627      25f8c7f3da61c       3 days ago          Restart             etcd                      0                   458e540c798c8
</code></pre><p>本例中，etcd容器一直启动，可以使用以下命令获取容器的日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl logs container-id
</code></pre></div><p>如此，通过日志帮助定位问题。</p>
<h4 id="更多命令">更多命令</h4>
<ul>
<li>列出所有的pods</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl pods
</code></pre></div><ul>
<li>创建容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl run --runtime<span style="color:#f92672">=</span>remote <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  docker.io/library/nginx:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  nginx-container
</code></pre></div><p>ps:使用远程容器CRI来使用最新的 nginx 镜像启动nginx-container的容器。</p>
<ul>
<li>删除容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crictl rm nginx-container
</code></pre></div><ul>
<li>列出所有镜像：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl images
</code></pre></div><ul>
<li>帮助</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> crictl -h 
NAME:
   crictl - client <span style="color:#66d9ef">for</span> CRI

USAGE:
   crictl <span style="color:#f92672">[</span>global options<span style="color:#f92672">]</span> command <span style="color:#f92672">[</span>command options<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>arguments...<span style="color:#f92672">]</span>

VERSION:
   v1.23.0

COMMANDS:
   attach              Attach to a running container
   create              Create a new container
   exec                Run a command in a running container
   version             Display runtime version information
   images, image, img  List images
   inspect             Display the status of one or more containers
   inspecti            Return the status of one or more images
   imagefsinfo         Return image filesystem info
   inspectp            Display the status of one or more pods
   logs                Fetch the logs of a container
   port-forward        Forward local port to a pod
   ps                  List containers
   pull                Pull an image from a registry
   run                 Run a new container inside a sandbox
   runp                Run a new pod
   rm                  Remove one or more containers
   rmi                 Remove one or more images
   rmp                 Remove one or more pods
   pods                List pods
   start               Start one or more created containers
   info                Display information of the container runtime
   stop                Stop one or more running containers
   stopp               Stop one or more running pods
   update              Update one or more running containers
   config              Get and set crictl client configuration options
   stats               List container<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> resource usage statistics
   completion          Output shell completion code
   help, h             Shows a list of commands or help <span style="color:#66d9ef">for</span> one command

GLOBAL OPTIONS:
   --config value, -c value            Location of the client config file. If not specified and the default does not exist, the program<span style="color:#e6db74">&#39;s directory is searched as well (default: &#34;/etc/crictl.yaml&#34;) [$CRI_CONFIG_FILE]
</span><span style="color:#e6db74">   --debug, -D                         Enable debug mode (default: false)
</span><span style="color:#e6db74">   --image-endpoint value, -i value    Endpoint of CRI image manager service (default: uses &#39;</span>runtime-endpoint<span style="color:#960050;background-color:#1e0010">&#39;</span> setting<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>$IMAGE_SERVICE_ENDPOINT<span style="color:#f92672">]</span>
   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service <span style="color:#f92672">(</span>default: uses in order the first successful one of <span style="color:#f92672">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style="color:#f92672">])</span>. Default is now deprecated and the endpoint should be set instead. <span style="color:#f92672">[</span>$CONTAINER_RUNTIME_ENDPOINT<span style="color:#f92672">]</span>
   --timeout value, -t value           Timeout of connecting to the server in seconds <span style="color:#f92672">(</span>e.g. 2s, 20s.<span style="color:#f92672">)</span>. <span style="color:#ae81ff">0</span> or less is set to default <span style="color:#f92672">(</span>default: 2s<span style="color:#f92672">)</span>
   --help, -h                          show help <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
   --version, -v                       print the version <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
</code></pre></div><p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">kubernetes.io 使用 crictl 对 Kubernetes 节点进行调试</a></li>
<li><a href="%C2%A0https://item.jd.com/13140598.html">《Kubernetes进阶实战-第2版》CRI 与OCI </a>
 </li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/" aria-label="">
      
          Docker、Go、PostgreSQL如何修改时区
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-25T15:55:06&#43;08:00">
        
   25, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍Docker、Go、PostgreSQL如何修改它们的时区。</p>
<p>首先需要知道一些基础概念:</p>
<ol>
<li>Unix 时间戳 -是从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数，不考虑闰秒。</li>
<li>UTC &ndash;协调世界时，又称世界统一时间、世界标准时间、国际协调时间。</li>
<li>CST&ndash;可视为中国、古巴的标准时间或美国、澳大利亚的中部时间。北京时间，也就是东八区时间。</li>
</ol>
<h3 id="docker">Docker</h3>
<p>Docker 作为部署和运行应用程序的环境，默认使用 UTC 作为其容器的时区，但我们可以通过设置环境变量来修改时区。</p>
<p>修改的方法</p>
<ol>
<li>在 Dockerfile 中添加以下行：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">ENV TZ=Asia/Shanghai</span>
</code></pre></div><ol start="2">
<li>在 Kubernetes 中的 Pod 配置文件中，添加 env 字段，设置环境变量。Example:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-container</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">my-image</span>
    <span style="color:#f92672">env</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">TZ</span>
        <span style="color:#f92672">value</span>: <span style="color:#ae81ff">Asia/Shanghai</span>
</code></pre></div><ol start="3">
<li>验证在容器中使用 env 命令查看环境变量，例如</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">env
</code></pre></div><p>输出会有key为TZ，value为Asia/Shanghai表示成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">TZ<span style="color:#f92672">=</span>Asia/Shanghai
</code></pre></div><h3 id="go">Go</h3>
<p>在 Go 中修改时区需要使用标准库中的 time 包。我们可以通过FixedZone来修改时区。
Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">utcZone</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">FixedZone</span>(<span style="color:#e6db74">&#34;UTC&#34;</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3600</span>) <span style="color:#75715e">// UTC
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Local</span> = <span style="color:#a6e22e">utcZone</span>
	<span style="color:#a6e22e">utcNow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">utcDate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Year</span>(), <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Month</span>(), <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Day</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Location</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UTC time: %s\n&#34;</span>, <span style="color:#a6e22e">utcDate</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UTC timestamp: %d\n&#34;</span>, <span style="color:#a6e22e">utcDate</span>.<span style="color:#a6e22e">Unix</span>())

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cstZone</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">FixedZone</span>(<span style="color:#e6db74">&#34;CST&#34;</span>, <span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3600</span>) <span style="color:#75715e">// 东八
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Local</span> = <span style="color:#a6e22e">cstZone</span>
	<span style="color:#a6e22e">cstNow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">cstDate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Year</span>(), <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Month</span>(), <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Day</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Location</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;CST time: %s\n&#34;</span>, <span style="color:#a6e22e">cstDate</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;CST timestamp: %d\n&#34;</span>, <span style="color:#a6e22e">cstDate</span>.<span style="color:#a6e22e">Unix</span>())
}
<span style="color:#75715e">//output
</span><span style="color:#75715e">//UTC time: 2023-02-25 00:00:00 +0000 UTC
</span><span style="color:#75715e">//UTC timestamp: 1677283200
</span><span style="color:#75715e">//CST time: 2023-02-25 00:00:00 +0800 CST
</span><span style="color:#75715e">//CST timestamp: 1677254400
</span></code></pre></div><p>在上面的代码中，我们使用time.FixedZone分别设置UTC、上海时区，并获取当天零点的时间戳 _date。</p>
<h3 id="postgresql">PostgreSQL</h3>
<p><strong>在PostgreSQL系统内部，所有日期和时间都用全球统一时间UTC格式存储， 时间在发给客户前端前由数据库服务器根据TimeZone 配置参数声明的时区转换成本地时间</strong>。</p>
<p>在 PostgreSQL 中，我们可以通过修改 postgresql.conf 文件来修改时区。
以下是如何在 Docker运行 PostgreSQL 中修改时区的步骤：</p>
<ol>
<li>拷贝dockers中的 postgresql.conf到宿主主机</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo docker cp <span style="color:#f92672">[</span>your_docker_contariner_id<span style="color:#f92672">]</span>:/var/lib/postgresql/data/postgresql.conf /<span style="color:#f92672">[</span>your_work_space<span style="color:#f92672">]</span>/
</code></pre></div><ol start="2">
<li>修改配置</li>
</ol>
<pre tabindex="0"><code>sudo vi /[your_work_space]/postgresql.conf
</code></pre><p>查找替换timezone为上海时区</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">timezone = 'Asia/Shanghai'
</code></pre><p>可以通过sql查找支持的时区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> pg_timezone_names;
</code></pre></div><ol start="3">
<li>保存并覆盖dockers中配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo docker cp /<span style="color:#f92672">[</span>your_work_space<span style="color:#f92672">]</span>/postgresql.conf <span style="color:#f92672">[</span>your_docker_contariner_id<span style="color:#f92672">]</span>:/var/lib/postgresql/data/
</code></pre></div><ol start="4">
<li>重新容器</li>
</ol>
<pre tabindex="0"><code>sudo docker restart [your_docker_contariner_id
</code></pre><p>现在，你的 PostgreSQL 数据库就使用了正确的时区。</p>
<ol start="5">
<li>检查是否设置成功
通过sql获取设置：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> pg_db_role_setting;
</code></pre></div><p>也可以查看数据库中表字段格式为TimestampTZ，Example
修改前</p>
<blockquote>
<p>2023-02-25 00:00:00 +0000 +00</p>
</blockquote>
<p>修改后台</p>
<blockquote>
<p>2023-02-25 08:00:00 +0000 +08</p>
</blockquote>
<p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/env"> docker 修改Env</a></li>
<li><a href="http://www.postgres.cn/docs/14/datatype-datetime.html">postgres.cn/docs</a></li>
<li><a href="https://hjxlog.com/posts/20210902215616.html"> 博客dockers-postgre 修改TimeZone</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" aria-label="">
      
          Ingress与IngressController
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-20T15:31:51&#43;08:00">
        
   20, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要学习记录Kubernetes集群暴露服务的方式: Ingress。</p>
<h3 id="简介">简介</h3>
<blockquote>
<p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p>IngressController  为了让 Ingress 资源工作，集群必须有一个正在运行的 Ingress 控制器。</p>
</blockquote>
<p><img src="https://luckytking.github.io/images/ingress_layout.png" alt=""></p>
<p>上图清晰标识出了Ingress的流量走向，其中：</p>
<ul>
<li>Ingress基于DNS名称（host）或URL路径把请求转发⾄指定的Service资源的规则。它仅是⼀组路由规则的集合。</li>
<li>Ingress控制器是真正实现“流量穿透”，可以由具有反向代理（HTTP/HTTPS）功能的服务程序实现 , 然后根据这些规则的匹配机制路由请求流量</li>
</ul>
<h3 id="ingress-资源声明">Ingress 资源声明</h3>
<p>Ingress是Kubernetes API的标准资源类型之⼀ ,一个最小Ingress例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minimal-ingress</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx-example</span>
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/testpath</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>其中:</p>
<ul>
<li>Ingress 需要指定 apiVersion、kind、 metadata和 spec 字段。</li>
<li>Ingress 对象的命名必须是合法的 DNS 子域名名称。</li>
<li>Ingress annotations 来配置一些选项,  ⽤于识别其所属的Ingress控制器的类别。</li>
<li>Ingress rules 提供了配置负载均衡器或者代理服务器所需的所有信息。 最重要的是，其中包含与所有传入请求匹配的规则列表。 Ingress 资源仅支持用于转发 HTTP(S) 流量的规则。</li>
</ul>
<p>更多参考： <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>Ingress控制器可以由任何具有反向代理（HTTP/HTTPS）功能的服务程序实现，目前支持和维护 AWS、 GCE 和 Nginx Ingress 控制器。</p>
<ul>
<li>Nginx Ingress 作为反向代理和负载均衡器。</li>
<li>Apache APISIX Ingress 控制器 是一个基于 Apache APISIX 网关 的 Ingress 控制器。</li>
</ul>
<p>更多参考：https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</p>
<h3 id="安装-ingress-nginx">安装 Ingress Nginx</h3>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/cloud/deploy.yaml  -O ingress-nginx-deploy.yaml

kubectl apply -f  ingress-nginx-deploy.yaml
</code></pre><p>观测是否成功：</p>
<pre tabindex="0"><code>kubectl get pods -n ingress-nginx --watch
</code></pre><p>如果成功的话，查看namespace下所有的资源信息</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get all -n ingress-nginx
NAME                                            READY   STATUS    RESTARTS   AGE
pod/ingress-nginx-controller-123456   1/1     Running   0          1h

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.104.182.98    192.168.1.100   80:31666/TCP,443:31888/TCP   1d
service/ingress-nginx-controller-admission   ClusterIP      10.111.228.99   &lt;none&gt;         443/TCP                      1d

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           1d

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-123456   1         1         1      1d

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           1s         1d
job.batch/ingress-nginx-admission-patch    1/1           2s         1d
</code></pre><h3 id="使用ingress-发布-tomcat">使用Ingress 发布 Tomcat</h3>
<p>部署Tomcat Service</p>
<ol>
<li>
<p>创建deployment</p>
<pre tabindex="0"><code>    kubectl create deployment web --image=tomcat:8.0.50-jre8-alpine
</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>kubectl expose deployment web --type=NodePort --port=8080

</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get service web
    NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
    web    NodePort   10.100.183.22   &lt;none&gt;        8080:32562/TCP   30s
</code></pre></li>
<li>
<p>验证nodeport 是否正常访问 tomcat ，浏览器访问  http://matster_ip:32562
<img src="https://luckytking.github.io/images/ingress_tomcat.png" alt=""></p>
</li>
<li>
<p>创建 ingress</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingressfoo</span>
      <span style="color:#f92672">annotations</span>:
        <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">rules</span>:
      - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ingressfoo.io</span>
        <span style="color:#f92672">http</span>:
          <span style="color:#f92672">paths</span>:
          - <span style="color:#f92672">backend</span>:
              <span style="color:#f92672">service</span>:
                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
                <span style="color:#f92672">port</span>:
                  <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bar</span>
            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>查看ingress是否创建成功</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get ingress
NAME         CLASS    HOSTS                     ADDRESS        PORTS   AGE
ingressfoo   &lt;none&gt;   ingressfoo.io   192.168.1.100   80      1h
</code></pre><p>说明Ingress创建成功，修改hosts ：</p>
<blockquote>
<p>ingressfoo.io 192.168.1.100</p>
</blockquote>
<p>验证访问 ingressfoo.io/bar</p>
<p><img src="https://luckytking.github.io/images/ingress_tomcat2.png" alt=""></p>
<p>success</p>
<h3 id="参考">参考</h3>
<ul>
<li>Ingress  介绍 <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></li>
<li>IngressController 介绍  <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</a></li>
<li><a href="https://github.com/apache/apisix-ingress-controller">https://github.com/apache/apisix-ingress-controller</a></li>
<li>NGINX Ingress 控制器配置 Ingress <a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8</a></li>
<li>在K8S上的Web服务该怎么做域名解析 <a href="https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA">https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" aria-label="">
      
          Kubernetes集群资源监控一机制和资源指标
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-05T22:50:36&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        本文主要介绍Kubernetes集群资源监控机制和资源指标
前言 临近双11，对于码农，尤其是后端，尤其是某宝某东的后端，那是多么激动人心（心惊胆战）的一夜，为什么？怕宕机呀~。那么就让我们来构建护城河&ndash;监控与自动扩容，来抵挡千军万马&ndash;高并发场景。首先让我们学习一些基础：k8s集群资源监控机制和资源指标。
分析 从需求出发，我们自然需要收集一些数据(资源指标)，再根据指标做一系列的操作(control)，比如说预警警告、统计、自动扩容等。
首先，我们希望可以监控整个Kubernetes集群的健康状况，包括：
 整个集群的资源利⽤率 集群中的所有⼯作节点是否运⾏正常、系统资源容量⼤⼩ 每个⼯作节点上运⾏的容器化应⽤的数量  k8s资源控制 我们看看k8s如何资源控制
限制节点 以购物平台为例，微服务广受推崇，比如双11当天，用户进首页是流畅的，但是进活动主页就卡顿，到了零点时，加入购物车的按钮都转圈了。设想你的设计可能是三个微服务（主页服务 、双十一活动服务、订单服务），可想而知，活动服务是压力最大的，我们希望，就算宕机，不要影响其他的服务。所以可以把活动服务限制运行在某节点。
 创建一个会被调度到特定节点上的 Pod，你也可以通过设置 nodeName 将某个 Pod 调度到特定的节点
 nodeName: foo-node # 调度 Pod 到特定的节点 限制内存 还是上面的例子，我们把活动服务调度到了 foo-node。那么剩下的服务没有去限制，但想想订单服务的压力也不小，这里我们希望限制它的资源上限。
 要为容器指定内存请求，请在容器资源清单中包含 resources：requests 字段。 同理，要指定内存限制，请包含 resources：limits。
 resources: requests: memory: &#34;1000Gi&#34; limits: memory: &#34;1000Gi&#34; 限制CPU  要为容器指定 CPU 请求，请在容器资源清单中包含 resources: requests 字段。 要指定 CPU 限制，请包含 resources:limits
 resources: limits: cpu: &#34;100&#34; requests: cpu: &#34;100&#34; Example 环境准备:
 k8s集群（master * 1，node * 2 ) kubectl 命令行工具( 笔者使用rancher)   创建一个namespace（stress）。 增加一个deployment, 修改内存上限为10M 1.
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" aria-label="">
      
          利用k8s储存卷来部署redis之三StatefulSet
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-11T18:20:54&#43;08:00">
        
   11, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前两篇(1.<a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/">volume</a>2.<a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/">pv&amp;pvc</a>)通过部署redis学习实战了k8s的来Volume、PV和PVC。但是，应⽤程序存在“有状态”和“⽆状态”两种类别，显然redis属于读写磁盘需求的有状态应⽤程序，如⽀持事务功能的RDBMS存储系统，所以，本文学习实战k8s有状态应用的部署。</p>
<h3 id="stateful基础">Stateful基础</h3>
<p>StatefulSet是Pod资源控制器的⼀种实现，⽤于部署和扩展有状态应⽤的Pod资源，确保它们的运⾏顺序及每个Pod资源的唯⼀性。适用以下需求的应用：</p>
<ul>
<li>稳定且唯⼀的⽹络标识符。</li>
<li>稳定且持久的存储。</li>
<li>有序、优雅地部署和扩展。</li>
<li>有序、优雅地删除和终⽌。</li>
<li>有序⽽⾃动地滚动更新。</li>
</ul>
<h3 id="部署">部署</h3>
<p>接着，这里把之前的redis存储修改为stateful的方式，修改后的步骤：</p>
<ol>
<li>创建 ConfigMap （参考第一篇）</li>
<li>修改 Deployment 为StatefulSets</li>
</ol>
<h4 id="修改部署statefulsets">修改部署StatefulSets</h4>
<p>mkdir my-redis-statefulsets.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
          <span style="color:#f92672">emptyDir</span>: {}
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>
 
---
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30379</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis          </span>

</code></pre></div><p>其中：</p>
<ol>
<li>Headless Service：⽤于为Pod资源标识符⽣成可解析的DNS资源记录</li>
<li>StatefulSet ⽤于管控Pod资源</li>
<li>volumeClaimTemplate则基于静态或动态的PV供给⽅式为Pod资源提供
专有且固定的存储（这里我们直接使用了第二篇创建的pv）</li>
</ol>
<h3 id="测试">测试</h3>
<p>redis-client 连接 NodeId:NodePort</p>
<pre tabindex="0"><code># redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&gt; info
# Serverredis_version:7.0.4
</code></pre><p>连接成功!</p>
<h3 id="参考">参考</h3>
<ul>
<li>官方stateful介绍 <a href="https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage">https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/" aria-label="">
      
          利用k8s储存卷来部署redis之二PV与PVC
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-02T23:28:57&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>之前学习实践使用熟悉卷（Volume）来存储<a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/">利用k8s储存卷来部署redis</a>，本文接着学习实践k8s的存储，主要通过redis存储例子学习实战PV和PVC。</p>
<h3 id="pv--pvc">PV &amp; PVC</h3>
<p>Kubernetes为例⽤户和开发隐藏底层架构的⽬标，在用户和存储服务之间添加了一个中间层，也就是PersistentVolume和PersistentVolumeClaim。</p>
<ul>
<li>PersistentVolume 持久卷 (是集群中的一块存储，可以由管理员事先制备， 或者使用存储类（Storage Class）来动态制备。）</li>
<li>PersistentVolumeClaim 持久卷申领 （
表达的是用户对存储的请求。概念上与 Pod 类似。）
更多详细参见参考 <a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></li>
</ul>
<h3 id="redisvolume修改为pvpvc">RedisVolume修改为PV&amp;PVC</h3>
<p>接着，这里把之前的redis存储修改为pv-pvc的方式，修改后的步骤：</p>
<ol>
<li>创建 ConfigMap （参考第一篇）</li>
<li>增加声明PV和PVC （新增）</li>
<li>增加 Deployment （把Volume修改为 步骤2 的PVC）</li>
<li>暴露 Service （参考第一篇）</li>
</ol>
<h4 id="步骤2增加声明pv和pvc">步骤2，增加声明PV和PVC</h4>
<p>mkdir my-redis-pv-pvc.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-pv</span>
  <span style="color:#f92672">labels</span>:
     <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">capacity</span>:
    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
  <span style="color:#f92672">accessModes</span>:
  - <span style="color:#ae81ff">ReadWriteOnce</span>
  <span style="color:#f92672">hostPath</span>:
    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/mnt/data/my-redis&#34;</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">accessModes</span>:
  - <span style="color:#ae81ff">ReadWriteOnce</span>
  <span style="color:#f92672">resources</span>:
    <span style="color:#f92672">requests</span>:
      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</code></pre></div><p>执行创建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">master# kubectl apply -f my-redis-pv-pvc.yaml
</code></pre></div><p>查看pv状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">master# kubectl get pv 
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM     STORAGECLASS    REASON   AGE
my-redis-pv     1Gi        RWO            Retain           Bound    my-ns/redis-pvc                                                 50m

</code></pre></div><p>查看pvc状态</p>
<pre tabindex="0"><code>master# kubectl get pvc -n my-ns
NAME               STATUS   VOLUME         CAPACITY   ACCESS MODES   STORAGECLASS   AGE
redis-pvc          Bound    my-redis-pv    1Gi             RWO                                          54m
</code></pre><p>pv和pvc已经Bound成功。</p>
<h4 id="步骤3增加-deployment-把volume修改为-步骤2-的pvc">步骤3，增加 Deployment （把Volume修改为 步骤2 的PVC）</h4>
<p>mkdir my-redis-deployment-pvc.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis</span> <span style="color:#75715e"># Unique name for the deployment</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">myns</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis      </span> <span style="color:#75715e"># Labels to be applied to this deployment</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:     <span style="color:#75715e"># This deployment applies to the Pods matching these labels</span>
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
      <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>        <span style="color:#75715e"># Run a single pod in the deployment</span>
  <span style="color:#f92672">template</span>:          <span style="color:#75715e"># Template for the pods that will be created by this deployment</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:        <span style="color:#75715e"># Labels to be applied to the Pods in this deployment</span>
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
        <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
        <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
    <span style="color:#f92672">spec</span>:            <span style="color:#75715e"># Spec for the container which will be run inside the Pod.</span>
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-persistent-storage </span>
          <span style="color:#f92672">persistentVolumeClaim</span>:
          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">redis-pvc</span> <span style="color:#75715e"># 这里修改为步骤2声明的pvc</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>

</code></pre></div><p>执行创建deployment</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">master# kubectl apply -f my-redis-deployment-pvc.yaml
</code></pre></div><p>检查状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">master# kubectl get pod -n my-ns
NAME                                   READY   STATUS    RESTARTS   AGE 
my-redis-6565459689-mbptf              1/1     Running   0          53m
</code></pre></div><h4 id="测试">测试</h4>
<p>redis-client 连接 NodeId:NodePort</p>
<pre tabindex="0"><code># redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&gt; info
# Server
redis_version:7.0.4
</code></pre><p>连接成功。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/" aria-label="">
      
          利用k8s储存卷来部署redis
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-08-28T16:29:07&#43;08:00">
        
   28, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要通过利用k8s如何部署Redis,来学习使用k8s的存储卷Volume。</p>
<p>Pod本⾝具有⽣命周期，故其内部运⾏的容器及其相关数据⾃⾝均⽆法持久存在。Kubernetes也⽀持类似Docker的存储卷功能，不过，其存储卷Volume是与Pod资源绑定⽽⾮容器。</p>
<h3 id="pod-volume">Pod Volume</h3>
<p><strong>如何要在一个Pod里声明 Volume</strong>：</p>
<ol>
<li>⼀是通过.spec.volumes字段定义在Pod之上的存储卷列表，其⽀持使⽤多种不同类型的存储卷且配置参数差别很⼤；</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
<span style="color:#ae81ff">…</span>
<span style="color:#f92672">volumes</span>:
<span style="color:#f92672">* name</span>: <span style="color:#ae81ff">logdata</span>
<span style="color:#f92672">emptyDir</span>: {}
<span style="color:#f92672">* name</span>: <span style="color:#ae81ff">example</span>
<span style="color:#f92672">gitRepo</span>:
<span style="color:#f92672">repository</span>: <span style="color:#ae81ff">https://github.com/iKubernetes/k8s_book.git</span>
<span style="color:#f92672">revision</span>: <span style="color:#ae81ff">master</span>
<span style="color:#f92672">directory</span>: <span style="color:#ae81ff">.</span>
</code></pre></div><ol start="2">
<li>另⼀个是通过.spec.containers.volumeMounts字段在容器上定义的存储卷挂载列表，它只能挂载当前Pod资源中定义的具体存储卷，当然，也可以不挂载任何存储卷</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
<span style="color:#ae81ff">…</span>
<span style="color:#f92672">containers</span>:
<span style="color:#f92672">* name</span>: <span style="color:#ae81ff">&lt;String&gt;</span>
<span style="color:#ae81ff">…</span>
<span style="color:#f92672">volumeMounts</span>:
* <span style="color:#ae81ff">name &lt;string&gt; -required-</span>
<span style="color:#ae81ff">mountPath &lt;string&gt; -required-</span>
</code></pre></div><p>在之前（<a href="https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/">声明式对象配置</a>）有介绍过nginx的部署，接着来部署Redis，和Nginx有所不同的是，这里多了一个 ConfigMap 和Volume ,用来配置管理redis和储存。</p>
<h3 id="环境">环境</h3>
<ul>
<li>一个k8s 集群（mater* 1，node* 1）</li>
<li>一个正常连接k8smater的主机的终端</li>
</ul>
<h3 id="创建-config-map">创建 Config-Map</h3>
<p>使用 ConfigMap 来配置 Redis ，包含了Redis配置文件里需要的配置项，在创建Pod时会作为配置文件挂载到应用所在的容器中。 my-config-map.yaml 具体如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">redis.conf</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    requirepass 123456
</span><span style="color:#e6db74">    protected-mode no
</span><span style="color:#e6db74">    port 6379
</span><span style="color:#e6db74">    tcp-backlog 511
</span><span style="color:#e6db74">    timeout 0
</span><span style="color:#e6db74">    tcp-keepalive 300
</span><span style="color:#e6db74">    daemonize no
</span><span style="color:#e6db74">    supervised no
</span><span style="color:#e6db74">    pidfile /var/run/redis_6379.pid
</span><span style="color:#e6db74">    loglevel notice
</span><span style="color:#e6db74">    logfile &#34;&#34;
</span><span style="color:#e6db74">    databases 16
</span><span style="color:#e6db74">    always-show-logo yes
</span><span style="color:#e6db74">    save 900 1
</span><span style="color:#e6db74">    save 300 10
</span><span style="color:#e6db74">    save 60 10000
</span><span style="color:#e6db74">    stop-writes-on-bgsave-error yes
</span><span style="color:#e6db74">    rdbcompression yes
</span><span style="color:#e6db74">    rdbchecksum yes
</span><span style="color:#e6db74">    dbfilename dump.rdb
</span><span style="color:#e6db74">    dir /data
</span><span style="color:#e6db74">    slave-serve-stale-data yes
</span><span style="color:#e6db74">    slave-read-only yes
</span><span style="color:#e6db74">    repl-diskless-sync no
</span><span style="color:#e6db74">    repl-diskless-sync-delay 5
</span><span style="color:#e6db74">    repl-disable-tcp-nodelay no
</span><span style="color:#e6db74">    slave-priority 100
</span><span style="color:#e6db74">    lazyfree-lazy-eviction no
</span><span style="color:#e6db74">    lazyfree-lazy-expire no
</span><span style="color:#e6db74">    lazyfree-lazy-server-del no
</span><span style="color:#e6db74">    slave-lazy-flush no
</span><span style="color:#e6db74">    appendonly no
</span><span style="color:#e6db74">    appendfilename &#34;appendonly.aof&#34;
</span><span style="color:#e6db74">    appendfsync everysec
</span><span style="color:#e6db74">    no-appendfsync-on-rewrite no
</span><span style="color:#e6db74">    auto-aof-rewrite-percentage 100
</span><span style="color:#e6db74">    auto-aof-rewrite-min-size 64mb
</span><span style="color:#e6db74">    aof-load-truncated yes
</span><span style="color:#e6db74">    aof-use-rdb-preamble no
</span><span style="color:#e6db74">    lua-time-limit 5000
</span><span style="color:#e6db74">    slowlog-log-slower-than 10000
</span><span style="color:#e6db74">    slowlog-max-len 128
</span><span style="color:#e6db74">    latency-monitor-threshold 0
</span><span style="color:#e6db74">    notify-keyspace-events Ex
</span><span style="color:#e6db74">    hash-max-ziplist-entries 512
</span><span style="color:#e6db74">    hash-max-ziplist-value 64
</span><span style="color:#e6db74">    list-max-ziplist-size -2
</span><span style="color:#e6db74">    list-compress-depth 0
</span><span style="color:#e6db74">    set-max-intset-entries 512
</span><span style="color:#e6db74">    zset-max-ziplist-entries 128
</span><span style="color:#e6db74">    zset-max-ziplist-value 64
</span><span style="color:#e6db74">    hll-sparse-max-bytes 3000
</span><span style="color:#e6db74">    activerehashing yes
</span><span style="color:#e6db74">    client-output-buffer-limit normal 0 0 0
</span><span style="color:#e6db74">    client-output-buffer-limit slave 256mb 64mb 60
</span><span style="color:#e6db74">    client-output-buffer-limit pubsub 32mb 8mb 60
</span><span style="color:#e6db74">    hz 10
</span><span style="color:#e6db74">    aof-rewrite-incremental-fsync yes</span>    
</code></pre></div><p>执行命令</p>
<pre tabindex="0"><code># kubectl apply -f my-redis-config.yaml
</code></pre><h3 id="创建-deployment">创建 Deployment</h3>
<p>创建Deployment 作为调度Pod运行 Redis 的载体。my-redis-deployment.yaml具体如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis</span> <span style="color:#75715e"># Unique name for the deployment</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis      </span> <span style="color:#75715e"># Labels to be applied to this deployment</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:     <span style="color:#75715e"># This deployment applies to the Pods matching these labels</span>
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
      <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>        <span style="color:#75715e"># Run a single pod in the deployment</span>
  <span style="color:#f92672">template</span>:          <span style="color:#75715e"># Template for the pods that will be created by this deployment</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:        <span style="color:#75715e"># Labels to be applied to the Pods in this deployment</span>
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
        <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
        <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
    <span style="color:#f92672">spec</span>:            <span style="color:#75715e"># Spec for the container which will be run inside the Pod.</span>
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
          <span style="color:#f92672">emptyDir</span>: {}
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>
</code></pre></div><p>执行</p>
<pre tabindex="0"><code># kubectl apply -f my-redis-deployment.yaml
</code></pre><h3 id="创建-service">创建 service</h3>
<p>NodePort 方式向外暴露服务。my-redis-service.yaml 具体如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service       </span> <span style="color:#75715e"># Type of Kubernetes resource</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-svc</span> <span style="color:#75715e"># Name of the Kubernetes resource</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
  <span style="color:#f92672">labels</span>:            <span style="color:#75715e"># Labels that will be applied to this resource</span>
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>       <span style="color:#75715e"># Map incoming connections on port 6379 to the target port 6379 of the Pod</span>
      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30379</span>
  <span style="color:#f92672">selector</span>:          <span style="color:#75715e"># Map any Pod with the specified labels to this service</span>
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">my-redis</span>
    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">master</span>
    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">backend</span>
</code></pre></div><p>执行</p>
<pre tabindex="0"><code># kubectl apply -f my-redis-service.yaml
</code></pre><h3 id="测试">测试</h3>
<p>redis-client 测试NodeId:NodePort</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">redis-cli -h YourNodeIp -p 30379 -a 123456
YourNodeIp:30379&gt; info
# Server
redis_version:7.0.4
...
</code></pre></div><p>连接成功。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tutorials/configuration/configure-redis-using-configmap/">https://kubernetes.io/zh-cn/docs/tutorials/configuration/configure-redis-using-configmap/</a></li>
<li><a href="https://github.com/kevinyan815/LearningKubernetes/tree/master/redis-singleton">https://github.com/kevinyan815/LearningKubernetes/tree/master/redis-singleton</a></li>
<li>《Kubernetes进阶实战-第2版》  <a href="https://item.jd.com/13140598.html">https://item.jd.com/13140598.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/08/rancher2.6.6%E6%9B%B4%E6%96%B0ssl%E4%B8%BA%E5%85%AC%E8%AE%A4ca%E8%AF%81%E4%B9%A6/" aria-label="">
      
          Rancher2.6.6更新ssl为公认CA证书
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-08-13T17:34:12&#43;08:00">
        
   13, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>访问Rancher后台提示“证书无效”。</p>
<p>排查原因是由于挂载的ssl证书失败，rancher启用了生成的默认 CA 证书。这里打算
更新为公认的 CA 签名证书，其中</p>
<ol>
<li>Rancher版本 v2.6.6</li>
<li>Racher为Docker单节点安装</li>
</ol>
<h3 id="解决步骤">解决步骤</h3>
<p>考虑到单机版是没有Volume的，为了保证数据不丢失。处理大致分为以下几个步骤</p>
<ol>
<li>从你的 Rancher 服务器容器创建数据的副本</li>
<li>创建一个备份压缩包</li>
<li>使用新的证书 启动新的Rancher服务器容器</li>
</ol>
<h4 id="1-从你的-rancher-服务器容器创建数据的副本">1. 从你的 Rancher 服务器容器创建数据的副本</h4>
<h5 id="11-停止当前运行-rancher-服务器的容器替换rancher_container_name为您的-rancher-容器的名称">1.1 停止当前运行 Rancher 服务器的容器。替换&lt;RANCHER_CONTAINER_NAME&gt;为您的 Rancher 容器的名称</h5>
<p><img src="https://luckytking.github.io/images/rancher-ssl.png" alt="">
运行停止RancherDocker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">docker stop &lt;RANCHER_CONTAINER_NAME&gt;
</code></pre></div><h5 id="12-使用以下命令替换每个占位符从您刚刚停止的-rancher-容器创建一个数据容器">1.2 使用以下命令替换每个占位符，从您刚刚停止的 Rancher 容器创建一个数据容器。</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">docker create --volumes-from &lt;RANCHER_CONTAINER_NAME&gt; --name rancher-data rancher/rancher<span style="color:#960050;background-color:#1e0010">:</span>&lt;RANCHER_CONTAINER_TAG&gt;
</code></pre></div><h4 id="2-创建一个备份压缩包">2. 创建一个备份压缩包</h4>
<p>从您刚刚创建的数据容器 ( rancher-data)，创建一个备份 tarball ( rancher-data-backup-&lt;RANCHER_VERSION&gt;-<!-- raw HTML omitted -->.tar.gz)。如果升级期间出现问题，此 tarball 将用作回滚点。使用以下命令，替换每个占位符。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">docker run --volumes-from rancher-data -v <span style="color:#e6db74">&#34;$PWD:/backup&#34;</span> --rm busybox tar zcvf /backup/rancher-data-backup-&lt;RANCHER_VERSION&gt;-&lt;DATE&gt;.tar.gz /var/lib/rancher
</code></pre></div><h4 id="3-启动新的rancher服务器容器">3. 启动新的Rancher服务器容器</h4>
<p>如果您选择使用由公认的 CA 签名的证书，您将添加&ndash;volumes-from rancher-data到您启动原始 Rancher 服务器容器的命令中，并且需要访问您最初安装时使用的相同证书。请记住将&ndash;no-cacerts作为参数包含在容器中以禁用 Rancher 生成的默认 CA 证书。</p>
<pre tabindex="0"><code>docker run -d --volumes-from rancher-data \
  --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  -v /[your-workspace]/certs:/etc/rancher/ssl \ 
  --privileged \
  rancher/rancher:v2.6.6 \
  --no-cacerts
</code></pre><p>这里的 [your-workspace]替换为你的证书存放路径。其中包括 
cert.pem 和 key.pem</p>
<p>再访问rancher dashboard，提示“有效证书”。</p>
<h3 id="参考">参考</h3>
<ul>
<li>使用 Docker 在单节点上安装 Rancher <a href="https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/">https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/</a></li>
<li>升级安装了Docker的Rancher <a href="https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/single-node-upgrades/">https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/single-node-upgrades/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/08/rancher2.6.6%E6%9B%B4%E6%96%B0ssl%E4%B8%BA%E5%85%AC%E8%AE%A4ca%E8%AF%81%E4%B9%A6/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/08/rancher%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%90%8E%E7%8A%B6%E6%80%81%E9%95%BF%E6%97%B6%E9%97%B4%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81/" aria-label="">
      
          Rancher导入k8s集群后状态长时间处于Pending状态
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-08-03T22:02:43&#43;08:00">
        
   3, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h4 id="问题描述">问题描述:</h4>
<p>在Rancher导入外部k8s集群 ,导入的集群一直处于“pending”状态。</p>
<p>这里简要记录一下排查过程和临时解决办法。</p>
<h4 id="问题环境">问题环境</h4>
<ul>
<li>rancher v2.6.6</li>
<li>kubernetes v1.24</li>
<li>vm1 ubuntu （rancer）</li>
<li>vm2-3-4 k8s集群</li>
</ul>
<p>导入步骤:“集群”&ndash;“添加”&ndash;“集群名称”&ndash;创建&ndash;</p>
<h4 id="排查解决">排查&amp;解决</h4>
<p>Rancher 通过 CusterAgent 与集群进行通信（通过cattle-cluster-agent调用 Kubernetes API 与集群通讯），并通过cattle-node-agent与节点进行通信。如果 cattle-cluster-agent 无法连接到已有的 Rancher Server 也就是server-url，集群将保留在 Pending 状态。</p>
<h5 id="1--在k8smaster节点上面查看clusteragent的pod状态是否正常默认的namespace为cattle-system">1 . 在k8smaster节点上面，查看ClusterAgent的pod状态是否正常，默认的namespace为“cattle-system”</h5>
<blockquote>
<p>kubectl get pods -n cattle-system</p>
</blockquote>
<pre tabindex="0"><code>root@k8s-master:~# kubectl get pods -n cattle-system
NAME                             READY   STATUS    RESTARTS   AGE
cattle-cluster-agent-79749...   1/0     Pending   0              8m52s
cattle-cluster-agent-79749...   1/0     Pending   0              5m21s
</code></pre><p>看到pod未正常启动</p>
<h5 id="2-进一步查看pod错误日志">2. 进一步查看pod错误日志</h5>
<blockquote>
<p>kubectl logs -f [contariner-id] -n cattle-system</p>
</blockquote>
<pre tabindex="0"><code>root@k8s-master:~# kubectl logs -f cattle-cluster-agent-79749... -n cattle-system
...
no secret assigned to service account cattle-system/rancher
...
</code></pre><h5 id="3-查找error处理办法">3. 查找error处理办法</h5>
<p>通过查阅官方issures有提到</p>
<blockquote>
<p>2.6.6版本说明建议:</p>
<p>Rancher v2.6.6是v2.6.5的镜像版本，只做了一个修改，以解决以下问题:</p>
<p>-当Rancher试图控制来自下游集群的大量流量时，出现了一个主要的性能问题。这种机制没有正确地处理断开，并将导致无限锁定。看到# 37250。</p>
<p>所以我猜他们没有在这个版本中添加K8S 1.24兼容性，因为v2.6.6中的兼容版本是:</p>
<ul>
<li>v1.18.20-rancher1-3</li>
<li>v1.19.16-rancher1-5</li>
<li>v1.20.15-rancher1-3</li>
<li>v1.21.12-rancher1-1</li>
<li>v1.22.9-rancher1-1</li>
<li>v1.23.6-rancher1-1</li>
</ul>
</blockquote>
<p>Rancher 2.6.6 不支持 1.24。根据在此问题上设置的里程碑，计划为 2.6.7 提供支持。</p>
<h5 id="4尝试回滚版本">4.尝试回滚版本</h5>
<p>回滚k8s版本v1.23，rancher重新导入集群，再查看pods状态</p>
<pre tabindex="0"><code>kubectl get pods -n cattle-system
NAME                                    READY   STATUS    RESTARTS   AGE
cattle-cluster-agent-79749...   1/1     Running   0          8m52s
cattle-cluster-agent-79749...   1/1     Running   0          5m21s
</code></pre><p>回到rancher查看导入的k8s状态为 “Active”</p>
<p>至此，问题已暂时解决。持续关注Rancher2.6.7版本。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index">https://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index</a></li>
<li><a href="https://github.com/rancher/rancher/issues/37027">https://github.com/rancher/rancher/issues/37027</a></li>
<li><a href="https://github.com/rancher/rancher/issues/37711">https://github.com/rancher/rancher/issues/37711</a></li>
<li><a href="https://lequ7.com/guan-yu-kubernetesrancher-dao-ru-kubernetes-ji-qun.html">https://lequ7.com/guan-yu-kubernetesrancher-dao-ru-kubernetes-ji-qun.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/08/rancher%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%90%8E%E7%8A%B6%E6%80%81%E9%95%BF%E6%97%B6%E9%97%B4%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
              
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/" aria-label="">
      
          K8s学习笔记  资源配置和声明式对象配置
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-31T18:04:12&#43;08:00">
        
   31, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要记录Kubernetes的资源管理，包括资源配置，声明式管理。</p>
<blockquote>
<p>Kubernetes提供了RESTful风格的API，它将各类组件均抽象为“资源”，并通过属性赋值完成实例化 。API主要由资源类型和控制器两部分组成，资源通常以json、yaml格式并写入集群的对象，控制器则在集群资源存储完成后自动创建并启动。</p>
</blockquote>
<p>常用的K8s资源有</p>
<ul>
<li>Pod</li>
<li>Deployment</li>
<li>Service</li>
<li>Ingress</li>
</ul>
<h3 id="资源分类">资源分类</h3>
<p>依据资源的主要功能作为分类标准，Kubernetes的API对象⼤体可分为</p>
<ul>
<li>
<p>⼯作负载 （Workload）</p>
<ul>
<li>ReplicationController</li>
<li>ReplicaSet</li>
<li>Deploymen</li>
<li>StatefulSet</li>
<li>DaemonSet</li>
<li>Job</li>
</ul>
</li>
<li>
<p>发现和负载均衡 （Discovery&amp;LB）</p>
</li>
<li>
<p>配置和存储 （Config&amp;Storage</p>
</li>
<li>
<p>集群 （Cluster）</p>
<ul>
<li>Namespace</li>
<li>Node</li>
<li>Role</li>
<li>ClusterRole</li>
</ul>
</li>
<li>
<p>元数据 （Metadata）</p>
</li>
</ul>
<p>它们基本上都是围绕⼀个核⼼⽬的⽽设计：如何更好地运⾏和丰富Pod资源，从⽽为容器化应⽤提供更灵活、更完善的操作与管理组件。</p>
<h3 id="资源配置">资源配置</h3>
<p>标准格式一般包括一级字段</p>
<ul>
<li>kind</li>
<li>apiVersion</li>
<li>metadata （对象元数据)</li>
<li>spec（描述所期望的对象应该具有的状态）</li>
<li>status（字段在对象创建后由系统⾃⾏维护）</li>
</ul>
<p>以一个nginx的pod.yaml为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pod</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.7.9</span>
      <span style="color:#f92672">ports</span>:
          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><ul>
<li>metadata:
<ul>
<li>name 当前的对象名称</li>
<li>labels： 当前对象的标签（键值对）</li>
</ul>
</li>
<li>spec
<ul>
<li>containers，它的值是⼀个容器对象列表，⽀持嵌套创建⼀到
多个容器。</li>
</ul>
</li>
</ul>
<h3 id="声明式对象配置">声明式对象配置</h3>
<p>提供配置清单文件给k8s系统，并委托系统来跟踪活动对象的状态变动。管理操作的命令通过apply</p>
<ul>
<li>创建</li>
</ul>
<pre tabindex="0"><code>$kubectl apply -f &lt;directory&gt;/
</code></pre><ul>
<li>更新</li>
</ul>
<pre tabindex="0"><code>kubectl apply -f &lt;directory&gt;/
</code></pre><ul>
<li>删除</li>
</ul>
<pre tabindex="0"><code>kubectl apply -f &lt;directory&gt;/ --prune -l your-label 
</code></pre><p>建议使用命令式的方法</p>
<pre tabindex="0"><code>kubectl delete -f  &lt;filename&gt;
</code></pre><h3 id="实战声明式部署nginx">实战声明式部署nginx</h3>
<p>定义的deployment文件: nginx_dp.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deployment</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-dp</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.7.9</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>暴露服务，定义service文件nginx_svc.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-svc</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
  <span style="color:#f92672">ports</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>访问nginx，output
<img src="https://luckytking.github.io/images/k8s-nginx.png" alt=""></p>
<h3 id="参考">参考</h3>
<ul>
<li>Kubernetes进阶实战-第2版》  <a href="https://item.jd.com/13140598.html">https://item.jd.com/13140598.html</a></li>
<li>k8s 部署nginx  <a href="https://github.com/kevinyan815/LearningKubernetes">https://github.com/kevinyan815/LearningKubernetes</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/07/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

            
            

          </section>
        
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>image-cri-shim on jefffff&#39;s Blog</title>
    <link>https://luckytking.github.io/tags/image-cri-shim/</link>
    <description>Recent content in image-cri-shim on jefffff&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Sat, 27 May 2023 18:11:54 +0800</lastBuildDate><atom:link href="https://luckytking.github.io/tags/image-cri-shim/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Kubernetes集群image-cri-him大量端口占用</title>
      <link>https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/</link>
      <pubDate>Sat, 27 May 2023 18:11:54 +0800</pubDate>
      
      <guid>https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/</guid>
      <description>&lt;p&gt;背景：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;sealos安装的Kubernetes集群，master节点出现大量端口占用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;环境：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;应用&lt;/th&gt;
&lt;th&gt;信息&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;os&lt;/td&gt;
&lt;td&gt;Ubuntu&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sealos&lt;/td&gt;
&lt;td&gt;v4.1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kubernetes&lt;/td&gt;
&lt;td&gt;v1.23.9&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;排查问题&#34;&gt;排查问题&lt;/h3&gt;
&lt;p&gt;按照本地端口对输出进行排序&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;netstat&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-anp&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;grep&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ESTABLISHED&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;awk&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{print $4}&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sort&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;uniq&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-c&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sort&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-n&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;28&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;6443&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;111&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;127&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;2379&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;9009&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;10&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查找本地端口对应的应用程序&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;lsof&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-i&lt;/span&gt; :&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;image-cri&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2811249&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4120u&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;IPv4&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;291818320&lt;/span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;0t0&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;TCP&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41710-&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;ESTABLISHED&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可见，是image-cri-shim占用的端口数。&lt;/p&gt;
&lt;h3 id=&#34;image-cri-shim-工作原理&#34;&gt;image-cri-shim 工作原理&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;image-cri-shim 是一个基于 CRI (Container Runtime Interface) 和 kubelet 的 gRPC (Google Remote Procedure Call) shim。CRI 是 Kubernetes 中用于与容器运行时进行交互的接口，而 kubelet 是负责维护容器运行状态和节点级别的资源管理的 Kubernetes 组件。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;常用操作:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;启动服务： systemctl start image-cri-shim&lt;/li&gt;
&lt;li&gt;停止服务： systemctl stop image-cri-shim&lt;/li&gt;
&lt;li&gt;重启服务： systemctl restart image-cri-shim&lt;/li&gt;
&lt;li&gt;查看服务状态： systemctl status image-cri-shim&lt;/li&gt;
&lt;li&gt;&lt;/li&gt;
&lt;li&gt;参考日志:  journalctl -u image-cri-shim -f&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;重现问题&#34;&gt;重现问题&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在测试环境安装相同版本的sealos版本4.1.7，这里就不赘述，可以参考(&lt;a href=&#34;https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle&#34;&gt;https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle&lt;/a&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;安装好之后，发现image-cri-shim的版本（4.1.3）不对，&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--version&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;3-ed0a75b9&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;更新image-cri-shim版本为4.1.7&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;wget https://github.com/labring/sealos/releases/download/v4.1.7/sealos_4.1.7_linux_amd64.tar.gz &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tar xvf sealos_4.1.7_linux_amd64.tar.gz.1 image-cri-shim
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl stop image-cri-shim&amp;#34;&lt;/span&gt;
sealos scp &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./image-cri-shim&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/usr/bin/image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl start image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;image-cri-shim -v&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出类似以下内容，表示成功:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;192&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;168&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;101&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;22&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;192&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;168&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;102&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;22&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;4&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;1&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;7-ed0a75b9&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;启动后，观察日志：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;journalctl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-u&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Logs&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;begin&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;at&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Wed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-04-19&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;22&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;32&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;UTC&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;actual&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;imageName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1116090&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T06&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;59&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;38&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;监控端口数的变化&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;netstat -na | grep &lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; | wc -l
&lt;span style=&#34;color:#ae81ff&#34;&gt;96&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;116&lt;/span&gt;
&lt;span style=&#34;color:#ae81ff&#34;&gt;120&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;可见，每个5分钟，占用的端口数就增加20左右。问题复现了，接着我们来看看怎么处理。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;更新版本为420&#34;&gt;更新版本为4.2.0&lt;/h3&gt;
&lt;p&gt;从sealos的github的issues有提供一个修复方案：升级image-cri-shim的版本为4.2.0&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;wget https://github.com/labring/sealos/releases/download/v4.2.0/sealos_4.2.0_linux_amd64.tar.gz &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tar xvf sealos_4.2.0_linux_amd64.tar.gz image-cri-shim
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl stop image-cri-shim&amp;#34;&lt;/span&gt;
sealos scp &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./image-cri-shim&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/usr/bin/image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;systemctl start image-cri-shim&amp;#34;&lt;/span&gt;
sealos exec -r master,node &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;image-cri-shim -v&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出如下，表示成功：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;image-cri-shim version 4.2.0-f696a621
192.168.1.101:22: image-cri-shim version 4.2.0-f696a621
192.168.1.102:22: image-cri-shim version 4.2.0-f696a621
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;观察是否已修复&#34;&gt;观察是否已修复&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;观察inamge-cri-shim日志：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;journalctl&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-u&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-f&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Logs&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;begin&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;at&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Wed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-04-19&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;22&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;32&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;UTC&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;--&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;Timeout&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; {&lt;span style=&#34;color:#f92672&#34;&gt;15m0s&lt;/span&gt;}
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;criRegistryAuth&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;criOfflineAuth&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;{Username:admin Password&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;passw0rd Auth&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; Email&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; ServerAddress&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;http&lt;span style=&#34;color:#f92672&#34;&gt;://&lt;/span&gt;sealos&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;hub&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; IdentityToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; RegistryToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;}&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;var&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;sock&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;containerd&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;containerd&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;sock&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;registry&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;http&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;://&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;changed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ownership&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/var/run/image-cri-shim.sock&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;changed&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;permissions&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/var/run/image-cri-shim.sock&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-rw-rw----&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;44&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;41&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;49&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;May&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;25&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;master1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image-cri-shim&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;1159432&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;2023-05-25T07&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;54&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;42&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;k8s&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;gcr&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;newImage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;sealos&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;hub&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;5000&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;pause&lt;/span&gt;:&lt;span style=&#34;color:#a6e22e&#34;&gt;3&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;ImageStatus&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;监控端口数的变化&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-css&#34; data-lang=&#34;css&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;root&lt;/span&gt;@&lt;span style=&#34;color:#66d9ef&#34;&gt;master1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:~&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;#&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;netstat&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-na&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;grep&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;wc&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-l&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt; 
&lt;span style=&#34;color:#f92672&#34;&gt;6&lt;/span&gt; 
&lt;span style=&#34;color:#f92672&#34;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;可见，请求是还有，但并没有增加端口数，看来问题修复了。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ps： 我们重现问题的Kubenetes版本是v1.23.9，在实际开发中发现其他版本的v1.25.7也会出现类似问题，验证此版本待后续更新。&lt;/p&gt;
&lt;h3 id=&#34;小结&#34;&gt;小结&lt;/h3&gt;
&lt;p&gt;本文主要记录排查、复现、处理【sealos安装的Kubenetes集群master节点大量占用端口】的过程，原因系image-cri-shim的版本问题，旧版本会频繁请求master，导致创建大量的连接，占用端口数。通过升级image-cri-shim版本可以解决该问题。&lt;/p&gt;
&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://sealos.io/zh-Hans/docs/design/image-cri-shim&#34;&gt; sealos Doc： image-cri-shim 介绍&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/2965&#34;&gt; 为什么sealos4.2部分的群，注册表库连接数很高 &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/labring/sealos/issues/3052&#34;&gt; BUG: image-cri-shim导致端口大量占用，耗尽服务器socket资源 &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
  </channel>
</rss>

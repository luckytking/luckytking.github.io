<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/post\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="Posts">
<meta name="twitter:title" content="Posts">
<meta property="og:url" content="https://luckytking.github.io/post/">
<meta property="twitter:url" content="https://luckytking.github.io/post/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>Posts</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/post/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/post/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" aria-label="">
      
          Ingress与IngressController
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-20T15:31:51&#43;08:00">
        
   20, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要学习记录Kubernetes集群暴露服务的方式: Ingress。</p>
<h3 id="简介">简介</h3>
<blockquote>
<p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p>IngressController  为了让 Ingress 资源工作，集群必须有一个正在运行的 Ingress 控制器。</p>
</blockquote>
<p><img src="https://luckytking.github.io/images/ingress_layout.png" alt=""></p>
<p>上图清晰标识出了Ingress的流量走向，其中：</p>
<ul>
<li>Ingress基于DNS名称（host）或URL路径把请求转发⾄指定的Service资源的规则。它仅是⼀组路由规则的集合。</li>
<li>Ingress控制器是真正实现“流量穿透”，可以由具有反向代理（HTTP/HTTPS）功能的服务程序实现 , 然后根据这些规则的匹配机制路由请求流量</li>
</ul>
<h3 id="ingress-资源声明">Ingress 资源声明</h3>
<p>Ingress是Kubernetes API的标准资源类型之⼀ ,一个最小Ingress例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minimal-ingress</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx-example</span>
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/testpath</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>其中:</p>
<ul>
<li>Ingress 需要指定 apiVersion、kind、 metadata和 spec 字段。</li>
<li>Ingress 对象的命名必须是合法的 DNS 子域名名称。</li>
<li>Ingress annotations 来配置一些选项,  ⽤于识别其所属的Ingress控制器的类别。</li>
<li>Ingress rules 提供了配置负载均衡器或者代理服务器所需的所有信息。 最重要的是，其中包含与所有传入请求匹配的规则列表。 Ingress 资源仅支持用于转发 HTTP(S) 流量的规则。</li>
</ul>
<p>更多参考： <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>Ingress控制器可以由任何具有反向代理（HTTP/HTTPS）功能的服务程序实现，目前支持和维护 AWS、 GCE 和 Nginx Ingress 控制器。</p>
<ul>
<li>Nginx Ingress 作为反向代理和负载均衡器。</li>
<li>Apache APISIX Ingress 控制器 是一个基于 Apache APISIX 网关 的 Ingress 控制器。</li>
</ul>
<p>更多参考：https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</p>
<h3 id="安装-ingress-nginx">安装 Ingress Nginx</h3>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/cloud/deploy.yaml  -O ingress-nginx-deploy.yaml

kubectl apply -f  ingress-nginx-deploy.yaml
</code></pre><p>观测是否成功：</p>
<pre tabindex="0"><code>kubectl get pods -n ingress-nginx --watch
</code></pre><p>如果成功的话，查看namespace下所有的资源信息</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get all -n ingress-nginx
NAME                                            READY   STATUS    RESTARTS   AGE
pod/ingress-nginx-controller-123456   1/1     Running   0          1h

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.104.182.98    192.168.1.100   80:31666/TCP,443:31888/TCP   1d
service/ingress-nginx-controller-admission   ClusterIP      10.111.228.99   &lt;none&gt;         443/TCP                      1d

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           1d

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-123456   1         1         1      1d

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           1s         1d
job.batch/ingress-nginx-admission-patch    1/1           2s         1d
</code></pre><h3 id="使用ingress-发布-tomcat">使用Ingress 发布 Tomcat</h3>
<p>部署Tomcat Service</p>
<ol>
<li>
<p>创建deployment</p>
<pre tabindex="0"><code>    kubectl create deployment web --image=tomcat:8.0.50-jre8-alpine
</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>kubectl expose deployment web --type=NodePort --port=8080

</code></pre></li>
<li>
<p>将 Deployment 暴露出来</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get service web
    NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
    web    NodePort   10.100.183.22   &lt;none&gt;        8080:32562/TCP   30s
</code></pre></li>
<li>
<p>验证nodeport 是否正常访问 tomcat ，浏览器访问  http://matster_ip:32562
<img src="https://luckytking.github.io/images/ingress_tomcat.png" alt=""></p>
</li>
<li>
<p>创建 ingress</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingressfoo</span>
      <span style="color:#f92672">annotations</span>:
        <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">rules</span>:
      - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ingressfoo.io</span>
        <span style="color:#f92672">http</span>:
          <span style="color:#f92672">paths</span>:
          - <span style="color:#f92672">backend</span>:
              <span style="color:#f92672">service</span>:
                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
                <span style="color:#f92672">port</span>:
                  <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bar</span>
            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>查看ingress是否创建成功</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get ingress
NAME         CLASS    HOSTS                     ADDRESS        PORTS   AGE
ingressfoo   &lt;none&gt;   ingressfoo.io   192.168.1.100   80      1h
</code></pre><p>说明Ingress创建成功，修改hosts ：</p>
<blockquote>
<p>ingressfoo.io 192.168.1.100</p>
</blockquote>
<p>验证访问 ingressfoo.io/bar</p>
<p><img src="https://luckytking.github.io/images/ingress_tomcat2.png" alt=""></p>
<p>success</p>
<h3 id="参考">参考</h3>
<ul>
<li>Ingress  介绍 <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></li>
<li>IngressController 介绍  <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</a></li>
<li><a href="https://github.com/apache/apisix-ingress-controller">https://github.com/apache/apisix-ingress-controller</a></li>
<li>NGINX Ingress 控制器配置 Ingress <a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8</a></li>
<li>在K8S上的Web服务该怎么做域名解析 <a href="https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA">https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/" aria-label="">
      
          Go网络抓包、引流工具GoReplay
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-12T22:57:15&#43;08:00">
        
   12, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文简要介绍Go网络抓包、引流工具GoReplay。</p>
<h3 id="前言">前言</h3>
<p>在后端的实际开发中，会遇到以下一些场景：</p>
<ul>
<li>用户通过作弊手段绕过前端，利用抓包，进行破解，模拟，魔改交互数据进行伪装。后端程序需要对其操作记录进行重现和跟踪。</li>
<li>某个bug在测试环境无法复现。</li>
<li>服务压测数据和线上数据有偏差，压测数据希望能和线上接近 。</li>
</ul>
<p>GoReplay是Go语言编写的流量回放工具，侦听器服务器捕获http流量并将其发送到重放服务器或保存到文件。重播服务器将流量转发给给定的地址。</p>
<h3 id="安装">安装</h3>
<p>测试环境： Windows。
版本： Version:1.3.0
安装分2步骤：</p>
<ol>
<li>前置条件： 安装npcap 
<a href="https://npcap.com">https://npcap.com</a></li>
</ol>
<blockquote>
<p>GoReplay可以在Windows机器上工作，但由于Windows堆栈的不同网络层的性质，它有一些细节。
默认情况下，Windows不像Unix系统那样有支持包捕获的网络驱动程序，如果您想捕获通信量，则必须单独安装它。其中一个选项是安装https://nmap.org/npcap/。</p>
</blockquote>
<ol start="2">
<li>安装：这里测试使用的是 gor-1.3.3_windows.zip
<a href="https://github.com/buger/goreplay/releases">https://github.com/buger/goreplay/releases</a> 
下载解压即可。</li>
</ol>
<h3 id="捕获流量">捕获流量</h3>
<blockquote>
<p>启动两个http服务：</p>
</blockquote>
<ol>
<li>httpServerA: http://localhost:8000 监听端口8000</li>
<li>httpServerB: http://localhost:8001 监听端口8001</li>
</ol>
<p>路由为 “get: &ldquo;/helloworld/{name}&rdquo;</p>
<blockquote>
<p>监听端口8000，并输出到stdout</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> ./gor --input-raw <span style="color:#960050;background-color:#1e0010">:</span>8000 --output-stdout
</code></pre></div><blockquote>
<p>打开浏览器请求接口 http://localhost:8000/helloworld/lilei</p>
</blockquote>
<blockquote>
<p>在gor的命令行窗口：</p>
</blockquote>
<pre tabindex="0"><code>1 db0a1f4000000001c344a1d3 1668261985986369000 0
GET /helloworld/lilei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot; 此处省略一些系数
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
此处省略一些参数
</code></pre><p>可见，gor已经把整个http请求的完整信息记录下来。
同时gor还支持输出到文件和ElasticSearch，进行回放和分析。记录到文件request.gor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> ./gor --input-raw <span style="color:#960050;background-color:#1e0010">:</span>8000 --output<span style="color:#f92672">-file</span> request.gor --input-raw-track-response --input-raw-override-snaplen
</code></pre></div><blockquote>
<p>打开浏览器请求接口 http://localhost:8000/helloworld/hanmeimei</p>
</blockquote>
<p>写入到文件 request_0.gor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Mode                 LastWriteTime         Length Name
----                 -------------         ------ ---- 
-a----        2022/11/12     21<span style="color:#960050;background-color:#1e0010">:</span>36           1876 request_0.gor
</code></pre></div><p>request_0 内容如下:</p>
<pre tabindex="0"><code class="language-gor" data-lang="gor">1 d4571f4000000001b7adc1a6 1668260139796335000 0
GET /helloworld/lilei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, 此处省略一些参数
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64), 此处省略一些参数
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
此处省略一些参数


🐵🙈🙉
2 d4571f4000000001b7adc1a6 1668260139796652000 0
HTTP/1.1 200 OK
Content-Type: application/json
Date: Sat, 12 Nov 2022 13:35:39 GMT
Content-Length: 25

{&quot;message&quot;:&quot;Hello lilei&quot;}
🐵🙈🙉
1 d4571f4000000001b7adc22b 1668260148757949000 0
GET /helloworld/hanmeimei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, 此处省略一些参数
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) , 此处省略一些参数
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
此处省略一些参数


🐵🙈🙉
2 d4571f4000000001b7adc22b 1668260148758268000 0
此处省略一些参数

{&quot;message&quot;:&quot;Hello hanmeimei&quot;}
🐵🙈🙉

</code></pre><h3 id="流量回放">流量回放</h3>
<p>接着将该文件request_0.gor 进行流量回放，并转发到另外一台服务器（HttpServerB）上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">./gor --input<span style="color:#f92672">-file</span> request_0.gor --output-http http<span style="color:#960050;background-color:#1e0010">:</span>//localhost<span style="color:#960050;background-color:#1e0010">:</span>8001
</code></pre></div><p>观察HttpServerB服务器控制台输出：</p>
<pre tabindex="0"><code>INFO ts=2022-11-12T21:37:26+08:00 caller=greeter.go:44 service.id=LAPTOP-H3HBMV8A service.name= service.version= trace.id= span.id= msg=CreateGreeter: lilei
INFO ts=2022-11-12T21:37:34+08:00 caller=greeter.go:44 service.id=LAPTOP-H3HBMV8A service.name= service.version= trace.id= span.id= msg=CreateGreeter: hanmeimei

</code></pre><p>从日志中可以看到两个请求（http://localhost:8000/helloworld/ilei、http://localhost:8000/helloworld/hanmeimei）分别重放请求到了HttpServerB。</p>
<p>gor支持进行流量缩小、放大、倍速重放，实现真实流量的压测效果。
更多命令 ./gor -help 查看</p>
<h3 id="参考">参考</h3>
<ul>
<li>官方GitHub  <a href="https://github.com/buger/goreplay">https://github.com/buger/goreplay</a></li>
<li>安装包 <a href="https://github.com/buger/goreplay/releases">https://github.com/buger/goreplay/releases</a></li>
<li>Windows 安装 <a href="https://github.com/buger/goreplay/wiki/Running-on-Windows">https://github.com/buger/goreplay/wiki/Running-on-Windows</a></li>
<li>官方npcap <a href="https://npcap.com/">https://npcap.com/</a></li>
<li>Goreplay详解 <a href="https://www.cnblogs.com/sunsky303/p/9072871.html">https://www.cnblogs.com/sunsky303/p/9072871.html</a></li>
<li>入门和导入Es  <a href="https://mp.weixin.qq.com/s/mNjLiEBnHIZhOTrDwNkmvA">https://mp.weixin.qq.com/s/mNjLiEBnHIZhOTrDwNkmvA</a></li>
<li>简介  <a href="https://www.jianshu.com/p/0f3bcfbf7874">https://www.jianshu.com/p/0f3bcfbf7874</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" aria-label="">
      
          Kubernetes集群资源监控一机制和资源指标
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-05T22:50:36&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        本文主要介绍Kubernetes集群资源监控机制和资源指标
前言 临近双11，对于码农，尤其是后端，尤其是某宝某东的后端，那是多么激动人心（心惊胆战）的一夜，为什么？怕宕机呀~。那么就让我们来构建护城河&ndash;监控与自动扩容，来抵挡千军万马&ndash;高并发场景。首先让我们学习一些基础：k8s集群资源监控机制和资源指标。
分析 从需求出发，我们自然需要收集一些数据(资源指标)，再根据指标做一系列的操作(control)，比如说预警警告、统计、自动扩容等。
首先，我们希望可以监控整个Kubernetes集群的健康状况，包括：
 整个集群的资源利⽤率 集群中的所有⼯作节点是否运⾏正常、系统资源容量⼤⼩ 每个⼯作节点上运⾏的容器化应⽤的数量  k8s资源控制 我们看看k8s如何资源控制
限制节点 以购物平台为例，微服务广受推崇，比如双11当天，用户进首页是流畅的，但是进活动主页就卡顿，到了零点时，加入购物车的按钮都转圈了。设想你的设计可能是三个微服务（主页服务 、双十一活动服务、订单服务），可想而知，活动服务是压力最大的，我们希望，就算宕机，不要影响其他的服务。所以可以把活动服务限制运行在某节点。
 创建一个会被调度到特定节点上的 Pod，你也可以通过设置 nodeName 将某个 Pod 调度到特定的节点
 nodeName: foo-node # 调度 Pod 到特定的节点 限制内存 还是上面的例子，我们把活动服务调度到了 foo-node。那么剩下的服务没有去限制，但想想订单服务的压力也不小，这里我们希望限制它的资源上限。
 要为容器指定内存请求，请在容器资源清单中包含 resources：requests 字段。 同理，要指定内存限制，请包含 resources：limits。
 resources: requests: memory: &#34;1000Gi&#34; limits: memory: &#34;1000Gi&#34; 限制CPU  要为容器指定 CPU 请求，请在容器资源清单中包含 resources: requests 字段。 要指定 CPU 限制，请包含 resources:limits
 resources: limits: cpu: &#34;100&#34; requests: cpu: &#34;100&#34; Example 环境准备:
 k8s集群（master * 1，node * 2 ) kubectl 命令行工具( 笔者使用rancher)   创建一个namespace（stress）。 增加一个deployment, 修改内存上限为10M 1.
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" aria-label="">
      
          Golang使用RedisSortSets实现排行榜
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-30T15:43:28&#43;08:00">
        
   30, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="前言">前言</h3>
<p>游戏排行榜是一个常见需求，今天主要介绍go语言使用redis-sort-sets来实现排行榜常见功能。</p>
<h3 id="redis-sort-sets">Redis Sort Sets</h3>
<p>官方介绍：</p>
<blockquote>
<p>Redis排序集是按相关分数排序的惟一字符串(成员)的集合。当多个字符串具有相同的分数时，字符串将按字典顺序排列。排序集的一些用例包括:</p>
<p>游戏排行榜。例如，您可以使用排序集轻松地维护大型在线游戏中最高分数的有序列表。
速率限制器。特别是，您可以使用一个排序集来构建滑动窗口速率限制器，以防止过多的API请求。</p>
</blockquote>
<p>常用于排行榜的命令:</p>
<ul>
<li>ZRANGE 返回排序集的成员（升序）</li>
<li>ZREVANGE 返回排序集的成员（降序序）</li>
<li>ZADD 向排序集添加一个新成员和相关分数。如果成员已经存在，则更新评分。</li>
<li>ZREM 删除排序集一个成员</li>
<li>ZRANK 返回提供的成员的排名(升序)</li>
<li>ZREVRANK 返回提供的成员的排名(降序)</li>
</ul>
<h3 id="go-redis">Go Redis</h3>
<p>Go Redis为各种风格的Redis提供Go客户端，基础的使用例子如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	})
	<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
}
</code></pre></div><h3 id="examples">Examples</h3>
<p>这里我们用go-redis实现排行榜常见的功能，包括:</p>
<ul>
<li>获取排行榜成员和分数 （升序、降序）</li>
<li>加入排行榜成员</li>
<li>删除排行榜成员</li>
<li>更新排行榜成员分数</li>
<li>获取排行榜成员分数</li>
<li>获取排行榜名次成员</li>
<li>清空排行榜</li>
</ul>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	}) 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//增加玩家分数的变化
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
			<span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>)),
			<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">i</span>),
		}).<span style="color:#a6e22e">Err</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersWithScore</span>)

	<span style="color:#75715e">//查询排行榜成员-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRev</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员-降序&#34;</span>, <span style="color:#a6e22e">membersRev</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//获取某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">user2Score</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZScore</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;获取某玩家 user:2 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//更新某玩家的分数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
		<span style="color:#a6e22e">Score</span>:  <span style="color:#a6e22e">user2Score</span>,
		<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:1&#34;</span>,
	}).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;更新某玩家 user:1 的分数&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//查询排行榜成员和分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜变化后的排行榜成员和分数-升序&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家  user:2 的排名&#34;</span>, <span style="color:#a6e22e">memberRank</span>)

	<span style="color:#75715e">//查询排行榜某玩家的分数-降序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRevRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;查询排行榜某玩家 user:2 的排名-降序&#34;</span>, <span style="color:#a6e22e">memberRevRank</span>)

	<span style="color:#75715e">//删除排序集一个成员
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">zrem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRem</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:1&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除排序集一个成员&#34;</span>, <span style="color:#a6e22e">zrem</span>)

	<span style="color:#75715e">//删除后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;删除后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>)

	<span style="color:#75715e">//清空排行榜
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clear</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRemRangeByRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;err zrem&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空排行榜&#34;</span>, <span style="color:#a6e22e">clear</span>)
	<span style="color:#75715e">//清空后查询排行榜成员-升序
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;清空后查询排行榜成员-升序&#34;</span>, <span style="color:#a6e22e">members</span>) 

</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>查询排行榜成员-升序 [user:3 user:4 user:1 user:5 user:2]
查询排行榜成员和分数-升序 [{87 user:2} {81 user:5} {81 user:1} {59 user:4} {47 user:3}]
查询排行榜成员-降序 [user:2 user:5 user:1 user:4 user:3]
查询排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:1} {81 user:5} {87 user:2}]
获取某玩家 user:2 的分数 87
更新某玩家 user:1 的分数 87
查询排行榜变化后的排行榜成员和分数-升序 [{47 user:3} {59 user:4} {81 user:5} {87 user:1} {87 user:2}]
查询排行榜某玩家  user:2 的排名 4
查询排行榜某玩家 user:2 的排名-降序 0
删除排序集一个成员 1
删除后查询排行榜成员-升序 [user:3 user:4 user:5 user:2]
清空排行榜 4
清空后查询排行榜成员-升序 []

</code></pre><h3 id="参考">参考</h3>
<ul>
<li>安装Redis <a href="https://redis.io/docs/getting-started/installation/">https://redis.io/docs/getting-started/installation/</a></li>
<li>Redis Sort Sets Docs <a href="https://redis.io/docs/data-types/sorted-sets/">https://redis.io/docs/data-types/sorted-sets/</a></li>
<li>Go Redis <a href="https://github.com/go-redis/redis/v9">https://github.com/go-redis/redis/v9</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" aria-label="">
      
          Go开发常用第三方库之ants
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-21T23:17:35&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>go语言提供非常方便的创建轻量级的协程goroutine来并发处理任务，但是 协程过多影响程序性能，所以，这时goroutine池就登场了。本文简要介绍ants goroutine 池的基本的使用方法。</p>
<h3 id="简介">简介</h3>
<p>ants是一个高性能的 goroutine 池，实现了对大规模 goroutine 的调度管理、goroutine 复用，允许使用者在开发并发程序的时候限制 goroutine 数量，复用资源，达到更高效执行任务的效果。 ants就是一个很多大厂广泛使用的goroute池。</p>
<p>官网地址</p>
<blockquote>
<p><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></p>
</blockquote>
<h3 id="功能">功能</h3>
<ul>
<li>自动调度海量的 goroutines，复用 goroutines</li>
<li>定期清理过期的 goroutines，进一步节省资源</li>
<li>提供了大量有用的接口：任务提交、获取运行中的 goroutine 数量、动态调整 Pool 大小、释放 Pool、重启 Pool</li>
<li>优雅处理 panic，防止程序崩溃</li>
<li>资源复用，极大节省内存使用量；在大规模批量并发任务场景下比原生 goroutine 并发具有更高的性能</li>
<li>非阻塞机制</li>
</ul>
<h3 id="quick-start">quick start</h3>
<p>使用 ants v1 版本:</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants</p>
</blockquote>
<p>使用 ants v2 版本 (开启 GO111MODULE=on):</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants/v2</p>
</blockquote>
<p>接下来看一下官方demo：实现一个计算大量整数和的程序</p>
<h3 id="newpool">NewPool</h3>
<p>NewPool生成ants池实例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoFunc</span>() {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()

	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>

	<span style="color:#75715e">//使用公共池。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#a6e22e">syncCalculateSum</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">demoFunc</span>()
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">syncCalculateSum</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Running</span>())
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks.\n&#34;</span>)
 }
</code></pre></div><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPool(size int,  options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.size  即池容量，即池中最多有 10 个 goroutine。
arg.Option  定制化 goroutine pool.</p>
</blockquote>
<ul>
<li>p.Submit向此池提交任务。</li>
<li>ants.Release关闭此池并释放工作队列。</li>
<li>defaultAntsPool 导入ants时初始化实例池。</li>
</ul>
<h3 id="newpoolwithfunc">NewPoolWithFunc</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#75715e">//使用带有函数的池
</span><span style="color:#75715e">//设置goroutine池的容量为10，过期时间为1秒。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	})
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#75715e">//逐个提交任务。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Invoke</span>(int32(<span style="color:#a6e22e">i</span>))
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks, result is %d\n&#34;</span>, <span style="color:#a6e22e">sum</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code class="language-shelll" data-lang="shelll">run with 1
run with 5
run with 11
run with 12
run with 13
run with 14
run with 7
...
run with 789
run with 809
running goroutines: 10
finish all tasks, result is 499500
</code></pre><p>其中：</p>
<p>生成一个具有特定函数的ants池实例</p>
<ul>
<li>NewPoolWithFunc(size int, pf func(interface{}), options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.pf  即为执行任务的函数</p>
</blockquote>
<h3 id="优雅处理-panic">优雅处理 panic</h3>
<p>测试一些当任务触发panic的情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;panic from task:%d&#34;</span>, <span style="color:#a6e22e">n</span>)))
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}
</code></pre></div><p>output：</p>
<pre tabindex="0"><code>run with 3
run with 13
...
run with 999
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:6
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:0
2022/10/21 21:41:07 worker with func exits from panic: goroutine 14 [running]:
</code></pre><p>可以看到，main routine 没有因此受影响。</p>
<h3 id="options">Options</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Options包含实例化ants池时将应用的所有选项。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ExpiryDuration is a period for the scavenger goroutine to clean up those expired workers,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the scavenger scans all workers every `ExpiryDuration` and clean up those workers that haven&#39;t been
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used for more than `ExpiryDuration`.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExpiryDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#75715e">// PreAlloc indicates whether to make memory pre-allocation when initializing Pool.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreAlloc</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Max number of goroutine blocking on pool.Submit.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 0 (default value) means no such limit.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxBlockingTasks</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// When Nonblocking is true, Pool.Submit will never be blocked.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ErrPoolOverload will be returned when Pool.Submit cannot be done at once.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// When Nonblocking is true, MaxBlockingTasks is inoperative.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Nonblocking</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// PanicHandler is used to handle panics from each worker goroutine.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if nil, panics will be thrown out again from worker goroutines.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicHandler</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// Logger is the customized logger for logging info, if it is not set,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// default standard logger from log package is used.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">Logger</span>
}
</code></pre></div><p>比如 PanicHandler 遇到 panic会调用这里设置的处理函数,以上例中，我们遇到偶数会触发panic，修改NewPool函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">WithPanicHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;panic recover %v&#34;</span>, <span style="color:#a6e22e">i</span>)
	}))
</code></pre></div><p>out：</p>
<pre tabindex="0"><code>panic recover panic from i:992run with 880
panic recover panic from i:880run with 972
panic recover panic from i:972run with 994
run with 991
</code></pre><p>还有更多关于 Benchmarks 性能报告，可参考https://github.com/panjf2000/ants</p>
<h3 id="参考">参考：</h3>
<ul>
<li><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></li>
<li><a href="https://darjun.github.io/2021/06/03/godailylib/ants/">https://darjun.github.io/2021/06/03/godailylib/ants/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%9E%84%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" aria-label="">
      
          设计模式 构造者模式
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-16T12:10:03&#43;08:00">
        
   16, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="定义">定义</h3>
<blockquote>
<p>将一个复杂对象的构建与它的表示分离，使得同样的构建 过程可以创建不同的表示。</p>
</blockquote>
<h3 id="复杂的构造函数">复杂的构造函数</h3>
<p>创建一个对象最常用的方式是，使用 new 关键字调用类的构造函数来完成。举个常用资源连接池的例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResourcePool</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">maxIdle</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">minIdle</span>  <span style="color:#66d9ef">int</span>
}
<span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>, 
<span style="color:#ae81ff">10</span>)
</code></pre></div><p>在可配置项不多的时候没什么问题，但是，如果可配置项逐渐增多，以gorm的配置文件为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Config GORM config
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// GORM perform single create, update, delete operations in transactions by default to ensure database data integrity
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// You can disable it by setting `SkipDefaultTransaction` to true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SkipDefaultTransaction</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// NamingStrategy tables, columns naming strategy
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NamingStrategy</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">Namer</span>
	<span style="color:#75715e">// FullSaveAssociations full save associations
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FullSaveAssociations</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// Logger
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Interface</span>
	<span style="color:#75715e">// NowFunc the function to be used when creating a new timestamp
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NowFunc</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
	<span style="color:#75715e">// DryRun generate sql without execute
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DryRun</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// PrepareStmt executes the given query in cached statement
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PrepareStmt</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableAutomaticPing
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableAutomaticPing</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableForeignKeyConstraintWhenMigrating
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableForeignKeyConstraintWhenMigrating</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableNestedTransaction disable nested transaction
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableNestedTransaction</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// AllowGlobalUpdate allow global update
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AllowGlobalUpdate</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// QueryFields executes the SQL query with all fields of the table
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">QueryFields</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// CreateBatchSize default create batch size
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CreateBatchSize</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// ClauseBuilders clause builder
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ClauseBuilders</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">clause</span>.<span style="color:#a6e22e">ClauseBuilder</span>
	<span style="color:#75715e">// ConnPool db conn pool
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnPool</span> <span style="color:#a6e22e">ConnPool</span>
	<span style="color:#75715e">// Dialector database dialector
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Dialector</span>
	<span style="color:#75715e">// Plugins registered plugins
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Plugins</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Plugin</span>
    <span style="color:#75715e">// ... 省略一些参数
</span><span style="color:#75715e"></span>}

</code></pre></div><p>这时，这个构造函数就变得复杂了。构造函数参数列表会变得很长，容易搞错各参数的顺序，造成隐蔽的bug。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>,   <span style="color:#ae81ff">16</span>, <span style="color:#a6e22e">null</span>, <span style="color:#ae81ff">8</span>, <span style="color:#a6e22e">null</span>, <span style="color:#66d9ef">false</span> , <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#66d9ef">false</span><span style="color:#960050;background-color:#1e0010">，</span> <span style="color:#66d9ef">true</span> )
</code></pre></div><p>开始重构，这里使用 set() 函数来给成员变量赋值，以替代冗长的构造函数，并在set()函数里做参数校验。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#a6e22e">this</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePool</span>{}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">name</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">maxTotal</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxTotal should be positive.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">maxTotal</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#a6e22e">minIdle</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">minIdle</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;minIdle should not be negative.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
</code></pre></div><p>重构后的构造函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>).<span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#ae81ff">8</span>)

</code></pre></div><p>但是，这里还是有几个问题：</p>
<ol>
<li>如果必填的配置项有很多，那构造函数就又会出现参数列表很长的问题。</li>
<li>如果配置项之间有一定的依赖关系，并校验参数的合法性。</li>
<li>如果希望ResourcePool的配置项不对外提供修改方法。</li>
</ol>
<h3 id="使用构造者重构">使用构造者重构</h3>
<ol>
<li>首先，创建一个构造者类Builder，并把参数改为私有，提供set()函数修改。</li>
<li>其次build() 方法真正创建对象之前，做集中的校验，校验通过之后才会创建对象。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">builder</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#a6e22e">this</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePool</span>{}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">name</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxTotal</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxIdle</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxIdle</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResourcePoolBuilder</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">maxIdle</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">minIdle</span>  <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Builder</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#a6e22e">builder</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePoolBuilder</span>{}
	<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#ae81ff">16</span>
	<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#ae81ff">5</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">builder</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">Build</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#75715e">// 校验逻辑放到这里来做，包括必填项校验、依赖关系校验、约束条件校验等
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">maxIdle</span> &gt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">maxTotal</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxIdle should bigger than maxTotal.&#34;</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">b</span>)
}


<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">name</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">maxTotal</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxTotal should be positive.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">maxTotal</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#a6e22e">minIdle</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">minIdle</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;minIdle should not be negative.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
</code></pre></div><p>重构后的构造函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Builder</span>().<span style="color:#a6e22e">SetName</span>(<span style="color:#e6db74">&#34;test&#34;</span>).<span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Build</span>()
</code></pre></div><p>如此，</p>
<ul>
<li>这样我们就只能通过建造者Builder 来创建 ResourcePool 类对象。</li>
<li>要修改resourcePool只能通过 Builder提供的 set()函数，配置项不对外提供修改方法。</li>
<li>参数校验或者提供默认参数可以放在build()函数内。</li>
</ul>
<h3 id="小结">小结</h3>
<p>构造者模式原理并不复杂，主要适当的场景中灵活使用。通过构造者类Builder、提供的set()函数设置必选项，最终调用build()处理构造类之前的一些逻辑。如此，可以以通过设置不同的可选参数，“定制化”地创建不同的复杂对象.</p>
<h3 id="参考">参考</h3>
<ul>
<li>设计模式之美 <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%9E%84%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" aria-label="">
      
          浅谈kratos的表现层源码实现与解码器
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-02T17:25:55&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前后端数据常用传输格式有：json、xml 和 proto等，不管是mvc还是ddd，都会在表现层的对不同的格式进行转化下层依赖所需的类、Object、 aggregate等。</p>
<h2 id="kratos-表现层">Kratos 表现层</h2>
<p>在实际开发场景中，前后端传输采用json。 但kratos使用proto定义Api， 那么我们以一个Http请求为例，来看看kratos的表现层是如何处理的。</p>
<p>以下是一个Kratos-Example，由编写好的proto文件，proto-go 等自动生成表现层的代码。 大概步骤：</p>
<ol>
<li>编写proto，包括Service，Req，Reply</li>
<li>生成表现层代码</li>
<li>实现下层逻辑等</li>
</ol>
<p>Example完整代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>可以看到：</p>
<ol>
<li>这里对具体的格式无感，输入In还是输出Out都是一个proto生成的类。</li>
<li>具体的实现交给了ctx 上下文去实现
查看 ctx.Result的源码:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Result</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">code</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">enc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">v</span>)
}
</code></pre></div><p>这里的enc，没有特殊设置，使用默认的DefaultResponseEncoder，部分源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultResponseEncoder</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CodecForRequest</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;Accept&#34;</span>)
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ContentType</span>(<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Name</span>()))
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>通过codc接口隔离具体实现，调用接口的 codec.Marshal序列化。</p>
<h2 id="codec包">codec包</h2>
<p>Codec定义Transport用于编码和解码消息的接口。它的实现包括 json，xml，proto，yaml等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Codec</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Marshal returns the wire format of v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">// Unmarshal parses the wire format into v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">// Name returns the name of the Codec implementation. The returned string
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will be used as part of content type in transmission.  The result must be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// static; the result cannot change between calls.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>这里我们聚焦正在使用的Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">codec</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">codec</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshaler</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MarshalJSON</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	}
}
</code></pre></div><p>这里Marshal()使用第三方库“&ldquo;google.golang.org/protobuf/encoding/protojson&rdquo;</p>
<p>实现proto转json。</p>
<h2 id="protojson第三方包">protojson第三方包</h2>
<p>protojson是Google提供的proto和json的转化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">api_test</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;google.golang.org/protobuf/encoding/protojson&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;helloworld/api/helloworld/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestToJson</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">HelloReply</span>{
		<span style="color:#a6e22e">Message</span>: <span style="color:#e6db74">&#34;Jobs&#34;</span>,
	}
	<span style="color:#a6e22e">replyJson</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">ProtoReflect</span>().<span style="color:#a6e22e">Interface</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Marshal Error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;replyJson:  %v&#34;</span>, string(<span style="color:#a6e22e">replyJson</span>))
}
</code></pre></div><p>更多的接口请参考“https://google.golang.org/protobuf/encoding/protojson”</p>
<h2 id="小结">小结</h2>
<p>本文主要以kratos的表现层的组织方式，来介绍常用的框架表现层处理方式。
其中：</p>
<ul>
<li>kratos通过proto来生成表现层代码的类，包括http和grapc，内部对具体实现无感。</li>
<li>kratos通过解码器codec实现不同传输格式的解耦。</li>
<li>第三方包protojson实现proto和json转换。</li>
</ul>
<p>框架的主要功能之一就是标准化处理一下公共的问题场景,从源码中可以学习：通过接口隔离具体的实现，而使框架与具体实现解耦,且具备更好的拓展性。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://go-kratos.dev/docs/getting-started/usage">https://go-kratos.dev/docs/getting-started/usage</a></li>
<li><a href="https://google.golang.org/protobuf/encoding/protojson">https://google.golang.org/protobuf/encoding/protojson</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" aria-label="">
      
          设计模式  观察者模式
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-25T16:43:20&#43;08:00">
        
   25, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="基础概念">基础概念</h3>
<p>来自Head First设计模式一书的定义</p>
<blockquote>
<p>观察者模式 Observer 
观察者模式 定义了一系列对象之间的一对多的关系,当一个对象的状态改变, 其他依赖者都会收到到通知。</p>
</blockquote>
<p>经常观察者模式也称发布订阅模式，一般观察者模式有以下组成：</p>
<ul>
<li>Subject-被观察者，亦或是发布者-Publisher</li>
<li>Observer-观察者，亦或是订阅者-Subscribe</li>
</ul>
<h3 id="经典的实现方式">经典的实现方式</h3>
<p>以下是golang的具体实现：observer.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Subject</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#a6e22e">Observer</span>)
	<span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{})
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Observer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{})
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteSubject</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">observerList</span> []<span style="color:#a6e22e">Observer</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConcreteSubject</span>() <span style="color:#a6e22e">Subject</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteSubject</span>{}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteSubject</span>) <span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#a6e22e">observer</span> <span style="color:#a6e22e">Observer</span>) {
	<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span> = append(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span>, <span style="color:#a6e22e">observer</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteSubject</span>) <span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">observer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span> {
		<span style="color:#a6e22e">observer</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span>)
	}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteObserverOne</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteObserverOne</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ConcreteObserverOne is notified.%v \n&#34;</span>, <span style="color:#a6e22e">message</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteObserverTwo</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteObserverTwo</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ConcreteObserverOne is notified.%v \n&#34;</span>, <span style="color:#a6e22e">message</span>)
}

</code></pre></div><p>observer_test.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;testing&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestObserver</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">concreteSubject</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConcreteSubject</span>()
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteObserverOne</span>{})
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteObserverTwo</span>{})
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#e6db74">&#34;hello every one&#34;</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>ConcreteObserverOne is notified.hello every one 
ConcreteObserverOne is notified.hello every one 
</code></pre><p>可以看到例子里包含了以下接口和实现：</p>
<ul>
<li>Subject 主题接口： 注册实现、通知所有观察者</li>
<li>Observer 观察者接口： 接收主体通知的接口。</li>
<li>ConcreteSubject 主题的具体实现</li>
<li>ConcreteObserverOne/ConcreteObserverTwo 不同的观察者实现</li>
</ul>
<p>当你需要增加一个观察者时，只需要实现 Update(）接口和注册Register到subject即可。</p>
<h3 id="应用场景">应用场景</h3>
<p>那么观察者模式在什么场景下适用呢？接着我们以一个游戏用户注册的例子来套用一下。</p>
<blockquote>
<p>场景: 玩家在注册成功后，将在“地图服务”创建一个出生点位，同时“邮件服务”会发送一份新手礼包。</p>
</blockquote>
<p>在没有使用观察者模式时，可能是这么写的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldMapService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWorldMapService</span>() <span style="color:#a6e22e">WorldMapService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">WorldMapService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">WorldMapService</span>) <span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;欢迎%v来到新手村&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MailService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMailService</span>() <span style="color:#a6e22e">MailService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MailService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">MailService</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;恭喜勇士%v,获得金币999&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>() <span style="color:#a6e22e">UserService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserService</span>{}
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">User</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;欢迎来到元宇宙&#34;</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserController</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">User</span>     <span style="color:#a6e22e">UserService</span>
	<span style="color:#a6e22e">WorldMap</span> <span style="color:#a6e22e">WorldMapService</span>
	<span style="color:#a6e22e">Mail</span>     <span style="color:#a6e22e">MailService</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserController</span>() <span style="color:#a6e22e">UserController</span> {
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>()
	<span style="color:#a6e22e">worldMap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewWorldMapService</span>()
	<span style="color:#a6e22e">mail</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewMailService</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserController</span>{
		<span style="color:#a6e22e">User</span>:     <span style="color:#a6e22e">user</span>,
		<span style="color:#a6e22e">WorldMap</span>: <span style="color:#a6e22e">worldMap</span>,
		<span style="color:#a6e22e">Mail</span>:     <span style="color:#a6e22e">mail</span>,
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">UserController</span>) <span style="color:#a6e22e">Do</span>() {
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;好奇的小明&#34;</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">WorldMap</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Mail</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Start</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserController</span>()
	<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Do</span>()
}

<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#a6e22e">MapService</span>: <span style="color:#a6e22e">欢迎好奇的小明来到新手村</span>
<span style="color:#a6e22e">MailService</span>: <span style="color:#a6e22e">恭喜勇士好奇的小明</span>,<span style="color:#a6e22e">获得金币999</span>
<span style="color:#a6e22e">UserService</span>: <span style="color:#a6e22e">让我们开始愉快的旅程吧</span>
</code></pre></div><p>UserController.Do 注册、增加出生点位、发送邮件，违反单一职责原则。如果模块越来越多，比如增加一个任务系统（登入过游戏赠送金币），坐骑模块（登入赠送初始坐骑）之类，那么这里的代码就会变得越来越长，不好拓展等。这时候，使用观察者模式，进行解耦。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldMapService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWorldMapService</span>() <span style="color:#a6e22e">WorldMapService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">WorldMapService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">WorldMapService</span>) <span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;MapService: 欢迎%v来到新手村&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MailService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMailService</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">MailService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MailService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">MailService</span>) <span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;MailService: 恭喜勇士%v,获得金币999&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>() <span style="color:#a6e22e">UserService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserService</span>{}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">User</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UserService: 让我们开始愉快的旅程吧&#34;</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserController</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">obsrvers</span> []<span style="color:#a6e22e">RegObserver</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserController</span>(<span style="color:#a6e22e">obsrvers</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">RegObserver</span>) <span style="color:#a6e22e">UserController</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserController</span>{<span style="color:#a6e22e">obsrvers</span>: <span style="color:#a6e22e">obsrvers</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">UserController</span>) <span style="color:#a6e22e">Do</span>() {
	<span style="color:#a6e22e">userSvc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>()
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userSvc</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;好奇的小明&#34;</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ob</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">obsrvers</span> {
		<span style="color:#a6e22e">ob</span>.<span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">user</span>)
	}
	<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Start</span>()
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RegObserver</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">User</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserController</span>(<span style="color:#a6e22e">NewWorldMapService</span>(), <span style="color:#a6e22e">NewMailService</span>())
	<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Do</span>()
}

</code></pre></div><p>这里</p>
<ol>
<li>
<p>定义了一个RegObserver接口，不同的服务都实现了这个接口。并注册到了userController，控制器保存了所有的观察者，在登入userController的执行函数Do里，会去遍历所有的观察者，执行HandleRegSuccess。</p>
</li>
<li>
<p>当拓展需求时，只需要再添加一个实现了RegObserver接口的类并注册到控制器即可。</p>
</li>
</ol>
<p>如此，各模块间耦合性就降低了。</p>
<h3 id="小结">小结</h3>
<p>本文主要介绍观察者模式和使用场景，观察者模式和发布订阅模式的思路是差不多的，主要是为了解耦。应用场景还是非常广泛的，在同一进程的编码上， 在进程间的消息队列，还是在产品的订阅模式都有异曲同工之处。</p>
<h3 id="参考">参考</h3>
<ul>
<li>设计模式之美 <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/docker-gitlab%E8%BF%81%E7%A7%BB%E4%B8%8E%E5%8D%87%E7%BA%A7/" aria-label="">
      
          Docker GitLab迁移与升级
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-16T21:32:33&#43;08:00">
        
   16, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/devops">DevOps</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>最近在日常运维过程，发现挖矿病毒利用GitLab的CVE-2021-22205漏洞，消耗服务器的资源。为了彻底解决问题，决定对GitLab进行迁移和版本升级。</p>
<h3 id="前提">前提</h3>
<table>
<thead>
<tr>
<th>服务器</th>
<th>OS</th>
<th>GitLabVersion</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>原始服务器A</td>
<td>Ubuntu</td>
<td>13.7.4</td>
<td>下文简称ServerA</td>
</tr>
<tr>
<td>迁移目标服务器B</td>
<td>Ubuntu</td>
<td>15.3.3</td>
<td>下文简称原ServerB</td>
</tr>
</tbody>
</table>
<p>大致步骤：</p>
<ol>
<li>ServerA:备份GitLab</li>
<li>ServerB:恢复GitLab</li>
<li>ServerB:更新GitLab版本</li>
</ol>
<h3 id="备份">备份</h3>
<h4 id="数据">数据</h4>
<p>这里我们是用DockerCompose运行的GitLab-13.7.4，从主机运行备份：
GitLab 12.2 或更高版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">$docker exec -t &lt;container name&gt; gitlab-backup create
</code></pre></div><p>GitLab 12.1 及更早版本：</p>
<pre tabindex="0"><code>$docker exec -t &lt;container name&gt; gitlab-rake gitlab:backup:create
</code></pre><p>开始备份:</p>
<pre tabindex="0"><code>$ docker exec -t 985506cf361c gitlab-rake gitlab:backup:create
2022-09-16 02:56:34 +0000 -- Dumping database ...
Dumping PostgreSQL database gitlabhq_production ... [DONE]
...
Backup task is done.
</code></pre><p>查看备份文件：
默认的备份路径为 /var/opt/gitlab/backups，如果不知道保存路径，可以从容器的 /etc/gitlab/gitlab.rb 文件，查找 gitlab_rails[&lsquo;backup_path&rsquo;] = &ldquo;/var/opt/gitlab/backups&rdquo; 此为备份目录。</p>
<pre tabindex="0"><code>$ docker exec -it 985506cf361c bash
root@985506cf361c:/# cd /var/opt/gitlab/backups
root@985506cf361c:/var/opt/gitlab/backups# ls
123456_2022_09_16_13.7.4—_gitlab_backup.tar
</code></pre><p>将容器数据备份拷贝到主机的当前目录</p>
<pre tabindex="0"><code>docker cp gitlab:/var/opt/gitlab/backups/123456_2022_09_16_13.7.4_gitlab_backup.tar  ~/
</code></pre><h4 id="配置">配置</h4>
<p>GitLab 提供的备份 Rake 任务不存储您的配置文件,故而这里需要收到备份</p>
<pre tabindex="0"><code>/etc/gitlab/gitlab-secrets.json
/etc/gitlab/gitlab.rb
</code></pre><p>再将配置备份拷贝到主机的当前目录</p>
<pre tabindex="0"><code>docker cp gitlab:/etc/gitlab  ~/
</code></pre><h3 id="迁移">迁移</h3>
<h4 id="相同版本启动">相同版本启动</h4>
<p>docker-compose.yaml 示例如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">web</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce:13.7.4-ce.0</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com&#39;
</span><span style="color:#e6db74">        # Add any other gitlab.rb configuration here, each on its own line</span>        
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#39;80:80&#39;</span>
      - <span style="color:#e6db74">&#39;443:443&#39;</span>
      - <span style="color:#e6db74">&#39;22:22&#39;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#39;./volumes/gitlab/config:/etc/gitlab&#39;</span>
      - <span style="color:#e6db74">&#39;./volumes/gitlab/logs:/var/log/gitlab&#39;</span>
      - <span style="color:#e6db74">&#39;./volumes/gitlab/data:/var/opt/gitlab&#39;</span>
    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</code></pre></div><h4 id="配置-1">配置</h4>
<h4 id="数据-1">数据</h4>
<p>将ServerA的备份拷贝到ServerB</p>
<pre tabindex="0"><code>docker cp 1123456_2022_09_16_13.7.4_gitlab_backup.tar gitlab:/var/opt/gitlab/backups/
</code></pre><p><strong>进入容器</strong>，</p>
<p>停止连接到数据库的进程。让 GitLab 的其余部分继续运行</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl stop unicorn
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl stop sidekiq
ok: down: sidekiq: 0s, normally up
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl status
</code></pre><p>备份文件必须是git用户所有者（root下导入才需要）</p>
<pre tabindex="0"><code># chown -R git:git /var/opt/gitlab/backups/备份.tar
</code></pre><p>开始还原备份</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-rake gitlab:backup:restore BACKUP=123456_2022_09_16_13.7.4
Unpacking backup ... done

Do you want to continue (yes/no)? yes
...
Do you want to continue (yes/no)? yes

Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data
and are not included in this backup. You will need to restore these files manually.
Restore task is done.
</code></pre><p>启动GitLab</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl start
</code></pre><p>登入http://ServerB，检查GitLab正常运行。</p>
<h3 id="更新gitlab版本">更新GitLab版本</h3>
<p>接着开始更新版本，这里采用的停机升级方案，耗时较久（大概3～4小时），所以需要选择适当时机更新。更新路线：
13.7.4-&gt; 13.8.8-&gt;13.12.15-&gt; 14.0.12-&gt; 14.3.6=&gt;14.6.2-&gt; 14.9.5-&gt; 14.10.5-&gt; 15.0.2-&gt;15.1.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">services</span>:
   <span style="color:#f92672">gitlab</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce:15.3.3-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:15.1.0-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:15.0.2-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.10.5-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.9.5-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.6.2-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.3.6-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.0.12-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.12.15-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.8.8-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.7.4-ce.0</span>
</code></pre></div><h3 id="遇到的问题">遇到的问题</h3>
<ol>
<li>在使用备份恢复GitLab时卡住</li>
</ol>
<pre tabindex="0"><code>$ docker exec -it 7ddbcc0a6eb2 gitlab-rake gitlab:backup:restore BACKUP=1123456_2022_09_16_13.7.4
Unpacking backup ... done
Do you want to continue (yes/no)? yes
</code></pre><p>处理方式：<strong>进入容器</strong>,授权,执行恢复</p>
<pre tabindex="0"><code># chown -R git:git /var/opt/gitlab/backups/备份.tar
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-rake gitlab:backup:restore 
</code></pre><p>备注：增加 gitlab-rake gitlab:backup:restore &ndash;trace 查看详细信息.</p>
<h3 id="参考">参考</h3>
<ul>
<li>备份GitLab <a href="https://docs.gitlab.com/ee/raketasks/backup_gitlab.html#storing-configuration-files">https://docs.gitlab.com/ee/raketasks/backup_gitlab.html#storing-configuration-files</a></li>
<li>恢复GitLab <a href="https://docs.gitlab.com/ee/raketasks/restore_gitlab.html#restore-prerequisites">https://docs.gitlab.com/ee/raketasks/restore_gitlab.html#restore-prerequisites</a></li>
<li>GitLab升级路径 <a href="https://docs.gitlab.com/ee/update/#upgrade-paths">https://docs.gitlab.com/ee/update/#upgrade-paths</a></li>
<li>Docker Hub-Gitlab.Ce <a href="https://hub.docker.com/r/gitlab/gitlab-ce/tags">https://hub.docker.com/r/gitlab/gitlab-ce/tags</a></li>
<li>Docker gitlab备份与还原 <a href="https://www.xtcoder.com/archives/docker-gitlab-backup-restore">https://www.xtcoder.com/archives/docker-gitlab-backup-restore</a></li>
<li>Gitlab 应急解决方案 <a href="https://overstarry.vip/posts/gitlab_cve-2021-22205/">https://overstarry.vip/posts/gitlab_cve-2021-22205/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/docker-gitlab%E8%BF%81%E7%A7%BB%E4%B8%8E%E5%8D%87%E7%BA%A7/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" aria-label="">
      
          利用k8s储存卷来部署redis之三StatefulSet
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-11T18:20:54&#43;08:00">
        
   11, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>前两篇(1.<a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/">volume</a>2.<a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/">pv&amp;pvc</a>)通过部署redis学习实战了k8s的来Volume、PV和PVC。但是，应⽤程序存在“有状态”和“⽆状态”两种类别，显然redis属于读写磁盘需求的有状态应⽤程序，如⽀持事务功能的RDBMS存储系统，所以，本文学习实战k8s有状态应用的部署。</p>
<h3 id="stateful基础">Stateful基础</h3>
<p>StatefulSet是Pod资源控制器的⼀种实现，⽤于部署和扩展有状态应⽤的Pod资源，确保它们的运⾏顺序及每个Pod资源的唯⼀性。适用以下需求的应用：</p>
<ul>
<li>稳定且唯⼀的⽹络标识符。</li>
<li>稳定且持久的存储。</li>
<li>有序、优雅地部署和扩展。</li>
<li>有序、优雅地删除和终⽌。</li>
<li>有序⽽⾃动地滚动更新。</li>
</ul>
<h3 id="部署">部署</h3>
<p>接着，这里把之前的redis存储修改为stateful的方式，修改后的步骤：</p>
<ol>
<li>创建 ConfigMap （参考第一篇）</li>
<li>修改 Deployment 为StatefulSets</li>
</ol>
<h4 id="修改部署statefulsets">修改部署StatefulSets</h4>
<p>mkdir my-redis-statefulsets.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
          <span style="color:#f92672">emptyDir</span>: {}
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>
 
---
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30379</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis          </span>

</code></pre></div><p>其中：</p>
<ol>
<li>Headless Service：⽤于为Pod资源标识符⽣成可解析的DNS资源记录</li>
<li>StatefulSet ⽤于管控Pod资源</li>
<li>volumeClaimTemplate则基于静态或动态的PV供给⽅式为Pod资源提供
专有且固定的存储（这里我们直接使用了第二篇创建的pv）</li>
</ol>
<h3 id="测试">测试</h3>
<p>redis-client 连接 NodeId:NodePort</p>
<pre tabindex="0"><code># redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&gt; info
# Serverredis_version:7.0.4
</code></pre><p>连接成功!</p>
<h3 id="参考">参考</h3>
<ul>
<li>官方stateful介绍 <a href="https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage">https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage</a></li>
<li>《Kubernetes进阶实战-第2版》  https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/post/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


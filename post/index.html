<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/post\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="Posts">
<meta name="twitter:title" content="Posts">
<meta property="og:url" content="https://luckytking.github.io/post/">
<meta property="twitter:url" content="https://luckytking.github.io/post/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>Posts</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/post/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/post/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" aria-label="">
      
          Ingressä¸IngressController
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-20T15:31:51&#43;08:00">
        
   20, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>æœ¬æ–‡ä¸»è¦å­¦ä¹ è®°å½•Kubernetesé›†ç¾¤æš´éœ²æœåŠ¡çš„æ–¹å¼: Ingressã€‚</p>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<blockquote>
<p>Ingress æ˜¯å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„å¤–éƒ¨è®¿é—®è¿›è¡Œç®¡ç†çš„ API å¯¹è±¡ï¼Œå…¸å‹çš„è®¿é—®æ–¹å¼æ˜¯ HTTPã€‚Ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“å’ŒåŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡ã€‚</p>
<p>IngressController  ä¸ºäº†è®© Ingress èµ„æºå·¥ä½œï¼Œé›†ç¾¤å¿…é¡»æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Ingress æ§åˆ¶å™¨ã€‚</p>
</blockquote>
<p><img src="https://luckytking.github.io/images/ingress_layout.png" alt=""></p>
<p>ä¸Šå›¾æ¸…æ™°æ ‡è¯†å‡ºäº†Ingressçš„æµé‡èµ°å‘ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>IngressåŸºäºDNSåç§°ï¼ˆhostï¼‰æˆ–URLè·¯å¾„æŠŠè¯·æ±‚è½¬å‘â¾„æŒ‡å®šçš„Serviceèµ„æºçš„è§„åˆ™ã€‚å®ƒä»…æ˜¯â¼€ç»„è·¯ç”±è§„åˆ™çš„é›†åˆã€‚</li>
<li>Ingressæ§åˆ¶å™¨æ˜¯çœŸæ­£å®ç°â€œæµé‡ç©¿é€â€ï¼Œå¯ä»¥ç”±å…·æœ‰åå‘ä»£ç†ï¼ˆHTTP/HTTPSï¼‰åŠŸèƒ½çš„æœåŠ¡ç¨‹åºå®ç° , ç„¶åæ ¹æ®è¿™äº›è§„åˆ™çš„åŒ¹é…æœºåˆ¶è·¯ç”±è¯·æ±‚æµé‡</li>
</ul>
<h3 id="ingress-èµ„æºå£°æ˜">Ingress èµ„æºå£°æ˜</h3>
<p>Ingressæ˜¯Kubernetes APIçš„æ ‡å‡†èµ„æºç±»å‹ä¹‹â¼€ ,ä¸€ä¸ªæœ€å°Ingressä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minimal-ingress</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx-example</span>
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/testpath</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>å…¶ä¸­:</p>
<ul>
<li>Ingress éœ€è¦æŒ‡å®šÂ apiVersionã€kindã€Â metadataå’ŒÂ specÂ å­—æ®µã€‚</li>
<li>Ingress å¯¹è±¡çš„å‘½åå¿…é¡»æ˜¯åˆæ³•çš„Â DNS å­åŸŸååç§°ã€‚</li>
<li>Ingress annotations æ¥é…ç½®ä¸€äº›é€‰é¡¹,  â½¤äºè¯†åˆ«å…¶æ‰€å±çš„Ingressæ§åˆ¶å™¨çš„ç±»åˆ«ã€‚</li>
<li>IngressÂ rulesÂ æä¾›äº†é…ç½®è´Ÿè½½å‡è¡¡å™¨æˆ–è€…ä»£ç†æœåŠ¡å™¨æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚ æœ€é‡è¦çš„æ˜¯ï¼Œå…¶ä¸­åŒ…å«ä¸æ‰€æœ‰ä¼ å…¥è¯·æ±‚åŒ¹é…çš„è§„åˆ™åˆ—è¡¨ã€‚ Ingress èµ„æºä»…æ”¯æŒç”¨äºè½¬å‘ HTTP(S) æµé‡çš„è§„åˆ™ã€‚</li>
</ul>
<p>æ›´å¤šå‚è€ƒï¼š <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>Ingressæ§åˆ¶å™¨å¯ä»¥ç”±ä»»ä½•å…·æœ‰åå‘ä»£ç†ï¼ˆHTTP/HTTPSï¼‰åŠŸèƒ½çš„æœåŠ¡ç¨‹åºå®ç°ï¼Œç›®å‰æ”¯æŒå’Œç»´æŠ¤Â AWSã€Â GCEÂ å’ŒÂ NginxÂ Ingress æ§åˆ¶å™¨ã€‚</p>
<ul>
<li>NginxÂ Ingress ä½œä¸ºåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ã€‚</li>
<li>Apache APISIX Ingress æ§åˆ¶å™¨Â æ˜¯ä¸€ä¸ªåŸºäºÂ Apache APISIX ç½‘å…³Â çš„ Ingress æ§åˆ¶å™¨ã€‚</li>
</ul>
<p>æ›´å¤šå‚è€ƒï¼šhttps://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</p>
<h3 id="å®‰è£…-ingress-nginx">å®‰è£… Ingress Nginx</h3>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/cloud/deploy.yaml  -O ingress-nginx-deploy.yaml

kubectl apply -f  ingress-nginx-deploy.yaml
</code></pre><p>è§‚æµ‹æ˜¯å¦æˆåŠŸï¼š</p>
<pre tabindex="0"><code>kubectl get pods -n ingress-nginx --watch
</code></pre><p>å¦‚æœæˆåŠŸçš„è¯ï¼ŒæŸ¥çœ‹namespaceä¸‹æ‰€æœ‰çš„èµ„æºä¿¡æ¯</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get all -n ingress-nginx
NAME                                            READY   STATUS    RESTARTS   AGE
pod/ingress-nginx-controller-123456   1/1     Running   0          1h

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.104.182.98    192.168.1.100   80:31666/TCP,443:31888/TCP   1d
service/ingress-nginx-controller-admission   ClusterIP      10.111.228.99   &lt;none&gt;         443/TCP                      1d

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           1d

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-123456   1         1         1      1d

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           1s         1d
job.batch/ingress-nginx-admission-patch    1/1           2s         1d
</code></pre><h3 id="ä½¿ç”¨ingress-å‘å¸ƒ-tomcat">ä½¿ç”¨Ingress å‘å¸ƒ Tomcat</h3>
<p>éƒ¨ç½²Tomcat Service</p>
<ol>
<li>
<p>åˆ›å»ºdeployment</p>
<pre tabindex="0"><code>    kubectl create deployment web --image=tomcat:8.0.50-jre8-alpine
</code></pre></li>
<li>
<p>å°† Deployment æš´éœ²å‡ºæ¥</p>
<pre tabindex="0"><code>kubectl expose deployment web --type=NodePort --port=8080

</code></pre></li>
<li>
<p>å°† Deployment æš´éœ²å‡ºæ¥</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get service web
    NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
    web    NodePort   10.100.183.22   &lt;none&gt;        8080:32562/TCP   30s
</code></pre></li>
<li>
<p>éªŒè¯nodeport æ˜¯å¦æ­£å¸¸è®¿é—® tomcat ï¼Œæµè§ˆå™¨è®¿é—®  http://matster_ip:32562
<img src="https://luckytking.github.io/images/ingress_tomcat.png" alt=""></p>
</li>
<li>
<p>åˆ›å»º ingress</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingressfoo</span>
      <span style="color:#f92672">annotations</span>:
        <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">rules</span>:
      - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ingressfoo.io</span>
        <span style="color:#f92672">http</span>:
          <span style="color:#f92672">paths</span>:
          - <span style="color:#f92672">backend</span>:
              <span style="color:#f92672">service</span>:
                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
                <span style="color:#f92672">port</span>:
                  <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bar</span>
            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>æŸ¥çœ‹ingressæ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
<pre tabindex="0"><code>root@master:/home/master# kubectl get ingress
NAME         CLASS    HOSTS                     ADDRESS        PORTS   AGE
ingressfoo   &lt;none&gt;   ingressfoo.io   192.168.1.100   80      1h
</code></pre><p>è¯´æ˜Ingressåˆ›å»ºæˆåŠŸï¼Œä¿®æ”¹hosts ï¼š</p>
<blockquote>
<p>ingressfoo.io 192.168.1.100</p>
</blockquote>
<p>éªŒè¯è®¿é—® ingressfoo.io/bar</p>
<p><img src="https://luckytking.github.io/images/ingress_tomcat2.png" alt=""></p>
<p>success</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>Ingress  ä»‹ç» <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></li>
<li>IngressController ä»‹ç»  <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/</a></li>
<li><a href="https://github.com/apache/apisix-ingress-controller">https://github.com/apache/apisix-ingress-controller</a></li>
<li>NGINX Ingress æ§åˆ¶å™¨é…ç½® Ingress <a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/#%E5%90%AF%E7%94%A8-ingress-%E6%8E%A7%E5%88%B6%E5%99%A8</a></li>
<li>åœ¨K8Sä¸Šçš„WebæœåŠ¡è¯¥æ€ä¹ˆåšåŸŸåè§£æ <a href="https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA">https://mp.weixin.qq.com/s/ZU61NIMxh_UOo-chNvkPXA</a></li>
<li>ã€ŠKubernetesè¿›é˜¶å®æˆ˜-ç¬¬2ç‰ˆã€‹Â Â https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/ingress%E4%B8%8Eingresscontroller/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/" aria-label="">
      
          Goç½‘ç»œæŠ“åŒ…ã€å¼•æµå·¥å…·GoReplay
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-12T22:57:15&#43;08:00">
        
   12, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">åç«¯å¼€å‘</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>æœ¬æ–‡ç®€è¦ä»‹ç»Goç½‘ç»œæŠ“åŒ…ã€å¼•æµå·¥å…·GoReplayã€‚</p>
<h3 id="å‰è¨€">å‰è¨€</h3>
<p>åœ¨åç«¯çš„å®é™…å¼€å‘ä¸­ï¼Œä¼šé‡åˆ°ä»¥ä¸‹ä¸€äº›åœºæ™¯ï¼š</p>
<ul>
<li>ç”¨æˆ·é€šè¿‡ä½œå¼Šæ‰‹æ®µç»•è¿‡å‰ç«¯ï¼Œåˆ©ç”¨æŠ“åŒ…ï¼Œè¿›è¡Œç ´è§£ï¼Œæ¨¡æ‹Ÿï¼Œé­”æ”¹äº¤äº’æ•°æ®è¿›è¡Œä¼ªè£…ã€‚åç«¯ç¨‹åºéœ€è¦å¯¹å…¶æ“ä½œè®°å½•è¿›è¡Œé‡ç°å’Œè·Ÿè¸ªã€‚</li>
<li>æŸä¸ªbugåœ¨æµ‹è¯•ç¯å¢ƒæ— æ³•å¤ç°ã€‚</li>
<li>æœåŠ¡å‹æµ‹æ•°æ®å’Œçº¿ä¸Šæ•°æ®æœ‰åå·®ï¼Œå‹æµ‹æ•°æ®å¸Œæœ›èƒ½å’Œçº¿ä¸Šæ¥è¿‘ ã€‚</li>
</ul>
<p>GoReplayæ˜¯Goè¯­è¨€ç¼–å†™çš„æµé‡å›æ”¾å·¥å…·ï¼Œä¾¦å¬å™¨æœåŠ¡å™¨æ•è·httpæµé‡å¹¶å°†å…¶å‘é€åˆ°é‡æ”¾æœåŠ¡å™¨æˆ–ä¿å­˜åˆ°æ–‡ä»¶ã€‚é‡æ’­æœåŠ¡å™¨å°†æµé‡è½¬å‘ç»™ç»™å®šçš„åœ°å€ã€‚</p>
<h3 id="å®‰è£…">å®‰è£…</h3>
<p>æµ‹è¯•ç¯å¢ƒï¼š Windowsã€‚
ç‰ˆæœ¬ï¼š Version:1.3.0
å®‰è£…åˆ†2æ­¥éª¤ï¼š</p>
<ol>
<li>å‰ç½®æ¡ä»¶ï¼š å®‰è£…npcap 
<a href="https://npcap.com">https://npcap.com</a></li>
</ol>
<blockquote>
<p>GoReplayå¯ä»¥åœ¨Windowsæœºå™¨ä¸Šå·¥ä½œï¼Œä½†ç”±äºWindowså †æ ˆçš„ä¸åŒç½‘ç»œå±‚çš„æ€§è´¨ï¼Œå®ƒæœ‰ä¸€äº›ç»†èŠ‚ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼ŒWindowsä¸åƒUnixç³»ç»Ÿé‚£æ ·æœ‰æ”¯æŒåŒ…æ•è·çš„ç½‘ç»œé©±åŠ¨ç¨‹åºï¼Œå¦‚æœæ‚¨æƒ³æ•è·é€šä¿¡é‡ï¼Œåˆ™å¿…é¡»å•ç‹¬å®‰è£…å®ƒã€‚å…¶ä¸­ä¸€ä¸ªé€‰é¡¹æ˜¯å®‰è£…https://nmap.org/npcap/ã€‚</p>
</blockquote>
<ol start="2">
<li>å®‰è£…ï¼šè¿™é‡Œæµ‹è¯•ä½¿ç”¨çš„æ˜¯ gor-1.3.3_windows.zip
<a href="https://github.com/buger/goreplay/releases">https://github.com/buger/goreplay/releases</a> 
ä¸‹è½½è§£å‹å³å¯ã€‚</li>
</ol>
<h3 id="æ•è·æµé‡">æ•è·æµé‡</h3>
<blockquote>
<p>å¯åŠ¨ä¸¤ä¸ªhttpæœåŠ¡ï¼š</p>
</blockquote>
<ol>
<li>httpServerA: http://localhost:8000 ç›‘å¬ç«¯å£8000</li>
<li>httpServerB: http://localhost:8001 ç›‘å¬ç«¯å£8001</li>
</ol>
<p>è·¯ç”±ä¸º â€œget: &ldquo;/helloworld/{name}&rdquo;</p>
<blockquote>
<p>ç›‘å¬ç«¯å£8000ï¼Œå¹¶è¾“å‡ºåˆ°stdout</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> ./gor --input-raw <span style="color:#960050;background-color:#1e0010">:</span>8000 --output-stdout
</code></pre></div><blockquote>
<p>æ‰“å¼€æµè§ˆå™¨è¯·æ±‚æ¥å£ http://localhost:8000/helloworld/lilei</p>
</blockquote>
<blockquote>
<p>åœ¨gorçš„å‘½ä»¤è¡Œçª—å£ï¼š</p>
</blockquote>
<pre tabindex="0"><code>1 db0a1f4000000001c344a1d3 1668261985986369000 0
GET /helloworld/lilei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot; æ­¤å¤„çœç•¥ä¸€äº›ç³»æ•°
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°
</code></pre><p>å¯è§ï¼Œgorå·²ç»æŠŠæ•´ä¸ªhttpè¯·æ±‚çš„å®Œæ•´ä¿¡æ¯è®°å½•ä¸‹æ¥ã€‚
åŒæ—¶gorè¿˜æ”¯æŒè¾“å‡ºåˆ°æ–‡ä»¶å’ŒElasticSearchï¼Œè¿›è¡Œå›æ”¾å’Œåˆ†æã€‚è®°å½•åˆ°æ–‡ä»¶request.gor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> ./gor --input-raw <span style="color:#960050;background-color:#1e0010">:</span>8000 --output<span style="color:#f92672">-file</span> request.gor --input-raw-track-response --input-raw-override-snaplen
</code></pre></div><blockquote>
<p>æ‰“å¼€æµè§ˆå™¨è¯·æ±‚æ¥å£ http://localhost:8000/helloworld/hanmeimei</p>
</blockquote>
<p>å†™å…¥åˆ°æ–‡ä»¶ request_0.gor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Mode                 LastWriteTime         Length Name
----                 -------------         ------ ---- 
-a----        2022/11/12     21<span style="color:#960050;background-color:#1e0010">:</span>36           1876 request_0.gor
</code></pre></div><p>request_0 å†…å®¹å¦‚ä¸‹:</p>
<pre tabindex="0"><code class="language-gor" data-lang="gor">1 d4571f4000000001b7adc1a6 1668260139796335000 0
GET /helloworld/lilei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64), æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°


ğŸµğŸ™ˆğŸ™‰
2 d4571f4000000001b7adc1a6 1668260139796652000 0
HTTP/1.1 200 OK
Content-Type: application/json
Date: Sat, 12 Nov 2022 13:35:39 GMT
Content-Length: 25

{&quot;message&quot;:&quot;Hello lilei&quot;}
ğŸµğŸ™ˆğŸ™‰
1 d4571f4000000001b7adc22b 1668260148757949000 0
GET /helloworld/hanmeimei HTTP/1.1
Host: localhost:8000
Connection: keep-alive
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) , æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°


ğŸµğŸ™ˆğŸ™‰
2 d4571f4000000001b7adc22b 1668260148758268000 0
æ­¤å¤„çœç•¥ä¸€äº›å‚æ•°

{&quot;message&quot;:&quot;Hello hanmeimei&quot;}
ğŸµğŸ™ˆğŸ™‰

</code></pre><h3 id="æµé‡å›æ”¾">æµé‡å›æ”¾</h3>
<p>æ¥ç€å°†è¯¥æ–‡ä»¶request_0.gor è¿›è¡Œæµé‡å›æ”¾ï¼Œå¹¶è½¬å‘åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨ï¼ˆHttpServerBï¼‰ä¸Šï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">./gor --input<span style="color:#f92672">-file</span> request_0.gor --output-http http<span style="color:#960050;background-color:#1e0010">:</span>//localhost<span style="color:#960050;background-color:#1e0010">:</span>8001
</code></pre></div><p>è§‚å¯ŸHttpServerBæœåŠ¡å™¨æ§åˆ¶å°è¾“å‡ºï¼š</p>
<pre tabindex="0"><code>INFO ts=2022-11-12T21:37:26+08:00 caller=greeter.go:44 service.id=LAPTOP-H3HBMV8A service.name= service.version= trace.id= span.id= msg=CreateGreeter: lilei
INFO ts=2022-11-12T21:37:34+08:00 caller=greeter.go:44 service.id=LAPTOP-H3HBMV8A service.name= service.version= trace.id= span.id= msg=CreateGreeter: hanmeimei

</code></pre><p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªè¯·æ±‚ï¼ˆhttp://localhost:8000/helloworld/ileiã€http://localhost:8000/helloworld/hanmeimeiï¼‰åˆ†åˆ«é‡æ”¾è¯·æ±‚åˆ°äº†HttpServerBã€‚</p>
<p>goræ”¯æŒè¿›è¡Œæµé‡ç¼©å°ã€æ”¾å¤§ã€å€é€Ÿé‡æ”¾ï¼Œå®ç°çœŸå®æµé‡çš„å‹æµ‹æ•ˆæœã€‚
æ›´å¤šå‘½ä»¤ ./gor -help æŸ¥çœ‹</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>å®˜æ–¹GitHub  <a href="https://github.com/buger/goreplay">https://github.com/buger/goreplay</a></li>
<li>å®‰è£…åŒ… <a href="https://github.com/buger/goreplay/releases">https://github.com/buger/goreplay/releases</a></li>
<li>Windows å®‰è£… <a href="https://github.com/buger/goreplay/wiki/Running-on-Windows">https://github.com/buger/goreplay/wiki/Running-on-Windows</a></li>
<li>å®˜æ–¹npcap <a href="https://npcap.com/">https://npcap.com/</a></li>
<li>Goreplayè¯¦è§£ <a href="https://www.cnblogs.com/sunsky303/p/9072871.html">https://www.cnblogs.com/sunsky303/p/9072871.html</a></li>
<li>å…¥é—¨å’Œå¯¼å…¥Es  <a href="https://mp.weixin.qq.com/s/mNjLiEBnHIZhOTrDwNkmvA">https://mp.weixin.qq.com/s/mNjLiEBnHIZhOTrDwNkmvA</a></li>
<li>ç®€ä»‹  <a href="https://www.jianshu.com/p/0f3bcfbf7874">https://www.jianshu.com/p/0f3bcfbf7874</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" aria-label="">
      
          Kubernetesé›†ç¾¤èµ„æºç›‘æ§ä¸€æœºåˆ¶å’Œèµ„æºæŒ‡æ ‡
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-11-05T22:50:36&#43;08:00">
        
   5, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        æœ¬æ–‡ä¸»è¦ä»‹ç»Kubernetesé›†ç¾¤èµ„æºç›‘æ§æœºåˆ¶å’Œèµ„æºæŒ‡æ ‡
å‰è¨€ ä¸´è¿‘åŒ11ï¼Œå¯¹äºç å†œï¼Œå°¤å…¶æ˜¯åç«¯ï¼Œå°¤å…¶æ˜¯æŸå®æŸä¸œçš„åç«¯ï¼Œé‚£æ˜¯å¤šä¹ˆæ¿€åŠ¨äººå¿ƒï¼ˆå¿ƒæƒŠèƒ†æˆ˜ï¼‰çš„ä¸€å¤œï¼Œä¸ºä»€ä¹ˆï¼Ÿæ€•å®•æœºå‘€~ã€‚é‚£ä¹ˆå°±è®©æˆ‘ä»¬æ¥æ„å»ºæŠ¤åŸæ²³&ndash;ç›‘æ§ä¸è‡ªåŠ¨æ‰©å®¹ï¼Œæ¥æŠµæŒ¡åƒå†›ä¸‡é©¬&ndash;é«˜å¹¶å‘åœºæ™¯ã€‚é¦–å…ˆè®©æˆ‘ä»¬å­¦ä¹ ä¸€äº›åŸºç¡€ï¼šk8sé›†ç¾¤èµ„æºç›‘æ§æœºåˆ¶å’Œèµ„æºæŒ‡æ ‡ã€‚
åˆ†æ ä»éœ€æ±‚å‡ºå‘ï¼Œæˆ‘ä»¬è‡ªç„¶éœ€è¦æ”¶é›†ä¸€äº›æ•°æ®(èµ„æºæŒ‡æ ‡)ï¼Œå†æ ¹æ®æŒ‡æ ‡åšä¸€ç³»åˆ—çš„æ“ä½œ(control)ï¼Œæ¯”å¦‚è¯´é¢„è­¦è­¦å‘Šã€ç»Ÿè®¡ã€è‡ªåŠ¨æ‰©å®¹ç­‰ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ç›‘æ§æ•´ä¸ªKubernetesé›†ç¾¤çš„å¥åº·çŠ¶å†µï¼ŒåŒ…æ‹¬ï¼š
 æ•´ä¸ªé›†ç¾¤çš„èµ„æºåˆ©â½¤ç‡ é›†ç¾¤ä¸­çš„æ‰€æœ‰â¼¯ä½œèŠ‚ç‚¹æ˜¯å¦è¿â¾æ­£å¸¸ã€ç³»ç»Ÿèµ„æºå®¹é‡â¼¤â¼© æ¯ä¸ªâ¼¯ä½œèŠ‚ç‚¹ä¸Šè¿â¾çš„å®¹å™¨åŒ–åº”â½¤çš„æ•°é‡  k8sèµ„æºæ§åˆ¶ æˆ‘ä»¬çœ‹çœ‹k8så¦‚ä½•èµ„æºæ§åˆ¶
é™åˆ¶èŠ‚ç‚¹ ä»¥è´­ç‰©å¹³å°ä¸ºä¾‹ï¼Œå¾®æœåŠ¡å¹¿å—æ¨å´‡ï¼Œæ¯”å¦‚åŒ11å½“å¤©ï¼Œç”¨æˆ·è¿›é¦–é¡µæ˜¯æµç•…çš„ï¼Œä½†æ˜¯è¿›æ´»åŠ¨ä¸»é¡µå°±å¡é¡¿ï¼Œåˆ°äº†é›¶ç‚¹æ—¶ï¼ŒåŠ å…¥è´­ç‰©è½¦çš„æŒ‰é’®éƒ½è½¬åœˆäº†ã€‚è®¾æƒ³ä½ çš„è®¾è®¡å¯èƒ½æ˜¯ä¸‰ä¸ªå¾®æœåŠ¡ï¼ˆä¸»é¡µæœåŠ¡ ã€åŒåä¸€æ´»åŠ¨æœåŠ¡ã€è®¢å•æœåŠ¡ï¼‰ï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œæ´»åŠ¨æœåŠ¡æ˜¯å‹åŠ›æœ€å¤§çš„ï¼Œæˆ‘ä»¬å¸Œæœ›ï¼Œå°±ç®—å®•æœºï¼Œä¸è¦å½±å“å…¶ä»–çš„æœåŠ¡ã€‚æ‰€ä»¥å¯ä»¥æŠŠæ´»åŠ¨æœåŠ¡é™åˆ¶è¿è¡Œåœ¨æŸèŠ‚ç‚¹ã€‚
 åˆ›å»ºä¸€ä¸ªä¼šè¢«è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ Podï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® nodeName å°†æŸä¸ª Pod è°ƒåº¦åˆ°ç‰¹å®šçš„èŠ‚ç‚¹
 nodeName: foo-node # è°ƒåº¦ Pod åˆ°ç‰¹å®šçš„èŠ‚ç‚¹ é™åˆ¶å†…å­˜ è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬æŠŠæ´»åŠ¨æœåŠ¡è°ƒåº¦åˆ°äº† foo-nodeã€‚é‚£ä¹ˆå‰©ä¸‹çš„æœåŠ¡æ²¡æœ‰å»é™åˆ¶ï¼Œä½†æƒ³æƒ³è®¢å•æœåŠ¡çš„å‹åŠ›ä¹Ÿä¸å°ï¼Œè¿™é‡Œæˆ‘ä»¬å¸Œæœ›é™åˆ¶å®ƒçš„èµ„æºä¸Šé™ã€‚
 è¦ä¸ºå®¹å™¨æŒ‡å®šå†…å­˜è¯·æ±‚ï¼Œè¯·åœ¨å®¹å™¨èµ„æºæ¸…å•ä¸­åŒ…å«Â resourcesï¼šrequestsÂ å­—æ®µã€‚ åŒç†ï¼Œè¦æŒ‡å®šå†…å­˜é™åˆ¶ï¼Œè¯·åŒ…å«Â resourcesï¼šlimitsã€‚
 resources: requests: memory: &#34;1000Gi&#34; limits: memory: &#34;1000Gi&#34; é™åˆ¶CPU  è¦ä¸ºå®¹å™¨æŒ‡å®š CPU è¯·æ±‚ï¼Œè¯·åœ¨å®¹å™¨èµ„æºæ¸…å•ä¸­åŒ…å«Â resources: requestsÂ å­—æ®µã€‚ è¦æŒ‡å®š CPU é™åˆ¶ï¼Œè¯·åŒ…å«Â resources:limits
 resources: limits: cpu: &#34;100&#34; requests: cpu: &#34;100&#34; Example ç¯å¢ƒå‡†å¤‡:
 k8sé›†ç¾¤ï¼ˆmaster * 1ï¼Œnode * 2 ) kubectl å‘½ä»¤è¡Œå·¥å…·( ç¬”è€…ä½¿ç”¨rancher)   åˆ›å»ºä¸€ä¸ªnamespaceï¼ˆstressï¼‰ã€‚ å¢åŠ ä¸€ä¸ªdeployment, ä¿®æ”¹å†…å­˜ä¸Šé™ä¸º10M 1.
      
      <p>
        
          <a href="https://luckytking.github.io/2022/11/kubernetes%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E4%B8%80%E6%9C%BA%E5%88%B6%E5%92%8C%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" aria-label="">
      
          Golangä½¿ç”¨RedisSortSetså®ç°æ’è¡Œæ¦œ
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-30T15:43:28&#43;08:00">
        
   30, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="å‰è¨€">å‰è¨€</h3>
<p>æ¸¸æˆæ’è¡Œæ¦œæ˜¯ä¸€ä¸ªå¸¸è§éœ€æ±‚ï¼Œä»Šå¤©ä¸»è¦ä»‹ç»goè¯­è¨€ä½¿ç”¨redis-sort-setsæ¥å®ç°æ’è¡Œæ¦œå¸¸è§åŠŸèƒ½ã€‚</p>
<h3 id="redis-sort-sets">Redis Sort Sets</h3>
<p>å®˜æ–¹ä»‹ç»ï¼š</p>
<blockquote>
<p>Redisæ’åºé›†æ˜¯æŒ‰ç›¸å…³åˆ†æ•°æ’åºçš„æƒŸä¸€å­—ç¬¦ä¸²(æˆå‘˜)çš„é›†åˆã€‚å½“å¤šä¸ªå­—ç¬¦ä¸²å…·æœ‰ç›¸åŒçš„åˆ†æ•°æ—¶ï¼Œå­—ç¬¦ä¸²å°†æŒ‰å­—å…¸é¡ºåºæ’åˆ—ã€‚æ’åºé›†çš„ä¸€äº›ç”¨ä¾‹åŒ…æ‹¬:</p>
<p>æ¸¸æˆæ’è¡Œæ¦œã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ’åºé›†è½»æ¾åœ°ç»´æŠ¤å¤§å‹åœ¨çº¿æ¸¸æˆä¸­æœ€é«˜åˆ†æ•°çš„æœ‰åºåˆ—è¡¨ã€‚
é€Ÿç‡é™åˆ¶å™¨ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ’åºé›†æ¥æ„å»ºæ»‘åŠ¨çª—å£é€Ÿç‡é™åˆ¶å™¨ï¼Œä»¥é˜²æ­¢è¿‡å¤šçš„APIè¯·æ±‚ã€‚</p>
</blockquote>
<p>å¸¸ç”¨äºæ’è¡Œæ¦œçš„å‘½ä»¤:</p>
<ul>
<li>ZRANGE è¿”å›æ’åºé›†çš„æˆå‘˜ï¼ˆå‡åºï¼‰</li>
<li>ZREVANGE è¿”å›æ’åºé›†çš„æˆå‘˜ï¼ˆé™åºåºï¼‰</li>
<li>ZADD å‘æ’åºé›†æ·»åŠ ä¸€ä¸ªæ–°æˆå‘˜å’Œç›¸å…³åˆ†æ•°ã€‚å¦‚æœæˆå‘˜å·²ç»å­˜åœ¨ï¼Œåˆ™æ›´æ–°è¯„åˆ†ã€‚</li>
<li>ZREM åˆ é™¤æ’åºé›†ä¸€ä¸ªæˆå‘˜</li>
<li>ZRANK è¿”å›æä¾›çš„æˆå‘˜çš„æ’å(å‡åº)</li>
<li>ZREVRANK è¿”å›æä¾›çš„æˆå‘˜çš„æ’å(é™åº)</li>
</ul>
<h3 id="go-redis">Go Redis</h3>
<p>Go Redisä¸ºå„ç§é£æ ¼çš„Redisæä¾›Goå®¢æˆ·ç«¯ï¼ŒåŸºç¡€çš„ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	})
	<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
}
</code></pre></div><h3 id="examples">Examples</h3>
<p>è¿™é‡Œæˆ‘ä»¬ç”¨go-rediså®ç°æ’è¡Œæ¦œå¸¸è§çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬:</p>
<ul>
<li>è·å–æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•° ï¼ˆå‡åºã€é™åºï¼‰</li>
<li>åŠ å…¥æ’è¡Œæ¦œæˆå‘˜</li>
<li>åˆ é™¤æ’è¡Œæ¦œæˆå‘˜</li>
<li>æ›´æ–°æ’è¡Œæ¦œæˆå‘˜åˆ†æ•°</li>
<li>è·å–æ’è¡Œæ¦œæˆå‘˜åˆ†æ•°</li>
<li>è·å–æ’è¡Œæ¦œåæ¬¡æˆå‘˜</li>
<li>æ¸…ç©ºæ’è¡Œæ¦œ</li>
</ul>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v9&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>, <span style="color:#75715e">// use default Addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,               <span style="color:#75715e">// no password set
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,                <span style="color:#75715e">// use default DB
</span><span style="color:#75715e"></span>	}) 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//å¢åŠ ç©å®¶åˆ†æ•°çš„å˜åŒ–
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
			<span style="color:#a6e22e">Score</span>:  float64(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>)),
			<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">i</span>),
		}).<span style="color:#a6e22e">Err</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº&#34;</span>, <span style="color:#a6e22e">members</span>)
	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº&#34;</span>, <span style="color:#a6e22e">membersWithScore</span>)

	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-é™åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRev</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-é™åº&#34;</span>, <span style="color:#a6e22e">membersRev</span>)
	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//è·å–æŸç©å®¶çš„åˆ†æ•°
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">user2Score</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZScore</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;è·å–æŸç©å®¶ user:2 çš„åˆ†æ•°&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//æ›´æ–°æŸç©å®¶çš„åˆ†æ•°
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Z</span>{
		<span style="color:#a6e22e">Score</span>:  <span style="color:#a6e22e">user2Score</span>,
		<span style="color:#a6e22e">Member</span>: <span style="color:#e6db74">&#34;user:1&#34;</span>,
	}).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æ›´æ–°æŸç©å®¶ user:1 çš„åˆ†æ•°&#34;</span>, <span style="color:#a6e22e">user2Score</span>)
	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">membersRevWithScore</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRangeWithScores</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œå˜åŒ–åçš„æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº&#34;</span>, <span style="color:#a6e22e">membersRevWithScore</span>)

	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶çš„åˆ†æ•°-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶  user:2 çš„æ’å&#34;</span>, <span style="color:#a6e22e">memberRank</span>)

	<span style="color:#75715e">//æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶çš„åˆ†æ•°-é™åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memberRevRank</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRevRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:2&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶ user:2 çš„æ’å-é™åº&#34;</span>, <span style="color:#a6e22e">memberRevRank</span>)

	<span style="color:#75715e">//åˆ é™¤æ’åºé›†ä¸€ä¸ªæˆå‘˜
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">zrem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRem</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#e6db74">&#34;user:1&#34;</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;åˆ é™¤æ’åºé›†ä¸€ä¸ªæˆå‘˜&#34;</span>, <span style="color:#a6e22e">zrem</span>)

	<span style="color:#75715e">//åˆ é™¤åæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;åˆ é™¤åæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº&#34;</span>, <span style="color:#a6e22e">members</span>)

	<span style="color:#75715e">//æ¸…ç©ºæ’è¡Œæ¦œ
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clear</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRemRangeByRank</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;err zrem&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æ¸…ç©ºæ’è¡Œæ¦œ&#34;</span>, <span style="color:#a6e22e">clear</span>)
	<span style="color:#75715e">//æ¸…ç©ºåæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">members</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">ZRange</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;leaderboard&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;æ¸…ç©ºåæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº&#34;</span>, <span style="color:#a6e22e">members</span>) 

</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº [user:3 user:4 user:1 user:5 user:2]
æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº [{87 user:2} {81 user:5} {81 user:1} {59 user:4} {47 user:3}]
æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-é™åº [user:2 user:5 user:1 user:4 user:3]
æŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº [{47 user:3} {59 user:4} {81 user:1} {81 user:5} {87 user:2}]
è·å–æŸç©å®¶ user:2 çš„åˆ†æ•° 87
æ›´æ–°æŸç©å®¶ user:1 çš„åˆ†æ•° 87
æŸ¥è¯¢æ’è¡Œæ¦œå˜åŒ–åçš„æ’è¡Œæ¦œæˆå‘˜å’Œåˆ†æ•°-å‡åº [{47 user:3} {59 user:4} {81 user:5} {87 user:1} {87 user:2}]
æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶  user:2 çš„æ’å 4
æŸ¥è¯¢æ’è¡Œæ¦œæŸç©å®¶ user:2 çš„æ’å-é™åº 0
åˆ é™¤æ’åºé›†ä¸€ä¸ªæˆå‘˜ 1
åˆ é™¤åæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº [user:3 user:4 user:5 user:2]
æ¸…ç©ºæ’è¡Œæ¦œ 4
æ¸…ç©ºåæŸ¥è¯¢æ’è¡Œæ¦œæˆå‘˜-å‡åº []

</code></pre><h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>å®‰è£…Redis <a href="https://redis.io/docs/getting-started/installation/">https://redis.io/docs/getting-started/installation/</a></li>
<li>Redis Sort Sets Docs <a href="https://redis.io/docs/data-types/sorted-sets/">https://redis.io/docs/data-types/sorted-sets/</a></li>
<li>Go Redis <a href="https://github.com/go-redis/redis/v9">https://github.com/go-redis/redis/v9</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/golang%E4%BD%BF%E7%94%A8redissortsets%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" aria-label="">
      
          Goå¼€å‘å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“ä¹‹ants
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-21T23:17:35&#43;08:00">
        
   21, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>goè¯­è¨€æä¾›éå¸¸æ–¹ä¾¿çš„åˆ›å»ºè½»é‡çº§çš„åç¨‹goroutineæ¥å¹¶å‘å¤„ç†ä»»åŠ¡ï¼Œä½†æ˜¯ åç¨‹è¿‡å¤šå½±å“ç¨‹åºæ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œè¿™æ—¶goroutineæ± å°±ç™»åœºäº†ã€‚æœ¬æ–‡ç®€è¦ä»‹ç»ants goroutine æ± çš„åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>antsæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ goroutine æ± ï¼Œå®ç°äº†å¯¹å¤§è§„æ¨¡ goroutine çš„è°ƒåº¦ç®¡ç†ã€goroutine å¤ç”¨ï¼Œå…è®¸ä½¿ç”¨è€…åœ¨å¼€å‘å¹¶å‘ç¨‹åºçš„æ—¶å€™é™åˆ¶ goroutine æ•°é‡ï¼Œå¤ç”¨èµ„æºï¼Œè¾¾åˆ°æ›´é«˜æ•ˆæ‰§è¡Œä»»åŠ¡çš„æ•ˆæœã€‚ antså°±æ˜¯ä¸€ä¸ªå¾ˆå¤šå¤§å‚å¹¿æ³›ä½¿ç”¨çš„gorouteæ± ã€‚</p>
<p>å®˜ç½‘åœ°å€</p>
<blockquote>
<p><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></p>
</blockquote>
<h3 id="åŠŸèƒ½">åŠŸèƒ½</h3>
<ul>
<li>è‡ªåŠ¨è°ƒåº¦æµ·é‡çš„ goroutinesï¼Œå¤ç”¨ goroutines</li>
<li>å®šæœŸæ¸…ç†è¿‡æœŸçš„ goroutinesï¼Œè¿›ä¸€æ­¥èŠ‚çœèµ„æº</li>
<li>æä¾›äº†å¤§é‡æœ‰ç”¨çš„æ¥å£ï¼šä»»åŠ¡æäº¤ã€è·å–è¿è¡Œä¸­çš„ goroutine æ•°é‡ã€åŠ¨æ€è°ƒæ•´ Pool å¤§å°ã€é‡Šæ”¾ Poolã€é‡å¯ Pool</li>
<li>ä¼˜é›…å¤„ç† panicï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ</li>
<li>èµ„æºå¤ç”¨ï¼Œæå¤§èŠ‚çœå†…å­˜ä½¿ç”¨é‡ï¼›åœ¨å¤§è§„æ¨¡æ‰¹é‡å¹¶å‘ä»»åŠ¡åœºæ™¯ä¸‹æ¯”åŸç”Ÿ goroutine å¹¶å‘å…·æœ‰æ›´é«˜çš„æ€§èƒ½</li>
<li>éé˜»å¡æœºåˆ¶</li>
</ul>
<h3 id="quick-start">quick start</h3>
<p>ä½¿ç”¨Â antsÂ v1 ç‰ˆæœ¬:</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants</p>
</blockquote>
<p>ä½¿ç”¨Â antsÂ v2 ç‰ˆæœ¬ (å¼€å¯ GO111MODULE=on):</p>
<blockquote>
<p>go get -u github.com/panjf2000/ants/v2</p>
</blockquote>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å®˜æ–¹demoï¼šå®ç°ä¸€ä¸ªè®¡ç®—å¤§é‡æ•´æ•°å’Œçš„ç¨‹åº</p>
<h3 id="newpool">NewPool</h3>
<p>NewPoolç”Ÿæˆantsæ± å®ä¾‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoFunc</span>() {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()

	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>

	<span style="color:#75715e">//ä½¿ç”¨å…¬å…±æ± ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#a6e22e">syncCalculateSum</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">demoFunc</span>()
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">syncCalculateSum</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Running</span>())
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks.\n&#34;</span>)
 }
</code></pre></div><p>å…¶ä¸­ï¼š</p>
<p>ç”Ÿæˆä¸€ä¸ªå…·æœ‰ç‰¹å®šå‡½æ•°çš„antsæ± å®ä¾‹</p>
<ul>
<li>NewPool(size int,  options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.size  å³æ± å®¹é‡ï¼Œå³æ± ä¸­æœ€å¤šæœ‰ 10 ä¸ª goroutineã€‚
arg.Option  å®šåˆ¶åŒ– goroutine pool.</p>
</blockquote>
<ul>
<li>p.Submitå‘æ­¤æ± æäº¤ä»»åŠ¡ã€‚</li>
<li>ants.Releaseå…³é—­æ­¤æ± å¹¶é‡Šæ”¾å·¥ä½œé˜Ÿåˆ—ã€‚</li>
<li>defaultAntsPool å¯¼å…¥antsæ—¶åˆå§‹åŒ–å®ä¾‹æ± ã€‚</li>
</ul>
<h3 id="newpoolwithfunc">NewPoolWithFunc</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#75715e">//ä½¿ç”¨å¸¦æœ‰å‡½æ•°çš„æ± 
</span><span style="color:#75715e">//è®¾ç½®goroutineæ± çš„å®¹é‡ä¸º10ï¼Œè¿‡æœŸæ—¶é—´ä¸º1ç§’ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	})
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#75715e">//é€ä¸ªæäº¤ä»»åŠ¡ã€‚
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Invoke</span>(int32(<span style="color:#a6e22e">i</span>))
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks, result is %d\n&#34;</span>, <span style="color:#a6e22e">sum</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code class="language-shelll" data-lang="shelll">run with 1
run with 5
run with 11
run with 12
run with 13
run with 14
run with 7
...
run with 789
run with 809
running goroutines: 10
finish all tasks, result is 499500
</code></pre><p>å…¶ä¸­ï¼š</p>
<p>ç”Ÿæˆä¸€ä¸ªå…·æœ‰ç‰¹å®šå‡½æ•°çš„antsæ± å®ä¾‹</p>
<ul>
<li>NewPoolWithFunc(size int, pf func(interface{}), options 
&hellip;Option) (*PoolWithFunc, error)</li>
</ul>
<blockquote>
<p>args.pf  å³ä¸ºæ‰§è¡Œä»»åŠ¡çš„å‡½æ•°</p>
</blockquote>
<h3 id="ä¼˜é›…å¤„ç†-panic">ä¼˜é›…å¤„ç† panic</h3>
<p>æµ‹è¯•ä¸€äº›å½“ä»»åŠ¡è§¦å‘panicçš„æƒ…å†µ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;panic from task:%d&#34;</span>, <span style="color:#a6e22e">n</span>)))
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
}
</code></pre></div><p>outputï¼š</p>
<pre tabindex="0"><code>run with 3
run with 13
...
run with 999
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:6
2022/10/21 21:41:05 worker with func exits from a panic: panic from task:0
2022/10/21 21:41:07 worker with func exits from panic: goroutine 14 [running]:
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œmain routine æ²¡æœ‰å› æ­¤å—å½±å“ã€‚</p>
<h3 id="options">Options</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// OptionsåŒ…å«å®ä¾‹åŒ–antsæ± æ—¶å°†åº”ç”¨çš„æ‰€æœ‰é€‰é¡¹ã€‚
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Options</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ExpiryDuration is a period for the scavenger goroutine to clean up those expired workers,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the scavenger scans all workers every `ExpiryDuration` and clean up those workers that haven&#39;t been
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// used for more than `ExpiryDuration`.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExpiryDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#75715e">// PreAlloc indicates whether to make memory pre-allocation when initializing Pool.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreAlloc</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Max number of goroutine blocking on pool.Submit.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 0 (default value) means no such limit.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxBlockingTasks</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// When Nonblocking is true, Pool.Submit will never be blocked.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ErrPoolOverload will be returned when Pool.Submit cannot be done at once.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// When Nonblocking is true, MaxBlockingTasks is inoperative.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Nonblocking</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// PanicHandler is used to handle panics from each worker goroutine.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if nil, panics will be thrown out again from worker goroutines.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicHandler</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// Logger is the customized logger for logging info, if it is not set,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// default standard logger from log package is used.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">Logger</span>
}
</code></pre></div><p>æ¯”å¦‚ PanicHandler é‡åˆ° panicä¼šè°ƒç”¨è¿™é‡Œè®¾ç½®çš„å¤„ç†å‡½æ•°,ä»¥ä¸Šä¾‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°å¶æ•°ä¼šè§¦å‘panicï¼Œä¿®æ”¹NewPoolå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	}, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">WithPanicHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;panic recover %v&#34;</span>, <span style="color:#a6e22e">i</span>)
	}))
</code></pre></div><p>outï¼š</p>
<pre tabindex="0"><code>panic recover panic from i:992run with 880
panic recover panic from i:880run with 972
panic recover panic from i:972run with 994
run with 991
</code></pre><p>è¿˜æœ‰æ›´å¤šå…³äº Benchmarks æ€§èƒ½æŠ¥å‘Šï¼Œå¯å‚è€ƒhttps://github.com/panjf2000/ants</p>
<h3 id="å‚è€ƒ">å‚è€ƒï¼š</h3>
<ul>
<li><a href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></li>
<li><a href="https://darjun.github.io/2021/06/03/godailylib/ants/">https://darjun.github.io/2021/06/03/godailylib/ants/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/go%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B9%8Bants/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%9E%84%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" aria-label="">
      
          è®¾è®¡æ¨¡å¼ æ„é€ è€…æ¨¡å¼
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-16T12:10:03&#43;08:00">
        
   16, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="å®šä¹‰">å®šä¹‰</h3>
<blockquote>
<p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»º è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</p>
</blockquote>
<h3 id="å¤æ‚çš„æ„é€ å‡½æ•°">å¤æ‚çš„æ„é€ å‡½æ•°</h3>
<p>åˆ›å»ºä¸€ä¸ªå¯¹è±¡æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯ï¼Œä½¿ç”¨ new å…³é”®å­—è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°æ¥å®Œæˆã€‚ä¸¾ä¸ªå¸¸ç”¨èµ„æºè¿æ¥æ± çš„ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResourcePool</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">maxIdle</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">minIdle</span>  <span style="color:#66d9ef">int</span>
}
<span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>, 
<span style="color:#ae81ff">10</span>)
</code></pre></div><p>åœ¨å¯é…ç½®é¡¹ä¸å¤šçš„æ—¶å€™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¦‚æœå¯é…ç½®é¡¹é€æ¸å¢å¤šï¼Œä»¥gormçš„é…ç½®æ–‡ä»¶ä¸ºä¾‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Config GORM config
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// GORM perform single create, update, delete operations in transactions by default to ensure database data integrity
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// You can disable it by setting `SkipDefaultTransaction` to true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SkipDefaultTransaction</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// NamingStrategy tables, columns naming strategy
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NamingStrategy</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">Namer</span>
	<span style="color:#75715e">// FullSaveAssociations full save associations
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FullSaveAssociations</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// Logger
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Interface</span>
	<span style="color:#75715e">// NowFunc the function to be used when creating a new timestamp
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NowFunc</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
	<span style="color:#75715e">// DryRun generate sql without execute
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DryRun</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// PrepareStmt executes the given query in cached statement
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PrepareStmt</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableAutomaticPing
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableAutomaticPing</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableForeignKeyConstraintWhenMigrating
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableForeignKeyConstraintWhenMigrating</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// DisableNestedTransaction disable nested transaction
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DisableNestedTransaction</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// AllowGlobalUpdate allow global update
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AllowGlobalUpdate</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// QueryFields executes the SQL query with all fields of the table
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">QueryFields</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// CreateBatchSize default create batch size
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CreateBatchSize</span> <span style="color:#66d9ef">int</span>

	<span style="color:#75715e">// ClauseBuilders clause builder
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ClauseBuilders</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">clause</span>.<span style="color:#a6e22e">ClauseBuilder</span>
	<span style="color:#75715e">// ConnPool db conn pool
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnPool</span> <span style="color:#a6e22e">ConnPool</span>
	<span style="color:#75715e">// Dialector database dialector
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Dialector</span>
	<span style="color:#75715e">// Plugins registered plugins
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Plugins</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Plugin</span>
    <span style="color:#75715e">// ... çœç•¥ä¸€äº›å‚æ•°
</span><span style="color:#75715e"></span>}

</code></pre></div><p>è¿™æ—¶ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°å°±å˜å¾—å¤æ‚äº†ã€‚æ„é€ å‡½æ•°å‚æ•°åˆ—è¡¨ä¼šå˜å¾—å¾ˆé•¿ï¼Œå®¹æ˜“æé”™å„å‚æ•°çš„é¡ºåºï¼Œé€ æˆéšè”½çš„bugã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>,   <span style="color:#ae81ff">16</span>, <span style="color:#a6e22e">null</span>, <span style="color:#ae81ff">8</span>, <span style="color:#a6e22e">null</span>, <span style="color:#66d9ef">false</span> , <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">ï¼Œ</span><span style="color:#66d9ef">false</span><span style="color:#960050;background-color:#1e0010">ï¼Œ</span> <span style="color:#66d9ef">true</span> )
</code></pre></div><p>å¼€å§‹é‡æ„ï¼Œè¿™é‡Œä½¿ç”¨ set() å‡½æ•°æ¥ç»™æˆå‘˜å˜é‡èµ‹å€¼ï¼Œä»¥æ›¿ä»£å†—é•¿çš„æ„é€ å‡½æ•°ï¼Œå¹¶åœ¨set()å‡½æ•°é‡Œåšå‚æ•°æ ¡éªŒã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#a6e22e">this</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePool</span>{}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">name</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">maxTotal</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxTotal should be positive.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">maxTotal</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span>) <span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#a6e22e">minIdle</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">minIdle</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;minIdle should not be negative.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
</code></pre></div><p>é‡æ„åçš„æ„é€ å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#e6db74">&#34;dbconnectionpool&#34;</span>).<span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#ae81ff">8</span>)

</code></pre></div><p>ä½†æ˜¯ï¼Œè¿™é‡Œè¿˜æ˜¯æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœå¿…å¡«çš„é…ç½®é¡¹æœ‰å¾ˆå¤šï¼Œé‚£æ„é€ å‡½æ•°å°±åˆä¼šå‡ºç°å‚æ•°åˆ—è¡¨å¾ˆé•¿çš„é—®é¢˜ã€‚</li>
<li>å¦‚æœé…ç½®é¡¹ä¹‹é—´æœ‰ä¸€å®šçš„ä¾èµ–å…³ç³»ï¼Œå¹¶æ ¡éªŒå‚æ•°çš„åˆæ³•æ€§ã€‚</li>
<li>å¦‚æœå¸Œæœ›ResourcePoolçš„é…ç½®é¡¹ä¸å¯¹å¤–æä¾›ä¿®æ”¹æ–¹æ³•ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨æ„é€ è€…é‡æ„">ä½¿ç”¨æ„é€ è€…é‡æ„</h3>
<ol>
<li>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ„é€ è€…ç±»Builderï¼Œå¹¶æŠŠå‚æ•°æ”¹ä¸ºç§æœ‰ï¼Œæä¾›set()å‡½æ•°ä¿®æ”¹ã€‚</li>
<li>å…¶æ¬¡build() æ–¹æ³•çœŸæ­£åˆ›å»ºå¯¹è±¡ä¹‹å‰ï¼Œåšé›†ä¸­çš„æ ¡éªŒï¼Œæ ¡éªŒé€šè¿‡ä¹‹åæ‰ä¼šåˆ›å»ºå¯¹è±¡ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">builder</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#a6e22e">this</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePool</span>{}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">name</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxTotal</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxIdle</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxIdle</span>
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResourcePoolBuilder</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">name</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">maxIdle</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">minIdle</span>  <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Builder</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#a6e22e">builder</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ResourcePoolBuilder</span>{}
	<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#ae81ff">16</span>
	<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#ae81ff">5</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">builder</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">Build</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePool</span> {
	<span style="color:#75715e">// æ ¡éªŒé€»è¾‘æ”¾åˆ°è¿™é‡Œæ¥åšï¼ŒåŒ…æ‹¬å¿…å¡«é¡¹æ ¡éªŒã€ä¾èµ–å…³ç³»æ ¡éªŒã€çº¦æŸæ¡ä»¶æ ¡éªŒç­‰
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">maxIdle</span> &gt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">maxTotal</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxIdle should bigger than maxTotal.&#34;</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewResourcePool</span>(<span style="color:#a6e22e">b</span>)
}


<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetName</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;name should not be empty.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">name</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#a6e22e">maxTotal</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">maxTotal</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;maxTotal should be positive.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">maxTotal</span> = <span style="color:#a6e22e">maxTotal</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">this</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span>) <span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#a6e22e">minIdle</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ResourcePoolBuilder</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">minIdle</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;minIdle should not be negative.&#34;</span>))
	}
	<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">minIdle</span> = <span style="color:#a6e22e">minIdle</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">this</span>
}
</code></pre></div><p>é‡æ„åçš„æ„é€ å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resourcePool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Builder</span>().<span style="color:#a6e22e">SetName</span>(<span style="color:#e6db74">&#34;test&#34;</span>).<span style="color:#a6e22e">SetMaxTotal</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">SetMinIdle</span>(<span style="color:#ae81ff">5</span>).<span style="color:#a6e22e">Build</span>()
</code></pre></div><p>å¦‚æ­¤ï¼Œ</p>
<ul>
<li>è¿™æ ·æˆ‘ä»¬å°±åªèƒ½é€šè¿‡å»ºé€ è€…Builder æ¥åˆ›å»º ResourcePool ç±»å¯¹è±¡ã€‚</li>
<li>è¦ä¿®æ”¹resourcePoolåªèƒ½é€šè¿‡ Builderæä¾›çš„ set()å‡½æ•°ï¼Œé…ç½®é¡¹ä¸å¯¹å¤–æä¾›ä¿®æ”¹æ–¹æ³•ã€‚</li>
<li>å‚æ•°æ ¡éªŒæˆ–è€…æä¾›é»˜è®¤å‚æ•°å¯ä»¥æ”¾åœ¨build()å‡½æ•°å†…ã€‚</li>
</ul>
<h3 id="å°ç»“">å°ç»“</h3>
<p>æ„é€ è€…æ¨¡å¼åŸç†å¹¶ä¸å¤æ‚ï¼Œä¸»è¦é€‚å½“çš„åœºæ™¯ä¸­çµæ´»ä½¿ç”¨ã€‚é€šè¿‡æ„é€ è€…ç±»Builderã€æä¾›çš„set()å‡½æ•°è®¾ç½®å¿…é€‰é¡¹ï¼Œæœ€ç»ˆè°ƒç”¨build()å¤„ç†æ„é€ ç±»ä¹‹å‰çš„ä¸€äº›é€»è¾‘ã€‚å¦‚æ­¤ï¼Œå¯ä»¥ä»¥é€šè¿‡è®¾ç½®ä¸åŒçš„å¯é€‰å‚æ•°ï¼Œâ€œå®šåˆ¶åŒ–â€åœ°åˆ›å»ºä¸åŒçš„å¤æ‚å¯¹è±¡.</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>è®¾è®¡æ¨¡å¼ä¹‹ç¾ <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%9E%84%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" aria-label="">
      
          æµ…è°ˆkratosçš„è¡¨ç°å±‚æºç å®ç°ä¸è§£ç å™¨
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-10-02T17:25:55&#43;08:00">
        
   2, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>å‰åç«¯æ•°æ®å¸¸ç”¨ä¼ è¾“æ ¼å¼æœ‰ï¼šjsonã€xml å’Œ protoç­‰ï¼Œä¸ç®¡æ˜¯mvcè¿˜æ˜¯dddï¼Œéƒ½ä¼šåœ¨è¡¨ç°å±‚çš„å¯¹ä¸åŒçš„æ ¼å¼è¿›è¡Œè½¬åŒ–ä¸‹å±‚ä¾èµ–æ‰€éœ€çš„ç±»ã€Objectã€ aggregateç­‰ã€‚</p>
<h2 id="kratos-è¡¨ç°å±‚">Kratos è¡¨ç°å±‚</h2>
<p>åœ¨å®é™…å¼€å‘åœºæ™¯ä¸­ï¼Œå‰åç«¯ä¼ è¾“é‡‡ç”¨jsonã€‚ ä½†kratosä½¿ç”¨protoå®šä¹‰Apiï¼Œ é‚£ä¹ˆæˆ‘ä»¬ä»¥ä¸€ä¸ªHttpè¯·æ±‚ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹kratosçš„è¡¨ç°å±‚æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªKratos-Exampleï¼Œç”±ç¼–å†™å¥½çš„protoæ–‡ä»¶ï¼Œproto-go ç­‰è‡ªåŠ¨ç”Ÿæˆè¡¨ç°å±‚çš„ä»£ç ã€‚ å¤§æ¦‚æ­¥éª¤ï¼š</p>
<ol>
<li>ç¼–å†™protoï¼ŒåŒ…æ‹¬Serviceï¼ŒReqï¼ŒReply</li>
<li>ç”Ÿæˆè¡¨ç°å±‚ä»£ç </li>
<li>å®ç°ä¸‹å±‚é€»è¾‘ç­‰</li>
</ol>
<p>Exampleå®Œæ•´ä»£ç å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>è¿™é‡Œå¯¹å…·ä½“çš„æ ¼å¼æ— æ„Ÿï¼Œè¾“å…¥Inè¿˜æ˜¯è¾“å‡ºOutéƒ½æ˜¯ä¸€ä¸ªprotoç”Ÿæˆçš„ç±»ã€‚</li>
<li>å…·ä½“çš„å®ç°äº¤ç»™äº†ctx ä¸Šä¸‹æ–‡å»å®ç°
æŸ¥çœ‹ ctx.Resultçš„æºç :</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Result</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">code</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">enc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">v</span>)
}
</code></pre></div><p>è¿™é‡Œçš„encï¼Œæ²¡æœ‰ç‰¹æ®Šè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤çš„DefaultResponseEncoderï¼Œéƒ¨åˆ†æºç å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultResponseEncoder</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CodecForRequest</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;Accept&#34;</span>)
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ContentType</span>(<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">Name</span>()))
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>é€šè¿‡codcæ¥å£éš”ç¦»å…·ä½“å®ç°ï¼Œè°ƒç”¨æ¥å£çš„ codec.Marshalåºåˆ—åŒ–ã€‚</p>
<h2 id="codecåŒ…">codecåŒ…</h2>
<p>Codecå®šä¹‰Transportç”¨äºç¼–ç å’Œè§£ç æ¶ˆæ¯çš„æ¥å£ã€‚å®ƒçš„å®ç°åŒ…æ‹¬ jsonï¼Œxmlï¼Œprotoï¼Œyamlç­‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Codec</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Marshal returns the wire format of v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">// Unmarshal parses the wire format into v.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">// Name returns the name of the Codec implementation. The returned string
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will be used as part of content type in transmission.  The result must be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// static; the result cannot change between calls.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬èšç„¦æ­£åœ¨ä½¿ç”¨çš„Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">codec</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">codec</span>) <span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#66d9ef">type</span>) {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshaler</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MarshalJSON</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">m</span>)
	}
}
</code></pre></div><p>è¿™é‡ŒMarshal()ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“â€œ&ldquo;google.golang.org/protobuf/encoding/protojson&rdquo;</p>
<p>å®ç°protoè½¬jsonã€‚</p>
<h2 id="protojsonç¬¬ä¸‰æ–¹åŒ…">protojsonç¬¬ä¸‰æ–¹åŒ…</h2>
<p>protojsonæ˜¯Googleæä¾›çš„protoå’Œjsonçš„è½¬åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">api_test</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;google.golang.org/protobuf/encoding/protojson&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;helloworld/api/helloworld/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestToJson</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">HelloReply</span>{
		<span style="color:#a6e22e">Message</span>: <span style="color:#e6db74">&#34;Jobs&#34;</span>,
	}
	<span style="color:#a6e22e">replyJson</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MarshalOptions</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">ProtoReflect</span>().<span style="color:#a6e22e">Interface</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Marshal Error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;replyJson:  %v&#34;</span>, string(<span style="color:#a6e22e">replyJson</span>))
}
</code></pre></div><p>æ›´å¤šçš„æ¥å£è¯·å‚è€ƒâ€œhttps://google.golang.org/protobuf/encoding/protojsonâ€</p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>æœ¬æ–‡ä¸»è¦ä»¥kratosçš„è¡¨ç°å±‚çš„ç»„ç»‡æ–¹å¼ï¼Œæ¥ä»‹ç»å¸¸ç”¨çš„æ¡†æ¶è¡¨ç°å±‚å¤„ç†æ–¹å¼ã€‚
å…¶ä¸­ï¼š</p>
<ul>
<li>kratosé€šè¿‡protoæ¥ç”Ÿæˆè¡¨ç°å±‚ä»£ç çš„ç±»ï¼ŒåŒ…æ‹¬httpå’Œgrapcï¼Œå†…éƒ¨å¯¹å…·ä½“å®ç°æ— æ„Ÿã€‚</li>
<li>kratosé€šè¿‡è§£ç å™¨codecå®ç°ä¸åŒä¼ è¾“æ ¼å¼çš„è§£è€¦ã€‚</li>
<li>ç¬¬ä¸‰æ–¹åŒ…protojsonå®ç°protoå’Œjsonè½¬æ¢ã€‚</li>
</ul>
<p>æ¡†æ¶çš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯æ ‡å‡†åŒ–å¤„ç†ä¸€ä¸‹å…¬å…±çš„é—®é¢˜åœºæ™¯,ä»æºç ä¸­å¯ä»¥å­¦ä¹ ï¼šé€šè¿‡æ¥å£éš”ç¦»å…·ä½“çš„å®ç°ï¼Œè€Œä½¿æ¡†æ¶ä¸å…·ä½“å®ç°è§£è€¦,ä¸”å…·å¤‡æ›´å¥½çš„æ‹“å±•æ€§ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://go-kratos.dev/docs/getting-started/usage">https://go-kratos.dev/docs/getting-started/usage</a></li>
<li><a href="https://google.golang.org/protobuf/encoding/protojson">https://google.golang.org/protobuf/encoding/protojson</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/10/%E6%B5%85%E8%B0%88kratos%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%B1%82%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" aria-label="">
      
          è®¾è®¡æ¨¡å¼  è§‚å¯Ÿè€…æ¨¡å¼
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-25T16:43:20&#43;08:00">
        
   25, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</h3>
<p>æ¥è‡ªHead Firstè®¾è®¡æ¨¡å¼ä¸€ä¹¦çš„å®šä¹‰</p>
<blockquote>
<p>è§‚å¯Ÿè€…æ¨¡å¼ Observer 
è§‚å¯Ÿè€…æ¨¡å¼ å®šä¹‰äº†ä¸€ç³»åˆ—å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šçš„å…³ç³»,å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€æ”¹å˜, å…¶ä»–ä¾èµ–è€…éƒ½ä¼šæ”¶åˆ°åˆ°é€šçŸ¥ã€‚</p>
</blockquote>
<p>ç»å¸¸è§‚å¯Ÿè€…æ¨¡å¼ä¹Ÿç§°å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä¸€èˆ¬è§‚å¯Ÿè€…æ¨¡å¼æœ‰ä»¥ä¸‹ç»„æˆï¼š</p>
<ul>
<li>Subject-è¢«è§‚å¯Ÿè€…ï¼Œäº¦æˆ–æ˜¯å‘å¸ƒè€…-Publisher</li>
<li>Observer-è§‚å¯Ÿè€…ï¼Œäº¦æˆ–æ˜¯è®¢é˜…è€…-Subscribe</li>
</ul>
<h3 id="ç»å…¸çš„å®ç°æ–¹å¼">ç»å…¸çš„å®ç°æ–¹å¼</h3>
<p>ä»¥ä¸‹æ˜¯golangçš„å…·ä½“å®ç°ï¼šobserver.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Subject</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#a6e22e">Observer</span>)
	<span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{})
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Observer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{})
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteSubject</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">observerList</span> []<span style="color:#a6e22e">Observer</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConcreteSubject</span>() <span style="color:#a6e22e">Subject</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteSubject</span>{}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteSubject</span>) <span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#a6e22e">observer</span> <span style="color:#a6e22e">Observer</span>) {
	<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span> = append(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span>, <span style="color:#a6e22e">observer</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteSubject</span>) <span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">observer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">observerList</span> {
		<span style="color:#a6e22e">observer</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span>)
	}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteObserverOne</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteObserverOne</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ConcreteObserverOne is notified.%v \n&#34;</span>, <span style="color:#a6e22e">message</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConcreteObserverTwo</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConcreteObserverTwo</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ConcreteObserverOne is notified.%v \n&#34;</span>, <span style="color:#a6e22e">message</span>)
}

</code></pre></div><p>observer_test.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;testing&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestObserver</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">concreteSubject</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConcreteSubject</span>()
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteObserverOne</span>{})
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">RegisterObserver</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConcreteObserverTwo</span>{})
	<span style="color:#a6e22e">concreteSubject</span>.<span style="color:#a6e22e">NotifyObservers</span>(<span style="color:#e6db74">&#34;hello every one&#34;</span>)
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>ConcreteObserverOne is notified.hello every one 
ConcreteObserverOne is notified.hello every one 
</code></pre><p>å¯ä»¥çœ‹åˆ°ä¾‹å­é‡ŒåŒ…å«äº†ä»¥ä¸‹æ¥å£å’Œå®ç°ï¼š</p>
<ul>
<li>Subject ä¸»é¢˜æ¥å£ï¼š æ³¨å†Œå®ç°ã€é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…</li>
<li>Observer è§‚å¯Ÿè€…æ¥å£ï¼š æ¥æ”¶ä¸»ä½“é€šçŸ¥çš„æ¥å£ã€‚</li>
<li>ConcreteSubject ä¸»é¢˜çš„å…·ä½“å®ç°</li>
<li>ConcreteObserverOne/ConcreteObserverTwo ä¸åŒçš„è§‚å¯Ÿè€…å®ç°</li>
</ul>
<p>å½“ä½ éœ€è¦å¢åŠ ä¸€ä¸ªè§‚å¯Ÿè€…æ—¶ï¼Œåªéœ€è¦å®ç° Update(ï¼‰æ¥å£å’Œæ³¨å†ŒRegisteråˆ°subjectå³å¯ã€‚</p>
<h3 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h3>
<p>é‚£ä¹ˆè§‚å¯Ÿè€…æ¨¡å¼åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹é€‚ç”¨å‘¢ï¼Ÿæ¥ç€æˆ‘ä»¬ä»¥ä¸€ä¸ªæ¸¸æˆç”¨æˆ·æ³¨å†Œçš„ä¾‹å­æ¥å¥—ç”¨ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>åœºæ™¯: ç©å®¶åœ¨æ³¨å†ŒæˆåŠŸåï¼Œå°†åœ¨â€œåœ°å›¾æœåŠ¡â€åˆ›å»ºä¸€ä¸ªå‡ºç”Ÿç‚¹ä½ï¼ŒåŒæ—¶â€œé‚®ä»¶æœåŠ¡â€ä¼šå‘é€ä¸€ä»½æ–°æ‰‹ç¤¼åŒ…ã€‚</p>
</blockquote>
<p>åœ¨æ²¡æœ‰ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ—¶ï¼Œå¯èƒ½æ˜¯è¿™ä¹ˆå†™çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldMapService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWorldMapService</span>() <span style="color:#a6e22e">WorldMapService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">WorldMapService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">WorldMapService</span>) <span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;æ¬¢è¿%væ¥åˆ°æ–°æ‰‹æ‘&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MailService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMailService</span>() <span style="color:#a6e22e">MailService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MailService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">MailService</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;æ­å–œå‹‡å£«%v,è·å¾—é‡‘å¸999&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>() <span style="color:#a6e22e">UserService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserService</span>{}
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">User</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;æ¬¢è¿æ¥åˆ°å…ƒå®‡å®™&#34;</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserController</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">User</span>     <span style="color:#a6e22e">UserService</span>
	<span style="color:#a6e22e">WorldMap</span> <span style="color:#a6e22e">WorldMapService</span>
	<span style="color:#a6e22e">Mail</span>     <span style="color:#a6e22e">MailService</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserController</span>() <span style="color:#a6e22e">UserController</span> {
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>()
	<span style="color:#a6e22e">worldMap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewWorldMapService</span>()
	<span style="color:#a6e22e">mail</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewMailService</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserController</span>{
		<span style="color:#a6e22e">User</span>:     <span style="color:#a6e22e">user</span>,
		<span style="color:#a6e22e">WorldMap</span>: <span style="color:#a6e22e">worldMap</span>,
		<span style="color:#a6e22e">Mail</span>:     <span style="color:#a6e22e">mail</span>,
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">UserController</span>) <span style="color:#a6e22e">Do</span>() {
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;å¥½å¥‡çš„å°æ˜&#34;</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">WorldMap</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Mail</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Start</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserController</span>()
	<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Do</span>()
}

<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">ï¼š</span>
<span style="color:#a6e22e">MapService</span>: <span style="color:#a6e22e">æ¬¢è¿å¥½å¥‡çš„å°æ˜æ¥åˆ°æ–°æ‰‹æ‘</span>
<span style="color:#a6e22e">MailService</span>: <span style="color:#a6e22e">æ­å–œå‹‡å£«å¥½å¥‡çš„å°æ˜</span>,<span style="color:#a6e22e">è·å¾—é‡‘å¸999</span>
<span style="color:#a6e22e">UserService</span>: <span style="color:#a6e22e">è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„æ—…ç¨‹å§</span>
</code></pre></div><p>UserController.Do æ³¨å†Œã€å¢åŠ å‡ºç”Ÿç‚¹ä½ã€å‘é€é‚®ä»¶ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™ã€‚å¦‚æœæ¨¡å—è¶Šæ¥è¶Šå¤šï¼Œæ¯”å¦‚å¢åŠ ä¸€ä¸ªä»»åŠ¡ç³»ç»Ÿï¼ˆç™»å…¥è¿‡æ¸¸æˆèµ é€é‡‘å¸ï¼‰ï¼Œåéª‘æ¨¡å—ï¼ˆç™»å…¥èµ é€åˆå§‹åéª‘ï¼‰ä¹‹ç±»ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ä»£ç å°±ä¼šå˜å¾—è¶Šæ¥è¶Šé•¿ï¼Œä¸å¥½æ‹“å±•ç­‰ã€‚è¿™æ—¶å€™ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè¿›è¡Œè§£è€¦ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldMapService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWorldMapService</span>() <span style="color:#a6e22e">WorldMapService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">WorldMapService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">WorldMapService</span>) <span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;MapService: æ¬¢è¿%væ¥åˆ°æ–°æ‰‹æ‘&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MailService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMailService</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">MailService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MailService</span>{}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">MailService</span>) <span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">User</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;MailService: æ­å–œå‹‡å£«%v,è·å¾—é‡‘å¸999&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Name</span>))
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>() <span style="color:#a6e22e">UserService</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserService</span>{}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">User</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UserService: è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„æ—…ç¨‹å§&#34;</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserController</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">obsrvers</span> []<span style="color:#a6e22e">RegObserver</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserController</span>(<span style="color:#a6e22e">obsrvers</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">RegObserver</span>) <span style="color:#a6e22e">UserController</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">UserController</span>{<span style="color:#a6e22e">obsrvers</span>: <span style="color:#a6e22e">obsrvers</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">UserController</span>) <span style="color:#a6e22e">Do</span>() {
	<span style="color:#a6e22e">userSvc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>()
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userSvc</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;å¥½å¥‡çš„å°æ˜&#34;</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ob</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">obsrvers</span> {
		<span style="color:#a6e22e">ob</span>.<span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">user</span>)
	}
	<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Start</span>()
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RegObserver</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">HandleRegSuccess</span>(<span style="color:#a6e22e">User</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserController</span>(<span style="color:#a6e22e">NewWorldMapService</span>(), <span style="color:#a6e22e">NewMailService</span>())
	<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Do</span>()
}

</code></pre></div><p>è¿™é‡Œ</p>
<ol>
<li>
<p>å®šä¹‰äº†ä¸€ä¸ªRegObserveræ¥å£ï¼Œä¸åŒçš„æœåŠ¡éƒ½å®ç°äº†è¿™ä¸ªæ¥å£ã€‚å¹¶æ³¨å†Œåˆ°äº†userControllerï¼Œæ§åˆ¶å™¨ä¿å­˜äº†æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œåœ¨ç™»å…¥userControllerçš„æ‰§è¡Œå‡½æ•°Doé‡Œï¼Œä¼šå»éå†æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œæ‰§è¡ŒHandleRegSuccessã€‚</p>
</li>
<li>
<p>å½“æ‹“å±•éœ€æ±‚æ—¶ï¼Œåªéœ€è¦å†æ·»åŠ ä¸€ä¸ªå®ç°äº†RegObserveræ¥å£çš„ç±»å¹¶æ³¨å†Œåˆ°æ§åˆ¶å™¨å³å¯ã€‚</p>
</li>
</ol>
<p>å¦‚æ­¤ï¼Œå„æ¨¡å—é—´è€¦åˆæ€§å°±é™ä½äº†ã€‚</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»è§‚å¯Ÿè€…æ¨¡å¼å’Œä½¿ç”¨åœºæ™¯ï¼Œè§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ€è·¯æ˜¯å·®ä¸å¤šçš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£è€¦ã€‚åº”ç”¨åœºæ™¯è¿˜æ˜¯éå¸¸å¹¿æ³›çš„ï¼Œåœ¨åŒä¸€è¿›ç¨‹çš„ç¼–ç ä¸Šï¼Œ åœ¨è¿›ç¨‹é—´çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿˜æ˜¯åœ¨äº§å“çš„è®¢é˜…æ¨¡å¼éƒ½æœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>è®¾è®¡æ¨¡å¼ä¹‹ç¾ <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/docker-gitlab%E8%BF%81%E7%A7%BB%E4%B8%8E%E5%8D%87%E7%BA%A7/" aria-label="">
      
          Docker GitLabè¿ç§»ä¸å‡çº§
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-16T21:32:33&#43;08:00">
        
   16, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/devops">DevOps</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>æœ€è¿‘åœ¨æ—¥å¸¸è¿ç»´è¿‡ç¨‹ï¼Œå‘ç°æŒ–çŸ¿ç—…æ¯’åˆ©ç”¨GitLabçš„CVE-2021-22205æ¼æ´ï¼Œæ¶ˆè€—æœåŠ¡å™¨çš„èµ„æºã€‚ä¸ºäº†å½»åº•è§£å†³é—®é¢˜ï¼Œå†³å®šå¯¹GitLabè¿›è¡Œè¿ç§»å’Œç‰ˆæœ¬å‡çº§ã€‚</p>
<h3 id="å‰æ">å‰æ</h3>
<table>
<thead>
<tr>
<th>æœåŠ¡å™¨</th>
<th>OS</th>
<th>GitLabVersion</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸå§‹æœåŠ¡å™¨A</td>
<td>Ubuntu</td>
<td>13.7.4</td>
<td>ä¸‹æ–‡ç®€ç§°ServerA</td>
</tr>
<tr>
<td>è¿ç§»ç›®æ ‡æœåŠ¡å™¨B</td>
<td>Ubuntu</td>
<td>15.3.3</td>
<td>ä¸‹æ–‡ç®€ç§°åŸServerB</td>
</tr>
</tbody>
</table>
<p>å¤§è‡´æ­¥éª¤ï¼š</p>
<ol>
<li>ServerA:å¤‡ä»½GitLab</li>
<li>ServerB:æ¢å¤GitLab</li>
<li>ServerB:æ›´æ–°GitLabç‰ˆæœ¬</li>
</ol>
<h3 id="å¤‡ä»½">å¤‡ä»½</h3>
<h4 id="æ•°æ®">æ•°æ®</h4>
<p>è¿™é‡Œæˆ‘ä»¬æ˜¯ç”¨DockerComposeè¿è¡Œçš„GitLab-13.7.4ï¼Œä»ä¸»æœºè¿è¡Œå¤‡ä»½ï¼š
GitLab 12.2 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">$docker exec -t &lt;container name&gt; gitlab-backup create
</code></pre></div><p>GitLab 12.1 åŠæ›´æ—©ç‰ˆæœ¬ï¼š</p>
<pre tabindex="0"><code>$docker exec -t &lt;container name&gt; gitlab-rake gitlab:backup:create
</code></pre><p>å¼€å§‹å¤‡ä»½:</p>
<pre tabindex="0"><code>$ docker exec -t 985506cf361c gitlab-rake gitlab:backup:create
2022-09-16 02:56:34 +0000 -- Dumping database ...
Dumping PostgreSQL database gitlabhq_production ... [DONE]
...
Backup task is done.
</code></pre><p>æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶ï¼š
é»˜è®¤çš„å¤‡ä»½è·¯å¾„ä¸º /var/opt/gitlab/backupsï¼Œå¦‚æœä¸çŸ¥é“ä¿å­˜è·¯å¾„ï¼Œå¯ä»¥ä»å®¹å™¨çš„ /etc/gitlab/gitlab.rb æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ gitlab_rails[&lsquo;backup_path&rsquo;] = &ldquo;/var/opt/gitlab/backups&rdquo; æ­¤ä¸ºå¤‡ä»½ç›®å½•ã€‚</p>
<pre tabindex="0"><code>$ docker exec -it 985506cf361c bash
root@985506cf361c:/# cd /var/opt/gitlab/backups
root@985506cf361c:/var/opt/gitlab/backups# ls
123456_2022_09_16_13.7.4â€”_gitlab_backup.tar
</code></pre><p>å°†å®¹å™¨æ•°æ®å¤‡ä»½æ‹·è´åˆ°ä¸»æœºçš„å½“å‰ç›®å½•</p>
<pre tabindex="0"><code>docker cp gitlab:/var/opt/gitlab/backups/123456_2022_09_16_13.7.4_gitlab_backup.tar  ~/
</code></pre><h4 id="é…ç½®">é…ç½®</h4>
<p>GitLab æä¾›çš„å¤‡ä»½ Rake ä»»åŠ¡ä¸å­˜å‚¨æ‚¨çš„é…ç½®æ–‡ä»¶,æ•…è€Œè¿™é‡Œéœ€è¦æ”¶åˆ°å¤‡ä»½</p>
<pre tabindex="0"><code>/etc/gitlab/gitlab-secrets.json
/etc/gitlab/gitlab.rb
</code></pre><p>å†å°†é…ç½®å¤‡ä»½æ‹·è´åˆ°ä¸»æœºçš„å½“å‰ç›®å½•</p>
<pre tabindex="0"><code>docker cp gitlab:/etc/gitlab  ~/
</code></pre><h3 id="è¿ç§»">è¿ç§»</h3>
<h4 id="ç›¸åŒç‰ˆæœ¬å¯åŠ¨">ç›¸åŒç‰ˆæœ¬å¯åŠ¨</h4>
<p>docker-compose.yaml ç¤ºä¾‹å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">web</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce:13.7.4-ce.0</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com&#39;
</span><span style="color:#e6db74">        # Add any other gitlab.rb configuration here, each on its own line</span>        
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#39;80:80&#39;</span>
      - <span style="color:#e6db74">&#39;443:443&#39;</span>
      - <span style="color:#e6db74">&#39;22:22&#39;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#39;./volumes/gitlab/config:/etc/gitlab&#39;</span>
      - <span style="color:#e6db74">&#39;./volumes/gitlab/logs:/var/log/gitlab&#39;</span>
      - <span style="color:#e6db74">&#39;./volumes/gitlab/data:/var/opt/gitlab&#39;</span>
    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</code></pre></div><h4 id="é…ç½®-1">é…ç½®</h4>
<h4 id="æ•°æ®-1">æ•°æ®</h4>
<p>å°†ServerAçš„å¤‡ä»½æ‹·è´åˆ°ServerB</p>
<pre tabindex="0"><code>docker cp 1123456_2022_09_16_13.7.4_gitlab_backup.tar gitlab:/var/opt/gitlab/backups/
</code></pre><p><strong>è¿›å…¥å®¹å™¨</strong>ï¼Œ</p>
<p>åœæ­¢è¿æ¥åˆ°æ•°æ®åº“çš„è¿›ç¨‹ã€‚è®© GitLab çš„å…¶ä½™éƒ¨åˆ†ç»§ç»­è¿è¡Œ</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl stop unicorn
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl stop sidekiq
ok: down: sidekiq: 0s, normally up
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl status
</code></pre><p>å¤‡ä»½æ–‡ä»¶å¿…é¡»æ˜¯gitç”¨æˆ·æ‰€æœ‰è€…ï¼ˆrootä¸‹å¯¼å…¥æ‰éœ€è¦ï¼‰</p>
<pre tabindex="0"><code># chown -R git:git /var/opt/gitlab/backups/å¤‡ä»½.tar
</code></pre><p>å¼€å§‹è¿˜åŸå¤‡ä»½</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-rake gitlab:backup:restore BACKUP=123456_2022_09_16_13.7.4
Unpacking backup ... done

Do you want to continue (yes/no)? yes
...
Do you want to continue (yes/no)? yes

Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data
and are not included in this backup. You will need to restore these files manually.
Restore task is done.
</code></pre><p>å¯åŠ¨GitLab</p>
<pre tabindex="0"><code>root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-ctl start
</code></pre><p>ç™»å…¥http://ServerBï¼Œæ£€æŸ¥GitLabæ­£å¸¸è¿è¡Œã€‚</p>
<h3 id="æ›´æ–°gitlabç‰ˆæœ¬">æ›´æ–°GitLabç‰ˆæœ¬</h3>
<p>æ¥ç€å¼€å§‹æ›´æ–°ç‰ˆæœ¬ï¼Œè¿™é‡Œé‡‡ç”¨çš„åœæœºå‡çº§æ–¹æ¡ˆï¼Œè€—æ—¶è¾ƒä¹…ï¼ˆå¤§æ¦‚3ï½4å°æ—¶ï¼‰ï¼Œæ‰€ä»¥éœ€è¦é€‰æ‹©é€‚å½“æ—¶æœºæ›´æ–°ã€‚æ›´æ–°è·¯çº¿ï¼š
13.7.4-&gt; 13.8.8-&gt;13.12.15-&gt; 14.0.12-&gt; 14.3.6=&gt;14.6.2-&gt; 14.9.5-&gt; 14.10.5-&gt; 15.0.2-&gt;15.1.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">services</span>:
   <span style="color:#f92672">gitlab</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce:15.3.3-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:15.1.0-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:15.0.2-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.10.5-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.9.5-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.6.2-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.3.6-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:14.0.12-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.12.15-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.8.8-ce.0</span>
<span style="color:#75715e">#    image: gitlab/gitlab-ce:13.7.4-ce.0</span>
</code></pre></div><h3 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h3>
<ol>
<li>åœ¨ä½¿ç”¨å¤‡ä»½æ¢å¤GitLabæ—¶å¡ä½</li>
</ol>
<pre tabindex="0"><code>$ docker exec -it 7ddbcc0a6eb2 gitlab-rake gitlab:backup:restore BACKUP=1123456_2022_09_16_13.7.4
Unpacking backup ... done
Do you want to continue (yes/no)? yes
</code></pre><p>å¤„ç†æ–¹å¼ï¼š<strong>è¿›å…¥å®¹å™¨</strong>,æˆæƒ,æ‰§è¡Œæ¢å¤</p>
<pre tabindex="0"><code># chown -R git:git /var/opt/gitlab/backups/å¤‡ä»½.tar
root@23b5e49fc9ea:/var/opt/gitlab/backups# gitlab-rake gitlab:backup:restore 
</code></pre><p>å¤‡æ³¨ï¼šå¢åŠ  gitlab-rake gitlab:backup:restore &ndash;trace æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯.</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>å¤‡ä»½GitLab <a href="https://docs.gitlab.com/ee/raketasks/backup_gitlab.html#storing-configuration-files">https://docs.gitlab.com/ee/raketasks/backup_gitlab.html#storing-configuration-files</a></li>
<li>æ¢å¤GitLab <a href="https://docs.gitlab.com/ee/raketasks/restore_gitlab.html#restore-prerequisites">https://docs.gitlab.com/ee/raketasks/restore_gitlab.html#restore-prerequisites</a></li>
<li>GitLabå‡çº§è·¯å¾„ <a href="https://docs.gitlab.com/ee/update/#upgrade-paths">https://docs.gitlab.com/ee/update/#upgrade-paths</a></li>
<li>Docker Hub-Gitlab.Ce <a href="https://hub.docker.com/r/gitlab/gitlab-ce/tags">https://hub.docker.com/r/gitlab/gitlab-ce/tags</a></li>
<li>Docker gitlabå¤‡ä»½ä¸è¿˜åŸ <a href="https://www.xtcoder.com/archives/docker-gitlab-backup-restore">https://www.xtcoder.com/archives/docker-gitlab-backup-restore</a></li>
<li>Gitlab åº”æ€¥è§£å†³æ–¹æ¡ˆ <a href="https://overstarry.vip/posts/gitlab_cve-2021-22205/">https://overstarry.vip/posts/gitlab_cve-2021-22205/</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/docker-gitlab%E8%BF%81%E7%A7%BB%E4%B8%8E%E5%8D%87%E7%BA%A7/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" aria-label="">
      
          åˆ©ç”¨k8så‚¨å­˜å·æ¥éƒ¨ç½²redisä¹‹ä¸‰StatefulSet
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-09-11T18:20:54&#43;08:00">
        
   11, 2022

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>å‰ä¸¤ç¯‡(1.<a href="https://luckytking.github.io/2022/08/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis/">volume</a>2.<a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%BA%8Cpv%E4%B8%8Epvc/">pv&amp;pvc</a>)é€šè¿‡éƒ¨ç½²rediså­¦ä¹ å®æˆ˜äº†k8sçš„æ¥Volumeã€PVå’ŒPVCã€‚ä½†æ˜¯ï¼Œåº”â½¤ç¨‹åºå­˜åœ¨â€œæœ‰çŠ¶æ€â€å’Œâ€œâ½†çŠ¶æ€â€ä¸¤ç§ç±»åˆ«ï¼Œæ˜¾ç„¶rediså±äºè¯»å†™ç£ç›˜éœ€æ±‚çš„æœ‰çŠ¶æ€åº”â½¤ç¨‹åºï¼Œå¦‚â½€æŒäº‹åŠ¡åŠŸèƒ½çš„RDBMSå­˜å‚¨ç³»ç»Ÿï¼Œæ‰€ä»¥ï¼Œæœ¬æ–‡å­¦ä¹ å®æˆ˜k8sæœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²ã€‚</p>
<h3 id="statefulåŸºç¡€">StatefulåŸºç¡€</h3>
<p>StatefulSetæ˜¯Podèµ„æºæ§åˆ¶å™¨çš„â¼€ç§å®ç°ï¼Œâ½¤äºéƒ¨ç½²å’Œæ‰©å±•æœ‰çŠ¶æ€åº”â½¤çš„Podèµ„æºï¼Œç¡®ä¿å®ƒä»¬çš„è¿â¾é¡ºåºåŠæ¯ä¸ªPodèµ„æºçš„å”¯â¼€æ€§ã€‚é€‚ç”¨ä»¥ä¸‹éœ€æ±‚çš„åº”ç”¨ï¼š</p>
<ul>
<li>ç¨³å®šä¸”å”¯â¼€çš„â½¹ç»œæ ‡è¯†ç¬¦ã€‚</li>
<li>ç¨³å®šä¸”æŒä¹…çš„å­˜å‚¨ã€‚</li>
<li>æœ‰åºã€ä¼˜é›…åœ°éƒ¨ç½²å’Œæ‰©å±•ã€‚</li>
<li>æœ‰åºã€ä¼˜é›…åœ°åˆ é™¤å’Œç»ˆâ½Œã€‚</li>
<li>æœ‰åºâ½½â¾ƒåŠ¨åœ°æ»šåŠ¨æ›´æ–°ã€‚</li>
</ul>
<h3 id="éƒ¨ç½²">éƒ¨ç½²</h3>
<p>æ¥ç€ï¼Œè¿™é‡ŒæŠŠä¹‹å‰çš„rediså­˜å‚¨ä¿®æ”¹ä¸ºstatefulçš„æ–¹å¼ï¼Œä¿®æ”¹åçš„æ­¥éª¤ï¼š</p>
<ol>
<li>åˆ›å»º ConfigMap ï¼ˆå‚è€ƒç¬¬ä¸€ç¯‡ï¼‰</li>
<li>ä¿®æ”¹ Deployment ä¸ºStatefulSets</li>
</ol>
<h4 id="ä¿®æ”¹éƒ¨ç½²statefulsets">ä¿®æ”¹éƒ¨ç½²StatefulSets</h4>
<p>mkdir my-redis-statefulsets.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">resources</span>:
            <span style="color:#f92672">requests</span>:
              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
<span style="color:#75715e">#          command: [&#34;redis-server&#34;,&#34;/etc/redis/redis.conf&#34;]</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">redis-server</span>
            - <span style="color:#ae81ff">/etc/redis/redis.conf</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/redis/redis.conf</span>
              <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">redis.conf</span>
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-storage</span>
          <span style="color:#f92672">emptyDir</span>: {}
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-redis-config</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">redis.conf</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">redis.conf</span>
 
---
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30379</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis          </span>

</code></pre></div><p>å…¶ä¸­ï¼š</p>
<ol>
<li>Headless Serviceï¼šâ½¤äºä¸ºPodèµ„æºæ ‡è¯†ç¬¦â½£æˆå¯è§£æçš„DNSèµ„æºè®°å½•</li>
<li>StatefulSet â½¤äºç®¡æ§Podèµ„æº</li>
<li>volumeClaimTemplateåˆ™åŸºäºé™æ€æˆ–åŠ¨æ€çš„PVä¾›ç»™â½…å¼ä¸ºPodèµ„æºæä¾›
ä¸“æœ‰ä¸”å›ºå®šçš„å­˜å‚¨ï¼ˆè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†ç¬¬äºŒç¯‡åˆ›å»ºçš„pvï¼‰</li>
</ol>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p>redis-client è¿æ¥ NodeId:NodePort</p>
<pre tabindex="0"><code># redis-cli -h YourNodeIp-p 30379 -a 123456
YourNodeIp:30379&gt; info
# Serverredis_version:7.0.4
</code></pre><p>è¿æ¥æˆåŠŸ!</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>å®˜æ–¹statefulä»‹ç» <a href="https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage">https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/#writing-to-stable-storage</a></li>
<li>ã€ŠKubernetesè¿›é˜¶å®æˆ˜-ç¬¬2ç‰ˆã€‹Â Â https://item.jd.com/13140598.html</li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2022/09/%E5%88%A9%E7%94%A8k8s%E5%82%A8%E5%AD%98%E5%8D%B7%E6%9D%A5%E9%83%A8%E7%BD%B2redis%E4%B9%8B%E4%B8%89statefulset/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/post/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/post\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="Posts">
<meta name="twitter:title" content="Posts">
<meta property="og:url" content="https://luckytking.github.io/post/">
<meta property="twitter:url" content="https://luckytking.github.io/post/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>Posts</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/post/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/post/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" aria-label="">
      
          Apisix基于SNI代理TCP、UDP
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-30T13:45:59&#43;08:00">
        
   30, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <blockquote>
<p>背景:
公司项目中，需要暴露对内网的Websocket服务。</p>
</blockquote>
<p>Websocket 它是一种基于 TCP 的一种独立实现，APISIX 可以对 TCP/UDP 协议进行代理并实现动态负载均衡， 在 nginx 世界，称 TCP/UDP 代理为 stream 代理，在 APISIX 这里我们也遵循了这个声明，下文统称Stream。</p>
<p>SNI（Server Name Indication）是用来改善 SSL 和 TLS 的一项特性，它允许客户端在服务器端向其发送证书之前向服务器端发送请求的域名，服务器端根据客户端请求的域名选择合适的 SSL 证书发送给客户端。</p>
<p>本文主要介绍ApiSix如何基于SNI代理TCP/UDP。</p>
<h3 id="启用stream-代理">启用Stream 代理</h3>
<p>在 conf/config.yaml 配置文件设置 stream_proxy 选项， 指定一组需要进行动态代理的 IP 地址。默认情况不开启 stream 代理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9101&#34;</span>
    <span style="color:#f92672">udp</span>: <span style="color:#75715e"># UDP proxy address list</span>
      - <span style="color:#ae81ff">9200</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9211&#34;</span>
</code></pre></div><p>如果 apisix.enable_admin 为 true，上面的配置会同时启用 HTTP 和 stream 代理。如果你设置 enable_admin 为 false，且需要同时启用 HTTP 和 stream 代理，设置 only 为 false：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">enable_admin</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
</code></pre></div><h3 id="启用-tls">启用 TLS：</h3>
<p>首先，我们需要给对应的 TCP 地址启用 TLS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#f92672">addr</span>: <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="配置路由">配置路由</h3>
<p>当连接为 TLS over TCP 时，我们可以通过 SNI 来匹配路由，比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">PUT</span> <span style="color:#f92672">-d</span> <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  {
</span><span style="color:#e6db74">      &#34;sni&#34;: &#34;mysite.com&#34;,
</span><span style="color:#e6db74">      &#34;server_port&#34;: 9333,
</span><span style="color:#e6db74">      &#34;upstream&#34;: {
</span><span style="color:#e6db74">          &#34;scheme&#34;: &#34;tls&#34;,
</span><span style="color:#e6db74">          &#34;nodes&#34;: {
</span><span style="color:#e6db74">              &#34;192.168.1.33:8080&#34;: 1
</span><span style="color:#e6db74">          },
</span><span style="color:#e6db74">          &#34;type&#34;: &#34;roundrobin&#34;
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">  }&#39;</span>
</code></pre></div><p>查看是否创建成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span>
</code></pre></div><p>如创建错误，可以删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">DELETE</span> 
</code></pre></div><p>查看更多stream路由：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">//</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> 
</code></pre></div><p>更多Api参考：
<a href="https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route">https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route</a></p>
<h3 id="上传sni证书">上传SNI证书</h3>
<p>上传站点(mysite.com)的证书到ApiSix</p>
<h3 id="测试">测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">-v</span> <span style="color:#f92672">https</span><span style="color:#f92672">://</span><span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span><span style="color:#f92672">/</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">Trying</span> <span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">...</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TCP_NODELAY</span> <span style="color:#f92672">set</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connected</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span> <span style="color:#f92672">(</span><span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">)</span> <span style="color:#f92672">port</span> <span style="color:#f92672">9333</span> <span style="color:#f92672">(</span>#0<span style="color:#f92672">)</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">h2</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">http</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">successfully</span> <span style="color:#f92672">set</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">locations</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">CAfile</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">etc</span><span style="color:#f92672">/</span><span style="color:#f92672">ssl</span><span style="color:#f92672">/</span><span style="color:#f92672">cert</span>.<span style="color:#a6e22e">pem</span>
  <span style="color:#f92672">CApath</span><span style="color:#f92672">:</span> <span style="color:#f92672">none</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">2</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Certificate</span> <span style="color:#f92672">(</span><span style="color:#f92672">11</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">12</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">14</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">16</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">SSL</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">using</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">/</span> <span style="color:#f92672">ECDHE-RSA-CHACHA20-POLY1305</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">server</span> <span style="color:#f92672">did</span> <span style="color:#f92672">not</span> <span style="color:#f92672">agree</span> <span style="color:#f92672">to</span> <span style="color:#f92672">a</span> <span style="color:#f92672">protocol</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">certificate</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subject</span><span style="color:#f92672">:</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=*</span>.<span style="color:#a6e22e">mysite</span>.<span style="color:#a6e22e">com</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">start</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Mar</span> <span style="color:#f92672">29</span> <span style="color:#f92672">00</span>:<span style="color:#a6e22e">00</span>:<span style="color:#a6e22e">00</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">expire</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Jun</span> <span style="color:#f92672">27</span> <span style="color:#f92672">23</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">59</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subjectAltName</span><span style="color:#f92672">:</span> <span style="color:#f92672">host</span> <span style="color:#e6db74">&#34;mysite.com&#34;</span> <span style="color:#f92672">matched</span> <span style="color:#f92672">cert</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">s</span> <span style="color:#e6db74">&#34;*.mysite.com&#34;</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">issuer</span><span style="color:#f92672">:</span> <span style="color:#f92672">C</span><span style="color:#f92672">=</span><span style="color:#f92672">AT</span><span style="color:#f92672">;</span> <span style="color:#f92672">O</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span><span style="color:#f92672">;</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span> <span style="color:#f92672">RSA</span> <span style="color:#f92672">Domain</span> <span style="color:#f92672">Secure</span> <span style="color:#f92672">Site</span> <span style="color:#f92672">CA</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">SSL</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">ok</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">GET</span> <span style="color:#f92672">/</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Host</span><span style="color:#f92672">:</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">User-Agent</span><span style="color:#f92672">:</span> <span style="color:#f92672">curl</span><span style="color:#f92672">/</span><span style="color:#f92672">7</span>.<span style="color:#a6e22e">64</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Accept</span><span style="color:#f92672">:</span> <span style="color:#f92672">*/*</span>
<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span> <span style="color:#f92672">400</span> <span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Type</span><span style="color:#f92672">:</span> <span style="color:#f92672">text</span><span style="color:#f92672">/</span><span style="color:#f92672">plain</span><span style="color:#f92672">;</span> <span style="color:#f92672">charset</span><span style="color:#f92672">=</span><span style="color:#f92672">utf-8</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Sec-Websocket-Version</span><span style="color:#f92672">:</span> <span style="color:#f92672">13</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">X-Content-Type-Options</span><span style="color:#f92672">:</span> <span style="color:#f92672">nosniff</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Sun</span><span style="color:#f92672">,</span> <span style="color:#f92672">23</span> <span style="color:#f92672">Apr</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">05</span>:<span style="color:#a6e22e">50</span>:<span style="color:#a6e22e">07</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Length</span><span style="color:#f92672">:</span> <span style="color:#f92672">12</span>
<span style="color:#f92672">&lt;</span>
<span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connection</span> #0 <span style="color:#f92672">to</span> <span style="color:#f92672">host</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span> <span style="color:#f92672">left</span> <span style="color:#f92672">intact</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
</code></pre></div><p>Success。</p>
<h3 id="过程中遇见的问题">过程中遇见的问题</h3>
<ol>
<li>连接不上</li>
</ol>
<pre tabindex="0"><code> curl -v http://mysite.com
*   Trying x.x.y.y...
* TCP_NODELAY set
* Connected to mysite.com (x.x.y.y.) port 19333
&gt; GET / HTTP/1.1
&gt; Host: mysite.com:19333
&gt; User-Agent: curl/7.64.1
&gt; Accept: */*
&gt;
* Recv failure: Connection reset by peer
* Closing connection 0
curl: (56) Recv failure: Connection reset by peer
</code></pre><p>需要排查路由器端口是否正常开放，ApiSix的端口是否正常，经排查原因是：配置路由时&quot;server_port&quot;缺失</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
      <span style="color:#f92672">&#34;sni&#34;</span>: <span style="color:#e6db74">&#34;mysite.com&#34;</span>,
      <span style="color:#f92672">&#34;upstream&#34;</span>: {
          <span style="color:#f92672">&#34;scheme&#34;</span>: <span style="color:#e6db74">&#34;tls&#34;</span>,
          <span style="color:#f92672">&#34;nodes&#34;</span>: {
              <span style="color:#f92672">&#34;192.168.1.33:8080&#34;</span>: <span style="color:#ae81ff">1</span>
          },
          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;roundrobin&#34;</span>
      }
  }
</code></pre></div><ol start="2">
<li>handshark失败，证书错误</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
<span style="color:#f92672">curl</span><span style="color:#f92672">:</span> <span style="color:#f92672">(</span><span style="color:#f92672">35</span><span style="color:#f92672">)</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
</code></pre></div><p>排位原因是：这里作者使用的ApiSix版本是2.12，缺失前缀 【addr】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.org/zh/docs</a></li>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.ogr/zh/streams</a></li>
<li><a href="https://www.fenghong.tech/blog/kubernetes/sni-apisix-tcp/">
Blog-基于sni使用apisix代理四层TCP/UDP</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" aria-label="">
      
          Go使用RedisStream实现消息队列
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-08T22:33:14&#43;08:00">
        
   8, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>上篇我们介绍了RedisStream实现消息队列和发布订阅模式 ，今天我们将介绍Go语言的实现方法。</p>
<h3 id="消息队列">消息队列</h3>
<p>接上篇的例子，我们通过go-redis库的接口XAdd、XReadGroup、XGroupCreateMkStream来实现，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>      = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span> = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">stream</span>   = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>    = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">start</span>    = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>    = <span style="color:#ae81ff">10</span>
	)

	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
		<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
		<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
		<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
		<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
		<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	} 
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
	}
}

</code></pre></div><p>上例实现了一个简单的消息队列，可以实现消息的发送和接收，并保证每条消息只被处理一次 。</p>
<h3 id="阻塞超时">阻塞超时</h3>
<p>通过修改Block（单位为ms）参数来实现阻塞，详细修改如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
		<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
			<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
			<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
			<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
			<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
			<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
			<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
		}).<span style="color:#a6e22e">Result</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>()) 
    <span style="color:#f92672">...</span>
	}
</code></pre></div><p>输出如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">23</span>.<span style="color:#a6e22e">9669498</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">529310801</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">Length</span><span style="color:#f92672">=</span> <span style="color:#f92672">1</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">message</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">name</span>:<span style="color:#a6e22e">foo</span><span style="color:#f92672">]</span>
<span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">panic</span><span style="color:#f92672">:</span> <span style="color:#f92672">read</span> <span style="color:#f92672">tcp</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">63777-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">6379</span><span style="color:#f92672">:</span> <span style="color:#f92672">i</span><span style="color:#f92672">/</span><span style="color:#f92672">o</span> <span style="color:#f92672">timeout</span>
</code></pre></div><p>可见,XReadGroup一直阻塞等待新的消息，直到 Redis 连接超时或者命令被中断。
ps: 如若不需要阻塞等待可修改Block为&lt;0 的值实现。</p>
<h3 id="发布订阅模式">发布订阅模式</h3>
<p>接着，我们实现上篇提到的发布订阅模式，XGroupCreateMkStream创建另外一个订阅组group2，两个协程XReadGroup接收消息，往stream中XAdd消息，两个订阅者将都收到消息，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>       = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span>  = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">consumer2</span> = <span style="color:#e6db74">&#34;consumer2&#34;</span>
		<span style="color:#a6e22e">stream</span>    = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>     = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">group2</span>    = <span style="color:#e6db74">&#34;group2&#34;</span>
		<span style="color:#a6e22e">start</span>     = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>     = <span style="color:#ae81ff">10</span>
	)
	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:        <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>:    <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:          <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">ReadTimeout</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">// 创建消费者组2
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group2</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}

		}
	}()
	<span style="color:#75715e">//读取消息2
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Start Receiving &#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group2</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer2</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;2Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}
		}
	}()
	<span style="color:#66d9ef">for</span> {
	}
}
</code></pre></div><p>输出如下：</p>
<pre tabindex="0"><code>Start Receiving 2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
2 Start Receiving  2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
Received Length= 1 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
Received message: map[name:foo]
Start Receiving 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
2 Received Length= 1 2023-04-08 22:19:42.3628412 +0800 CST m=+0.711897201
2Received message: map[name:foo]
</code></pre><h3 id="参考">参考</h3>
<ul>
<li><a href="https://redis.io/commands/xread">redis.io</a></li>
<li><a href="https://redis.io/docs/data-types/streams-tutorial">redis.io streams-tutorial</a></li>
<li><a href="https://mp.weixin.qq.com/s/RthQvzLHZRGNo-z6X_7jQQ">一篇List、PubSub、Stream实现消息队列的博客</a></li>
<li><a href="https://overstarry.vip/posts/%E4%BD%BF%E7%94%A8redis%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97-/">golang适用用List、PubSub、Stream 实现消息队列</a></li>
<li><a href="%E5%88%97/https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">redisstream实现消息队</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" aria-label="">
      
          RedisStream实现消息队列
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-02T15:20:45&#43;08:00">
        
   2, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        Redis Stream是在 Redis 5.0中引入的数据类型，可以实现高性能、高可靠性的消息队列。本文主要介绍 Redis Stream 的概念、使用方法和一些适用场景如发布订阅模式、消息队列。
简介 Redis Stream是Redis为消息队列设计的数据类型，它将消息队列的数据结构抽象为一个有序的消息流（stream），每个消息都有一个唯一的ID和一个关联的键值对（key-value pairs）它支持以下功能：
 添加消息-将消息添加到队列的末尾 读取消息-从队列的开头读取消息 删除消息-删除指定id的消息 创建消费者组-创建多个消费者组，每个消费者组都可以独立地读取消息。同时可实现负载均衡和消息分发。 确认消息- XACK 命令来确认已经成功处理的消息，避免重复消费  XADD-添加消息 语法：
XADD key [NOMKSTREAM] [&lt;MAXLEN | MINID&gt; [= | ~] threshold [LIMIT count]] &lt;* | id&gt; field value [field value ...]  MAXLEN：可选参数，用于限制消息流的长度。如果指定了 MAXLEN，那么当消息流的长度超过指定的长度时，最早的消息将被自动删除 ID：可选参数，用于指定消息的 ID。如果不指定，Redis 会自动生成一个唯一的 ID。 field value [field value &hellip; ：消息的键值对，可以是任何字符串。  例如：
XADD mystream * name Foo age 10此命令将向名为 mystream 的消息流中添加一条消息，输出如下：
&gt;&#34;1680355760868-0&#34; XREAD-读取消息 语法：
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" aria-label="">
      
          Postgres事务隔离级别与MVCC
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-26T16:30:12&#43;08:00">
        
   26, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Postgres 中基于 MVCC（多版本并发控制）技术 ,使用一种称为“版本链”的技术来维护对数据库中行的并发访问, 来实现事务隔离级别的。</p>
<h3 id="mvcc-多版本并发控制">MVCC-多版本并发控制</h3>
<p>在 Postgres 中，每当一行被修改时，Postgres 就会创建一个新版本的该行，并将其添加到版本链的末尾。版本链包含了所有当前和以前的行版本，这样可以避免并发读写时的数据竞争和数据不一致问题。</p>
<p>MVCC避免了传统的数据库系统的锁定方法，将锁争夺最小化来允许多用户环境中的合理性能。</p>
<h3 id="常见并发问题">常见并发问题</h3>
<ol>
<li>脏读: 
一个事务读取了另一个并行未提交事务写入的数据</li>
<li>不可重复读
一个事务重新读取之前读取过的数据，发现该数据已经被另一个事务（在初始读之后提交）修改。</li>
<li>幻读
一个事务重新执行一个返回符合一个搜索条件的行集合的查询， 发现满足条件的行集合因为另一个最近提交的事务而发生了改变。</li>
<li>序列化异常
成功提交一组事务的结果与这些事务所有可能的串行执行结果都不一致。</li>
</ol>
<h3 id="事务隔离级解决方案">事务隔离级（解决方案）</h3>
<p>事务隔离级别指的是多个并发事务之间的可见性和可操作性，SQL标准定义了四种隔离级别，分别是：</p>
<ol>
<li>Read Uncommitted（读未提交）
这是最低的事务隔离级别，它允许一个事务读取其他事务未提交的数据。这可能会导致脏读、不可重复读和幻读问题。</li>
<li>Read Committed（读提交）
在该隔离级别下，事务只能看到已经提交的数据。它解决了脏读问题，但仍然存在不可重复读和幻读问题。</li>
<li>Repeatable Read（可重复读）
在该隔离级别下，事务在执行期间看到的所有数据都是一致的。它解决了不可重复读问题，但仍然存在幻读问题。</li>
<li>Serializable（可串行化）
在该隔离级别下，事务看到的所有数据都是一致的，并且完全避免了脏读、不可重复读和幻读问题。这是最高的事务隔离级别，但也是最慢的，因为它会导致大量的锁竞争。</li>
</ol>
<p>在PostgreSQL中，你可以请求四种标准事务隔离级别中的任意一种，但是内部只实现了三种不同的隔离级别，即 PostgreSQL 的读未提交模式的行为和读已提交相同。</p>
<h3 id="golang-libpq设置隔离等级">golang lib/pq设置隔离等级</h3>
<p>在golang中，使用lib/pq包，通过执行“SET TRANSACTION ISOLATION LEVEL &hellip;”来设置隔离等级。以下测试脏读的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;database/sql&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 连接数据库
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>, <span style="color:#a6e22e">dsn</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#75715e">// 设置隔离级别为读未提交
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED&#34;</span>)
	<span style="color:#75715e">//_, err = db.Exec(&#34;SET TRANSACTION ISOLATION LEVEL READ COMMITTED&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 开始第一个事务，修改用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;UPDATE users SET age = 6 WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx1 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	}()

	<span style="color:#75715e">// 暂停 1 秒钟，以便让第二个事务读取到未提交的数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">// 开始第二个事务，读取用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx2 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	<span style="color:#75715e">// 提交第一个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 提交第二个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

</code></pre></div><p>执行输出如下:</p>
<pre tabindex="0"><code>tx1 Bob's age is 6
tx2 Bob's age is 5
</code></pre><p>上例中，分别开启两个隔离级别为“读未提交”事务tx1、tx2，其中tx1对一行数据（Bob）的字段（Age）进行了修改，接着两个事务分别读取，即使在tx1提交之前，tx2也不会读取到未提交的数据,有效避免脏读等并发问题。</p>
<h3 id="小结">小结</h3>
<p>PostgreSQL 的事务隔离级别和 MVCC 技术为开发人员提供了强大的并发性能和数据一致性保证。同时MVCC并发控制模型，降低了锁竞争和死锁的风险，允许并发事务访问相同的数据而不会相互干扰。对查询（读）数据的锁请求与写数据的锁请求不冲突，所以读不会阻塞写，而写也从不阻塞读。但是，在选择事务隔离级别时，需要考虑不同事务隔离级别的性能以及<strong>应用程序的需求和性能特征</strong>，并根据实际情况进行权衡，充分利用 MVCC 技术的优点。</p>
<h3 id="参考">参考</h3>
<ul>
<li>postgres.cn  <a href="http://postgres.cn/docs/14/transaction-iso.html">http://postgres.cn/docs/14/transaction-iso.html</a></li>
<li>设置隔离级别blog <a href="https://juejin.cn/post/6992097803778392077">https://juejin.cn/post/6992097803778392077</a></li>
<li>go实例脏读、可不重复读、序列化异常 blog  <a href="https://blog.csdn.net/dfsgwe1231/article/details/107261355">https://blog.csdn.net/dfsgwe1231/article/details/107261355</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/gor%E5%92%8Capisixproxymirror%E5%AE%9E%E7%8E%B0%E6%8D%95%E8%8E%B7%E5%A4%8D%E5%88%B6%E6%B5%81%E9%87%8F/" aria-label="">
      
          Gor和ApisixProxyMirror实现捕获复制流量
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-19T16:09:13&#43;08:00">
        
   19, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e8%bd%af%e4%bb%b6%e6%b5%8b%e8%af%95">软件测试</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在上一篇  <a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/">Go网络抓包、引流工具GoReplay</a> 介绍了Gor的一些基础和实际开发中对 HTTP 流量进行复制，以用于测试、性能监测等用途。而Apache APISIX 是 Apache 软件基金会下的云原生 API 网关，它兼具动态、实时、高性能等特点，提供了负载均衡、动态上游、灰度发布（金丝雀发布）、服务熔断、身份认证、可观测性等丰富的流量管理功能。结合使用 Gor 和 Apisix 可以轻松地实现流量复制，并将其应用于各种场景中。</p>
<p>本篇文章将介绍如何使用 Gor 和 Apisix 实现流量复制，具体包括以下几个部分：</p>
<ol>
<li>测试环境介绍</li>
<li>安装和配置 Gor</li>
<li>安装和配置 Apisix</li>
<li>配置 Apisix 的 proxy-mirror 插件</li>
<li>测试流量复制</li>
</ol>
<h3 id="测试环境介绍">测试环境介绍</h3>
<ol>
<li>OS: 两台 Ubuntu 虚拟机（Gateway、Node）
<blockquote>
<p>a.  Gateway 安装 ApiSix</p>
<p>b.  Node 安装节点服务</p>
</blockquote>
</li>
<li>Docker &amp; DockerCompose</li>
</ol>
<h3 id="安装和配置-gor">安装和配置 Gor</h3>
<p>首先，需要在Node上安装 Gor 工具。可以从 Gor 的<a href="https://apisix.apache.org/zh/docs/apisix/installation-guide/">官网下载</a>相应的二进制文件，然后将其解压到服务器上即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># tar xvf gor_1.3.3_x64.tar.gz</span>
<span style="color:#75715e"># cp gor /usr/local/bin/gor</span>
<span style="color:#75715e"># sudo chmod +x /usr/local/bin/gor</span>
</code></pre></div><p>安装完成后，可以使用以下命令启动 Gor：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># gor version</span>
</code></pre></div><p>输出</p>
<pre tabindex="0"><code># Version:1.3.0 
</code></pre><h3 id="安装和配置-apisix">安装和配置 Apisix</h3>
<p>ApiSix: 这里使用 DockerCompose安装</p>
<blockquote>
<p>git clone <a href="https://github.com/apache/apisix-docker.git">https://github.com/apache/apisix-docker.git</a></p>
<p>cd apisix-docker/example</p>
<p>docker-compose up -d</p>
</blockquote>
<p>这个命令会启动 Apisix 并监听在本地的 80 端口。</p>
<h3 id="配置-apisix-的-proxy-mirror-插件">配置 Apisix 的 proxy-mirror 插件</h3>
<p>Apisix 的 proxy-mirror 插件可以用于流量复制。
增加一个路由hello-proxy-mirror, Upstream为Node主机的服务A(端口9696)，流量复制到Node主机的服务B(端口9797)，其中</p>
<ol>
<li>host 为 指定镜像服务地址</li>
<li>sample_ratio 镜像请求采样率，本例中为1，表示全量复制</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;uri&#34;</span>: <span style="color:#e6db74">&#34;/hello&#34;</span>,
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;hello-proxy-mirror&#34;</span>,
  <span style="color:#f92672">&#34;methods&#34;</span>: [
    <span style="color:#e6db74">&#34;GET&#34;</span>,
    <span style="color:#e6db74">&#34;POST&#34;</span>,
    <span style="color:#e6db74">&#34;PUT&#34;</span>,
    <span style="color:#e6db74">&#34;DELETE&#34;</span>,
    <span style="color:#e6db74">&#34;PATCH&#34;</span>,
    <span style="color:#e6db74">&#34;HEAD&#34;</span>,
    <span style="color:#e6db74">&#34;OPTIONS&#34;</span>,
    <span style="color:#e6db74">&#34;CONNECT&#34;</span>,
    <span style="color:#e6db74">&#34;TRACE&#34;</span>
  ],
  <span style="color:#f92672">&#34;plugins&#34;</span>: {
    <span style="color:#f92672">&#34;proxy-mirror&#34;</span>: {
      <span style="color:#f92672">&#34;disable&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;http://192.168.1.101:9797&#34;</span>,
      <span style="color:#f92672">&#34;sample_ratio&#34;</span>: <span style="color:#ae81ff">1</span>
    }
  },
  <span style="color:#f92672">&#34;upstream&#34;</span>: {
    <span style="color:#f92672">&#34;nodes&#34;</span>: [
      {
        <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;192.168.1.101&#34;</span>,
        <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">9696</span>,
        <span style="color:#f92672">&#34;weight&#34;</span>: <span style="color:#ae81ff">1</span>
      }
    ],
    <span style="color:#f92672">&#34;timeout&#34;</span>: {
      <span style="color:#f92672">&#34;connect&#34;</span>: <span style="color:#ae81ff">6</span>,
      <span style="color:#f92672">&#34;send&#34;</span>: <span style="color:#ae81ff">6</span>,
      <span style="color:#f92672">&#34;read&#34;</span>: <span style="color:#ae81ff">6</span>
    },
    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;roundrobin&#34;</span>,
    <span style="color:#f92672">&#34;scheme&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
    <span style="color:#f92672">&#34;pass_host&#34;</span>: <span style="color:#e6db74">&#34;pass&#34;</span>,
    <span style="color:#f92672">&#34;keepalive_pool&#34;</span>: {
      <span style="color:#f92672">&#34;idle_timeout&#34;</span>: <span style="color:#ae81ff">60</span>,
      <span style="color:#f92672">&#34;requests&#34;</span>: <span style="color:#ae81ff">1000</span>,
      <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">320</span>
    }
  },
  <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>这个配置会开启 proxy-mirror 插件，并将其配置为将流量发送到本地的 8080 端口，即 Gor 监听的地址。</p>
<h3 id="测试流量复制">测试流量复制</h3>
<p>接着可开始测试流量复制。</p>
<h4 id="启动-http-服务a监听9696端口">启动 HTTP 服务A监听9696端口：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python3 -m http.server <span style="color:#ae81ff">9696</span>
</code></pre></div><p>正常启动输出</p>
<pre tabindex="0"><code>Serving HTTP on 0.0.0.0 port 9696 (http://0.0.0.0:9696/) ...
</code></pre><h4 id="启动-镜像服务b监听9797端口">启动 镜像服务B监听9797端口：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python3 -m http.server <span style="color:#ae81ff">9797</span>
</code></pre></div><p>正常启动输出</p>
<pre tabindex="0"><code>Serving HTTP on 0.0.0.0 port 9797 (http://0.0.0.0:9797/) ...
</code></pre><h4 id="启动-gor-监听在本地的-9797-端口">启动 Gor 监听在本地的 9797 端口</h4>
<pre tabindex="0"><code>sudo gor --input-raw :9797 --output-stdout  
</code></pre><p>此命令将监听镜像服务B端口9797， 将 HTTP 流量输出到控制台</p>
<p>接着，curl测试</p>
<pre tabindex="0"><code class="language-curl" data-lang="curl">curl http://192.168.1.100:80/hello -i
</code></pre><p>输出</p>
<pre tabindex="0"><code>HTTP/1.1 404 File not found
Content-Type: text/html;charset=utf-8
Content-Length: 469
Connection: keep-alive
Date: Sun, 19 Mar 2023 06:55:42 GMT
Server: APISIX/3.2.0

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;
        &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
        &lt;title&gt;Error response&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Error response&lt;/h1&gt;
        &lt;p&gt;Error code: 404&lt;/p&gt;
        &lt;p&gt;Message: File not found.&lt;/p&gt;
        &lt;p&gt;Error code explanation: HTTPStatus.NOT_FOUND - Nothing matches the given URI.&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>测试会发送一个 HTTP 请求到Apisix开放的Http端口80，可以到达下游服务（Node主机的ServerA 9696端口），输出如下：</p>
<pre tabindex="0"><code>192.168.1.100 - - [19/Mar/2023 06:47:44] code 404, message File not found
192.168.1.100 - - [19/Mar/2023 06:47:44] &quot;GET /hello HTTP/1.1&quot; 404 -
</code></pre><p>而且，ApiSix Proxy Mirror复制Http请求到端口 9797的镜像服务， 输出如下:</p>
<pre tabindex="0"><code>192.168.1.100 - - [19/Mar/2023 06:49:07] code 404, message File not found
192.168.1.100 - - [19/Mar/2023 06:49:07] &quot;GET /hello HTTP/1.1&quot; 404 -
</code></pre><p>可见和目标服务的的完全一致。 
接着，观察Gor是否正常记录http请求，正常输出如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ae81ff">1</span> af0c2645c0a801c7399d6efb <span style="color:#ae81ff">1679212462567906772</span> <span style="color:#ae81ff">0</span>
GET /hello HTTP/1.1
Host: 192.168.1.100
Connection: close
User-Agent: curl/7.64.1
Accept: */*
</code></pre></div><p>说明Gor已经成功从镜像服务捕获流量。
再结合使用Gor的流量回放功能可以应用于例如测试、性能监测等场景。 
以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/getting-started">ApiSix Wiki</a></li>
<li><a href="https://625a9090d04b9a6953165811--2-11-old-docs-apache-apisix.netlify.app/zh/docs/apisix/plugins/proxy-mirror">Proxy Mirror</a></li>
<li><a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/">go网络抓包引流工具 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/gor%E5%92%8Capisixproxymirror%E5%AE%9E%E7%8E%B0%E6%8D%95%E8%8E%B7%E5%A4%8D%E5%88%B6%E6%B5%81%E9%87%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" aria-label="">
      
          CRI与使用crictl调试k8s节点
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-12T17:24:41&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Kubernetes 中，Kubelet 是在每个节点上运行的重要组件之一，它负责管理容器的生命周期。而 CRI（Container Runtime Interface）则是 Kubelet 用于与容器运行时进行通信的接口（如下图）。</p>
<p>CRI 采用了 ProtoBuffer 和 gPRC，规定 kubelet 该如何调用容器运行时去管理容器和镜像，Kubernetes 通过CRI可支持多种类型的OCI容器运行时，例如 docker、contained、CRI-O、runC、fraki和Kata Containers 等）。</p>
<p>为了方便用户进行容器运行时的调试工作，社区提供了 crictl 工具，用于与 CRI 接口进行交互，本文简要介绍如何使用 crictl 对 Kubernetes节点进行调试 。</p>
<p>kubelet-layout：</p>
<!-- raw HTML omitted -->
<p><img src="https://luckytking.github.io/images/kubelet-layout.png" alt=""></p>
<h4 id="安装">安装</h4>
<blockquote>
<p>你可以从 cri-tools <a href="https://github.com/kubernetes-sigs/cri-tools/releases">发布页面</a> 下载一个压缩的 crictl 归档文件，用于几种不同的架构。 下载与你的 kubernetes 版本相对应的版本。 提取它并将其移动到系统路径上的某个位置，例如 /usr/local/bin/。</p>
</blockquote>
<ul>
<li>查看版本，验证安装</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl --version
</code></pre></div><p>输出例如如下，说明安装成功:</p>
<pre tabindex="0"><code>crictl version v1.23.0 
</code></pre><h4 id="查看或编辑配置">查看或编辑配置</h4>
<p>要查看或编辑当前配置，请查看或编辑 /etc/crictl.yaml 的内容。</p>
<pre tabindex="0"><code>cat /etc/crictl.yaml
image-endpoint: unix:///var/run/image-cri-shim.sock
runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><h4 id="调试节点">调试节点</h4>
<ul>
<li>列出运行中的容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl ps
</code></pre></div><p>例如我们列出k8s集群的所有容器，例如输出：</p>
<pre tabindex="0"><code>CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID
508e30da66ce7       7a71aca7b60fc       3 days ago          Running             calico-node               0                   e0ec650992997
9daa288a68426       f822f80398b9a       3 days ago          Running             calico-typha              0                   f5c4bd6471941
300d948e75019       f6bc1b780606f       3 days ago          Running             kube-controller-manager   1                   d5d681744a377
1cfdc1a6726ae       0198979b7707e       3 days ago          Running             kube-scheduler            1                   eb6ff07ees98c
3699c312c56f9       9e6a540eeeb62       3 days ago          Running             kube-proxy                0                   e8707140d12941
4159d7ec37b29       5bc0062e9555c       3 days ago          Running             kube-apiserver            0                   22d043569737f
8f56a047e8627      25f8c7f3da61c       3 days ago          Restart             etcd                      0                   458e540c798c8
</code></pre><p>本例中，etcd容器一直启动，可以使用以下命令获取容器的日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl logs container-id
</code></pre></div><p>如此，通过日志帮助定位问题。</p>
<h4 id="更多命令">更多命令</h4>
<ul>
<li>列出所有的pods</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl pods
</code></pre></div><ul>
<li>创建容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl run --runtime<span style="color:#f92672">=</span>remote <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  docker.io/library/nginx:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  nginx-container
</code></pre></div><p>ps:使用远程容器CRI来使用最新的 nginx 镜像启动nginx-container的容器。</p>
<ul>
<li>删除容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crictl rm nginx-container
</code></pre></div><ul>
<li>列出所有镜像：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl images
</code></pre></div><ul>
<li>帮助</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> crictl -h 
NAME:
   crictl - client <span style="color:#66d9ef">for</span> CRI

USAGE:
   crictl <span style="color:#f92672">[</span>global options<span style="color:#f92672">]</span> command <span style="color:#f92672">[</span>command options<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>arguments...<span style="color:#f92672">]</span>

VERSION:
   v1.23.0

COMMANDS:
   attach              Attach to a running container
   create              Create a new container
   exec                Run a command in a running container
   version             Display runtime version information
   images, image, img  List images
   inspect             Display the status of one or more containers
   inspecti            Return the status of one or more images
   imagefsinfo         Return image filesystem info
   inspectp            Display the status of one or more pods
   logs                Fetch the logs of a container
   port-forward        Forward local port to a pod
   ps                  List containers
   pull                Pull an image from a registry
   run                 Run a new container inside a sandbox
   runp                Run a new pod
   rm                  Remove one or more containers
   rmi                 Remove one or more images
   rmp                 Remove one or more pods
   pods                List pods
   start               Start one or more created containers
   info                Display information of the container runtime
   stop                Stop one or more running containers
   stopp               Stop one or more running pods
   update              Update one or more running containers
   config              Get and set crictl client configuration options
   stats               List container<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> resource usage statistics
   completion          Output shell completion code
   help, h             Shows a list of commands or help <span style="color:#66d9ef">for</span> one command

GLOBAL OPTIONS:
   --config value, -c value            Location of the client config file. If not specified and the default does not exist, the program<span style="color:#e6db74">&#39;s directory is searched as well (default: &#34;/etc/crictl.yaml&#34;) [$CRI_CONFIG_FILE]
</span><span style="color:#e6db74">   --debug, -D                         Enable debug mode (default: false)
</span><span style="color:#e6db74">   --image-endpoint value, -i value    Endpoint of CRI image manager service (default: uses &#39;</span>runtime-endpoint<span style="color:#960050;background-color:#1e0010">&#39;</span> setting<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>$IMAGE_SERVICE_ENDPOINT<span style="color:#f92672">]</span>
   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service <span style="color:#f92672">(</span>default: uses in order the first successful one of <span style="color:#f92672">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style="color:#f92672">])</span>. Default is now deprecated and the endpoint should be set instead. <span style="color:#f92672">[</span>$CONTAINER_RUNTIME_ENDPOINT<span style="color:#f92672">]</span>
   --timeout value, -t value           Timeout of connecting to the server in seconds <span style="color:#f92672">(</span>e.g. 2s, 20s.<span style="color:#f92672">)</span>. <span style="color:#ae81ff">0</span> or less is set to default <span style="color:#f92672">(</span>default: 2s<span style="color:#f92672">)</span>
   --help, -h                          show help <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
   --version, -v                       print the version <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
</code></pre></div><p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">kubernetes.io 使用 crictl 对 Kubernetes 节点进行调试</a></li>
<li><a href="%C2%A0https://item.jd.com/13140598.html">《Kubernetes进阶实战-第2版》CRI 与OCI </a>
 </li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/go%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BA%93robfig-cron%E4%B8%80%E4%BA%9B%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" aria-label="">
      
          Go定时任务库robfig Cron一些主要功能、实际应用场景
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-04T22:21:37&#43;08:00">
        
   4, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>github.com/robfig/cron/v3 是一个功能强大且易于使用的定时任务管理库。本文进一步介绍robfig/cron在定时任务一些主要功能、如何使用它以及一些实际应用场景的例子。主要包括</p>
<ol>
<li>添加任务方法AddJob</li>
<li>指定执行时间</li>
<li>动态添加和删除任务</li>
<li>Option选项</li>
<li>JobWrapper与DefaultWrapper</li>
</ol>
<h3 id="addjob添加任务">AddJob添加任务</h3>
<p>Cron实例可以通过调用AddJob() 方法用于添加一个实现了 Job 接口的对象作为任务，Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingJob</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#a6e22e">GreetingJob</span>) <span style="color:#a6e22e">Run</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hi: &#34;</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>()
	<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddJob</span>(<span style="color:#e6db74">&#34;@every 2s&#34;</span>, <span style="color:#a6e22e">GreetingJob</span>{<span style="color:#e6db74">&#34;Greeter&#34;</span>})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error : %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID:&#34;</span>, <span style="color:#a6e22e">entityID</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#75715e">//output:
</span><span style="color:#75715e">//entityID: 1
</span><span style="color:#75715e">//Hi:  Greeter now: 2023-03-04 17:50:07.0169185 +0800 CST m=+1.716253301
</span><span style="color:#75715e">//Hi:  Greeter now: 2023-03-04 17:50:09.0068064 +0800 CST m=+3.706141201
</span></code></pre></div><p>此例中，GreetingJob实现了cron.Job 接口，cron实例调用AddJob，加入一个每2秒执行的任务，务并传递参数。</p>
<h3 id="指定执行时间">指定执行时间</h3>
<p>可以通过修改 cron 表达式来指定任务的执行时间。Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>()) 
<span style="color:#a6e22e">entityID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;0 05 18 * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hi now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
})
</code></pre></div><p>此例中，将在每天的傍晚18点5分执行指定的函数。</p>
<h3 id="动态添加和删除任务">动态添加和删除任务</h3>
<p>cron/v3 允许开发人员在运行时动态添加和删除任务。Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>())
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
     <span style="color:#75715e">// 添加第一个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entityID1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;*/2 * * * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Job1: &#34;</span>, <span style="color:#a6e22e">count</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
	})
	<span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID1:&#34;</span>, <span style="color:#a6e22e">entityID1</span>)
     <span style="color:#75715e">// 等待 6 秒钟，让第一个任务执行3次
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>)
    <span style="color:#75715e">// 添加第二个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entityID2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;*/2 * * * * *&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Job2: &#34;</span>, <span style="color:#a6e22e">count</span>, <span style="color:#e6db74">&#34;now:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
	})
	<span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span>)
     <span style="color:#75715e">// 等待 10秒钟，让两个任务交替执行几次
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
     <span style="color:#75715e">// 删除第2个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">entityID2</span>)
     <span style="color:#75715e">// 等待 10秒钟，发现只有任务1在执行了
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
     <span style="color:#75715e">// 删除第2个任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">EntryID</span>(<span style="color:#ae81ff">1</span>))
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;entityID2&#34;</span>, <span style="color:#a6e22e">entityID2</span>)
    <span style="color:#75715e">//发现只有没有任务在执行了 
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">must</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">err</span>))
	}
}

</code></pre></div><h3 id="option选项">Option选项</h3>
<p>Option 是一种用于配置 Cron 实例的结构体类型。Option 类型有多个可选字段，可用于配置定时任务的行为，上例中有使用到的WithSeconds。</p>
<p>以下是 Option 类型的一些字段及其说明：</p>
<ul>
<li>WithSeconds()：在 cron 表达式中包含秒（0-59），默认为不包含秒。</li>
<li>WithLocation()：设置时区，可以使用标准时区名称或时区偏移量。</li>
<li>WithChain()：将多个函数连接成单个函数。</li>
<li>WithParser()：指定 cron 表达式的解析器，默认为 StandardParser。</li>
<li>WithLogger()：指定日志记录器，默认为 DefaultLogger。</li>
</ul>
<p>下面 WithLogger Option Cron Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithLogger</span>(
			<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">VerbosePrintfLogger</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>, <span style="color:#e6db74">&#34;cron: &#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">LstdFlags</span>))))
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;@every 1s&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
	})
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}
<span style="color:#75715e">//output:
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:17 start
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:17 schedule, now=2023-03-04T21:31:17+08:00, entry=1, next=2023-03-04T21:31:18+08:00
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:18 wake, now=2023-03-04T21:31:18+08:00
</span><span style="color:#75715e">//cron: 2023/03/04 21:31:18 run, now=2023-03-04T21:31:18+08:00, entry=1, next=2023-03-04T21:31:19+08:00
</span><span style="color:#75715e">//hello world
</span></code></pre></div><p>上例中，调用cron.VerbosPrintfLogger()包装log.Logger，这个logger会详细记录cron内部的调度过程</p>
<h3 id="jobwrapper与defaultwrapper">JobWrapper与DefaultWrapper</h3>
<p>//NewChain返回一个由给定JobWrappers组成的Chain，类似中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JobWrapper</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Job</span>) <span style="color:#a6e22e">Job</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Chain</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">wrappers</span> []<span style="color:#a6e22e">JobWrapper</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChain</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">JobWrapper</span>) <span style="color:#a6e22e">Chain</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Chain</span>{<span style="color:#a6e22e">c</span>}
}
</code></pre></div><p>cron内置了 3 个用得比较多的JobWrapper</p>
<ul>
<li>Recover 捕获内部Job产生的 panic</li>
<li>DelayIfStillRunning 序列化作业，延迟后续的运行直到前一个是完整的。</li>
<li>SkipIfStillRunning 跳过Job的调用，如果之前的调用是仍在运行。 
以Reover为例：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/robfig/cron/v3&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithSeconds</span>(),
		<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">WithChain</span>(
			<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">Recover</span>(<span style="color:#a6e22e">cron</span>.<span style="color:#a6e22e">DefaultLogger</span>),
		),
	)

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AddFunc</span>(<span style="color:#e6db74">&#34;@every 2s&#34;</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start...&#34;</span>)
		panic(<span style="color:#a6e22e">any</span>(<span style="color:#e6db74">&#34;ohno....&#34;</span>))
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;End...&#34;</span>)
	})

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()

	<span style="color:#66d9ef">select</span> {}
}
</code></pre></div><p>output:</p>
<pre tabindex="0"><code>Start...
cron: 2023/03/04 21:59:32 panic, error=ohno...., stack=...
goroutine 7 [running]:
github.com/robfig/cron/v3.Recover.func1.1.1()
	E:/gopath/pkg/mod/github.com/robfig/cron/v3@v3.0.1/chain.go:45 +0xa5
panic({0x7370c0, 0x75b930})
	...
</code></pre><p>在上例中，使用 cron.Recover() 方法来捕获任务执行过程中的 panic，并记录日志。如果不进行 panic 捕获的话，程序将会因为 panic 而退出。需要注意的是，当使用 Recover() 方法时，不应该让任务函数返回一个 error，否则它将不会被正确地捕获。如果任务函数可能会返回 error，建议使用 Try() 方法进行捕获。</p>
<p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/robfig/cron/v3">github.com/robfig/cron/v3</a></li>
<li><a href="https://darjun.github.io/2020/06/25/godailylib/cron/">一篇讲的比较详细的Blog</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/go%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BA%93robfig-cron%E4%B8%80%E4%BA%9B%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/" aria-label="">
      
          Docker、Go、PostgreSQL如何修改时区
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-25T15:55:06&#43;08:00">
        
   25, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍Docker、Go、PostgreSQL如何修改它们的时区。</p>
<p>首先需要知道一些基础概念:</p>
<ol>
<li>Unix 时间戳 -是从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数，不考虑闰秒。</li>
<li>UTC &ndash;协调世界时，又称世界统一时间、世界标准时间、国际协调时间。</li>
<li>CST&ndash;可视为中国、古巴的标准时间或美国、澳大利亚的中部时间。北京时间，也就是东八区时间。</li>
</ol>
<h3 id="docker">Docker</h3>
<p>Docker 作为部署和运行应用程序的环境，默认使用 UTC 作为其容器的时区，但我们可以通过设置环境变量来修改时区。</p>
<p>修改的方法</p>
<ol>
<li>在 Dockerfile 中添加以下行：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">ENV TZ=Asia/Shanghai</span>
</code></pre></div><ol start="2">
<li>在 Kubernetes 中的 Pod 配置文件中，添加 env 字段，设置环境变量。Example:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-container</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">my-image</span>
    <span style="color:#f92672">env</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">TZ</span>
        <span style="color:#f92672">value</span>: <span style="color:#ae81ff">Asia/Shanghai</span>
</code></pre></div><ol start="3">
<li>验证在容器中使用 env 命令查看环境变量，例如</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">env
</code></pre></div><p>输出会有key为TZ，value为Asia/Shanghai表示成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">TZ<span style="color:#f92672">=</span>Asia/Shanghai
</code></pre></div><h3 id="go">Go</h3>
<p>在 Go 中修改时区需要使用标准库中的 time 包。我们可以通过FixedZone来修改时区。
Example：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">utcZone</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">FixedZone</span>(<span style="color:#e6db74">&#34;UTC&#34;</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3600</span>) <span style="color:#75715e">// UTC
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Local</span> = <span style="color:#a6e22e">utcZone</span>
	<span style="color:#a6e22e">utcNow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">utcDate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Year</span>(), <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Month</span>(), <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Day</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">utcNow</span>.<span style="color:#a6e22e">Location</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UTC time: %s\n&#34;</span>, <span style="color:#a6e22e">utcDate</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UTC timestamp: %d\n&#34;</span>, <span style="color:#a6e22e">utcDate</span>.<span style="color:#a6e22e">Unix</span>())

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cstZone</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">FixedZone</span>(<span style="color:#e6db74">&#34;CST&#34;</span>, <span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3600</span>) <span style="color:#75715e">// 东八
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Local</span> = <span style="color:#a6e22e">cstZone</span>
	<span style="color:#a6e22e">cstNow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">cstDate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Year</span>(), <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Month</span>(), <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Day</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cstNow</span>.<span style="color:#a6e22e">Location</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;CST time: %s\n&#34;</span>, <span style="color:#a6e22e">cstDate</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;CST timestamp: %d\n&#34;</span>, <span style="color:#a6e22e">cstDate</span>.<span style="color:#a6e22e">Unix</span>())
}
<span style="color:#75715e">//output
</span><span style="color:#75715e">//UTC time: 2023-02-25 00:00:00 +0000 UTC
</span><span style="color:#75715e">//UTC timestamp: 1677283200
</span><span style="color:#75715e">//CST time: 2023-02-25 00:00:00 +0800 CST
</span><span style="color:#75715e">//CST timestamp: 1677254400
</span></code></pre></div><p>在上面的代码中，我们使用time.FixedZone分别设置UTC、上海时区，并获取当天零点的时间戳 _date。</p>
<h3 id="postgresql">PostgreSQL</h3>
<p><strong>在PostgreSQL系统内部，所有日期和时间都用全球统一时间UTC格式存储， 时间在发给客户前端前由数据库服务器根据TimeZone 配置参数声明的时区转换成本地时间</strong>。</p>
<p>在 PostgreSQL 中，我们可以通过修改 postgresql.conf 文件来修改时区。
以下是如何在 Docker运行 PostgreSQL 中修改时区的步骤：</p>
<ol>
<li>拷贝dockers中的 postgresql.conf到宿主主机</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo docker cp <span style="color:#f92672">[</span>your_docker_contariner_id<span style="color:#f92672">]</span>:/var/lib/postgresql/data/postgresql.conf /<span style="color:#f92672">[</span>your_work_space<span style="color:#f92672">]</span>/
</code></pre></div><ol start="2">
<li>修改配置</li>
</ol>
<pre tabindex="0"><code>sudo vi /[your_work_space]/postgresql.conf
</code></pre><p>查找替换timezone为上海时区</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">timezone = 'Asia/Shanghai'
</code></pre><p>可以通过sql查找支持的时区：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> pg_timezone_names;
</code></pre></div><ol start="3">
<li>保存并覆盖dockers中配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo docker cp /<span style="color:#f92672">[</span>your_work_space<span style="color:#f92672">]</span>/postgresql.conf <span style="color:#f92672">[</span>your_docker_contariner_id<span style="color:#f92672">]</span>:/var/lib/postgresql/data/
</code></pre></div><ol start="4">
<li>重新容器</li>
</ol>
<pre tabindex="0"><code>sudo docker restart [your_docker_contariner_id
</code></pre><p>现在，你的 PostgreSQL 数据库就使用了正确的时区。</p>
<ol start="5">
<li>检查是否设置成功
通过sql获取设置：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> pg_db_role_setting;
</code></pre></div><p>也可以查看数据库中表字段格式为TimestampTZ，Example
修改前</p>
<blockquote>
<p>2023-02-25 00:00:00 +0000 +00</p>
</blockquote>
<p>修改后台</p>
<blockquote>
<p>2023-02-25 08:00:00 +0000 +08</p>
</blockquote>
<p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/env"> docker 修改Env</a></li>
<li><a href="http://www.postgres.cn/docs/14/datatype-datetime.html">postgres.cn/docs</a></li>
<li><a href="https://hjxlog.com/posts/20210902215616.html"> 博客dockers-postgre 修改TimeZone</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/dockergopostgresql%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" aria-label="">
      
          Go分布式任务队列Asynq入门
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-18T21:37:06&#43;08:00">
        
   18, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        分布式任务任务调度与管理在微服务开发中是很有必要的。例如，当需要执行一些计算密集型或网络I/O密集型操作时，为了不影响主线程的性能，我们可以将这些任务放到后台异步执行。此外，异步任务处理还可以改善应用程序的可伸缩性和可靠性，因为它可以将任务分布到多个处理器上并允许任务的重试。
Asynq 介绍  Asynq Simple, reliable, and efficient distributed task queue in Go
 Asynq 是一个 Go 库，用于排队任务并与 worker 异步处理它们。它由Redis提供支持，旨在实现可扩展且易于上手。
特性：
 保证至少执行一次任务 任务调度 失败任务的重试 工作人员崩溃时自动恢复任务 加权优先级队列 严格的优先队列 添加任务的延迟低，因为 Redis 中的写入速度很快 使用唯一选项对任务进行重复数据删除 允许每个任务超时和截止日期 允许聚合任务组以批处理多个连续操作 支持中间件的灵活处理程序接口 能够暂停队列以停止处理队列中的任务 定期任务 支持 Redis Cluster实现自动分片和高可用 支持 Redis Sentinels以实现高可用性 与Prometheus集成以收集和可视化队列指标 用于检查和远程控制队列和任务的Web UI CLI检查和远程控制队列和任务  总的来说:
 分布式任务队列：Asynq提供了一个任务队列，可以分布式地处理异步任务，使得任务可以在多个处理器之间分配。 可靠性：Asynq具有高可靠性，可以确保任务不会丢失或重复执行。 异常处理：Asynq提供了对任务异常的处理机制，以便在任务执行失败时进行重试或处理。 优先级和延迟任务：Asynq允许您为任务设置优先级和延迟执行，以便您可以控制任务的执行顺序。 Web UI和CLI：Asynq提供了一个易于使用的Web UI和CLI工具，可以方便地监控和管理异步任务。  本文主要记录Asynq的入门、基本使用和工作原理。
安装 使用go get命令安装Asynq库
go get -u github.com/hibiken/asynq工作原理 高级概述：
  Client客户端将任务放入队列 Server服务器从队列中拉取任务并为每个任务启动一个工作协程 任务由多个worker同时处理   Client 创建异步任务 asynq.
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/go%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97asynq%E5%85%A5%E9%97%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" aria-label="">
      
          深入了解KratosMiddlewar的实现原理
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-02-12T16:10:45&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Kratos Middleware是Kratos的核心一个中间件层，它是Kratos架构的核心部分，负责处理所有微服务间的通信和数据流。本文将深入了解Kratos Middleware的工作原理，更好地理解和使用Kratos。</p>
<h3 id="使用示例">使用示例</h3>
<p>Kratos 内置了一系列的 middleware（中间件）用于处理 logging、 metrics 等通用场景,
您也可以通过实现 Middleware 接口，开发自定义 middleware，进行通用的业务处理，比如用户登录鉴权等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// http
</span><span style="color:#75715e">// 定义opts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> = []<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ServerOption</span>{
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Middleware</span>(
        <span style="color:#a6e22e">recovery</span>.<span style="color:#a6e22e">Recovery</span>(), <span style="color:#75715e">// 把middleware按照需要的顺序加入
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">tracing</span>.<span style="color:#a6e22e">Server</span>(),
        <span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Server</span>(),
    ),
}
<span style="color:#75715e">// 创建server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</code></pre></div><p>自定义中间件的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Middleware1</span>() <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">ok</span> {
                <span style="color:#75715e">// Do something on entering
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
                <span style="color:#75715e">// Do something on exiting
</span><span style="color:#75715e"></span>                 }()
            }
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
        }
    }
}
</code></pre></div><h3 id="链式调用">链式调用</h3>
<p>Kratos Middleware是通过链式结构实现的，其中每一个中间件都代表一个独立的处理单元，可以在请求的生命周期中的不同阶段执行不同的操作，如请求前的预处理、请求后的后处理等。</p>
<p>每一个中间件都是一个函数，具有相同的签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Handler定义中间件调用的处理程序
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>)
</code></pre></div><p>再看看/go-kratos/kratos/blob/main/middleware/middleware包中Middleware和Chain的实现，Middleware 是HTTP/gRPC传输中间件。 Chain返回一个中间件，它指定endpoint.的链式处理程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Middleware</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Middleware</span>) <span style="color:#a6e22e">Middleware</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">m</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> {
			<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>](<span style="color:#a6e22e">next</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>
	}
}
</code></pre></div><p>Example,以https://github.com/go-kratos/kratos/blob/main/middleware/middleware_test.go为例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestChain</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">next</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;reply&#34;</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">test1Middleware</span>, <span style="color:#a6e22e">test2Middleware</span>, <span style="color:#a6e22e">test3Middleware</span>)(<span style="color:#a6e22e">next</span>)(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;hello kratos!&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expect %v, got %v&#34;</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>)
        }
  }
  
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test1Middleware</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 before&#34;</span>)
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;test1 after&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
}  
<span style="color:#f92672">...</span> <span style="color:#a6e22e">篇幅限制</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">省略部分代码</span>
<span style="color:#a6e22e">OutPut</span><span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">before</span>
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">before</span>
    <span style="color:#a6e22e">middleware_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">14</span>: <span style="color:#a6e22e">hello</span> <span style="color:#a6e22e">kratos</span>!
<span style="color:#a6e22e">test3</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test2</span> <span style="color:#a6e22e">after</span>
<span style="color:#a6e22e">test1</span> <span style="color:#a6e22e">after</span>
</code></pre></div><h3 id="调用过程">调用过程</h3>
<p>对链式调用的使用有所了解后，接着来看Middleware 调用组织过程，大致归纳为：</p>
<ol>
<li>option方式配置中间件</li>
<li>url路由匹配中间件</li>
<li>组装中间件添加到调用链</li>
<li>注册到gorilla，其中gorilla实现net.hander，设置为服务路由中间件</li>
</ol>
<p>以Transport.Server Http服务为例，重点关注middleware和router 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Server is an HTTP server wrapper.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>
	<span style="color:#a6e22e">middleware</span>  <span style="color:#a6e22e">matcher</span>.<span style="color:#a6e22e">Matcher</span>
	<span style="color:#a6e22e">router</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Router</span>
	<span style="color:#f92672">...</span>
}
<span style="color:#75715e">// Matcher is a middleware matcher.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Matcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">selector</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ms</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>)
	<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>
}
</code></pre></div><ul>
<li>Matcher是一个中间件匹配器，operation 为path，实现路由查找。</li>
<li>router 为gorilla.Mux, Http路由器和Url匹配器</li>
</ul>
<p>一个完成的调用api-service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_Greeter_SayHello0_HTTP_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">GreeterHTTPServer</span>) <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">HelloRequest</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindQuery</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">BindVars</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetOperation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/helloworld.v1.Greeter/SayHello&#34;</span>)
		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Middleware</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloRequest</span>))
		})
		<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">in</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">out</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReply</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Result</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">reply</span>)
	}
}
</code></pre></div><p>其中ctx.Middleware的实现是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">wrapper</span>) <span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">FromServerContext</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Context</span>()); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">tr</span>.<span style="color:#a6e22e">Operation</span>())<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Chain</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>)<span style="color:#f92672">...</span>)(<span style="color:#a6e22e">h</span>)
} 

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">matcher</span>) <span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">operation</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span> {
	<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Middleware</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>))
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">defaults</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">operation</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">next</span><span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">prefix</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">prefix</span>) {
			<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">matchs</span>[<span style="color:#a6e22e">prefix</span>]<span style="color:#f92672">...</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ms</span>
}
</code></pre></div><p>以optionnal方式定义的中间件存储m.defaults,通过matcher.Match给不同的路由匹配不同的中间件。最终加入到 middleware.Chain的调用链实现链式调用。</p>
<h3 id="小结">小结</h3>
<p>文本记录深入理解Kratos框架和Kratos Middleware，核心使用middleware.Chain的链式调用具有相同的签名的中间件函数。框架通过option的方式提供设置中间件， Matcher中间件匹配器匹配不同路由规则的中间件，来实现链式调用。</p>
<h3 id="参考">参考</h3>
<ul>
<li>kratos doc <a href="https://go-kratos.dev/docs/component/middleware/overview">https://go-kratos.dev/docs/component/middleware/overview</a></li>
<li>kratos middleware pkg  <a href="https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go">https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/02/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3kratosmiddlewar%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/post/" aria-label="">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span></span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/post/page/3/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


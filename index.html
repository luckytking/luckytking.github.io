<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="jefffff&#39;s Blog">
<meta name="twitter:title" content="jefffff&#39;s Blog">
<meta property="og:url" content="https://luckytking.github.io/">
<meta property="twitter:url" content="https://luckytking.github.io/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>jefffff&#39;s Blog</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/go%E7%BB%98%E5%88%B6%E5%9B%BE%E8%A1%A8%E5%BA%93go-echarts/" aria-label="">
      
          Go绘制图表库go Echarts
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-30T18:48:38&#43;08:00">
        
   30, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <h3 id="简介">简介</h3>
<p>ECharts是一款基于JavaScript的数据可视化图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。ECharts最初由百度团队开源，并于2018年初捐赠给Apache基金会，成为ASF孵化级项目。</p>
<p>在 Golang 这门语言中，目前数据可视化的第三方库还是特别少，go-echarts 的开发就是为了填补这部分的空隙。Apache ECharts 是非常优秀的可视化图表库，凭借着良好的交互性，精巧的图表设计，得到了众多开发者的认可。也有其他语言为其实现了相应语言版本的接口，如 Python 的 pyecharts，go-echarts 也是借鉴了 pyecharts 的一些设计思想。</p>
<p>特性</p>
<ul>
<li>简洁的 API 设计，使用如丝滑般流畅</li>
<li>囊括了 25+ 种常见图表，应有尽有</li>
<li>高度灵活的配置项，可轻松搭配出精美的图表</li>
<li>详细的文档和示例，帮助开发者更快的上手项目</li>
<li>多达 400+ 地图，为地理数据可视化提供强有力的支持</li>
</ul>
<h3 id="如何使用">如何使用</h3>
<p>1.安装go-echarts库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">go get -u github.com/go-echarts/go-echarts/v2
</code></pre></div><p>2.接着，我们来创建一个图表实例，绘制一个条形图，来演示如何使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>

	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
)

<span style="color:#75715e">// generate random data for bar chartg
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateBarItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">BarData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个新的bar实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewBar</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first bar chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateBarItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateBarItems</span>())
	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;bar.html&#34;</span>)
	<span style="color:#a6e22e">bar</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">f</span>)
}

</code></pre></div><p>运行上例，会生成bar.html，详细：
<img src="https://luckytking.github.io/images/go-echars-1.png" alt=""></p>
<ol start="3">
<li>如果想把上例改成折线图呢</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#75715e">// generate random data for line chart
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateLineItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建一个折线图实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewLine</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first lines chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">SetSeriesOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithLineChartOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineChart</span>{<span style="color:#a6e22e">Smooth</span>: <span style="color:#66d9ef">true</span>}))

	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;lines.html&#34;</span>)
	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">f</span>)
}

</code></pre></div><p>运行上例，会生成lines.html，详细：</p>
<p><img src="https://luckytking.github.io/images/go-echars-2.png" alt=""></p>
<ol start="4">
<li>如果想直接生成图表的 http serve呢：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/charts&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-echarts/go-echarts/v2/opts&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#75715e">// generate random data for line chart
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateLineItems</span>() []<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span> {
	<span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">items</span> = append(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineData</span>{<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">300</span>)})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">httpserver</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#75715e">//创建一个折线图实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">NewLine</span>()
	<span style="color:#75715e">//设置一些全局选项，如标题/图例/工具提示或其他任何东西
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//example: 标题/子标题
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetGlobalOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithTitleOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Title</span>{
		<span style="color:#a6e22e">Title</span>:    <span style="color:#e6db74">&#34;My first lines chart generated by go-echarts&#34;</span>,
		<span style="color:#a6e22e">Subtitle</span>: <span style="color:#e6db74">&#34;It&#39;s extremely easy to use, right?&#34;</span>,
	}))

	<span style="color:#75715e">//将数据放入实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">SetXAxis</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;Mon&#34;</span>, <span style="color:#e6db74">&#34;Tue&#34;</span>, <span style="color:#e6db74">&#34;Wed&#34;</span>, <span style="color:#e6db74">&#34;Thu&#34;</span>, <span style="color:#e6db74">&#34;Fri&#34;</span>, <span style="color:#e6db74">&#34;Sat&#34;</span>, <span style="color:#e6db74">&#34;Sun&#34;</span>}).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category A&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">AddSeries</span>(<span style="color:#e6db74">&#34;Category B&#34;</span>, <span style="color:#a6e22e">generateLineItems</span>()).
		<span style="color:#a6e22e">SetSeriesOptions</span>(<span style="color:#a6e22e">charts</span>.<span style="color:#a6e22e">WithLineChartOpts</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LineChart</span>{<span style="color:#a6e22e">Smooth</span>: <span style="color:#66d9ef">true</span>}))

	<span style="color:#75715e">//奇迹发生的地方-绘图生成html
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">Render</span>(<span style="color:#a6e22e">w</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">httpserver</span>)
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)
}
</code></pre></div><p>访问，http://localhost:8080/ ，详细如下
<img src="https://luckytking.github.io/images/go-echars-3.png" alt=""></p>
<h3 id="三总结">三、总结</h3>
<p>本文简要介绍go-echarts和使用方法，并通过绘制条形图、折线图和图表的http server 的例子演示了使用方法。更多功能待续。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="%C2%A0%C2%A0https://github.com/go-echarts/go-echarts">go-echarts</a></li>
<li><a href="%C2%A0https://github.com/go-echarts/examples">go-echarts/examples</a></li>
<li><a href="https://echrts.apache.org/zh/index.html">echrts</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/go%E7%BB%98%E5%88%B6%E5%9B%BE%E8%A1%A8%E5%BA%93go-echarts/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/ingressannotations%E6%A8%A1%E5%BC%8F%E5%90%AF%E7%94%A8apisix%E7%9A%84cors/" aria-label="">
      
          IngressAnnotations模式启用Apisix的Cors
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-15T22:19:52&#43;08:00">
        
   15, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Apache APISIX 是 Apache 软件基金会下的云原生 API 网关，它兼具动态、实时、高性能等特点，提供了负载均衡、动态上游、灰度发布（金丝雀发布）、服务熔断、身份认证、可观测性等丰富的流量管理功能。很多场景下，我们可以选择在APISIX中使用CORS（跨源资源共享）来解决跨域问题。</p>
<p>APISIX提供了CRD和Annotations模式来启用CORS。本文主要介绍如何在APISIX Ingress Annotations模式下启用CORS。</p>
<p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
<tr>
<td>apisix</td>
<td>apache/apisix:3.4.0-debian</td>
</tr>
<tr>
<td>apisix-ingress-controller</td>
<td>apache/apisix-ingress-controller:1.6.0</td>
</tr>
</tbody>
</table>
<h3 id="ingressannotations模式">IngressAnnotations模式</h3>
<p>IngressAnnotations模式，可以通过在Ingress资源上添加注释来配置APISIX的行为。比如添加一个CORS注释来指示APISIX启用CORS：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">annotations</span>
    <span style="color:#f92672">k8s.apisix.apache.org/enable-cors</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">apisix</span>
</code></pre></div><p>接着，我们以给一个Http服务my-service, 创建了一个Ingress资源的例子来演示, Ingress详细如下：</p>
<h4 id="创建ingress">创建Ingress</h4>
<p>创建my-service的ingress资源：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">match-ingress</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-ns</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">k8s.apisix.apache.org/enable-cors</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">apisix</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-service</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8000</span>
        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/v2</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</code></pre></div><p>在这个示例中，我们添加了【k8s.apisix.apache.org/enable-cors: &ldquo;true&rdquo;】的注释， 即启用cors功能，默认允许来自任何源的请求访问my-service的API。</p>
<h4 id="dashboard启用cors">Dashboard启用CORS</h4>
<p>打开APISIX Dashboard界面：在【插件】中查找“CORS” 。单击该插件，然后单击“启用”。</p>
<p>然后，可以在路由点击查看my-service的对应路由，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;uris&#34;</span>: [
    <span style="color:#e6db74">&#34;/v2/&#34;</span>,
    <span style="color:#e6db74">&#34;/v2/*&#34;</span>
  ],
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ing_my-service-ingress_cfc81dbe&#34;</span>,
  <span style="color:#f92672">&#34;desc&#34;</span>: <span style="color:#e6db74">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span>,
  <span style="color:#f92672">&#34;plugins&#34;</span>: {
    <span style="color:#f92672">&#34;cors&#34;</span>: {
      <span style="color:#f92672">&#34;allow_credential&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;allow_headers&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;allow_methods&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;allow_origins&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;expose_headers&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
      <span style="color:#f92672">&#34;max_age&#34;</span>: <span style="color:#ae81ff">5</span>
    }
  },
  <span style="color:#f92672">&#34;upstream_id&#34;</span>: <span style="color:#e6db74">&#34;7c630009&#34;</span>,
  <span style="color:#f92672">&#34;labels&#34;</span>: {
    <span style="color:#f92672">&#34;managed-by&#34;</span>: <span style="color:#e6db74">&#34;apisix-ingress-controller&#34;</span>
  },
  <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>plugins.cors为跨域的对应规则配置，说明插件启用成功。</p>
<h4 id="测试">测试</h4>
<p>然后我们向my-service的发起一个测试请求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">-i</span> <span style="color:#f92672">-k</span> <span style="color:#e6db74">&#39;http://[my-cluster-ip:nodeport]/v2/my-service/api/geeker&#39;</span>   <span style="color:#f92672">-X</span> <span style="color:#f92672">OPTIONS</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Allow-Origin: *&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Request-Method: POST&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Access-Control-Request-Headers: content-type&#34;</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#34;Origin: http://localhost/&#34;</span> 
   
</code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Date: Sat, <span style="color:#ae81ff">15</span> Jul <span style="color:#ae81ff">2023</span> 13:53:57 GMT
Content-Type: text/plain; charset<span style="color:#f92672">=</span>utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/3.4.0
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: *
Access-Control-Max-Age: <span style="color:#ae81ff">5</span>
Access-Control-Expose-Headers: *
Access-Control-Allow-Headers: *
</code></pre></div><p>如果返回结果中出现 CORS 相关的 header（
ccess-Control-Allow-Origin: *
&lt; Access-Control-Allow-Methods: *
&lt; Access-Control-Allow-Headers: *
&lt; Access-Control-Expose-Headers: *
&lt; Access-Control-Max-Age: 5
），则代表插件生效、跨域成功。</p>
<h3 id="遇到的问题">遇到的问题</h3>
<p>在增加好ingress后测试API，发现没有CORS 相关的 header</p>
<p>，跨域失败</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Content-Length: <span style="color:#ae81ff">0</span>
Connection: keep-alive
Access-Control-Allow-Headers: Content-Type
Access-Control-Allow-Origin: *
Date: Sat, <span style="color:#ae81ff">15</span> Jul <span style="color:#ae81ff">2023</span> 13:46:16 GMT
Server: APISIX/3.4.0
</code></pre></div><p>经检查，是ApiSix的config配置有误，在配置的插件里，开启了其他插件，没有包括cors，导致插件不生效。去掉后，重启插件配置生效、跨域成功。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">plugins</span>:
  <span style="color:#75715e"># the plugins you enabled</span>
  - <span style="color:#ae81ff">log-rotate</span>
  - <span style="color:#ae81ff">proxy-rewrite</span>
</code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/plugins/cors/">apisix cors</a></li>
<li><a href="https://apisix.apache.org/zh/blog/2022/12/15/how-support-ingress-custom-plugins/">apisix Ingress 如何支持自定义插件</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/ingressannotations%E6%A8%A1%E5%BC%8F%E5%90%AF%E7%94%A8apisix%E7%9A%84cors/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/rds-postgresql%E5%A4%87%E4%BB%BDsql%E6%81%A2%E5%A4%8D%E5%88%B0mac%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BA%93/" aria-label="">
      
          RDS PostgreSQL备份SQL恢复到Mac本地数据库
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-07T22:43:53&#43;08:00">
        
   7, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/database">Database</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要记录通过云盘实例的备份数据转换成的SQL文件, 恢复到PostgreSQL自建数据库的过程和遇到的问题。</p>
<p>恢复过程主要包括：</p>
<ol>
<li>下载备份：通过生成的外部连接下载</li>
<li>下载python脚本restore_pg.py</li>
<li>执行脚本恢复到PostgreSQL</li>
</ol>
<p>接着，下文将描述恢复到数据库:fooDatabase表:geeker的过程。</p>
<h4 id="下载备份">下载备份</h4>
<ol>
<li>通过下载备份功能将云盘实例的备份文件转换成CSV文件或SQL文件下载到本地或ECS</li>
</ol>
<p><img src="https://luckytking.github.io/images/rds-postgresql.png" alt=""></p>
<ol start="2">
<li>解压下载的文件。
解压缩命令格式为 tar -zxvf&lt;压缩包文件名&gt;.tar.gz -C &lt;解压缩后的文件位置&gt; 。
示例如下：</li>
</ol>
<pre tabindex="0"><code># tar -zxvf fooDatabase.tar.gz -C ./home/abs/exports
</code></pre><p>解压后的文件目录</p>
<pre tabindex="0"><code>#tree
|____.DS_Store
|____fooDatabase
| |____structure.sql
| |____public
| | |____geeker
| | | |____column_structure.sql
| | | |____constraint_structure.sql
| | | |____data
| | | | |____0-1.sql
| | |____structure.sql
</code></pre><ul>
<li>./fooDatabase/structure..sql 为创建数据库，详细：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> fooDatabase;
<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">c</span> fooDatabase;
</code></pre></div><ul>
<li>./fooDatabase/public/structure..sql  创建模式， 详细 ：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">SCHEMA</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> <span style="color:#e6db74">&#34;public&#34;</span>
</code></pre></div><h4 id="下载restore_pgpy">下载restore_pg.py</h4>
<ol>
<li>下载Python脚本。<a href="https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/file-manage-files/zh-CN/20230111/lvmx/restore_pg.py?spm=a2c4g.456306.0.0.14f359aeqChZwi&amp;file=restore_pg.py">https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/file-manage-files/zh-CN/20230111/lvmx/restore_pg.py?spm=a2c4g.456306.0.0.14f359aeqChZwi&amp;file=restore_pg.py</a></li>
</ol>
<p>ps: 如果数据名包含大写，需要修改脚本。可以参考<a href="https://github.com/easytking/database/blob/main/restore_pg.py">https://github.com/easytking/database/blob/main/restore_pg.py</a></p>
<ol start="2">
<li>执行如下命令对Python脚本文件restore_pg.py添加执行权限。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># chmod +x ./restore_pg.py</span>
</code></pre></div><h4 id="恢复到数据库">恢复到数据库</h4>
<h5 id="搭建数据库">搭建数据库</h5>
<p>这里使用Dockers搭建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.5&#39;</span> 

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">pg2</span>:
    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;postgres:14&#34;</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">pg2</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always   </span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;5432:5432&#34;</span>       
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">POSTGRES_USER=postgres</span>
      - <span style="color:#ae81ff">POSTGRES_PASSWORD=123456</span>
      - <span style="color:#ae81ff">POSTGRES_DB=test</span>
      - <span style="color:#ae81ff">PGDATA=/var/lib/postgresql/data</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">./data/pg2/postgresql:/var/lib/postgresql/data  </span>
</code></pre></div><h5 id="postgres客户端安装">Postgres客户端安装</h5>
<p>macOS下使用brew安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">brew</span> <span style="color:#f92672">install</span> <span style="color:#f92672">postgres</span>
</code></pre></div><h3 id="执行脚本恢复">执行脚本恢复</h3>
<p>执行如下命令将CSV文件或SQL文件恢复至目标数据库。
命令格式为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">python3 restore_pg<span style="color:#f92672">.</span>py <span style="color:#f92672">&lt;</span>CSV文件或SQL文件路径<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>数据库主机<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>数据库端口<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>数据库账号<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>数据库密码<span style="color:#f92672">&gt;</span>
</code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">python3 restore_pg<span style="color:#f92672">.</span>py <span style="color:#f92672">/</span>exports  <span style="color:#ae81ff">127.0.0.1</span> <span style="color:#ae81ff">5432</span> postgres <span style="color:#ae81ff">123456</span>
</code></pre></div><p>此时，127.0.0.1:5432将会新增数据fooDatabase，表geeker。</p>
<p>Succee。</p>
<h3 id="遇到的问题-数据库名大小写">遇到的问题-数据库名大小写</h3>
<p>由于的数据库名中包含大写【fooDatabase】，在导入的过程中，抛出错误：</p>
<pre tabindex="0"><code>restore structure database
[ERROR]: execute SQL failed. command: 
</code></pre><p>在 PostgreSQL 中，数据库名称默认情况下是不区分大小写的，但是在创建数据库时，如果您使用了双引号引用数据库名称，则 PostgreSQL 会将其视为区分大小写的标识符。</p>
<h4 id="解决方法1-手动修改databasestructuresql">解决方法1： 手动修改Database/structure.sql</h4>
<p>或者手动建库的sql: ./exports/structure.sql</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> fooDatabse;
<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">c</span> fooDatabse;
</code></pre></div><p>修改为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#e6db74">&#34;fooDatabse&#34;</span>;
<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">c</span> fooDatabse;
</code></pre></div><h4 id="解决方法2-修改python脚本">解决方法2： 修改python脚本</h4>
<p>分析一些restore_pg.py ，主要包含了以下方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">create_database：创建数据库。</span>
<span style="color:#ae81ff">create_schema：创建模式。</span>
<span style="color:#ae81ff">import_file_csv：从 CSV 文件导入数据。</span>
<span style="color:#ae81ff">import_file_sql：从 SQL 文件导入数据。</span>
<span style="color:#ae81ff">print_usage：输出脚本使用方法。</span>
<span style="color:#ae81ff">__main__ 脚本的主要逻辑是，遍历备份数据目录，对每个数据库和每个模式执行相应的恢复操作，包括创建数据库、创建模式、创建表和导入数据。在导入数据时，脚本支持从 CSV 文件和 SQL 文件中导入数据。同时，脚本还支持导入表的约束、索引和继承关系等结构信息。</span>

<span style="color:#ae81ff">脚本的运行需要传入 5 个参数，分别是备份数据所在目录、数据库主机名、数据库端口、数据库用户名和数据库密码。如果参数不足 5 个，则会输出使用方法并退出。</span>
</code></pre></div><p>那么显然我们需要修改的是create_database，原始的是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_database</span>(db_host, db_port, db_user, db_pass, db_name, create_stmt_file):
    <span style="color:#66d9ef">if</span> db_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;postgres&#34;</span>:
        <span style="color:#66d9ef">return</span>
    cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PGPASSWORD=&#34;</span> <span style="color:#f92672">+</span> db_pass <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; psql -h&#34;</span> <span style="color:#f92672">+</span> db_host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -p&#34;</span> <span style="color:#f92672">+</span> db_port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -U&#34;</span> <span style="color:#f92672">+</span> db_user <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -d&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;postgres&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &lt;&#34;</span> <span style="color:#f92672">+</span> create_stmt_file
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>system(cmd) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
        print(<span style="color:#e6db74">&#34;[ERROR]: execute SQL failed. command: &#34;</span> <span style="color:#f92672">+</span> cmd)
        exit(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>要修改上面的 Python 代码以区分大小写地创建数据库，您需要在使用 psql 命令创建数据库时将数据库名称用双引号引用起来。以下是修改后的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_database</span>(db_host, db_port, db_user, db_pass, db_name, create_stmt_file):
    <span style="color:#66d9ef">if</span> db_name<span style="color:#f92672">.</span>lower() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;postgres&#34;</span>:  <span style="color:#75715e"># 将 db_name 转换为小写，以便检查是否为 &#34;postgres&#34;</span>
        <span style="color:#66d9ef">return</span>
    cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;PGPASSWORD=&#34;&#39;</span> <span style="color:#f92672">+</span> db_pass <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34; psql -h &#39;</span> <span style="color:#f92672">+</span> db_host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; -p &#39;</span> <span style="color:#f92672">+</span> db_port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; -U &#39;</span> <span style="color:#f92672">+</span> db_user <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; -d postgres -c &#34;CREATE DATABASE </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;&#39;</span> <span style="color:#f92672">+</span> db_name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;;&#34;&#39;</span>
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>system(cmd) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
        print(<span style="color:#e6db74">&#34;[ERROR]: execute SQL failed. command: &#34;</span> <span style="color:#f92672">+</span> cmd)
        exit(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>完成脚本上传到：<a href="https://github.com/easytking/database/blob/main/restore_pg.py">https://github.com/easytking/database/blob/main/restore_pg.py</a></p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://blog.csdn.net/liumiaocn/article/details/108314207">PostgreSQL：客户端安装</a></li>
<li><a href="https://help.aliyun.com/document_detail/96774.html?spm=a2c4g.456306.0.0.14f359aeqChZwi#section-ojf-3ux-3no">RDS 下载备份</a></li>
<li><a href="https://help.aliyun.com/document_detail/456306.html?spm=5176.19908310.0.0.236b1450fV0OvI">RDS PostgreSQL CSV或SQL文件恢复到自建数据库</a></li>
<li><a href="https://github.com/easytking/database/blob/main/restore_pg.py">https://github.com/easytking/database/blob/main/restore_pg.py</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/rds-postgresql%E5%A4%87%E4%BB%BDsql%E6%81%A2%E5%A4%8D%E5%88%B0mac%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BA%93/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/" aria-label="">
      
          Sealos V4.2.2删除再增加节点失败
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-07-02T14:47:46&#43;08:00">
        
   2, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>sealos安装的Kubernetes集群，删除后增加节点失败。</p>
</blockquote>
<pre tabindex="0"><code>Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
</code></pre><p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>Ubuntu</td>
</tr>
<tr>
<td>sealos</td>
<td>v4.2.2</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
</tbody>
</table>
<h3 id="问题1文件时md5校验失败">问题1：文件时md5校验失败</h3>
<p>操作步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">sealos</span> <span style="color:#f92672">delete</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span> 
<span style="color:#f92672">sealos</span> <span style="color:#f92672">add</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span> 
</code></pre></div><p>执行报错:</p>
<pre tabindex="0"><code>sha256 sum not match
</code></pre><p>Sealos 的 &ndash;debug 参数是一个全局参数，用于开启调试模式，以便在出现问题时能更详细地了解系统的运行情况。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">sealos</span> <span style="color:#f92672">add</span> <span style="color:#f92672">--nodes</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">X</span>  <span style="color:#f92672">--debug</span>
</code></pre></div><p>Sealos传输文件时比较md5查看是否报错，issues给了一个解决办法：可以关闭校验。</p>
<pre tabindex="0"><code>#  export SEALOS_SCP_CHECKSUM=false
</code></pre><p>修改完，出现了另外一个问题：</p>
<h3 id="问题2sealctl-增加host失败">问题2：sealctl 增加host失败</h3>
<pre tabindex="0"><code>Error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.Master --domain sealos.hub on 10.0.0.Node:22, output: , error: Process exited with status 139 from signal SEGV,
</code></pre><p> debug模式查看详细</p>
<pre tabindex="0"><code>2023-06-28T09:56:43 debug show registry info, IP: 10.0.0.X:22, Domain: sealos.hub, Data: /var/lib/registry2023-06-28T09:56:43 debug start to exec /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:222023-06-28T09:56:44 error Applied to cluster error: failed to add hosts: run command /var/lib/sealos/data/default/rootfs/opt/sealctl hosts add --ip 10.0.0.X --domain sealos.hub on 10.0.0.M:22, output: , error: Process exited with status 139 from signal SEGV,2023-06-28T09:56:44 debug save objects into local: /root/.sealos/default/Clusterfile, objects: [apiVersion: apps.sealos.io/v1beta1kind: Cluster
</code></pre><p>可见，是seactl执行&quot;sealctl hosts add &ndash;ip 10.0.0.X &ndash;domain sealos.hub&quot; 失败。此文件是从master拷贝过来的：</p>
<pre tabindex="0"><code>/var/lib/containers/storage/overlay/5dd64dde7bc046cfd7554458e2950c41c0d86536e4e96532cfa2ee60685404d4/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:40 debug remote copy files src /var/lib/containers/storage/overlay/44ce75c1b3e483c61ecfbc07a72f87da8627ce40d9df9451f2d04dfad8dffc65/merged/opt to dst /var/lib/sealos/data/default/rootfs/opt2023-06-28T09:56:42 debug remote copy files src
</code></pre><p>我们试着手动拷贝过去，执行是正常的。初步判断是传输的文件出错 ,issure沟通,建议试着“scp进程可能有问题，比较md5查看是否有问题。export SEALOS_SCP_CHECKSUM = true”，还是出现 &ldquo;sha256 sum not match&rdquo;。无效。</p>
<h3 id="解决">解决</h3>
<p>这个v4.2.2 的一个bug，希望下个版本能修复。最终一个临时处理办法：重置集群</p>
<pre tabindex="0"><code># sealos reset 
</code></pre><p>我尝试重置集群，再加入node是可行的。</p>
<h3 id="小结">小结</h3>
<p>本文主要记录排查、解决【sealos-v4.2.2删除节点后再增加节点失败】的过程，原因sealos的版本v4.2.2 问题，，其一，旧版本在拷贝seactl文件到node时会抛出失败：sha256比较文件时，经排查判断是传输过程文件出错了。其二,可以临时通过重置集群来恢复。  希望对你有所帮助。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://sealos.io/docs/lifecycle-management/reference/sealos/commands/#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4"> sealos env 命令 </a></li>
<li><a href="https://github.com/labring/sealos/issues/2605"> sha256 not match</a></li>
<li><a href="https://github.com/labring/sealos/issues/3413"> sealos delete &ndash;nodes XXX sealos add &ndash;nodes XXX failed </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/07/sealos-v4.2.2%E5%88%A0%E9%99%A4%E5%86%8D%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/" aria-label="">
      
          K8s安装metrics Server
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-23T18:17:24&#43;08:00">
        
   23, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Metrics Server是一个可扩展的、高效的容器资源度量源，用于Kubernetes内置的自动伸缩管道。</p>
<p>kubectl top 可以查看node、pod 的实时资源使用情况：如CPU、内存。但需要预装 Metrics Server ，不然会出现如下错误提示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">kubectl</span> <span style="color:#f92672">top</span> <span style="color:#f92672">pods</span>
<span style="color:#f92672">error</span><span style="color:#f92672">:</span> <span style="color:#f92672">Metrics</span> <span style="color:#f92672">API</span> <span style="color:#f92672">not</span> <span style="color:#f92672">available</span>
</code></pre></div><p>Metrics Server 从 Kubelet 收集资源指标，并通过Metrics API在 Kubernetes apiserver 中公开， 以供Horizo​​ntal Pod Autoscaler和Vertical Pod Autoscaler使用。指标 API 也可以通过 访问kubectl top，从而更容易调试自动缩放管道。</p>
<p>今天主要介绍安装的过程，以及记录安装过程遇到一些问题。</p>
<h3 id="开始安装">开始安装</h3>
<p>这里我们采用官网给的清单 components.yaml安装最新的 Metrics Server 版本:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">kubectl</span> <span style="color:#f92672">apply</span> <span style="color:#f92672">-f</span> <span style="color:#f92672">https</span><span style="color:#f92672">://</span><span style="color:#f92672">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#f92672">kubernetes-sigs</span><span style="color:#f92672">/</span><span style="color:#f92672">metrics-server</span><span style="color:#f92672">/</span><span style="color:#f92672">releases</span><span style="color:#f92672">/</span><span style="color:#f92672">latest</span><span style="color:#f92672">/</span><span style="color:#f92672">download</span><span style="color:#f92672">/</span><span style="color:#f92672">components</span>.<span style="color:#a6e22e">yaml</span>
</code></pre></div><p>查看是否安装成功:</p>
<pre tabindex="0"><code># kubectl get deployment metrics-server -n kube-system
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
metrics-server   0/1     1            0           118s
</code></pre><p>发现安装失败。</p>
<h3 id="问题1镜像拉取失败">问题1：镜像拉取失败</h3>
<p>查看pod详细信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">get</span> <span style="color:#f92672">pod</span>  <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">NAME</span>                              <span style="color:#f92672">READY</span>   <span style="color:#f92672">STATUS</span>         <span style="color:#f92672">RESTARTS</span>      <span style="color:#f92672">AGE</span>
<span style="color:#f92672">metrics-server-55c774cdbb-jmfz8</span>   <span style="color:#f92672">0</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>     <span style="color:#f92672">ErrImagePull</span>   <span style="color:#f92672">0</span>             <span style="color:#f92672">2m34s</span>
</code></pre></div><p>查看pod日志:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">logs</span> <span style="color:#f92672">pods</span><span style="color:#f92672">/</span><span style="color:#f92672">metrics-server-55c774cdbb-jmfz8</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">Error</span> <span style="color:#f92672">from</span> <span style="color:#f92672">server</span> <span style="color:#f92672">(</span><span style="color:#f92672">BadRequest</span><span style="color:#f92672">):</span> <span style="color:#f92672">container</span> <span style="color:#e6db74">&#34;metrics-server&#34;</span> <span style="color:#f92672">in</span> <span style="color:#f92672">pod</span> <span style="color:#e6db74">&#34;metrics-server-55c774cdbb-jmfz8&#34;</span> <span style="color:#f92672">is</span> <span style="color:#f92672">waiting</span> <span style="color:#f92672">to</span> <span style="color:#f92672">start</span><span style="color:#f92672">:</span> <span style="color:#f92672">trying</span> <span style="color:#f92672">and</span> <span style="color:#f92672">failing</span> <span style="color:#f92672">to</span> <span style="color:#f92672">pull</span> <span style="color:#f92672">image</span>
</code></pre></div><p>从日志可知是镜像拉取不下来，我们可以修改镜像地址。可以从dockerhub，查找最新版本，如作者安装的版本是：metrics-server:v0.6.1。打开components.yaml , 修改Deployment，spec.containers.coimage 为搜索到的，如“registry.aliyuncs.com/google_containers/metrics-server:v0.6.1&quot;,修改完详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">args</span>:
        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
        - --<span style="color:#ae81ff">secure-port=4443</span>
        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
        - --<span style="color:#ae81ff">metric-resolution=15s</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.aliyuncs.com/google_containers/metrics-server:v0.6.1</span>
</code></pre></div><p>更新部署deployment：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">delete</span>  <span style="color:#f92672">deployment</span> <span style="color:#f92672">metrics-server</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">deployment</span>.<span style="color:#a6e22e">apps</span> <span style="color:#e6db74">&#34;metrics-server&#34;</span> <span style="color:#f92672">deleted</span>

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">kubectl</span> <span style="color:#f92672">apply</span> <span style="color:#f92672">-f</span> <span style="color:#f92672">components</span>.<span style="color:#a6e22e">yaml</span>
</code></pre></div><h3 id="问题2证书">问题2：证书</h3>
<p>更新后，发现另外一个问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">server</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">132</span><span style="color:#f92672">]</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fully</span> <span style="color:#f92672">scrape</span> <span style="color:#f92672">metrics</span><span style="color:#f92672">:</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fully</span> <span style="color:#f92672">scrape</span> <span style="color:#f92672">metrics</span> <span style="color:#f92672">from</span> <span style="color:#f92672">node</span> <span style="color:#f92672">docker-desktop</span><span style="color:#f92672">:</span> <span style="color:#f92672">unable</span> <span style="color:#f92672">to</span> <span style="color:#f92672">fetch</span> <span style="color:#f92672">metrics</span> <span style="color:#f92672">from</span> <span style="color:#f92672">node</span> <span style="color:#f92672">docker-desktop</span><span style="color:#f92672">:</span> <span style="color:#f92672">Get</span> <span style="color:#e6db74">&#34;https://192.168.1.88:10250/stats/summary?only_cpu_and_memory=true&#34;</span><span style="color:#f92672">:</span> <span style="color:#f92672">x509</span><span style="color:#f92672">:</span> <span style="color:#f92672">cannot</span> <span style="color:#f92672">validate</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">for</span> <span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">88</span> <span style="color:#f92672">because</span> <span style="color:#f92672">it</span> <span style="color:#f92672">doesn</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">t</span> <span style="color:#f92672">contain</span> <span style="color:#f92672">any</span> <span style="color:#f92672">IP</span> <span style="color:#f92672">SANs</span>
</code></pre></div><p>从日志可知是权限验证（证书）出了问题，通过搜索github issues ，issue回复里提供了一个解决方法是在可以关闭证书验证，详细如下：</p>
<p>修改清单components.yam, 增加：</p>
<pre tabindex="0"><code>- --kubelet-insecure-tls
</code></pre><p>修改完 Deplyment详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">args</span>:
        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
        - --<span style="color:#ae81ff">secure-port=4443</span>
        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
        - --<span style="color:#ae81ff">kubelet-insecure-tls</span>
        - --<span style="color:#ae81ff">metric-resolution=15s</span>
</code></pre></div><p>其中：</p>
<blockquote>
<p>&ndash;kubelet-preferred-address-types：
优先使用 InternalIP 来访问 kubelet，这样可以避免节点名称没有 DNS 解析记录时，通过节点名称调用节点 kubelet API 失败的情况（未配置时默认的情况）；</p>
<p>&ndash;kubelet-insecure-tls：
kubelet 的 10250 端口使用的是 https 协议，连接需要验证 tls 证书。&ndash;kubelet-insecure-tls 不验证客户端证书。</p>
</blockquote>
<p>然后，检查是否启动成功：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">#kubectl <span style="color:#f92672">get</span> <span style="color:#f92672">deployment</span> <span style="color:#f92672">metrics-server</span> <span style="color:#f92672">-n</span> <span style="color:#f92672">kube-system</span>
<span style="color:#f92672">NAME</span>             <span style="color:#f92672">READY</span>   <span style="color:#f92672">UP-TO-DATE</span>   <span style="color:#f92672">AVAILABLE</span>   <span style="color:#f92672">AGE</span>
<span style="color:#f92672">metrics-server</span>   <span style="color:#f92672">1</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>     <span style="color:#f92672">1</span>            <span style="color:#f92672">1</span>           <span style="color:#f92672">14m</span>
</code></pre></div><p>success。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/kubernetes-sigs/metrics-server"> 官网 </a></li>
<li><a href="https://cloud.tencent.com/developer/article/1818865"> 容器 &amp; 服务：metrics-server 安装探索   </a></li>
<li><a href="https://github.com/kubernetes-sigs/metrics-server/issues/131"> github issues 关闭证书  </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/k8s%E5%AE%89%E8%A3%85metrics-server/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/" aria-label="">
      
          导入k8s集群到rancher报错no Secret Assigned to Service Account Cattle System
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-18T15:30:58&#43;08:00">
        
   18, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>在导入外部集群到rancher时，cattle-cluster-agent报错</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">level</span><span style="color:#f92672">=</span><span style="color:#f92672">fatal</span> <span style="color:#f92672">msg</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;looking up cattle-system/cattle ca/token: no secret exists for service account cattle-system/cattle&#34;</span>
</code></pre></div><p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes</td>
<td>v1.25.7</td>
</tr>
<tr>
<td>Rancher</td>
<td>v2.6.6</td>
</tr>
</tbody>
</table>
<h3 id="解决">解决</h3>
<p>经查，K8s在版本v1.24启用新测试功能特性-LegacyServiceAccountTokenNoAutoGeneration，默认是开启的。</p>
<blockquote>
<p>服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的持有者令牌来验证请求。</p>
<p>服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。</p>
</blockquote>
<p>我们可以通过k8s 组件上指定的各种特性开关控制 -
【特性门控是描述 Kubernetes 特性的一组键值对。你可以在 Kubernetes 的各个组件中使用 &ndash;feature-gates 标志来启用或禁用这些特性。】
关闭该特性：</p>
<p>打开 /etc/kubernetes/manifest/kube-controller-manager.yml的
spec.container.command中增加</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">-</span> <span style="color:#f92672">--feature-gates</span><span style="color:#f92672">=</span><span style="color:#f92672">LegacyServiceAccountTokenNoAutoGeneration</span><span style="color:#f92672">=</span><span style="color:#f92672">false</span>
</code></pre></div><p>修改完，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">creationTimestamp</span>: <span style="color:#66d9ef">null</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">kube-controller-manager</span>
    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">control-plane</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-controller-manager</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">command</span>:
    - <span style="color:#ae81ff">kube-controller-manager</span>
    - --<span style="color:#ae81ff">allocate-node-cidrs=true</span>
    - --<span style="color:#ae81ff">authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">bind-address=0.0.0.0</span>
    - --<span style="color:#ae81ff">client-ca-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">cluster-cidr=1.2.0.0/10</span>
    - --<span style="color:#ae81ff">cluster-name=kubernetes</span>
    - --<span style="color:#ae81ff">cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span>
    - --<span style="color:#ae81ff">controllers=*,bootstrapsigner,tokencleaner</span>
    - --<span style="color:#ae81ff">feature-gates=EphemeralContainers=true</span>
    - --<span style="color:#ae81ff">kubeconfig=/etc/kubernetes/controller-manager.conf</span>
    - --<span style="color:#ae81ff">leader-elect=true</span>
    - --<span style="color:#ae81ff">requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span>
    - --<span style="color:#ae81ff">root-ca-file=/etc/kubernetes/pki/ca.crt</span>
    - --<span style="color:#ae81ff">service-account-private-key-file=/etc/kubernetes/pki/sa.key</span>
    - --<span style="color:#ae81ff">service-cluster-ip-range=10.88.0.0/22</span>
    - --<span style="color:#ae81ff">use-service-account-credentials=true</span>
    - --<span style="color:#ae81ff">feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false</span>
    <span style="color:#ae81ff">...</span>
</code></pre></div><p>重启 kube-controller-manager，ps：如果是多个master，需要每个都修改。</p>
<h3 id="小结">小结</h3>
<p>本文记录导入外部集群到rancher时，遇到的用户认证密钥不正确的问题。回顾k8s在1.23~1.25的更新日志，以及查阅issues，原因是1.24启用了新测试特性LegacyServiceAccountTokenNoAutoGeneration，该特性使用经过签名的持有者令牌来验证请求。可以通过k8s组件上指定的各种特性开关控制来关闭此特性来解决报错，最终正常导入到rancher。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/feature-gates/"> k8s-features </a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#service-account-tokens">service-account-tokens </a></li>
<li><a href="htps://github.com/rancher/rancher/issues/37027"> issues </a></li>
<li><a href="htps://blog.isweluiz.com.br/2022/09/kubenetes-v1244-rancher-agent-error-no.html"> blog 解决用户secret </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/%E5%AF%BC%E5%85%A5k8s%E9%9B%86%E7%BE%A4%E5%88%B0rancher%E6%8A%A5%E9%94%99no-secret-assigned-to-service-account-cattle-system/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" aria-label="">
      
          Golang实现AES加解密
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-10T21:30:32&#43;08:00">
        
   10, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在数据的传输过程，为了安全，我们需要对其进行加密。加密算法分为双向加密和单向加密。单向加密包括MD5、SHA等摘要算法，它们是不可逆的。双向加密包括对称加密和非对称加密，对称加密包括AES加密、DES加密等。双向加密是可逆的，它使用相同的密钥进行加密和解密。本文主要介绍AES算法以及如何使用golang实现AES加解密。</p>
<h3 id="aes简介">AES简介</h3>
<blockquote>
<p>AES是高级加密标准，在密码学中又称Rijndael加密法，是美国联邦政府采用的一种区块加密标准。这个标准用来替代原先的DES，目前已经被全世界广泛使用，同时AES已经成为对称密钥加密中最流行的算法之一。AES支持三种长度的密钥：128位，192位，256位。</p>
</blockquote>
<p>加解密过程为：字节代替、行移位、列混淆、轮密钥加。</p>
<p>相关概念：</p>
<ol>
<li>
<p>密钥：AES128，AES192，AES256，实际上就是指的AES算法对不同长度密钥的使用</p>
</li>
<li>
<p>分组： 把明文拆分成一个个独立的明文块，每一个明文块长度128bit。加密生成一个个独立的密文块，这些密文块拼接在一起。填充模式有：</p>
<ol>
<li>NoPadding :不做任何填充，但是要求明文必须是16字节的整数倍。</li>
<li>PKCS5Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字符，且每个字节的值等于缺少的字符数。</li>
<li>ISO10126Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字节，最后一个字符值等于缺少的字符数，其他字符填充随机数</li>
</ol>
</li>
<li>
<p>加密模式：</p>
<ol>
<li>电码本模式（Electronic Codebook Book (ECB)） 模式是将整个明文分成若干段相同的小段，然后对每一小段进行加密。</li>
<li>密码分组链接模式（Cipher Block Chaining (CBC)） 模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算，再与密钥进行加密</li>
<li>计算器模式（Counter (CTR)）不常用，在 CTR 模式中， 有一个自增的算子，这个算子用密钥加密之后输出和明文异或的结果得到密文，相当于一次一密</li>
<li>密码反馈模式（Cipher FeedBack (CFB)）不常用</li>
<li>输出反馈模式（Output FeedBack (OFB)）</li>
</ol>
</li>
</ol>
<h3 id="golang实现aes加解密">golang实现AES加解密</h3>
<p>golang使用“crypto/aes”进行AES加解密 。接着我们通过一个使用CBC模式对原文进行加解密的例子来演示如何实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;crypto/aes&#34;</span>
    <span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
    <span style="color:#e6db74">&#34;encoding/base64&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 原始数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)

    <span style="color:#75715e">// 密钥，长度必须为 16、24 或 32 字节(128位，192位，256位)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

    <span style="color:#75715e">// 使用 AES 创建加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        panic(<span style="color:#a6e22e">err</span>)
    }

    <span style="color:#75715e">// 对数据进行填充，使其长度为块大小的整数倍
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

    <span style="color:#75715e">// 创建 CBC 模式的加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>) <span style="color:#75715e">// 初始化向量，长度必须为块大小
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

    <span style="color:#75715e">// 将密文进行 base64 编码
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">encoded</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 解码 base64 编码的密文
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 创建 CBC 模式的解密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> = <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

    <span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decrypted</span>))
}

<span style="color:#75715e">// 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
    <span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
    <span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
    <span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}
</code></pre></div><p>输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">+</span><span style="color:#f92672">HzZQh0Do42Kg1PQsdhdcw</span><span style="color:#f92672">==</span>
<span style="color:#f92672">Hello</span><span style="color:#f92672">,</span> <span style="color:#f92672">world</span><span style="color:#f92672">!</span>
</code></pre></div><p>上例中，分别演示了</p>
<ol>
<li>对加密过程：创建加密对象、原文填充、创建CBC模式，加密。</li>
<li>解密过程： 创建CBC解密模式，解密，去除填充。</li>
</ol>
<p>为了方便使用，我们对上例的加解密进行封装，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/aes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
	<span style="color:#e6db74">&#34;encoding/base64&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)
	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)
	<span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

	<span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

	<span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decoded</span>))
}

<span style="color:#75715e">// AesCBCEncrypt 使用 AES CBC 模式加密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// AesCBCDecrypt 使用 AES CBC 模式解密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">ciphertext</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">ciphertext</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">decoded</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;ciphertext is not a multiple of the block size&#34;</span>)
	}

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

	<span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decrypted</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// PKCS5Padding 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
	<span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
	<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// PKCS5UnPadding 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
	<span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}

</code></pre></div><h3 id="总结">总结</h3>
<p>本文主要介绍对称加密算法AES，AES使用不同指定长度的密钥，对原文进行分组，可选用更安全的加密模式CBC。在 golang中，可以使用“crypto/aes”快速实现原文填充、加密模式、加密、解密、去除填充等AES加解密过程。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/golang/crypto">golang/crypto</a></li>
<li><a href="https://xie.infoq.cn/article/1b405dfbe6d0acf06dea0f9f6">AES加密模式</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023025778520640">NodeJs-AES加密</a></li>
<li><a href="https://overstarry.vip/posts/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BD%BF%E7%94%A8aes%E5%8A%A0%E5%AF%86%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE/">前后端使用aes加密传输数据</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/562256846">什么是AES加密？详解AES加密算法原理流程</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" aria-label="">
      
          Kubernetes集群image-cri-him大量端口占用
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-27T18:11:54&#43;08:00">
        
   27, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>sealos安装的Kubernetes集群，master节点出现大量端口占用。</p>
</blockquote>
<p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>Ubuntu</td>
</tr>
<tr>
<td>sealos</td>
<td>v4.1.7</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.23.9</td>
</tr>
</tbody>
</table>
<h3 id="排查问题">排查问题</h3>
<p>按照本地端口对输出进行排序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">netstat</span> <span style="color:#f92672">-anp</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">ESTABLISHED</span> <span style="color:#f92672">|</span> <span style="color:#f92672">awk</span> <span style="color:#e6db74">&#39;{print $4}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">|</span> <span style="color:#f92672">uniq</span> <span style="color:#f92672">-c</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">-n</span>
    <span style="color:#f92672">28</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">6443</span>
    <span style="color:#f92672">111</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">2379</span>
  <span style="color:#f92672">9009</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">5000</span>
</code></pre></div><p>查找本地端口对应的应用程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">  <span style="color:#f92672">lsof</span> <span style="color:#f92672">-i</span> :<span style="color:#a6e22e">5000</span>
  <span style="color:#f92672">image-cri</span> <span style="color:#f92672">2811249</span> <span style="color:#f92672">root</span> <span style="color:#f92672">4120u</span>  <span style="color:#f92672">IPv4</span> <span style="color:#f92672">291818320</span>      <span style="color:#f92672">0t0</span>  <span style="color:#f92672">TCP</span> <span style="color:#f92672">master1</span>:<span style="color:#a6e22e">41710-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">master1</span>:<span style="color:#a6e22e">5000</span> <span style="color:#f92672">(</span><span style="color:#f92672">ESTABLISHED</span><span style="color:#f92672">)</span>
</code></pre></div><p>可见，是image-cri-shim占用的端口数。</p>
<h3 id="image-cri-shim-工作原理">image-cri-shim 工作原理</h3>
<blockquote>
<p>image-cri-shim 是一个基于 CRI (Container Runtime Interface) 和 kubelet 的 gRPC (Google Remote Procedure Call) shim。CRI 是 Kubernetes 中用于与容器运行时进行交互的接口，而 kubelet 是负责维护容器运行状态和节点级别的资源管理的 Kubernetes 组件。</p>
</blockquote>
<p>常用操作:</p>
<ul>
<li>启动服务： systemctl start image-cri-shim</li>
<li>停止服务： systemctl stop image-cri-shim</li>
<li>重启服务： systemctl restart image-cri-shim</li>
<li>查看服务状态： systemctl status image-cri-shim</li>
<li></li>
<li>参考日志:  journalctl -u image-cri-shim -f</li>
</ul>
<h3 id="重现问题">重现问题</h3>
<ol>
<li>
<p>在测试环境安装相同版本的sealos版本4.1.7，这里就不赘述，可以参考(<a href="https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle">https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle</a>)</p>
</li>
<li>
<p>安装好之后，发现image-cri-shim的版本（4.1.3）不对，</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">--version</span>
<span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">3-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>更新image-cri-shim版本为4.1.7</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.1.7/sealos_4.1.7_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.1.7_linux_amd64.tar.gz.1 image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出类似以下内容，表示成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">102</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>启动后，观察日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="4">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">netstat -na | grep <span style="color:#ae81ff">5000</span> | wc -l
<span style="color:#ae81ff">96</span>
<span style="color:#ae81ff">116</span>
<span style="color:#ae81ff">120</span>
...
</code></pre></div><ol start="5">
<li>可见，每个5分钟，占用的端口数就增加20左右。问题复现了，接着我们来看看怎么处理。</li>
</ol>
<h3 id="更新版本为420">更新版本为4.2.0</h3>
<p>从sealos的github的issues有提供一个修复方案：升级image-cri-shim的版本为4.2.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.2.0/sealos_4.2.0_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.2.0_linux_amd64.tar.gz image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出如下，表示成功：</p>
<pre tabindex="0"><code>image-cri-shim version 4.2.0-f696a621
192.168.1.101:22: image-cri-shim version 4.2.0-f696a621
192.168.1.102:22: image-cri-shim version 4.2.0-f696a621
</code></pre><h3 id="观察是否已修复">观察是否已修复</h3>
<ol>
<li>观察inamge-cri-shim日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">Timeout</span><span style="color:#f92672">:</span> {<span style="color:#f92672">15m0s</span>}
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criRegistryAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criOfflineAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">:</span>{Username:admin Password<span style="color:#f92672">:</span>passw0rd Auth<span style="color:#f92672">:</span> Email<span style="color:#f92672">:</span> ServerAddress<span style="color:#f92672">:</span>http<span style="color:#f92672">://</span>sealos<span style="color:#f92672">.</span>hub<span style="color:#f92672">:</span><span style="color:#ae81ff">5000</span> IdentityToken<span style="color:#f92672">:</span> RegistryToken<span style="color:#f92672">:</span>}<span style="color:#f92672">]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">socket</span> <span style="color:#f92672">info</span> <span style="color:#f92672">shim</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">var</span><span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">image-cri-shim</span>.<span style="color:#a6e22e">sock</span> <span style="color:#f92672">,</span><span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span>.<span style="color:#a6e22e">sock</span><span style="color:#f92672">,</span> <span style="color:#f92672">registry</span><span style="color:#f92672">:</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">ownership</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">root</span><span style="color:#f92672">/</span><span style="color:#f92672">root</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">permissions</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">-rw-rw----</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="2">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">netstat</span> <span style="color:#f92672">-na</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">5000</span> <span style="color:#f92672">|</span> <span style="color:#f92672">wc</span> <span style="color:#f92672">-l</span>
<span style="color:#f92672">1</span> 
<span style="color:#f92672">6</span> 
<span style="color:#f92672">1</span>
</code></pre></div><ol start="3">
<li>可见，请求是还有，但并没有增加端口数，看来问题修复了。</li>
</ol>
<p>ps： 我们重现问题的Kubenetes版本是v1.23.9，在实际开发中发现其他版本的v1.25.7也会出现类似问题，验证此版本待后续更新。</p>
<h3 id="小结">小结</h3>
<p>本文主要记录排查、复现、处理【sealos安装的Kubenetes集群master节点大量占用端口】的过程，原因系image-cri-shim的版本问题，旧版本会频繁请求master，导致创建大量的连接，占用端口数。通过升级image-cri-shim版本可以解决该问题。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://sealos.io/zh-Hans/docs/design/image-cri-shim"> sealos Doc： image-cri-shim 介绍</a></li>
<li><a href="https://github.com/labring/sealos/issues/2965"> 为什么sealos4.2部分的群，注册表库连接数很高 </a></li>
<li><a href="https://github.com/labring/sealos/issues/3052"> BUG: image-cri-shim导致端口大量占用，耗尽服务器socket资源 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0nginx-proxy-manager%E5%85%A5%E9%97%A8/" aria-label="">
      
          Nginx可视化管理平台Nginx Proxy Manager入门
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-21T15:51:14&#43;08:00">
        
   21, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/dockers">Dockers</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Nginx-Proxy-Manager 是Nginx  Web GUI( 可视化管理界面)，为新手快速设置反向代理提供帮助。
它的主要目标是：</p>
<blockquote>
<p>我创建这个项目是为了满足个人需要，为用户提供一种简单的方法来完成带有 SSL 终止的反向代理主机，而且它必须非常简单，以至于猴子都能做到。这个目标没有改变。虽然可能有高级选项，但它们是可选的，并且项目应该尽可能简单，以便进入这里的门槛很低。</p>
</blockquote>
<h3 id="feature">feature</h3>
<p>它主要的功能包括以下几个：</p>
<ul>
<li>基于Tabler的美观安全的管理界面</li>
<li>在对 Nginx 一无所知的情况下轻松创建转发域、重定向、流和 404 主机</li>
<li>使用 Let&rsquo;s Encrypt 的免费 SSL 或提供您自己的自定义 SSL 证书</li>
<li>主机的访问列表和基本 HTTP 身份验证</li>
<li>超级用户可用的高级 Nginx 配置</li>
<li>用户管理、权限和审计日志</li>
</ul>
<h3 id="安装">安装</h3>
<p>这里我们Docker Compose安装启动。</p>
<ol>
<li>你需要预先安装了Docker Compose 环境。</li>
<li>创建docker-compose.yml</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.8&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">app</span>:
    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#39;jc21/nginx-proxy-manager:latest&#39;</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#39;8080:80&#39;</span>
      - <span style="color:#e6db74">&#39;81:81&#39;</span>
      - <span style="color:#e6db74">&#39;8443:443&#39;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">./data:/data</span>
      - <span style="color:#ae81ff">./letsencrypt:/etc/letsencrypt</span>
</code></pre></div><ol start="3">
<li>启动</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">docker-compose</span> <span style="color:#f92672">-d</span>
</code></pre></div><ol start="4">
<li>Dashboard</li>
</ol>
<p>访问web界面 http://127.0.0.1:81</p>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_login.png" alt=""></p>
<p>这么默认的用户名和密码是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">Email</span><span style="color:#f92672">:</span>    <span style="color:#f92672">admin</span>@<span style="color:#66d9ef">example</span>.<span style="color:#a6e22e">com</span>
<span style="color:#f92672">Password</span><span style="color:#f92672">:</span> <span style="color:#f92672">changeme</span>
</code></pre></div><p>登入后，按提示重新设置用户名、密码即可。</p>
<ol start="5">
<li>主页面 home page</li>
</ol>
<p>如成功登入，可以看到主页面如下：</p>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_home.png" alt=""></p>
<h3 id="实战-反向代理nginx-proxy-manage后台">实战 ：反向代理Nginx-Proxy-Manage后台</h3>
<p>如上述中，我们通过81端口可以访问GUI，下面，我们将通过反向代理，可以直接通过 http://your-site:8080即可访问GUI。</p>
<ol>
<li>点击 【Proxy Hosts】,在界面Details选项添加如下图所示：</li>
</ol>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_details.png" alt=""></p>
<ol start="2">
<li>访问 http://your-site:8080
<img src="https://luckytking.github.io/images/nginx_proxy_manager_test_ok.png" alt=""></li>
</ol>
<p>说明成功了</p>
<ol start="3">
<li>
<p>如果想要关闭代理，点击编辑【Proxy Host】 的 Enable，详细如下
<img src="https://luckytking.github.io/images/nginx_proxy_manager_enable.png" alt=""></p>
</li>
<li>
<p>再访问，会跳出404界面
<img src="https://luckytking.github.io/images/nginx_proxy_manager_disable.png" alt=""></p>
</li>
</ol>
<p>以上。</p>
<h3 id="小结">小结</h3>
<p>本文主要简介Nginx可视化管理平台Nginx-Proxy-Manager及主要功能，为配置强大Nginx代理功能降低门槛。通过一个实战案例：代理Manager后台，演示了基础使用方法。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://nginxproxymanager.com"> 官网 </a></li>
<li><a href="https://mp.weixin.qq.com/s/gGoQGsuFVKemPNQ4Zfx4Hw">Blog:
超强大的 Nginx 可视化管理平台 Nginx-Proxy-Manager 中文入门指南 </a></li>
<li><a href="https://sspai.com/post/76910">Blog:
Nginx Proxy Manager - Docker 建站最佳伴侣 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0nginx-proxy-manager%E5%85%A5%E9%97%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8Fflyweight/" aria-label="">
      
          设计模式  享元模式flyweight
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-14T16:06:36&#43;08:00">
        
   14, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍享元模式基础概念、实现原理和通过一个棋牌游戏例子简述实现过程。</p>
<h3 id="享元模式">享元模式</h3>
<p>所谓“享元”，顾名思义就是被共享的单元。享元模式的意图是复用对象，节省内存，前提是享元对象是不可变对象。
具体来讲，当一个系统中存在大量重复对象的时候，如果这些重复的对象是不可变对象，我们就可以利用享元模式将对象设计成享元，在内存中只保留一份实例，供多处代码引用。</p>
<p>享元的实现并不复杂，通过工厂模式，通过一个 Map 来缓存已经创建过的享元对象，来达到复用的目的。
其中：</p>
<ul>
<li>Flyweight ： 享元类包含原始对象中部分能在多个对象中共享的状态。</li>
<li>FlyweightFactory：享元工厂，会对已有享元的缓存池进行管理。</li>
</ul>
<p>接着，我们通过一个棋牌游戏的案例来演示。</p>
<h3 id="案例-棋牌游戏">案例-棋牌游戏</h3>
<p>这里以象棋为例，游戏大厅中有N个房间，那么每个房间会有一个棋局对象，和X个（将、相、士、炮）棋子对象。以下是go的具体实现flyweight.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChessPiece</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Color</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">PositionX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">PositionY</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChessBoard</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Cards</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChessBoard</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ChessBoard</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ChessBoard</span>{
		<span style="color:#a6e22e">Cards</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{
			<span style="color:#ae81ff">1</span>: {
				<span style="color:#a6e22e">Name</span>:      <span style="color:#e6db74">&#34;車&#34;</span>,
				<span style="color:#a6e22e">Color</span>:     <span style="color:#e6db74">&#34;紅&#34;</span>,
				<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">1</span>,
				<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">11</span>,
			},
			<span style="color:#ae81ff">2</span>: {
				<span style="color:#a6e22e">Name</span>:      <span style="color:#e6db74">&#34;馬&#34;</span>,
				<span style="color:#a6e22e">Color</span>:     <span style="color:#e6db74">&#34;黑&#34;</span>,
				<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">2</span>,
				<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">2</span>,
			},
		},
		<span style="color:#75715e">// 其他棋子
</span><span style="color:#75715e"></span>	}
}


</code></pre></div><p>开N个房间flyweight_test.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewChessBoard</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">game1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewChessBoard</span>()
	<span style="color:#a6e22e">game2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewChessBoard</span>()
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game1</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game2</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game1</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">game2</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>=== RUN   TestNewChessBoard
    flyweight_test.go:15: &amp;{車 紅 1 11}
    flyweight_test.go:16: &amp;{車 紅 1 11}
    flyweight_test.go:17: false
--- PASS: TestNewChessBoard (0.00s)
</code></pre><p>例中，每创建一个棋局就需要初始化对应的棋子，如果游戏大厅有百万人同时在线 ，那保存这么多棋局对象就会消耗大量的内存。</p>
<h3 id="使用享元模式重构">使用享元模式重构</h3>
<p>如何对上例进行优化呢，从例子中，每个大厅存在大量重复对象棋牌，利用享元模式把棋牌设计成共享的（map）详细如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">chessPieceUnit</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{
	<span style="color:#ae81ff">1</span>: {
		<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;車&#34;</span>,
		<span style="color:#a6e22e">Color</span>: <span style="color:#e6db74">&#34;紅&#34;</span>,
		<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">11</span>,
	},
	<span style="color:#ae81ff">2</span>: {
		<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;馬&#34;</span>,
		<span style="color:#a6e22e">Color</span>: <span style="color:#e6db74">&#34;黑&#34;</span>,
		<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">2</span>,
	},
	<span style="color:#75715e">// 其他棋子
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChessPieceUnitFactory</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ChessBoard</span> {
	<span style="color:#a6e22e">board</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ChessBoard</span>{<span style="color:#a6e22e">Cards</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{}}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">chessPieceUnit</span> {
		<span style="color:#a6e22e">board</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">chessPieceUnit</span>[<span style="color:#a6e22e">id</span>]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">board</span>
}
</code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">===</span> <span style="color:#f92672">RUN</span>   <span style="color:#f92672">TestNewChessPieceUnitFactory</span>
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">13</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>{<span style="color:#960050;background-color:#1e0010">車</span> <span style="color:#960050;background-color:#1e0010">紅</span> <span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#960050;background-color:#1e0010">11</span>}
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">14</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>{<span style="color:#960050;background-color:#1e0010">車</span> <span style="color:#960050;background-color:#1e0010">紅</span> <span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#960050;background-color:#1e0010">11</span>}
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">15</span><span style="color:#f92672">:</span> <span style="color:#f92672">true</span>
<span style="color:#f92672">---</span> <span style="color:#f92672">PASS</span><span style="color:#f92672">:</span> <span style="color:#f92672">TestNewChessPieceUnitFactory</span> <span style="color:#f92672">(</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">00s</span><span style="color:#f92672">)</span>
</code></pre></div><p>例中，通过一个ChessPieceUnit来缓存一个ChessBoard棋局的30+个ChessPiece棋子对象。原本如果是1万个ChessBoard棋局，需要创建【1万乘30】约30万个棋子对象。现在通过共享同一个ChessPieceUnit，那么需要创建约【30】个对象，大大节省了内存。</p>
<h3 id="参考">参考</h3>
<ul>
<li>设计模式之美 <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8Fflyweight/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>


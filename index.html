<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/luckytking.github.io\/",
  "author": {
    "@type": "Person",
    "name": "jefffff",
    
    "image": "https://luckytking.github.io/images/tk.jpg"
    
  },
  "name":"jefffff\u0027s Blog",
  "description":"",
  "url":"https:\/\/luckytking.github.io\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.89.2 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="jefffff">
<meta name="keywords" content="">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:title" content="jefffff&#39;s Blog">
<meta name="twitter:title" content="jefffff&#39;s Blog">
<meta property="og:url" content="https://luckytking.github.io/">
<meta property="twitter:url" content="https://luckytking.github.io/">
<meta property="og:site_name" content="jefffff&#39;s Blog">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="en">


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@none">


  <meta name="twitter:creator" content="@none">






  <meta property="og:image" content="https://luckytking.github.io/images/tk.jpg">
  <meta property="twitter:image" content="https://luckytking.github.io/images/tk.jpg">






    <title>jefffff&#39;s Blog</title>

    <link rel="icon" href="https://luckytking.github.io/favicon.jpg">
    
      <link rel="alternate" type="application/rss+xml" title="RSS" href="https://luckytking.github.io/index.xml">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;thibaudlepretre">
    

    <link rel="canonical" href="https://luckytking.github.io/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://luckytking.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://luckytking.github.io/" aria-label="">jefffff&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon open-algolia-search"
         href="https://luckytking.github.io/#search" aria-label="">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://luckytking.github.io/#about" aria-label="">
          <img class="sidebar-profile-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
        </a>
        <h4 class="sidebar-profile-name">jefffff</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/luckytking" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://luckytking.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <section class="postShorten-group main-content-wrap">
          
          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" aria-label="">
      
          Golang实现AES加解密
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-10T21:30:32&#43;08:00">
        
   10, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在数据的传输过程，为了安全，我们需要对其进行加密。加密算法分为双向加密和单向加密。单向加密包括MD5、SHA等摘要算法，它们是不可逆的。双向加密包括对称加密和非对称加密，对称加密包括AES加密、DES加密等。双向加密是可逆的，它使用相同的密钥进行加密和解密。本文主要介绍AES算法以及如何使用golang实现AES加解密。</p>
<h3 id="aes简介">AES简介</h3>
<blockquote>
<p>AES是高级加密标准，在密码学中又称Rijndael加密法，是美国联邦政府采用的一种区块加密标准。这个标准用来替代原先的DES，目前已经被全世界广泛使用，同时AES已经成为对称密钥加密中最流行的算法之一。AES支持三种长度的密钥：128位，192位，256位。</p>
</blockquote>
<p>加解密过程为：字节代替、行移位、列混淆、轮密钥加。</p>
<p>相关概念：</p>
<ol>
<li>
<p>密钥：AES128，AES192，AES256，实际上就是指的AES算法对不同长度密钥的使用</p>
</li>
<li>
<p>分组： 把明文拆分成一个个独立的明文块，每一个明文块长度128bit。加密生成一个个独立的密文块，这些密文块拼接在一起。填充模式有：</p>
<ol>
<li>NoPadding :不做任何填充，但是要求明文必须是16字节的整数倍。</li>
<li>PKCS5Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字符，且每个字节的值等于缺少的字符数。</li>
<li>ISO10126Padding: 如果明文块少于16个字节（128bit），在明文块末尾补足相应数量的字节，最后一个字符值等于缺少的字符数，其他字符填充随机数</li>
</ol>
</li>
<li>
<p>加密模式：</p>
<ol>
<li>电码本模式（Electronic Codebook Book (ECB)） 模式是将整个明文分成若干段相同的小段，然后对每一小段进行加密。</li>
<li>密码分组链接模式（Cipher Block Chaining (CBC)） 模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算，再与密钥进行加密</li>
<li>计算器模式（Counter (CTR)）不常用，在 CTR 模式中， 有一个自增的算子，这个算子用密钥加密之后输出和明文异或的结果得到密文，相当于一次一密</li>
<li>密码反馈模式（Cipher FeedBack (CFB)）不常用</li>
<li>输出反馈模式（Output FeedBack (OFB)）</li>
</ol>
</li>
</ol>
<h3 id="golang实现aes加解密">golang实现AES加解密</h3>
<p>golang使用“crypto/aes”进行AES加解密 。接着我们通过一个使用CBC模式对原文进行加解密的例子来演示如何实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;crypto/aes&#34;</span>
    <span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
    <span style="color:#e6db74">&#34;encoding/base64&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 原始数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)

    <span style="color:#75715e">// 密钥，长度必须为 16、24 或 32 字节(128位，192位，256位)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

    <span style="color:#75715e">// 使用 AES 创建加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        panic(<span style="color:#a6e22e">err</span>)
    }

    <span style="color:#75715e">// 对数据进行填充，使其长度为块大小的整数倍
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

    <span style="color:#75715e">// 创建 CBC 模式的加密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>) <span style="color:#75715e">// 初始化向量，长度必须为块大小
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

    <span style="color:#75715e">// 将密文进行 base64 编码
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">encoded</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 解码 base64 编码的密文
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">encoded</span>)

    <span style="color:#75715e">// 创建 CBC 模式的解密算法对象
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mode</span> = <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

    <span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
    <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

    <span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decrypted</span>))
}

<span style="color:#75715e">// 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
    <span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
    <span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
    <span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
    <span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}
</code></pre></div><p>输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">+</span><span style="color:#f92672">HzZQh0Do42Kg1PQsdhdcw</span><span style="color:#f92672">==</span>
<span style="color:#f92672">Hello</span><span style="color:#f92672">,</span> <span style="color:#f92672">world</span><span style="color:#f92672">!</span>
</code></pre></div><p>上例中，分别演示了</p>
<ol>
<li>对加密过程：创建加密对象、原文填充、创建CBC模式，加密。</li>
<li>解密过程： 创建CBC解密模式，解密，去除填充。</li>
</ol>
<p>为了方便使用，我们对上例的加解密进行封装，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/aes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
	<span style="color:#e6db74">&#34;encoding/base64&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">plaintext</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)
	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)
	<span style="color:#a6e22e">iv</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>)

	<span style="color:#75715e">// 加密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">encoded</span>)

	<span style="color:#75715e">// 解密数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">encoded</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">decoded</span>))
}

<span style="color:#75715e">// AesCBCEncrypt 使用 AES CBC 模式加密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCEncrypt</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">plaintext</span> = <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">plaintext</span>, <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>())

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCEncrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">ciphertext</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">plaintext</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">plaintext</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">ciphertext</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// AesCBCDecrypt 使用 AES CBC 模式解密数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AesCBCDecrypt</span>(<span style="color:#a6e22e">ciphertext</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">iv</span> []<span style="color:#66d9ef">byte</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">decoded</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">DecodeString</span>(<span style="color:#a6e22e">ciphertext</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">decoded</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">BlockSize</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;ciphertext is not a multiple of the block size&#34;</span>)
	}

	<span style="color:#a6e22e">mode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewCBCDecrypter</span>(<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">iv</span>)

	<span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">decoded</span>))
	<span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">CryptBlocks</span>(<span style="color:#a6e22e">decrypted</span>, <span style="color:#a6e22e">decoded</span>)

	<span style="color:#a6e22e">decrypted</span> = <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">decrypted</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decrypted</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// PKCS5Padding 对数据进行填充，使其长度为 blockSize 的整数倍
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5Padding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">blockSize</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">padding</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">-</span> len(<span style="color:#a6e22e">data</span>)<span style="color:#f92672">%</span><span style="color:#a6e22e">blockSize</span>
	<span style="color:#a6e22e">padtext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">padding</span>)}, <span style="color:#a6e22e">padding</span>)
	<span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">padtext</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// PKCS5UnPadding 去除填充数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PKCS5UnPadding</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>)
	<span style="color:#a6e22e">unpadding</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>[:(<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unpadding</span>)]
}

</code></pre></div><h3 id="总结">总结</h3>
<p>本文主要介绍对称加密算法AES，AES使用不同指定长度的密钥，对原文进行分组，可选用更安全的加密模式CBC。在 golang中，可以使用“crypto/aes”快速实现原文填充、加密模式、加密、解密、去除填充等AES加解密过程。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://github.com/golang/crypto">golang/crypto</a></li>
<li><a href="https://xie.infoq.cn/article/1b405dfbe6d0acf06dea0f9f6">AES加密模式</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023025778520640">NodeJs-AES加密</a></li>
<li><a href="https://overstarry.vip/posts/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BD%BF%E7%94%A8aes%E5%8A%A0%E5%AF%86%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE/">前后端使用aes加密传输数据</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/562256846">什么是AES加密？详解AES加密算法原理流程</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/06/golang%E5%AE%9E%E7%8E%B0aes%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" aria-label="">
      
          Kubernetes集群image-cri-him大量端口占用
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-27T18:11:54&#43;08:00">
        
   27, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>背景：</p>
<blockquote>
<p>sealos安装的Kubernetes集群，master节点出现大量端口占用。</p>
</blockquote>
<p>环境：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>Ubuntu</td>
</tr>
<tr>
<td>sealos</td>
<td>v4.1.7</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.23.9</td>
</tr>
</tbody>
</table>
<h3 id="排查问题">排查问题</h3>
<p>按照本地端口对输出进行排序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">netstat</span> <span style="color:#f92672">-anp</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">ESTABLISHED</span> <span style="color:#f92672">|</span> <span style="color:#f92672">awk</span> <span style="color:#e6db74">&#39;{print $4}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">|</span> <span style="color:#f92672">uniq</span> <span style="color:#f92672">-c</span> <span style="color:#f92672">|</span> <span style="color:#f92672">sort</span> <span style="color:#f92672">-n</span>
    <span style="color:#f92672">28</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">6443</span>
    <span style="color:#f92672">111</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">2379</span>
  <span style="color:#f92672">9009</span> <span style="color:#f92672">10</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">5000</span>
</code></pre></div><p>查找本地端口对应的应用程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">  <span style="color:#f92672">lsof</span> <span style="color:#f92672">-i</span> :<span style="color:#a6e22e">5000</span>
  <span style="color:#f92672">image-cri</span> <span style="color:#f92672">2811249</span> <span style="color:#f92672">root</span> <span style="color:#f92672">4120u</span>  <span style="color:#f92672">IPv4</span> <span style="color:#f92672">291818320</span>      <span style="color:#f92672">0t0</span>  <span style="color:#f92672">TCP</span> <span style="color:#f92672">master1</span>:<span style="color:#a6e22e">41710-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">master1</span>:<span style="color:#a6e22e">5000</span> <span style="color:#f92672">(</span><span style="color:#f92672">ESTABLISHED</span><span style="color:#f92672">)</span>
</code></pre></div><p>可见，是image-cri-shim占用的端口数。</p>
<h3 id="image-cri-shim-工作原理">image-cri-shim 工作原理</h3>
<blockquote>
<p>image-cri-shim 是一个基于 CRI (Container Runtime Interface) 和 kubelet 的 gRPC (Google Remote Procedure Call) shim。CRI 是 Kubernetes 中用于与容器运行时进行交互的接口，而 kubelet 是负责维护容器运行状态和节点级别的资源管理的 Kubernetes 组件。</p>
</blockquote>
<p>常用操作:</p>
<ul>
<li>启动服务： systemctl start image-cri-shim</li>
<li>停止服务： systemctl stop image-cri-shim</li>
<li>重启服务： systemctl restart image-cri-shim</li>
<li>查看服务状态： systemctl status image-cri-shim</li>
<li></li>
<li>参考日志:  journalctl -u image-cri-shim -f</li>
</ul>
<h3 id="重现问题">重现问题</h3>
<ol>
<li>
<p>在测试环境安装相同版本的sealos版本4.1.7，这里就不赘述，可以参考(<a href="https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle">https://sealos.io/zh-Hans/docs/getting-started/kuberentes-life-cycle</a>)</p>
</li>
<li>
<p>安装好之后，发现image-cri-shim的版本（4.1.3）不对，</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">--version</span>
<span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">3-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>更新image-cri-shim版本为4.1.7</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.1.7/sealos_4.1.7_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.1.7_linux_amd64.tar.gz.1 image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出类似以下内容，表示成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">101</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
<span style="color:#f92672">192</span>.<span style="color:#a6e22e">168</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">102</span>:<span style="color:#a6e22e">22</span><span style="color:#f92672">:</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">version</span> <span style="color:#f92672">4</span>.<span style="color:#a6e22e">1</span>.<span style="color:#a6e22e">7-ed0a75b9</span>
</code></pre></div><ol start="3">
<li>启动后，观察日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">actual</span> <span style="color:#f92672">imageName</span><span style="color:#f92672">:</span> <span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1116090</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T06</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">38</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="4">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">netstat -na | grep <span style="color:#ae81ff">5000</span> | wc -l
<span style="color:#ae81ff">96</span>
<span style="color:#ae81ff">116</span>
<span style="color:#ae81ff">120</span>
...
</code></pre></div><ol start="5">
<li>可见，每个5分钟，占用的端口数就增加20左右。问题复现了，接着我们来看看怎么处理。</li>
</ol>
<h3 id="更新版本为420">更新版本为4.2.0</h3>
<p>从sealos的github的issues有提供一个修复方案：升级image-cri-shim的版本为4.2.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/labring/sealos/releases/download/v4.2.0/sealos_4.2.0_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar xvf sealos_4.2.0_linux_amd64.tar.gz image-cri-shim
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl stop image-cri-shim&#34;</span>
sealos scp <span style="color:#e6db74">&#34;./image-cri-shim&#34;</span> <span style="color:#e6db74">&#34;/usr/bin/image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;systemctl start image-cri-shim&#34;</span>
sealos exec -r master,node <span style="color:#e6db74">&#34;image-cri-shim -v&#34;</span>
</code></pre></div><p>输出如下，表示成功：</p>
<pre tabindex="0"><code>image-cri-shim version 4.2.0-f696a621
192.168.1.101:22: image-cri-shim version 4.2.0-f696a621
192.168.1.102:22: image-cri-shim version 4.2.0-f696a621
</code></pre><h3 id="观察是否已修复">观察是否已修复</h3>
<ol>
<li>观察inamge-cri-shim日志：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">journalctl</span> <span style="color:#f92672">-u</span> <span style="color:#f92672">image-cri-shim</span> <span style="color:#f92672">-f</span>
<span style="color:#f92672">--</span> <span style="color:#f92672">Logs</span> <span style="color:#f92672">begin</span> <span style="color:#f92672">at</span> <span style="color:#f92672">Wed</span> <span style="color:#f92672">2023-04-19</span> <span style="color:#f92672">22</span>:<span style="color:#a6e22e">42</span>:<span style="color:#a6e22e">32</span> <span style="color:#f92672">UTC</span><span style="color:#f92672">.</span> <span style="color:#f92672">--</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">Timeout</span><span style="color:#f92672">:</span> {<span style="color:#f92672">15m0s</span>}
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criRegistryAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">criOfflineAuth</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">:</span>{Username:admin Password<span style="color:#f92672">:</span>passw0rd Auth<span style="color:#f92672">:</span> Email<span style="color:#f92672">:</span> ServerAddress<span style="color:#f92672">:</span>http<span style="color:#f92672">://</span>sealos<span style="color:#f92672">.</span>hub<span style="color:#f92672">:</span><span style="color:#ae81ff">5000</span> IdentityToken<span style="color:#f92672">:</span> RegistryToken<span style="color:#f92672">:</span>}<span style="color:#f92672">]</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">socket</span> <span style="color:#f92672">info</span> <span style="color:#f92672">shim</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">var</span><span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">image-cri-shim</span>.<span style="color:#a6e22e">sock</span> <span style="color:#f92672">,</span><span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">run</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span><span style="color:#f92672">/</span><span style="color:#f92672">containerd</span>.<span style="color:#a6e22e">sock</span><span style="color:#f92672">,</span> <span style="color:#f92672">registry</span><span style="color:#f92672">:</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">ownership</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">root</span><span style="color:#f92672">/</span><span style="color:#f92672">root</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">09</span> <span style="color:#f92672">info</span> <span style="color:#f92672">changed</span> <span style="color:#f92672">permissions</span> <span style="color:#f92672">of</span> <span style="color:#f92672">socket</span> <span style="color:#e6db74">&#34;/var/run/image-cri-shim.sock&#34;</span> <span style="color:#f92672">to</span> <span style="color:#f92672">-rw-rw----</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">44</span>:<span style="color:#a6e22e">41</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">49</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
<span style="color:#f92672">May</span> <span style="color:#f92672">25</span> <span style="color:#f92672">07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">master1</span> <span style="color:#f92672">image-cri-shim</span><span style="color:#f92672">[</span><span style="color:#f92672">1159432</span><span style="color:#f92672">]:</span> <span style="color:#f92672">2023-05-25T07</span>:<span style="color:#a6e22e">54</span>:<span style="color:#a6e22e">42</span> <span style="color:#f92672">info</span> <span style="color:#f92672">image</span><span style="color:#f92672">:</span> <span style="color:#f92672">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">newImage</span><span style="color:#f92672">:</span> <span style="color:#f92672">sealos</span>.<span style="color:#a6e22e">hub</span>:<span style="color:#a6e22e">5000</span><span style="color:#f92672">/</span><span style="color:#f92672">pause</span>:<span style="color:#a6e22e">3</span>.<span style="color:#a6e22e">6</span><span style="color:#f92672">,</span> <span style="color:#f92672">action</span><span style="color:#f92672">:</span> <span style="color:#f92672">ImageStatus</span>
</code></pre></div><ol start="2">
<li>监控端口数的变化</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">root</span>@<span style="color:#66d9ef">master1</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">netstat</span> <span style="color:#f92672">-na</span> <span style="color:#f92672">|</span> <span style="color:#f92672">grep</span> <span style="color:#f92672">5000</span> <span style="color:#f92672">|</span> <span style="color:#f92672">wc</span> <span style="color:#f92672">-l</span>
<span style="color:#f92672">1</span> 
<span style="color:#f92672">6</span> 
<span style="color:#f92672">1</span>
</code></pre></div><ol start="3">
<li>可见，请求是还有，但并没有增加端口数，看来问题修复了。</li>
</ol>
<p>ps： 我们重现问题的Kubenetes版本是v1.23.9，在实际开发中发现其他版本的v1.25.7也会出现类似问题，验证此版本待后续更新。</p>
<h3 id="小结">小结</h3>
<p>本文主要记录排查、复现、处理【sealos安装的Kubenetes集群master节点大量占用端口】的过程，原因系image-cri-shim的版本问题，旧版本会频繁请求master，导致创建大量的连接，占用端口数。通过升级image-cri-shim版本可以解决该问题。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://sealos.io/zh-Hans/docs/design/image-cri-shim"> sealos Doc： image-cri-shim 介绍</a></li>
<li><a href="https://github.com/labring/sealos/issues/2965"> 为什么sealos4.2部分的群，注册表库连接数很高 </a></li>
<li><a href="https://github.com/labring/sealos/issues/3052"> BUG: image-cri-shim导致端口大量占用，耗尽服务器socket资源 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/kubernetes%E9%9B%86%E7%BE%A4image-cri-him%E5%A4%A7%E9%87%8F%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0nginx-proxy-manager%E5%85%A5%E9%97%A8/" aria-label="">
      
          Nginx可视化管理平台Nginx Proxy Manager入门
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-21T15:51:14&#43;08:00">
        
   21, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/dockers">Dockers</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>Nginx-Proxy-Manager 是Nginx  Web GUI( 可视化管理界面)，为新手快速设置反向代理提供帮助。
它的主要目标是：</p>
<blockquote>
<p>我创建这个项目是为了满足个人需要，为用户提供一种简单的方法来完成带有 SSL 终止的反向代理主机，而且它必须非常简单，以至于猴子都能做到。这个目标没有改变。虽然可能有高级选项，但它们是可选的，并且项目应该尽可能简单，以便进入这里的门槛很低。</p>
</blockquote>
<h3 id="feature">feature</h3>
<p>它主要的功能包括以下几个：</p>
<ul>
<li>基于Tabler的美观安全的管理界面</li>
<li>在对 Nginx 一无所知的情况下轻松创建转发域、重定向、流和 404 主机</li>
<li>使用 Let&rsquo;s Encrypt 的免费 SSL 或提供您自己的自定义 SSL 证书</li>
<li>主机的访问列表和基本 HTTP 身份验证</li>
<li>超级用户可用的高级 Nginx 配置</li>
<li>用户管理、权限和审计日志</li>
</ul>
<h3 id="安装">安装</h3>
<p>这里我们Docker Compose安装启动。</p>
<ol>
<li>你需要预先安装了Docker Compose 环境。</li>
<li>创建docker-compose.yml</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.8&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">app</span>:
    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#39;jc21/nginx-proxy-manager:latest&#39;</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#39;8080:80&#39;</span>
      - <span style="color:#e6db74">&#39;81:81&#39;</span>
      - <span style="color:#e6db74">&#39;8443:443&#39;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">./data:/data</span>
      - <span style="color:#ae81ff">./letsencrypt:/etc/letsencrypt</span>
</code></pre></div><ol start="3">
<li>启动</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">docker-compose</span> <span style="color:#f92672">-d</span>
</code></pre></div><ol start="4">
<li>Dashboard</li>
</ol>
<p>访问web界面 http://127.0.0.1:81</p>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_login.png" alt=""></p>
<p>这么默认的用户名和密码是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">Email</span><span style="color:#f92672">:</span>    <span style="color:#f92672">admin</span>@<span style="color:#66d9ef">example</span>.<span style="color:#a6e22e">com</span>
<span style="color:#f92672">Password</span><span style="color:#f92672">:</span> <span style="color:#f92672">changeme</span>
</code></pre></div><p>登入后，按提示重新设置用户名、密码即可。</p>
<ol start="5">
<li>主页面 home page</li>
</ol>
<p>如成功登入，可以看到主页面如下：</p>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_home.png" alt=""></p>
<h3 id="实战-反向代理nginx-proxy-manage后台">实战 ：反向代理Nginx-Proxy-Manage后台</h3>
<p>如上述中，我们通过81端口可以访问GUI，下面，我们将通过反向代理，可以直接通过 http://your-site:8080即可访问GUI。</p>
<ol>
<li>点击 【Proxy Hosts】,在界面Details选项添加如下图所示：</li>
</ol>
<p><img src="https://luckytking.github.io/images/nginx_proxy_manager_details.png" alt=""></p>
<ol start="2">
<li>访问 http://your-site:8080
<img src="https://luckytking.github.io/images/nginx_proxy_manager_test_ok.png" alt=""></li>
</ol>
<p>说明成功了</p>
<ol start="3">
<li>
<p>如果想要关闭代理，点击编辑【Proxy Host】 的 Enable，详细如下
<img src="https://luckytking.github.io/images/nginx_proxy_manager_enable.png" alt=""></p>
</li>
<li>
<p>再访问，会跳出404界面
<img src="https://luckytking.github.io/images/nginx_proxy_manager_disable.png" alt=""></p>
</li>
</ol>
<p>以上。</p>
<h3 id="小结">小结</h3>
<p>本文主要简介Nginx可视化管理平台Nginx-Proxy-Manager及主要功能，为配置强大Nginx代理功能降低门槛。通过一个实战案例：代理Manager后台，演示了基础使用方法。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://nginxproxymanager.com"> 官网 </a></li>
<li><a href="https://mp.weixin.qq.com/s/gGoQGsuFVKemPNQ4Zfx4Hw">Blog:
超强大的 Nginx 可视化管理平台 Nginx-Proxy-Manager 中文入门指南 </a></li>
<li><a href="https://sspai.com/post/76910">Blog:
Nginx Proxy Manager - Docker 建站最佳伴侣 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0nginx-proxy-manager%E5%85%A5%E9%97%A8/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8Fflyweight/" aria-label="">
      
          设计模式  享元模式flyweight
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-14T16:06:36&#43;08:00">
        
   14, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/disignmode">DisignMode</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>本文主要介绍享元模式基础概念、实现原理和通过一个棋牌游戏例子简述实现过程。</p>
<h3 id="享元模式">享元模式</h3>
<p>所谓“享元”，顾名思义就是被共享的单元。享元模式的意图是复用对象，节省内存，前提是享元对象是不可变对象。
具体来讲，当一个系统中存在大量重复对象的时候，如果这些重复的对象是不可变对象，我们就可以利用享元模式将对象设计成享元，在内存中只保留一份实例，供多处代码引用。</p>
<p>享元的实现并不复杂，通过工厂模式，通过一个 Map 来缓存已经创建过的享元对象，来达到复用的目的。
其中：</p>
<ul>
<li>Flyweight ： 享元类包含原始对象中部分能在多个对象中共享的状态。</li>
<li>FlyweightFactory：享元工厂，会对已有享元的缓存池进行管理。</li>
</ul>
<p>接着，我们通过一个棋牌游戏的案例来演示。</p>
<h3 id="案例-棋牌游戏">案例-棋牌游戏</h3>
<p>这里以象棋为例，游戏大厅中有N个房间，那么每个房间会有一个棋局对象，和X个（将、相、士、炮）棋子对象。以下是go的具体实现flyweight.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChessPiece</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Color</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">PositionX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">PositionY</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChessBoard</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Cards</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChessBoard</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ChessBoard</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ChessBoard</span>{
		<span style="color:#a6e22e">Cards</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{
			<span style="color:#ae81ff">1</span>: {
				<span style="color:#a6e22e">Name</span>:      <span style="color:#e6db74">&#34;車&#34;</span>,
				<span style="color:#a6e22e">Color</span>:     <span style="color:#e6db74">&#34;紅&#34;</span>,
				<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">1</span>,
				<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">11</span>,
			},
			<span style="color:#ae81ff">2</span>: {
				<span style="color:#a6e22e">Name</span>:      <span style="color:#e6db74">&#34;馬&#34;</span>,
				<span style="color:#a6e22e">Color</span>:     <span style="color:#e6db74">&#34;黑&#34;</span>,
				<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">2</span>,
				<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">2</span>,
			},
		},
		<span style="color:#75715e">// 其他棋子
</span><span style="color:#75715e"></span>	}
}


</code></pre></div><p>开N个房间flyweight_test.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewChessBoard</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">game1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewChessBoard</span>()
	<span style="color:#a6e22e">game2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewChessBoard</span>()
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game1</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game2</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">game1</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">game2</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#ae81ff">1</span>])
}
</code></pre></div><p>OutPut:</p>
<pre tabindex="0"><code>=== RUN   TestNewChessBoard
    flyweight_test.go:15: &amp;{車 紅 1 11}
    flyweight_test.go:16: &amp;{車 紅 1 11}
    flyweight_test.go:17: false
--- PASS: TestNewChessBoard (0.00s)
</code></pre><p>例中，每创建一个棋局就需要初始化对应的棋子，如果游戏大厅有百万人同时在线 ，那保存这么多棋局对象就会消耗大量的内存。</p>
<h3 id="使用享元模式重构">使用享元模式重构</h3>
<p>如何对上例进行优化呢，从例子中，每个大厅存在大量重复对象棋牌，利用享元模式把棋牌设计成共享的（map）详细如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">design_mode</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">chessPieceUnit</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{
	<span style="color:#ae81ff">1</span>: {
		<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;車&#34;</span>,
		<span style="color:#a6e22e">Color</span>: <span style="color:#e6db74">&#34;紅&#34;</span>,
		<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">11</span>,
	},
	<span style="color:#ae81ff">2</span>: {
		<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;馬&#34;</span>,
		<span style="color:#a6e22e">Color</span>: <span style="color:#e6db74">&#34;黑&#34;</span>,
		<span style="color:#a6e22e">PositionX</span>: <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">PositionY</span>: <span style="color:#ae81ff">2</span>,
	},
	<span style="color:#75715e">// 其他棋子
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChessPieceUnitFactory</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ChessBoard</span> {
	<span style="color:#a6e22e">board</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ChessBoard</span>{<span style="color:#a6e22e">Cards</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ChessPiece</span>{}}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">chessPieceUnit</span> {
		<span style="color:#a6e22e">board</span>.<span style="color:#a6e22e">Cards</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">chessPieceUnit</span>[<span style="color:#a6e22e">id</span>]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">board</span>
}
</code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">===</span> <span style="color:#f92672">RUN</span>   <span style="color:#f92672">TestNewChessPieceUnitFactory</span>
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">13</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>{<span style="color:#960050;background-color:#1e0010">車</span> <span style="color:#960050;background-color:#1e0010">紅</span> <span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#960050;background-color:#1e0010">11</span>}
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">14</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>{<span style="color:#960050;background-color:#1e0010">車</span> <span style="color:#960050;background-color:#1e0010">紅</span> <span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#960050;background-color:#1e0010">11</span>}
    <span style="color:#f92672">flyweight2_test</span>.<span style="color:#a6e22e">go</span>:<span style="color:#a6e22e">15</span><span style="color:#f92672">:</span> <span style="color:#f92672">true</span>
<span style="color:#f92672">---</span> <span style="color:#f92672">PASS</span><span style="color:#f92672">:</span> <span style="color:#f92672">TestNewChessPieceUnitFactory</span> <span style="color:#f92672">(</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">00s</span><span style="color:#f92672">)</span>
</code></pre></div><p>例中，通过一个ChessPieceUnit来缓存一个ChessBoard棋局的30+个ChessPiece棋子对象。原本如果是1万个ChessBoard棋局，需要创建【1万乘30】约30万个棋子对象。现在通过共享同一个ChessPieceUnit，那么需要创建约【30】个对象，大大节省了内存。</p>
<h3 id="参考">参考</h3>
<ul>
<li>设计模式之美 <a href="https://item.jd.com/13174161.html">https://item.jd.com/13174161.html</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8Fflyweight/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" aria-label="">
      
          Apisix基于SNI代理TCP、UDP
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-30T13:45:59&#43;08:00">
        
   30, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <blockquote>
<p>背景:
公司项目中，需要暴露对内网的Websocket服务。</p>
</blockquote>
<p>Websocket 它是一种基于 TCP 的一种独立实现，APISIX 可以对 TCP/UDP 协议进行代理并实现动态负载均衡， 在 nginx 世界，称 TCP/UDP 代理为 stream 代理，在 APISIX 这里我们也遵循了这个声明，下文统称Stream。</p>
<p>SNI（Server Name Indication）是用来改善 SSL 和 TLS 的一项特性，它允许客户端在服务器端向其发送证书之前向服务器端发送请求的域名，服务器端根据客户端请求的域名选择合适的 SSL 证书发送给客户端。</p>
<p>本文主要介绍ApiSix如何基于SNI代理TCP/UDP。</p>
<h3 id="启用stream-代理">启用Stream 代理</h3>
<p>在 conf/config.yaml 配置文件设置 stream_proxy 选项， 指定一组需要进行动态代理的 IP 地址。默认情况不开启 stream 代理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9101&#34;</span>
    <span style="color:#f92672">udp</span>: <span style="color:#75715e"># UDP proxy address list</span>
      - <span style="color:#ae81ff">9200</span>
      - <span style="color:#e6db74">&#34;127.0.0.1:9211&#34;</span>
</code></pre></div><p>如果 apisix.enable_admin 为 true，上面的配置会同时启用 HTTP 和 stream 代理。如果你设置 enable_admin 为 false，且需要同时启用 HTTP 和 stream 代理，设置 only 为 false：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apisix</span>:
  <span style="color:#f92672">enable_admin</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
</code></pre></div><h3 id="启用-tls">启用 TLS：</h3>
<p>首先，我们需要给对应的 TCP 地址启用 TLS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#f92672">addr</span>: <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="配置路由">配置路由</h3>
<p>当连接为 TLS over TCP 时，我们可以通过 SNI 来匹配路由，比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">PUT</span> <span style="color:#f92672">-d</span> <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  {
</span><span style="color:#e6db74">      &#34;sni&#34;: &#34;mysite.com&#34;,
</span><span style="color:#e6db74">      &#34;server_port&#34;: 9333,
</span><span style="color:#e6db74">      &#34;upstream&#34;: {
</span><span style="color:#e6db74">          &#34;scheme&#34;: &#34;tls&#34;,
</span><span style="color:#e6db74">          &#34;nodes&#34;: {
</span><span style="color:#e6db74">              &#34;192.168.1.33:8080&#34;: 1
</span><span style="color:#e6db74">          },
</span><span style="color:#e6db74">          &#34;type&#34;: &#34;roundrobin&#34;
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">  }&#39;</span>
</code></pre></div><p>查看是否创建成功:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span>
</code></pre></div><p>如创建错误，可以删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">/</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> <span style="color:#f92672">-X</span> <span style="color:#f92672">DELETE</span> 
</code></pre></div><p>查看更多stream路由：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">9180</span><span style="color:#f92672">//</span><span style="color:#f92672">apisix</span><span style="color:#f92672">/</span><span style="color:#f92672">admin</span><span style="color:#f92672">/</span><span style="color:#f92672">stream_routes</span> <span style="color:#f92672">-H</span> <span style="color:#e6db74">&#39;X-API-KEY: Your-Api-Key&#39;</span> 
</code></pre></div><p>更多Api参考：
<a href="https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route">https://apisix.apache.org/zh/docs/apisix/2.12/admin-api/#stream-route</a></p>
<h3 id="上传sni证书">上传SNI证书</h3>
<p>上传站点(mysite.com)的证书到ApiSix</p>
<h3 id="测试">测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">curl</span> <span style="color:#f92672">-v</span> <span style="color:#f92672">https</span><span style="color:#f92672">://</span><span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span><span style="color:#f92672">/</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">Trying</span> <span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">...</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TCP_NODELAY</span> <span style="color:#f92672">set</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connected</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span> <span style="color:#f92672">(</span><span style="color:#f92672">x</span>.<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">)</span> <span style="color:#f92672">port</span> <span style="color:#f92672">9333</span> <span style="color:#f92672">(</span>#0<span style="color:#f92672">)</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">h2</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">offering</span> <span style="color:#f92672">http</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">successfully</span> <span style="color:#f92672">set</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">locations</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>   <span style="color:#f92672">CAfile</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span><span style="color:#f92672">etc</span><span style="color:#f92672">/</span><span style="color:#f92672">ssl</span><span style="color:#f92672">/</span><span style="color:#f92672">cert</span>.<span style="color:#a6e22e">pem</span>
  <span style="color:#f92672">CApath</span><span style="color:#f92672">:</span> <span style="color:#f92672">none</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">2</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Certificate</span> <span style="color:#f92672">(</span><span style="color:#f92672">11</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">12</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">14</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">key</span> <span style="color:#f92672">exchange</span> <span style="color:#f92672">(</span><span style="color:#f92672">16</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">change</span> <span style="color:#f92672">cipher</span><span style="color:#f92672">,</span> <span style="color:#f92672">Change</span> <span style="color:#f92672">cipher</span> <span style="color:#f92672">spec</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">IN</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Finished</span> <span style="color:#f92672">(</span><span style="color:#f92672">20</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">SSL</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">using</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">/</span> <span style="color:#f92672">ECDHE-RSA-CHACHA20-POLY1305</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">ALPN</span><span style="color:#f92672">,</span> <span style="color:#f92672">server</span> <span style="color:#f92672">did</span> <span style="color:#f92672">not</span> <span style="color:#f92672">agree</span> <span style="color:#f92672">to</span> <span style="color:#f92672">a</span> <span style="color:#f92672">protocol</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Server</span> <span style="color:#f92672">certificate</span><span style="color:#f92672">:</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subject</span><span style="color:#f92672">:</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=*</span>.<span style="color:#a6e22e">mysite</span>.<span style="color:#a6e22e">com</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">start</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Mar</span> <span style="color:#f92672">29</span> <span style="color:#f92672">00</span>:<span style="color:#a6e22e">00</span>:<span style="color:#a6e22e">00</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">expire</span> <span style="color:#f92672">date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Jun</span> <span style="color:#f92672">27</span> <span style="color:#f92672">23</span>:<span style="color:#a6e22e">59</span>:<span style="color:#a6e22e">59</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">subjectAltName</span><span style="color:#f92672">:</span> <span style="color:#f92672">host</span> <span style="color:#e6db74">&#34;mysite.com&#34;</span> <span style="color:#f92672">matched</span> <span style="color:#f92672">cert</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">s</span> <span style="color:#e6db74">&#34;*.mysite.com&#34;</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">issuer</span><span style="color:#f92672">:</span> <span style="color:#f92672">C</span><span style="color:#f92672">=</span><span style="color:#f92672">AT</span><span style="color:#f92672">;</span> <span style="color:#f92672">O</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span><span style="color:#f92672">;</span> <span style="color:#f92672">CN</span><span style="color:#f92672">=</span><span style="color:#f92672">ZeroSSL</span> <span style="color:#f92672">RSA</span> <span style="color:#f92672">Domain</span> <span style="color:#f92672">Secure</span> <span style="color:#f92672">Site</span> <span style="color:#f92672">CA</span>
<span style="color:#f92672">*</span>  <span style="color:#f92672">SSL</span> <span style="color:#f92672">certificate</span> <span style="color:#f92672">verify</span> <span style="color:#f92672">ok</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">GET</span> <span style="color:#f92672">/</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Host</span><span style="color:#f92672">:</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">9333</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">User-Agent</span><span style="color:#f92672">:</span> <span style="color:#f92672">curl</span><span style="color:#f92672">/</span><span style="color:#f92672">7</span>.<span style="color:#a6e22e">64</span>.<span style="color:#a6e22e">1</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">Accept</span><span style="color:#f92672">:</span> <span style="color:#f92672">*/*</span>
<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">HTTP</span><span style="color:#f92672">/</span><span style="color:#f92672">1</span>.<span style="color:#a6e22e">1</span> <span style="color:#f92672">400</span> <span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Type</span><span style="color:#f92672">:</span> <span style="color:#f92672">text</span><span style="color:#f92672">/</span><span style="color:#f92672">plain</span><span style="color:#f92672">;</span> <span style="color:#f92672">charset</span><span style="color:#f92672">=</span><span style="color:#f92672">utf-8</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Sec-Websocket-Version</span><span style="color:#f92672">:</span> <span style="color:#f92672">13</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">X-Content-Type-Options</span><span style="color:#f92672">:</span> <span style="color:#f92672">nosniff</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Date</span><span style="color:#f92672">:</span> <span style="color:#f92672">Sun</span><span style="color:#f92672">,</span> <span style="color:#f92672">23</span> <span style="color:#f92672">Apr</span> <span style="color:#f92672">2023</span> <span style="color:#f92672">05</span>:<span style="color:#a6e22e">50</span>:<span style="color:#a6e22e">07</span> <span style="color:#f92672">GMT</span>
<span style="color:#f92672">&lt;</span> <span style="color:#f92672">Content-Length</span><span style="color:#f92672">:</span> <span style="color:#f92672">12</span>
<span style="color:#f92672">&lt;</span>
<span style="color:#f92672">Bad</span> <span style="color:#f92672">Request</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Connection</span> #0 <span style="color:#f92672">to</span> <span style="color:#f92672">host</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span> <span style="color:#f92672">left</span> <span style="color:#f92672">intact</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
</code></pre></div><p>Success。</p>
<h3 id="过程中遇见的问题">过程中遇见的问题</h3>
<ol>
<li>连接不上</li>
</ol>
<pre tabindex="0"><code> curl -v http://mysite.com
*   Trying x.x.y.y...
* TCP_NODELAY set
* Connected to mysite.com (x.x.y.y.) port 19333
&gt; GET / HTTP/1.1
&gt; Host: mysite.com:19333
&gt; User-Agent: curl/7.64.1
&gt; Accept: */*
&gt;
* Recv failure: Connection reset by peer
* Closing connection 0
curl: (56) Recv failure: Connection reset by peer
</code></pre><p>需要排查路由器端口是否正常开放，ApiSix的端口是否正常，经排查原因是：配置路由时&quot;server_port&quot;缺失</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
      <span style="color:#f92672">&#34;sni&#34;</span>: <span style="color:#e6db74">&#34;mysite.com&#34;</span>,
      <span style="color:#f92672">&#34;upstream&#34;</span>: {
          <span style="color:#f92672">&#34;scheme&#34;</span>: <span style="color:#e6db74">&#34;tls&#34;</span>,
          <span style="color:#f92672">&#34;nodes&#34;</span>: {
              <span style="color:#f92672">&#34;192.168.1.33:8080&#34;</span>: <span style="color:#ae81ff">1</span>
          },
          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;roundrobin&#34;</span>
      }
  }
</code></pre></div><ol start="2">
<li>handshark失败，证书错误</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">*</span> <span style="color:#f92672">TLSv1</span>.<span style="color:#a6e22e">2</span> <span style="color:#f92672">(</span><span style="color:#f92672">OUT</span><span style="color:#f92672">),</span> <span style="color:#f92672">TLS</span> <span style="color:#f92672">handshake</span><span style="color:#f92672">,</span> <span style="color:#f92672">Client</span> <span style="color:#f92672">hello</span> <span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">):</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
<span style="color:#f92672">*</span> <span style="color:#f92672">Closing</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">0</span>
<span style="color:#f92672">curl</span><span style="color:#f92672">:</span> <span style="color:#f92672">(</span><span style="color:#f92672">35</span><span style="color:#f92672">)</span> <span style="color:#f92672">LibreSSL</span> <span style="color:#f92672">SSL_connect</span><span style="color:#f92672">:</span> <span style="color:#f92672">SSL_ERROR_SYSCALL</span> <span style="color:#f92672">in</span> <span style="color:#f92672">connection</span> <span style="color:#f92672">to</span> <span style="color:#f92672">mysite</span>.<span style="color:#a6e22e">com</span>:<span style="color:#a6e22e">19333</span>
</code></pre></div><p>排位原因是：这里作者使用的ApiSix版本是2.12，缺失前缀 【addr】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">stream_proxy</span>: <span style="color:#75715e"># TCP/UDP proxy</span>
    <span style="color:#f92672">only</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">tcp</span>: <span style="color:#75715e"># TCP proxy address list</span>
      - <span style="color:#ae81ff">9100</span>
      - <span style="color:#ae81ff">9333</span>
        <span style="color:#f92672">tls</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.org/zh/docs</a></li>
<li><a href="https://apisix.apache.org/zh/docs/apisix/2.12/stream-proxy/#%E4%BB%A3%E7%90%86%E5%88%B0-tls-over-tcp-%E4%B8%8A%E6%B8%B8">apisix.apache.ogr/zh/streams</a></li>
<li><a href="https://www.fenghong.tech/blog/kubernetes/sni-apisix-tcp/">
Blog-基于sni使用apisix代理四层TCP/UDP</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/apisix%E5%9F%BA%E4%BA%8Esni%E4%BB%A3%E7%90%86tcpudp/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" aria-label="">
      
          Go使用RedisStream实现消息队列
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-08T22:33:14&#43;08:00">
        
   8, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>上篇我们介绍了RedisStream实现消息队列和发布订阅模式 ，今天我们将介绍Go语言的实现方法。</p>
<h3 id="消息队列">消息队列</h3>
<p>接上篇的例子，我们通过go-redis库的接口XAdd、XReadGroup、XGroupCreateMkStream来实现，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>      = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span> = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">stream</span>   = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>    = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">start</span>    = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>    = <span style="color:#ae81ff">10</span>
	)

	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
		<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
		<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
		<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
		<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
		<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	} 
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
	}
}

</code></pre></div><p>上例实现了一个简单的消息队列，可以实现消息的发送和接收，并保证每条消息只被处理一次 。</p>
<h3 id="阻塞超时">阻塞超时</h3>
<p>通过修改Block（单位为ms）参数来实现阻塞，详细修改如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
		<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
			<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
			<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
			<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
			<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
			<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
			<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
		}).<span style="color:#a6e22e">Result</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>()) 
    <span style="color:#f92672">...</span>
	}
</code></pre></div><p>输出如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">23</span>.<span style="color:#a6e22e">9669498</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">529310801</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">Length</span><span style="color:#f92672">=</span> <span style="color:#f92672">1</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">Received</span> <span style="color:#f92672">message</span><span style="color:#f92672">:</span> <span style="color:#f92672">map</span><span style="color:#f92672">[</span><span style="color:#f92672">name</span>:<span style="color:#a6e22e">foo</span><span style="color:#f92672">]</span>
<span style="color:#f92672">Start</span> <span style="color:#f92672">Receiving</span> <span style="color:#f92672">2023-04-08</span> <span style="color:#f92672">21</span>:<span style="color:#a6e22e">39</span>:<span style="color:#a6e22e">24</span>.<span style="color:#a6e22e">0419963</span> <span style="color:#f92672">+</span><span style="color:#f92672">0800</span> <span style="color:#f92672">CST</span> <span style="color:#f92672">m</span><span style="color:#f92672">=+</span><span style="color:#f92672">0</span>.<span style="color:#a6e22e">604357301</span>
<span style="color:#f92672">panic</span><span style="color:#f92672">:</span> <span style="color:#f92672">read</span> <span style="color:#f92672">tcp</span> <span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">63777-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">127</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">0</span>.<span style="color:#a6e22e">1</span>:<span style="color:#a6e22e">6379</span><span style="color:#f92672">:</span> <span style="color:#f92672">i</span><span style="color:#f92672">/</span><span style="color:#f92672">o</span> <span style="color:#f92672">timeout</span>
</code></pre></div><p>可见,XReadGroup一直阻塞等待新的消息，直到 Redis 连接超时或者命令被中断。
ps: 如若不需要阻塞等待可修改Block为&lt;0 的值实现。</p>
<h3 id="发布订阅模式">发布订阅模式</h3>
<p>接着，我们实现上篇提到的发布订阅模式，XGroupCreateMkStream创建另外一个订阅组group2，两个协程XReadGroup接收消息，往stream中XAdd消息，两个订阅者将都收到消息，详细如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">ctx</span>       = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
		<span style="color:#a6e22e">consumer</span>  = <span style="color:#e6db74">&#34;consumer1&#34;</span>
		<span style="color:#a6e22e">consumer2</span> = <span style="color:#e6db74">&#34;consumer2&#34;</span>
		<span style="color:#a6e22e">stream</span>    = <span style="color:#e6db74">&#34;mystream&#34;</span>
		<span style="color:#a6e22e">group</span>     = <span style="color:#e6db74">&#34;group1&#34;</span>
		<span style="color:#a6e22e">group2</span>    = <span style="color:#e6db74">&#34;group2&#34;</span>
		<span style="color:#a6e22e">start</span>     = <span style="color:#e6db74">&#34;&gt;&#34;</span>
		<span style="color:#a6e22e">count</span>     = <span style="color:#ae81ff">10</span>
	)
	<span style="color:#75715e">// 创建Redis客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
		<span style="color:#a6e22e">Addr</span>:        <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
		<span style="color:#a6e22e">Password</span>:    <span style="color:#e6db74">&#34;&#34;</span>,
		<span style="color:#a6e22e">DB</span>:          <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">ReadTimeout</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>,
	})
	<span style="color:#75715e">// 创建消费者组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">// 创建消费者组2
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XGroupCreateMkStream</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">group2</span>, <span style="color:#e6db74">&#34;0-0&#34;</span>).<span style="color:#a6e22e">Err</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">//panic(err)
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">//添加消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XAdd</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XAddArgs</span>{
		<span style="color:#a6e22e">Stream</span>: <span style="color:#a6e22e">stream</span>,
		<span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;*&#34;</span>,
		<span style="color:#a6e22e">Values</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
			<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
		},
	}).<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start Receiving&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#75715e">//读取消息
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}

		}
	}()
	<span style="color:#75715e">//读取消息2
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Start Receiving &#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#a6e22e">messages</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">XReadGroup</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">XReadGroupArgs</span>{
				<span style="color:#a6e22e">Group</span>:    <span style="color:#a6e22e">group2</span>,
				<span style="color:#a6e22e">Consumer</span>: <span style="color:#a6e22e">consumer2</span>,
				<span style="color:#a6e22e">Streams</span>:  []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">start</span>},
				<span style="color:#a6e22e">Count</span>:    int64(<span style="color:#a6e22e">count</span>),
				<span style="color:#a6e22e">Block</span>:    <span style="color:#ae81ff">2000</span>,
				<span style="color:#a6e22e">NoAck</span>:    <span style="color:#66d9ef">false</span>,
			}).<span style="color:#a6e22e">Result</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;2 Received Length=&#34;</span>, len(<span style="color:#a6e22e">messages</span>), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">String</span>())
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Messages</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;2Received message: %v\n&#34;</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Values</span>)
			}
		}
	}()
	<span style="color:#66d9ef">for</span> {
	}
}
</code></pre></div><p>输出如下：</p>
<pre tabindex="0"><code>Start Receiving 2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
2 Start Receiving  2023-04-08 22:19:41.9981051 +0800 CST m=+0.347161101
Received Length= 1 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
Received message: map[name:foo]
Start Receiving 2023-04-08 22:19:42.0571709 +0800 CST m=+0.406226901
2 Received Length= 1 2023-04-08 22:19:42.3628412 +0800 CST m=+0.711897201
2Received message: map[name:foo]
</code></pre><h3 id="参考">参考</h3>
<ul>
<li><a href="https://redis.io/commands/xread">redis.io</a></li>
<li><a href="https://redis.io/docs/data-types/streams-tutorial">redis.io streams-tutorial</a></li>
<li><a href="https://mp.weixin.qq.com/s/RthQvzLHZRGNo-z6X_7jQQ">一篇List、PubSub、Stream实现消息队列的博客</a></li>
<li><a href="https://overstarry.vip/posts/%E4%BD%BF%E7%94%A8redis%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97-/">golang适用用List、PubSub、Stream 实现消息队列</a></li>
<li><a href="%E5%88%97/https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">redisstream实现消息队</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/go%E4%BD%BF%E7%94%A8redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" aria-label="">
      
          RedisStream实现消息队列
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-04-02T15:20:45&#43;08:00">
        
   2, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91">后端开发</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        Redis Stream是在 Redis 5.0中引入的数据类型，可以实现高性能、高可靠性的消息队列。本文主要介绍 Redis Stream 的概念、使用方法和一些适用场景如发布订阅模式、消息队列。
简介 Redis Stream是Redis为消息队列设计的数据类型，它将消息队列的数据结构抽象为一个有序的消息流（stream），每个消息都有一个唯一的ID和一个关联的键值对（key-value pairs）它支持以下功能：
 添加消息-将消息添加到队列的末尾 读取消息-从队列的开头读取消息 删除消息-删除指定id的消息 创建消费者组-创建多个消费者组，每个消费者组都可以独立地读取消息。同时可实现负载均衡和消息分发。 确认消息- XACK 命令来确认已经成功处理的消息，避免重复消费  XADD-添加消息 语法：
XADD key [NOMKSTREAM] [&lt;MAXLEN | MINID&gt; [= | ~] threshold [LIMIT count]] &lt;* | id&gt; field value [field value ...]  MAXLEN：可选参数，用于限制消息流的长度。如果指定了 MAXLEN，那么当消息流的长度超过指定的长度时，最早的消息将被自动删除 ID：可选参数，用于指定消息的 ID。如果不指定，Redis 会自动生成一个唯一的 ID。 field value [field value &hellip; ：消息的键值对，可以是任何字符串。  例如：
XADD mystream * name Foo age 10此命令将向名为 mystream 的消息流中添加一条消息，输出如下：
&gt;&#34;1680355760868-0&#34; XREAD-读取消息 语法：
      
      <p>
        
          <a href="https://luckytking.github.io/2023/04/redisstream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" aria-label="">
      
          Postgres事务隔离级别与MVCC
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-26T16:30:12&#43;08:00">
        
   26, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/go">go</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Postgres 中基于 MVCC（多版本并发控制）技术 ,使用一种称为“版本链”的技术来维护对数据库中行的并发访问, 来实现事务隔离级别的。</p>
<h3 id="mvcc-多版本并发控制">MVCC-多版本并发控制</h3>
<p>在 Postgres 中，每当一行被修改时，Postgres 就会创建一个新版本的该行，并将其添加到版本链的末尾。版本链包含了所有当前和以前的行版本，这样可以避免并发读写时的数据竞争和数据不一致问题。</p>
<p>MVCC避免了传统的数据库系统的锁定方法，将锁争夺最小化来允许多用户环境中的合理性能。</p>
<h3 id="常见并发问题">常见并发问题</h3>
<ol>
<li>脏读: 
一个事务读取了另一个并行未提交事务写入的数据</li>
<li>不可重复读
一个事务重新读取之前读取过的数据，发现该数据已经被另一个事务（在初始读之后提交）修改。</li>
<li>幻读
一个事务重新执行一个返回符合一个搜索条件的行集合的查询， 发现满足条件的行集合因为另一个最近提交的事务而发生了改变。</li>
<li>序列化异常
成功提交一组事务的结果与这些事务所有可能的串行执行结果都不一致。</li>
</ol>
<h3 id="事务隔离级解决方案">事务隔离级（解决方案）</h3>
<p>事务隔离级别指的是多个并发事务之间的可见性和可操作性，SQL标准定义了四种隔离级别，分别是：</p>
<ol>
<li>Read Uncommitted（读未提交）
这是最低的事务隔离级别，它允许一个事务读取其他事务未提交的数据。这可能会导致脏读、不可重复读和幻读问题。</li>
<li>Read Committed（读提交）
在该隔离级别下，事务只能看到已经提交的数据。它解决了脏读问题，但仍然存在不可重复读和幻读问题。</li>
<li>Repeatable Read（可重复读）
在该隔离级别下，事务在执行期间看到的所有数据都是一致的。它解决了不可重复读问题，但仍然存在幻读问题。</li>
<li>Serializable（可串行化）
在该隔离级别下，事务看到的所有数据都是一致的，并且完全避免了脏读、不可重复读和幻读问题。这是最高的事务隔离级别，但也是最慢的，因为它会导致大量的锁竞争。</li>
</ol>
<p>在PostgreSQL中，你可以请求四种标准事务隔离级别中的任意一种，但是内部只实现了三种不同的隔离级别，即 PostgreSQL 的读未提交模式的行为和读已提交相同。</p>
<h3 id="golang-libpq设置隔离等级">golang lib/pq设置隔离等级</h3>
<p>在golang中，使用lib/pq包，通过执行“SET TRANSACTION ISOLATION LEVEL &hellip;”来设置隔离等级。以下测试脏读的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;database/sql&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 连接数据库
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>, <span style="color:#a6e22e">dsn</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#75715e">// 设置隔离级别为读未提交
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED&#34;</span>)
	<span style="color:#75715e">//_, err = db.Exec(&#34;SET TRANSACTION ISOLATION LEVEL READ COMMITTED&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 开始第一个事务，修改用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#e6db74">&#34;UPDATE users SET age = 6 WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx1 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	}()

	<span style="color:#75715e">// 暂停 1 秒钟，以便让第二个事务读取到未提交的数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">// 开始第二个事务，读取用户 &#34;Bob&#34; 的年龄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tx2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Begin</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">rows</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;SELECT age FROM users WHERE name = &#39;Bob&#39;&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Next</span>() {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;tx2 Bob&#39;s age is %d\n&#34;</span>, <span style="color:#a6e22e">age</span>)
	<span style="color:#75715e">// 提交第一个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx1</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 提交第二个事务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx2</span>.<span style="color:#a6e22e">Commit</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

</code></pre></div><p>执行输出如下:</p>
<pre tabindex="0"><code>tx1 Bob's age is 6
tx2 Bob's age is 5
</code></pre><p>上例中，分别开启两个隔离级别为“读未提交”事务tx1、tx2，其中tx1对一行数据（Bob）的字段（Age）进行了修改，接着两个事务分别读取，即使在tx1提交之前，tx2也不会读取到未提交的数据,有效避免脏读等并发问题。</p>
<h3 id="小结">小结</h3>
<p>PostgreSQL 的事务隔离级别和 MVCC 技术为开发人员提供了强大的并发性能和数据一致性保证。同时MVCC并发控制模型，降低了锁竞争和死锁的风险，允许并发事务访问相同的数据而不会相互干扰。对查询（读）数据的锁请求与写数据的锁请求不冲突，所以读不会阻塞写，而写也从不阻塞读。但是，在选择事务隔离级别时，需要考虑不同事务隔离级别的性能以及<strong>应用程序的需求和性能特征</strong>，并根据实际情况进行权衡，充分利用 MVCC 技术的优点。</p>
<h3 id="参考">参考</h3>
<ul>
<li>postgres.cn  <a href="http://postgres.cn/docs/14/transaction-iso.html">http://postgres.cn/docs/14/transaction-iso.html</a></li>
<li>设置隔离级别blog <a href="https://juejin.cn/post/6992097803778392077">https://juejin.cn/post/6992097803778392077</a></li>
<li>go实例脏读、可不重复读、序列化异常 blog  <a href="https://blog.csdn.net/dfsgwe1231/article/details/107261355">https://blog.csdn.net/dfsgwe1231/article/details/107261355</a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/postgres%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8Emvcc/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/gor%E5%92%8Capisixproxymirror%E5%AE%9E%E7%8E%B0%E6%8D%95%E8%8E%B7%E5%A4%8D%E5%88%B6%E6%B5%81%E9%87%8F/" aria-label="">
      
          Gor和ApisixProxyMirror实现捕获复制流量
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-19T16:09:13&#43;08:00">
        
   19, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/%e8%bd%af%e4%bb%b6%e6%b5%8b%e8%af%95">软件测试</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在上一篇  <a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/">Go网络抓包、引流工具GoReplay</a> 介绍了Gor的一些基础和实际开发中对 HTTP 流量进行复制，以用于测试、性能监测等用途。而Apache APISIX 是 Apache 软件基金会下的云原生 API 网关，它兼具动态、实时、高性能等特点，提供了负载均衡、动态上游、灰度发布（金丝雀发布）、服务熔断、身份认证、可观测性等丰富的流量管理功能。结合使用 Gor 和 Apisix 可以轻松地实现流量复制，并将其应用于各种场景中。</p>
<p>本篇文章将介绍如何使用 Gor 和 Apisix 实现流量复制，具体包括以下几个部分：</p>
<ol>
<li>测试环境介绍</li>
<li>安装和配置 Gor</li>
<li>安装和配置 Apisix</li>
<li>配置 Apisix 的 proxy-mirror 插件</li>
<li>测试流量复制</li>
</ol>
<h3 id="测试环境介绍">测试环境介绍</h3>
<ol>
<li>OS: 两台 Ubuntu 虚拟机（Gateway、Node）
<blockquote>
<p>a.  Gateway 安装 ApiSix</p>
<p>b.  Node 安装节点服务</p>
</blockquote>
</li>
<li>Docker &amp; DockerCompose</li>
</ol>
<h3 id="安装和配置-gor">安装和配置 Gor</h3>
<p>首先，需要在Node上安装 Gor 工具。可以从 Gor 的<a href="https://apisix.apache.org/zh/docs/apisix/installation-guide/">官网下载</a>相应的二进制文件，然后将其解压到服务器上即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># tar xvf gor_1.3.3_x64.tar.gz</span>
<span style="color:#75715e"># cp gor /usr/local/bin/gor</span>
<span style="color:#75715e"># sudo chmod +x /usr/local/bin/gor</span>
</code></pre></div><p>安装完成后，可以使用以下命令启动 Gor：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># gor version</span>
</code></pre></div><p>输出</p>
<pre tabindex="0"><code># Version:1.3.0 
</code></pre><h3 id="安装和配置-apisix">安装和配置 Apisix</h3>
<p>ApiSix: 这里使用 DockerCompose安装</p>
<blockquote>
<p>git clone <a href="https://github.com/apache/apisix-docker.git">https://github.com/apache/apisix-docker.git</a></p>
<p>cd apisix-docker/example</p>
<p>docker-compose up -d</p>
</blockquote>
<p>这个命令会启动 Apisix 并监听在本地的 80 端口。</p>
<h3 id="配置-apisix-的-proxy-mirror-插件">配置 Apisix 的 proxy-mirror 插件</h3>
<p>Apisix 的 proxy-mirror 插件可以用于流量复制。
增加一个路由hello-proxy-mirror, Upstream为Node主机的服务A(端口9696)，流量复制到Node主机的服务B(端口9797)，其中</p>
<ol>
<li>host 为 指定镜像服务地址</li>
<li>sample_ratio 镜像请求采样率，本例中为1，表示全量复制</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;uri&#34;</span>: <span style="color:#e6db74">&#34;/hello&#34;</span>,
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;hello-proxy-mirror&#34;</span>,
  <span style="color:#f92672">&#34;methods&#34;</span>: [
    <span style="color:#e6db74">&#34;GET&#34;</span>,
    <span style="color:#e6db74">&#34;POST&#34;</span>,
    <span style="color:#e6db74">&#34;PUT&#34;</span>,
    <span style="color:#e6db74">&#34;DELETE&#34;</span>,
    <span style="color:#e6db74">&#34;PATCH&#34;</span>,
    <span style="color:#e6db74">&#34;HEAD&#34;</span>,
    <span style="color:#e6db74">&#34;OPTIONS&#34;</span>,
    <span style="color:#e6db74">&#34;CONNECT&#34;</span>,
    <span style="color:#e6db74">&#34;TRACE&#34;</span>
  ],
  <span style="color:#f92672">&#34;plugins&#34;</span>: {
    <span style="color:#f92672">&#34;proxy-mirror&#34;</span>: {
      <span style="color:#f92672">&#34;disable&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;http://192.168.1.101:9797&#34;</span>,
      <span style="color:#f92672">&#34;sample_ratio&#34;</span>: <span style="color:#ae81ff">1</span>
    }
  },
  <span style="color:#f92672">&#34;upstream&#34;</span>: {
    <span style="color:#f92672">&#34;nodes&#34;</span>: [
      {
        <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;192.168.1.101&#34;</span>,
        <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">9696</span>,
        <span style="color:#f92672">&#34;weight&#34;</span>: <span style="color:#ae81ff">1</span>
      }
    ],
    <span style="color:#f92672">&#34;timeout&#34;</span>: {
      <span style="color:#f92672">&#34;connect&#34;</span>: <span style="color:#ae81ff">6</span>,
      <span style="color:#f92672">&#34;send&#34;</span>: <span style="color:#ae81ff">6</span>,
      <span style="color:#f92672">&#34;read&#34;</span>: <span style="color:#ae81ff">6</span>
    },
    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;roundrobin&#34;</span>,
    <span style="color:#f92672">&#34;scheme&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
    <span style="color:#f92672">&#34;pass_host&#34;</span>: <span style="color:#e6db74">&#34;pass&#34;</span>,
    <span style="color:#f92672">&#34;keepalive_pool&#34;</span>: {
      <span style="color:#f92672">&#34;idle_timeout&#34;</span>: <span style="color:#ae81ff">60</span>,
      <span style="color:#f92672">&#34;requests&#34;</span>: <span style="color:#ae81ff">1000</span>,
      <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">320</span>
    }
  },
  <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>这个配置会开启 proxy-mirror 插件，并将其配置为将流量发送到本地的 8080 端口，即 Gor 监听的地址。</p>
<h3 id="测试流量复制">测试流量复制</h3>
<p>接着可开始测试流量复制。</p>
<h4 id="启动-http-服务a监听9696端口">启动 HTTP 服务A监听9696端口：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python3 -m http.server <span style="color:#ae81ff">9696</span>
</code></pre></div><p>正常启动输出</p>
<pre tabindex="0"><code>Serving HTTP on 0.0.0.0 port 9696 (http://0.0.0.0:9696/) ...
</code></pre><h4 id="启动-镜像服务b监听9797端口">启动 镜像服务B监听9797端口：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python3 -m http.server <span style="color:#ae81ff">9797</span>
</code></pre></div><p>正常启动输出</p>
<pre tabindex="0"><code>Serving HTTP on 0.0.0.0 port 9797 (http://0.0.0.0:9797/) ...
</code></pre><h4 id="启动-gor-监听在本地的-9797-端口">启动 Gor 监听在本地的 9797 端口</h4>
<pre tabindex="0"><code>sudo gor --input-raw :9797 --output-stdout  
</code></pre><p>此命令将监听镜像服务B端口9797， 将 HTTP 流量输出到控制台</p>
<p>接着，curl测试</p>
<pre tabindex="0"><code class="language-curl" data-lang="curl">curl http://192.168.1.100:80/hello -i
</code></pre><p>输出</p>
<pre tabindex="0"><code>HTTP/1.1 404 File not found
Content-Type: text/html;charset=utf-8
Content-Length: 469
Connection: keep-alive
Date: Sun, 19 Mar 2023 06:55:42 GMT
Server: APISIX/3.2.0

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;
        &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
        &lt;title&gt;Error response&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Error response&lt;/h1&gt;
        &lt;p&gt;Error code: 404&lt;/p&gt;
        &lt;p&gt;Message: File not found.&lt;/p&gt;
        &lt;p&gt;Error code explanation: HTTPStatus.NOT_FOUND - Nothing matches the given URI.&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>测试会发送一个 HTTP 请求到Apisix开放的Http端口80，可以到达下游服务（Node主机的ServerA 9696端口），输出如下：</p>
<pre tabindex="0"><code>192.168.1.100 - - [19/Mar/2023 06:47:44] code 404, message File not found
192.168.1.100 - - [19/Mar/2023 06:47:44] &quot;GET /hello HTTP/1.1&quot; 404 -
</code></pre><p>而且，ApiSix Proxy Mirror复制Http请求到端口 9797的镜像服务， 输出如下:</p>
<pre tabindex="0"><code>192.168.1.100 - - [19/Mar/2023 06:49:07] code 404, message File not found
192.168.1.100 - - [19/Mar/2023 06:49:07] &quot;GET /hello HTTP/1.1&quot; 404 -
</code></pre><p>可见和目标服务的的完全一致。 
接着，观察Gor是否正常记录http请求，正常输出如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ae81ff">1</span> af0c2645c0a801c7399d6efb <span style="color:#ae81ff">1679212462567906772</span> <span style="color:#ae81ff">0</span>
GET /hello HTTP/1.1
Host: 192.168.1.100
Connection: close
User-Agent: curl/7.64.1
Accept: */*
</code></pre></div><p>说明Gor已经成功从镜像服务捕获流量。
再结合使用Gor的流量回放功能可以应用于例如测试、性能监测等场景。 
以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/getting-started">ApiSix Wiki</a></li>
<li><a href="https://625a9090d04b9a6953165811--2-11-old-docs-apache-apisix.netlify.app/zh/docs/apisix/plugins/proxy-mirror">Proxy Mirror</a></li>
<li><a href="https://luckytking.github.io/2022/11/go%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%BC%95%E6%B5%81%E5%B7%A5%E5%85%B7goreplay/">go网络抓包引流工具 </a></li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/gor%E5%92%8Capisixproxymirror%E5%AE%9E%E7%8E%B0%E6%8D%95%E8%8E%B7%E5%A4%8D%E5%88%B6%E6%B5%81%E9%87%8F/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
            
  
    
      
        
      
    
  


  

<article class="postShorten postShorten--thumbnailimg-right">
  <div class="postShorten-wrap">
    
    <div class="postShorten-header">
      <h1 class="postShorten-title">
      
        <a class="link-unstyled" href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" aria-label="">
      
          CRI与使用crictl调试k8s节点
        </a>
      </h1>
      
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-12T17:24:41&#43;08:00">
        
   12, 2023

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="https://luckytking.github.io/categories/k8s">k8s</a>
    
  

  </div>

    </div>
    <div class="postShorten-excerpt">
      
        <p>在 Kubernetes 中，Kubelet 是在每个节点上运行的重要组件之一，它负责管理容器的生命周期。而 CRI（Container Runtime Interface）则是 Kubelet 用于与容器运行时进行通信的接口（如下图）。</p>
<p>CRI 采用了 ProtoBuffer 和 gPRC，规定 kubelet 该如何调用容器运行时去管理容器和镜像，Kubernetes 通过CRI可支持多种类型的OCI容器运行时，例如 docker、contained、CRI-O、runC、fraki和Kata Containers 等）。</p>
<p>为了方便用户进行容器运行时的调试工作，社区提供了 crictl 工具，用于与 CRI 接口进行交互，本文简要介绍如何使用 crictl 对 Kubernetes节点进行调试 。</p>
<p>kubelet-layout：</p>
<!-- raw HTML omitted -->
<p><img src="https://luckytking.github.io/images/kubelet-layout.png" alt=""></p>
<h4 id="安装">安装</h4>
<blockquote>
<p>你可以从 cri-tools <a href="https://github.com/kubernetes-sigs/cri-tools/releases">发布页面</a> 下载一个压缩的 crictl 归档文件，用于几种不同的架构。 下载与你的 kubernetes 版本相对应的版本。 提取它并将其移动到系统路径上的某个位置，例如 /usr/local/bin/。</p>
</blockquote>
<ul>
<li>查看版本，验证安装</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl --version
</code></pre></div><p>输出例如如下，说明安装成功:</p>
<pre tabindex="0"><code>crictl version v1.23.0 
</code></pre><h4 id="查看或编辑配置">查看或编辑配置</h4>
<p>要查看或编辑当前配置，请查看或编辑 /etc/crictl.yaml 的内容。</p>
<pre tabindex="0"><code>cat /etc/crictl.yaml
image-endpoint: unix:///var/run/image-cri-shim.sock
runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><h4 id="调试节点">调试节点</h4>
<ul>
<li>列出运行中的容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl ps
</code></pre></div><p>例如我们列出k8s集群的所有容器，例如输出：</p>
<pre tabindex="0"><code>CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID
508e30da66ce7       7a71aca7b60fc       3 days ago          Running             calico-node               0                   e0ec650992997
9daa288a68426       f822f80398b9a       3 days ago          Running             calico-typha              0                   f5c4bd6471941
300d948e75019       f6bc1b780606f       3 days ago          Running             kube-controller-manager   1                   d5d681744a377
1cfdc1a6726ae       0198979b7707e       3 days ago          Running             kube-scheduler            1                   eb6ff07ees98c
3699c312c56f9       9e6a540eeeb62       3 days ago          Running             kube-proxy                0                   e8707140d12941
4159d7ec37b29       5bc0062e9555c       3 days ago          Running             kube-apiserver            0                   22d043569737f
8f56a047e8627      25f8c7f3da61c       3 days ago          Restart             etcd                      0                   458e540c798c8
</code></pre><p>本例中，etcd容器一直启动，可以使用以下命令获取容器的日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl logs container-id
</code></pre></div><p>如此，通过日志帮助定位问题。</p>
<h4 id="更多命令">更多命令</h4>
<ul>
<li>列出所有的pods</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl pods
</code></pre></div><ul>
<li>创建容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl run --runtime<span style="color:#f92672">=</span>remote <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  docker.io/library/nginx:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  nginx-container
</code></pre></div><p>ps:使用远程容器CRI来使用最新的 nginx 镜像启动nginx-container的容器。</p>
<ul>
<li>删除容器：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crictl rm nginx-container
</code></pre></div><ul>
<li>列出所有镜像：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crictl images
</code></pre></div><ul>
<li>帮助</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> crictl -h 
NAME:
   crictl - client <span style="color:#66d9ef">for</span> CRI

USAGE:
   crictl <span style="color:#f92672">[</span>global options<span style="color:#f92672">]</span> command <span style="color:#f92672">[</span>command options<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>arguments...<span style="color:#f92672">]</span>

VERSION:
   v1.23.0

COMMANDS:
   attach              Attach to a running container
   create              Create a new container
   exec                Run a command in a running container
   version             Display runtime version information
   images, image, img  List images
   inspect             Display the status of one or more containers
   inspecti            Return the status of one or more images
   imagefsinfo         Return image filesystem info
   inspectp            Display the status of one or more pods
   logs                Fetch the logs of a container
   port-forward        Forward local port to a pod
   ps                  List containers
   pull                Pull an image from a registry
   run                 Run a new container inside a sandbox
   runp                Run a new pod
   rm                  Remove one or more containers
   rmi                 Remove one or more images
   rmp                 Remove one or more pods
   pods                List pods
   start               Start one or more created containers
   info                Display information of the container runtime
   stop                Stop one or more running containers
   stopp               Stop one or more running pods
   update              Update one or more running containers
   config              Get and set crictl client configuration options
   stats               List container<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> resource usage statistics
   completion          Output shell completion code
   help, h             Shows a list of commands or help <span style="color:#66d9ef">for</span> one command

GLOBAL OPTIONS:
   --config value, -c value            Location of the client config file. If not specified and the default does not exist, the program<span style="color:#e6db74">&#39;s directory is searched as well (default: &#34;/etc/crictl.yaml&#34;) [$CRI_CONFIG_FILE]
</span><span style="color:#e6db74">   --debug, -D                         Enable debug mode (default: false)
</span><span style="color:#e6db74">   --image-endpoint value, -i value    Endpoint of CRI image manager service (default: uses &#39;</span>runtime-endpoint<span style="color:#960050;background-color:#1e0010">&#39;</span> setting<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>$IMAGE_SERVICE_ENDPOINT<span style="color:#f92672">]</span>
   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service <span style="color:#f92672">(</span>default: uses in order the first successful one of <span style="color:#f92672">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style="color:#f92672">])</span>. Default is now deprecated and the endpoint should be set instead. <span style="color:#f92672">[</span>$CONTAINER_RUNTIME_ENDPOINT<span style="color:#f92672">]</span>
   --timeout value, -t value           Timeout of connecting to the server in seconds <span style="color:#f92672">(</span>e.g. 2s, 20s.<span style="color:#f92672">)</span>. <span style="color:#ae81ff">0</span> or less is set to default <span style="color:#f92672">(</span>default: 2s<span style="color:#f92672">)</span>
   --help, -h                          show help <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
   --version, -v                       print the version <span style="color:#f92672">(</span>default: false<span style="color:#f92672">)</span>
</code></pre></div><p>以上。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">kubernetes.io 使用 crictl 对 Kubernetes 节点进行调试</a></li>
<li><a href="%C2%A0https://item.jd.com/13140598.html">《Kubernetes进阶实战-第2版》CRI 与OCI </a>
 </li>
</ul>
      
      <p>
        
          <a href="https://luckytking.github.io/2023/03/cri%E4%B8%8E%E4%BD%BF%E7%94%A8crictl%E8%B0%83%E8%AF%95k8s%E8%8A%82%E7%82%B9/" class="postShorten-excerpt_link link" aria-label=""></a>
        
        
      </p>
    </div>
  </div>
  
</article>

          
          
  <div class="pagination-bar">
    <ul class="pagination">
      
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="https://luckytking.github.io/page/2/" aria-label="">
              <span></span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
      
      <li class="pagination-number"> </li>
    </ul>
  </div>


        </section>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 jefffff. 
  </span>
</footer>

      </div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://luckytking.github.io/images/tk.jpg" alt="" />
    
    <h4 id="about-card-name">jefffff</h4>
    
      <div id="about-card-bio">Stay hungry. Stay Foolish  <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Go backend developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        China Amoy
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://luckytking.github.io/images/cover-v1.2.0.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://luckytking.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

